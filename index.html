<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Habits - Daily Rituals</title>
  <meta name="theme-color" content="#1a1a2e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="icon" type="image/png" href="apple-touch-icon.png">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="manifest" href="manifest.json">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* === NIGHT MODE (Default - Aurora/Twilight) === */
      --bg-deep: #1a1a2e;
      --bg-mid: #16213e;
      --bg-card: rgba(255,255,255,0.08);
      --bg-card-hover: rgba(255,255,255,0.12);
      
      --text: #ffffff;
      --text-dim: rgba(255,255,255,0.85);
      --text-muted: rgba(255,255,255,0.6);
      
      --accent-pink: #ff6b9d;
      --accent-orange: #ffa552;
      --accent-yellow: #ffd93d;
      --accent-teal: #6dd5ed;
      --accent-purple: #c471ed;
      
      --glow-pink: rgba(255,107,157,0.4);
      --glow-orange: rgba(255,165,82,0.4);
      --glow-teal: rgba(109,213,237,0.4);
      --glow-purple: rgba(196,113,237,0.4);
      
      --success: #6dd5ed;
      --success-soft: rgba(109,213,237,0.2);
      
      --sleep: #c471ed;
      --water: #6dd5ed;
      --movement: #ff6b9d;
      --nutrition: #6dd5ed;
      
      --border: rgba(255,255,255,0.2);
      --radius: 20px;
      --radius-sm: 12px;
      --radius-pill: 100px;
      
      /* Gradient backgrounds */
      --bg-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 25%, #1a1a2e 50%, #2d1b4e 75%, #1a1a2e 100%);
      --bg-aurora: 
        radial-gradient(ellipse at 20% 20%, rgba(196,113,237,0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(255,107,157,0.1) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, rgba(109,213,237,0.08) 0%, transparent 60%);
    }
    
    /* === DAY MODE - Soft Cantaloupe === */
    body.day-mode {
      --bg-deep: #ffeaa7;
      --bg-mid: #fdcb6e;
      --bg-card: rgba(255,255,255,0.6);
      --bg-card-hover: rgba(255,255,255,0.8);
      
      /* Dark text for contrast on light background */
      --text: #1a1a2e;
      --text-dim: rgba(26,26,46,0.8);
      --text-muted: rgba(26,26,46,0.6);
      
      /* Vibrant accents to pop against yellow-orange background */
      --accent-pink: #e11d48;
      --accent-orange: #ea580c;
      --accent-yellow: #ca8a04;
      --accent-teal: #0d9488;
      --accent-purple: #6366f1;
      
      --glow-pink: rgba(225,29,72,0.3);
      --glow-orange: rgba(234,88,12,0.3);
      --glow-teal: rgba(13,148,136,0.3);
      --glow-purple: rgba(99,102,241,0.4);
      
      --success: #059669;
      --success-soft: rgba(5,150,105,0.15);
      
      --sleep: #6366f1;
      --water: #0d9488;
      --movement: #e11d48;
      --nutrition: #059669;
      
      --border: rgba(0,0,0,0.1);
      
      /* Soft Cantaloupe gradient */
      background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 30%, #f9a825 70%, #fdcb6e 100%) !important;
    }
    
    body.day-mode::before {
      background: radial-gradient(ellipse at 30% 20%, rgba(255,234,167,0.5) 0%, transparent 50%) !important;
    }
    
    /* Day mode specific overrides - indigo/purple buttons on cantaloupe background */
    body.day-mode .logo {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      box-shadow: 0 0 20px var(--glow-purple);
    }
    body.day-mode .date-btn {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      box-shadow: 0 4px 15px var(--glow-purple);
      color: white;
    }
    body.day-mode .phase-fill {
      background: linear-gradient(90deg, #6366f1, #8b5cf6, #a855f7);
    }
    body.day-mode .fab {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      box-shadow: 0 8px 25px var(--glow-purple);
      color: white;
    }
    body.day-mode .btn-primary {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
    }
    body.day-mode .ring-progress {
      stroke: #6366f1;
    }
    body.day-mode .ring-text {
      color: #6366f1;
    }
    body.day-mode .chip.on {
      background: rgba(251, 146, 60, 0.25);
      border-color: #f97316;
      box-shadow: 0 0 10px rgba(249, 115, 22, 0.3);
    }
    body.day-mode .chip.on .chip-dot {
      background: #f97316;
      border-color: #f97316;
      color: white;
      box-shadow: 0 0 8px rgba(249, 115, 22, 0.4);
    }
    body.day-mode .water-btn {
      border-color: var(--accent-teal);
      color: var(--accent-teal);
    }
    body.day-mode .water-btn:hover {
      background: var(--accent-teal);
      color: white;
    }
    body.day-mode .water-num {
      color: var(--text);
    }
    body.day-mode .milestone-title {
      background: linear-gradient(90deg, var(--accent-orange), var(--accent-pink), var(--accent-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    body.day-mode .card {
      background: rgba(255,255,255,0.6);
      border-color: rgba(0,0,0,0.08);
    }
    body.day-mode .card-title {
      color: var(--text-muted);
    }
    body.day-mode .card-avg {
      color: var(--text-muted);
    }
    body.day-mode .section {
      background: rgba(255,255,255,0.6);
      border-color: rgba(0,0,0,0.08);
    }
    body.day-mode .sec-name {
      color: var(--text);
    }
    body.day-mode .nav-link {
      background: rgba(255,255,255,0.6);
      border-color: rgba(0,0,0,0.1);
      color: var(--text-dim);
    }
    body.day-mode .nav-link:hover {
      background: rgba(255,255,255,0.8);
      color: var(--accent-orange);
      border-color: var(--accent-orange);
    }
    body.day-mode .date-nav {
      background: rgba(255,255,255,0.6);
      border-color: rgba(0,0,0,0.08);
    }
    body.day-mode .date-main,
    body.day-mode .date-sub {
      color: var(--text);
    }
    body.day-mode .steps-bar-fill {
      background: linear-gradient(to top, #6366f1, #8b5cf6, #a855f7);
    }
    body.day-mode .water-bar-fill {
      background: linear-gradient(to top, var(--accent-teal), #14b8a6, #5eead4);
    }
    body.day-mode .big-input {
      color: var(--text);
    }
    body.day-mode .big-input::placeholder {
      color: var(--text-muted);
    }
    body.day-mode .chip-text {
      color: var(--text-dim);
    }
    body.day-mode .chip.on .chip-text {
      color: #1f2937;
    }
    body.day-mode .chip-dot {
      border-color: var(--text-muted);
    }
    /* Dark empty progress bars in day mode */
    body.day-mode .steps-bar-track,
    body.day-mode .water-bar-track {
      background: rgba(0,0,0,0.15);
    }
    body.day-mode .ring-bg {
      stroke: rgba(0,0,0,0.15);
    }
    body.day-mode .phase-track {
      background: rgba(0,0,0,0.12);
    }
    /* Darker collapse arrows */
    body.day-mode .sec-toggle {
      color: var(--text-dim);
    }
    
    /* === SUNSET TRANSITION MODE === */
    body.sunset-mode {
      --bg-deep: #2d1b4e;
      --bg-mid: #1a1a2e;
      --bg-card: rgba(255,255,255,0.06);
      --bg-card-hover: rgba(255,255,255,0.1);
      
      --text: #f0f0f0;
      --text-dim: rgba(255,255,255,0.7);
      --text-muted: rgba(255,255,255,0.5);
      
      --bg-gradient: linear-gradient(135deg, #2d1b4e 0%, #4a1942 30%, #1a1a2e 70%, #16213e 100%);
      --bg-aurora: 
        radial-gradient(ellipse at 50% 0%, rgba(255,107,157,0.2) 0%, transparent 50%),
        radial-gradient(ellipse at 30% 50%, rgba(255,165,82,0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 70% 80%, rgba(196,113,237,0.15) 0%, transparent 50%);
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      min-height: 100vh;
      color: var(--text);
      padding: 16px;
      padding-bottom: 120px;
      font-size: 16px;
      line-height: 1.5;
      background: var(--bg-gradient);
      background-attachment: fixed;
      position: relative;
      transition: background 1s ease, color 0.5s ease;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--bg-aurora);
      pointer-events: none;
      z-index: 0;
      transition: background 1s ease;
    }
    
    body > * { position: relative; z-index: 1; }
    
    /* Theme indicator */
    .theme-indicator {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      color: var(--text-muted);
      background: var(--bg-card);
      padding: 4px 12px;
      border-radius: var(--radius-pill);
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 1001;
      backdrop-filter: blur(10px);
    }
    .theme-indicator.show {
      opacity: 1;
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--bg-deep);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .loading-overlay.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }
    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: var(--accent-pink);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .loading-text {
      margin-top: 16px;
      font-size: 14px;
      color: var(--text-muted);
    }
    body.day-mode .loading-overlay {
      background: linear-gradient(135deg, #fef3e2 0%, #fce7c8 50%, #fff9f0 100%);
    }
    body.day-mode .loading-spinner {
      border-color: rgba(0,0,0,0.1);
      border-top-color: var(--accent-orange);
    }
    body.day-mode .loading-text {
      color: #6b7280;
    }
    
    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 12px 24px;
      border-radius: var(--radius-pill);
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      backdrop-filter: blur(20px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 10000;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .toast.show {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }
    .toast.success {
      border-color: var(--success);
      box-shadow: 0 0 20px var(--glow-teal);
    }
    .toast.error {
      border-color: #ef4444;
      box-shadow: 0 0 20px rgba(239,68,68,0.4);
    }
    body.day-mode .toast {
      background: rgba(255,255,255,0.95);
      color: #1f2937;
    }
    
    /* Pull to Refresh */
    .pull-indicator {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%) translateY(-100%);
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 8px 16px;
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
      font-size: 12px;
      color: var(--text-muted);
      backdrop-filter: blur(10px);
      transition: transform 0.2s;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .pull-indicator.visible {
      transform: translateX(-50%) translateY(0);
    }
    .pull-indicator .pull-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.2);
      border-top-color: var(--accent-teal);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    body.day-mode .pull-indicator {
      background: rgba(255,255,255,0.9);
      color: #6b7280;
    }
    body.day-mode .pull-indicator .pull-spinner {
      border-color: rgba(0,0,0,0.1);
      border-top-color: var(--accent-orange);
    }
      --radius-pill: 100px;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      min-height: 100vh;
      color: var(--text);
      padding: 16px;
      padding-top: max(66px, calc(12px + env(safe-area-inset-top, 54px)));
      padding-bottom: calc(120px + env(safe-area-inset-bottom, 0px));
      padding-left: calc(16px + env(safe-area-inset-left, 0px));
      padding-right: calc(16px + env(safe-area-inset-right, 0px));
      font-size: 16px;
      line-height: 1.5;
      
      /* Aurora gradient background */
      background: linear-gradient(135deg, 
        #1a1a2e 0%, 
        #16213e 25%, 
        #1a1a2e 50%,
        #2d1b4e 75%,
        #1a1a2e 100%
      );
      background-attachment: fixed;
      position: relative;
    }
    
    /* Animated aurora glow overlay */
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: 
        radial-gradient(ellipse at 20% 20%, rgba(196,113,237,0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(255,107,157,0.1) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, rgba(109,213,237,0.08) 0%, transparent 60%);
      pointer-events: none;
      z-index: 0;
    }
    
    body > * { position: relative; z-index: 1; }
    
    /* Header */
    .header { 
      padding: 20px; 
      margin-bottom: 20px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: var(--radius);
      backdrop-filter: blur(20px);
    }
    body.day-mode .header {
      background: rgba(255,255,255,0.6);
      border-color: rgba(0,0,0,0.08);
    }
    .header-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; }
    .brand { display: flex; align-items: center; gap: 12px; }
    .logo {
      width: 48px; height: 48px; border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-pink), var(--accent-purple));
      display: flex; align-items: center; justify-content: center; font-size: 22px;
      box-shadow: 0 0 30px var(--glow-pink), 0 0 60px var(--glow-purple);
      animation: pulse-glow 3s ease-in-out infinite;
    }
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px var(--glow-pink), 0 0 40px var(--glow-purple); }
      50% { box-shadow: 0 0 30px var(--glow-pink), 0 0 60px var(--glow-purple); }
    }
    .brand h1 { font-family: 'Space Grotesk', sans-serif; font-size: 32px; font-weight: 700; letter-spacing: -0.02em; color: white; margin: 0; }
    .brand h1 .version { font-size: 12px; font-weight: 500; color: var(--text-muted); vertical-align: super; margin-left: 4px; }
    body.day-mode .brand h1 { color: #1f2937; }
    .brand .tagline { font-size: 16px; font-weight: 600; color: var(--accent-pink); margin-top: 2px; }
    .phase-day { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    .nav-links { display: flex; gap: 8px; }
    .nav-link {
      width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border);
      background: var(--bg-card); color: var(--text-dim); font-size: 15px; cursor: pointer;
      display: flex; align-items: center; justify-content: center; text-decoration: none;
      transition: all 0.3s; backdrop-filter: blur(10px);
    }
    .nav-link:hover { 
      background: var(--bg-card-hover); 
      color: var(--accent-teal); 
      border-color: var(--accent-teal);
      box-shadow: 0 0 20px var(--glow-teal);
    }
    
    /* Date Nav - Glassmorphism */
    .date-nav {
      display: grid; 
      grid-template-columns: auto 1fr auto auto;
      align-items: center; 
      gap: 12px; 
      padding: 16px;
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius); backdrop-filter: blur(20px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    .date-nav .phase {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }
    .date-btn {
      width: 44px; height: 44px; border-radius: 50%; border: none;
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));
      color: white; font-size: 18px; font-weight: 600;
      cursor: pointer; transition: all 0.3s;
      box-shadow: 0 4px 15px var(--glow-purple);
    }
    .date-btn:hover { transform: scale(1.1); box-shadow: 0 6px 25px var(--glow-pink); }
    .date-btn:active { transform: scale(0.95); }
    .date-center { flex: 1; text-align: center; }
    .date-main { font-family: 'Space Grotesk', sans-serif; font-size: 18px; font-weight: 600; color: white; }
    .date-sub { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    
    /* Progress Ring - Glowing */
    .ring-wrap { position: relative; width: 72px; height: 72px; }
    .ring { transform: rotate(-90deg); }
    .ring-bg { fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 5; }
    .ring-progress { 
      fill: none; 
      stroke: url(#auroraGrad); 
      stroke-width: 5; 
      stroke-linecap: round; 
      transition: stroke-dashoffset 0.6s;
      filter: drop-shadow(0 0 6px var(--glow-teal));
    }
    .ring-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-family: 'Space Grotesk', sans-serif; font-size: 18px; font-weight: 700; color: var(--accent-teal); }
    
    /* Phase Bar */
    .phase { margin-top: 0; }
    .phase-label { display: flex; justify-content: space-between; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 8px; }
    .phase-track { height: 6px; background: rgba(255,255,255,0.1); border-radius: var(--radius-pill); overflow: hidden; }
    .phase-fill { 
      height: 100%; 
      background: linear-gradient(90deg, var(--accent-purple), var(--accent-pink), var(--accent-orange)); 
      border-radius: var(--radius-pill); 
      box-shadow: 0 0 20px var(--glow-pink);
      transition: width 0.6s;
    }
    
    /* Cards - Glowing borders on hover */
    .quick-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
    
    /* REHIT full-width card */
    .rehit-full {
      margin-bottom: 16px;
      min-height: auto;
    }
    .rehit-dots-row {
      display: flex;
      gap: 8px;
      margin: 10px 0 14px 0;
    }
    .rehit-dots-row .rehit-dot {
      flex: 1;
      height: 8px;
      border-radius: 4px;
      background: rgba(255,255,255,0.15);
      transition: all 0.3s;
    }
    .rehit-dots-row .rehit-dot.on {
      background: linear-gradient(90deg, var(--accent-pink), var(--accent-orange));
      box-shadow: 0 0 10px var(--glow-pink);
    }
    .rehit-layout {
      display: flex;
      gap: 20px;
      align-items: flex-end;
    }
    .rehit-left {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .rehit-chips {
      flex-direction: column;
      gap: 8px;
    }
    .rehit-chip {
      padding: 10px 16px;
    }
    .rehit-chip .chip-dot {
      width: 22px;
      height: 22px;
      font-size: 12px;
    }
    .rehit-chip .chip-text {
      font-size: 15px;
      font-weight: 600;
    }
    .rehit-week-count {
      margin-top: auto;
      padding-top: 0;
    }
    .rehit-right {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding-left: 20px;
      border-left: 1px solid var(--border);
    }
    .rehit-stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px 24px;
    }
    .rehit-stat {
      text-align: center;
    }
    .rehit-stat-label {
      display: block;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: var(--text-muted);
      margin-bottom: 2px;
    }
    .rehit-stat-value {
      display: block;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 20px;
      font-weight: 700;
    }
    .rehit-edit-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-pill);
      background: rgba(255,255,255,0.06);
      color: var(--text-dim);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .rehit-edit-btn .chip-dot {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 2px solid var(--accent-pink);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: var(--accent-pink);
      transition: all 0.3s;
    }
    .rehit-edit-btn:hover {
      background: rgba(236, 72, 153, 0.1);
      border-color: var(--accent-pink);
    }
    .rehit-edit-btn:hover .chip-dot {
      background: var(--accent-pink);
      color: white;
      box-shadow: 0 0 10px var(--glow-pink);
    }
    body.day-mode .rehit-edit-btn {
      background: rgba(0,0,0,0.05);
    }
    
    .card {
      background: rgba(255,255,255,0.06); 
      border: 1px solid rgba(255,255,255,0.15); 
      border-radius: var(--radius);
      padding: 18px; 
      position: relative; 
      overflow: hidden; 
      backdrop-filter: blur(20px);
      transition: all 0.3s;
      display: flex;
      flex-direction: column;
      min-height: 140px;
    }
    .card::before { 
      content: ''; 
      position: absolute; 
      top: 0; left: 0; right: 0; 
      height: 3px; 
      background: linear-gradient(90deg, var(--accent-start, var(--accent-purple)), var(--accent-end, var(--accent-pink))); 
      opacity: 0.8; 
    }
    .card:hover { 
      border-color: rgba(255,255,255,0.25);
      box-shadow: 0 0 30px var(--card-glow, var(--glow-purple));
      transform: translateY(-2px);
    }
    .card.sleep { --accent-start: var(--accent-purple); --accent-end: var(--accent-pink); --card-glow: var(--glow-purple); }
    .card.water { --accent-start: var(--accent-teal); --accent-end: var(--accent-purple); --card-glow: var(--glow-teal); }
    .card.movement { --accent-start: var(--accent-pink); --accent-end: var(--accent-orange); --card-glow: var(--glow-pink); }
    
    .card-head { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
    .card-icon { 
      width: 32px; height: 32px; border-radius: 50%; 
      display: flex; align-items: center; justify-content: center; font-size: 15px; 
      background: linear-gradient(135deg, var(--accent-start, var(--accent-purple)), var(--accent-end, var(--accent-pink)));
      box-shadow: 0 0 15px var(--card-glow, var(--glow-purple));
    }
    .card-title { font-size: 12px; font-weight: 600; color: rgba(255,255,255,0.8); text-transform: uppercase; letter-spacing: 0.05em; }
    .card-value { font-family: 'Space Grotesk', sans-serif; font-size: 32px; font-weight: 700; line-height: 1; color: #ffffff; }
    .card-unit { font-size: 13px; color: var(--text); margin-left: 4px; }
    .input-row { display: flex; align-items: baseline; }
    .card-avg { font-size: 11px; color: rgba(255,255,255,0.5); margin-top: auto; padding-top: 8px; }
    
    /* REHIT Dots */
    .rehit-dots { display: flex; gap: 6px; margin-left: auto; }
    .rehit-dot { 
      width: 10px; height: 10px; 
      border-radius: 50%; 
      background: rgba(255,255,255,0.2); 
      transition: all 0.3s;
    }
    .rehit-dot.on { 
      background: var(--accent-teal); 
      box-shadow: 0 0 8px var(--glow-teal);
    }
    body.day-mode .rehit-dot {
      background: rgba(0,0,0,0.15);
    }
    body.day-mode .rehit-dot.on {
      background: var(--success);
      box-shadow: 0 0 8px rgba(5,150,105,0.4);
    }
    body.day-mode .rehit-dots-row .rehit-dot {
      background: rgba(0,0,0,0.1);
    }
    body.day-mode .rehit-dots-row .rehit-dot.on {
      background: linear-gradient(90deg, var(--accent-pink), var(--accent-orange));
      box-shadow: 0 0 8px rgba(236, 72, 153, 0.4);
    }
    
    /* Counter dots (for weekly goals) */
    .counter-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      transition: all 0.3s;
    }
    .counter-dot.on {
      background: var(--accent-teal);
      box-shadow: 0 0 8px var(--glow-teal);
    }
    body.day-mode .counter-dot {
      background: rgba(0,0,0,0.15);
    }
    body.day-mode .counter-dot.on {
      background: var(--success);
      box-shadow: 0 0 8px rgba(5,150,105,0.4);
    }
    
    /* Rating stars */
    .rating-stars {
      display: flex;
      gap: 8px;
      font-size: 28px;
    }
    .star {
      cursor: pointer;
      color: rgba(255,255,255,0.3);
      transition: all 0.2s;
    }
    .star:hover, .star.filled {
      color: var(--accent-orange);
      text-shadow: 0 0 10px var(--glow-orange);
    }
    body.day-mode .star {
      color: rgba(0,0,0,0.2);
    }
    body.day-mode .star:hover, body.day-mode .star.filled {
      color: var(--accent-orange);
    }
    
    /* Custom log modal */
    #customLogModal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    #customLogModal.show {
      display: flex;
    }
    #customLogModal .modal-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
    }
    #customLogModal .modal-content {
      position: relative;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }
    #customLogModal .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    #customLogModal .modal-header h3 {
      margin: 0;
      font-size: 18px;
    }
    body.day-mode #customLogModal .modal-content {
      background: rgba(255,255,255,0.95);
    }
    
    /* Mini Supplements (in own card) */
    .mini-supps-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 8px;
    }
    .mini-supp {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px 6px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: rgba(255,255,255,0.05);
      cursor: pointer;
      transition: all 0.2s;
    }
    .mini-supp input {
      display: none;
    }
    .mini-supp span {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
    }
    .mini-supp:has(input:checked) {
      background: var(--success-soft);
      border-color: var(--success);
      box-shadow: 0 0 10px var(--glow-teal);
    }
    .mini-supp:has(input:checked) span {
      color: white;
    }
    body.day-mode .mini-supp {
      background: rgba(0,0,0,0.05);
    }
    body.day-mode .mini-supp:has(input:checked) {
      background: rgba(251, 146, 60, 0.25);
      border-color: #f97316;
      box-shadow: 0 0 8px rgba(249, 115, 22, 0.3);
    }
    body.day-mode .mini-supp:has(input:checked) span {
      color: #1f2937;
    }
    .card.supplements {
      --accent-start: var(--accent-teal);
      --accent-end: var(--accent-purple);
      --card-glow: var(--glow-teal);
    }
    .mini-supps-grid.three-col {
      grid-template-columns: 1fr 1fr 1fr;
    }
    
    /* Horizontal Progress Bars (same style as phase bar) */
    .progress-bar-h {
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: var(--radius-pill);
      overflow: hidden;
      margin-top: 10px;
    }
    .progress-bar-h-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-purple), var(--accent-pink), var(--accent-orange));
      border-radius: var(--radius-pill);
      box-shadow: 0 0 10px var(--glow-pink);
      transition: width 0.5s ease;
      width: 0%;
    }
    body.day-mode .progress-bar-h {
      background: rgba(0,0,0,0.1);
    }
    
    /* Movement Modal */
    .movement-types {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }
    .movement-type-btn {
      padding: 20px 10px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg-card);
      color: var(--text);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .movement-type-btn .type-icon {
      font-size: 28px;
    }
    .movement-type-btn.selected {
      border-color: var(--accent-teal);
      background: rgba(45, 212, 191, 0.15);
      box-shadow: 0 0 20px var(--glow-teal);
    }
    .duration-section {
      margin-bottom: 0;
    }
    .duration-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 12px;
    }
    .duration-presets {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .duration-preset {
      flex: 1;
      min-width: 50px;
      padding: 12px 8px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg-card);
      color: var(--text);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    .duration-preset.selected {
      border-color: var(--accent-pink);
      background: rgba(236, 72, 153, 0.15);
      box-shadow: 0 0 15px var(--glow-pink);
    }
    .duration-custom-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 12px;
    }
    .duration-custom-row input {
      width: 80px;
      padding: 10px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg-card);
      color: var(--text);
      font-size: 18px;
      font-weight: 600;
      text-align: center;
    }
    .duration-custom-row input:focus {
      outline: none;
      border-color: var(--accent-pink);
    }
    .duration-custom-row span {
      color: var(--text-muted);
      font-size: 14px;
    }
    #movementModal .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    body.day-mode .movement-type-btn,
    body.day-mode .duration-preset,
    body.day-mode .duration-custom-row input {
      background: rgba(255,255,255,0.5);
    }

    /* Reading Modal */
    .reading-field {
      margin-bottom: 20px;
    }
    .reading-field:last-child {
      margin-bottom: 0;
    }
    .reading-label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 10px;
    }
    .reading-input {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg-card);
      color: var(--text);
      font-size: 15px;
      font-family: 'Inter', -apple-system, sans-serif;
    }
    .reading-input:focus {
      outline: none;
      border-color: var(--accent-purple);
      box-shadow: 0 0 15px var(--glow-purple);
    }
    .reading-input::placeholder {
      color: var(--text-muted);
    }
    #readingModal .duration-preset.selected {
      border-color: var(--accent-purple);
      background: rgba(196, 113, 237, 0.15);
      box-shadow: 0 0 15px var(--glow-purple);
    }
    #readingModal .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    body.day-mode .reading-input {
      background: rgba(255,255,255,0.5);
    }

    .big-input { width: auto; flex: 1; min-width: 0; background: transparent; border: none; font-family: 'Space Grotesk', sans-serif; font-size: 32px; font-weight: 700; color: white; outline: none; transition: color 0.3s; }
    .big-input::placeholder { color: var(--text-muted); }
    .big-input:focus { color: var(--accent-teal); }
    
    /* Water */
    .water-row { display: flex; align-items: center; gap: 12px; justify-content: center; }
    .water-btn { 
      width: 44px; height: 44px; border-radius: 50%; 
      border: 2px solid var(--accent-teal); background: transparent; 
      color: var(--accent-teal); font-size: 18px; cursor: pointer; transition: all 0.3s; 
    }
    .water-btn:hover { 
      background: var(--accent-teal); 
      color: var(--bg-deep); 
      box-shadow: 0 0 20px var(--glow-teal);
    }
    .water-btn:active { transform: scale(0.9); }
    .water-num { font-family: 'Space Grotesk', sans-serif; font-size: 32px; font-weight: 700; min-width: 44px; text-align: center; color: white; }
    
    /* Sections */
    .section { 
      background: rgba(255,255,255,0.06); 
      border: 1px solid rgba(255,255,255,0.15); 
      border-radius: var(--radius); 
      padding: 18px; 
      margin-bottom: 12px; 
      backdrop-filter: blur(20px); 
      transition: all 0.3s;
    }
    .section:hover { border-color: rgba(255,255,255,0.2); }

    .reminder-card {
      background: rgba(249, 115, 22, 0.35);
      border: 1px solid rgba(249, 115, 22, 0.55);
      border-radius: var(--radius);
      padding: 18px;
      margin-bottom: 12px;
      text-align: center;
      backdrop-filter: blur(20px);
    }
    .reminder-card .reminder-icon { font-size: 28px; margin-bottom: 6px; }
    .reminder-card .reminder-title { font-size: 15px; font-weight: 600; color: var(--text); }
    .reminder-card .reminder-sub { font-size: 12px; color: var(--text-dim); margin-top: 4px; }
    .reminder-card .reminder-close { position: absolute; top: 8px; right: 12px; background: none; border: none; color: var(--text-dim); font-size: 16px; cursor: pointer; }
    .reminder-card { position: relative; }
    body.day-mode .reminder-card {
      background: rgba(99, 102, 241, 0.32);
      border-color: rgba(99, 102, 241, 0.55);
    }
    /* Biomarkers Page */
    .bio-category { margin-bottom: 14px; }
    .bio-cat-header { display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius) var(--radius) 0 0; cursor: pointer; }
    .bio-cat-header .bio-cat-icon { font-size: 16px; }
    .bio-cat-header .bio-cat-name { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-dim); flex: 1; }
    .bio-cat-header .bio-cat-toggle { font-size: 10px; color: var(--text-muted); transition: transform 0.3s; }
    .bio-cat-header.collapsed .bio-cat-toggle { transform: rotate(-90deg); }
    .bio-cat-body { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-top: none; border-radius: 0 0 var(--radius) var(--radius); overflow: hidden; }
    .bio-cat-body.collapsed { display: none; }

    .bio-card { padding: 14px; border-bottom: 1px solid rgba(255,255,255,0.06); }
    .bio-card:last-child { border-bottom: none; }
    .bio-card-top { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
    .bio-name { font-size: 14px; font-weight: 600; color: var(--accent-teal); flex: 1; cursor: pointer; }
    .bio-name:active { opacity: 0.7; }
    .bio-history-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.06); font-size: 13px; }
    .bio-history-row:last-child { border-bottom: none; }
    .bio-history-date { color: var(--text-muted); }
    .bio-history-val { font-weight: 600; }
    .bio-history-val.in-range { color: #52b788; }
    .bio-history-val.out-range { color: #d4a017; }
    body.day-mode .bio-history-row { border-bottom-color: rgba(0,0,0,0.06); }
    body.day-mode .bio-name { color: #6366f1; }
    .bio-info-btn { width: 22px; height: 22px; border-radius: 50%; border: 1px solid var(--text-muted); background: none; color: var(--text-muted); font-size: 11px; font-style: italic; font-family: Georgia, serif; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .bio-info-btn:hover, .bio-info-btn.active { border-color: var(--accent-teal); color: var(--accent-teal); }
    .bio-range-text { font-size: 11px; color: var(--text-muted); margin-bottom: 10px; }
    .bio-tooltip { display: none; padding: 8px 10px; margin-bottom: 8px; background: rgba(99,102,241,0.1); border-radius: var(--radius-sm); font-size: 12px; line-height: 1.5; color: var(--text-dim); }
    .bio-tooltip.show { display: block; }

    .bio-bar-wrap { position: relative; height: 14px; border-radius: 7px; overflow: visible; margin: 0 8px 4px; display: flex; }
    .bio-bar-low { background: #d4a017; border-radius: 7px 0 0 7px; height: 100%; }
    .bio-bar-normal { background: #52b788; height: 100%; }
    .bio-bar-high { background: #d4a017; border-radius: 0 7px 7px 0; height: 100%; flex: 1; }
    .bio-bar-labels { display: flex; justify-content: space-between; padding: 0 8px; margin-bottom: 8px; }
    .bio-bar-label { font-size: 10px; color: var(--text-muted); }

    .bio-bubble-wrap { position: absolute; top: -28px; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; pointer-events: none; }
    .bio-bubble { padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: 700; color: #fff; white-space: nowrap; }
    .bio-bubble-arrow { width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 5px solid; }
    .bio-bubble.in-range { background: #52b788; }
    .bio-bubble.in-range + .bio-bubble-arrow { border-top-color: #52b788; }
    .bio-bubble.out-range { background: #d4a017; }
    .bio-bubble.out-range + .bio-bubble-arrow { border-top-color: #d4a017; }
    .bio-bubble.no-result { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-muted); }
    .bio-bubble.no-result + .bio-bubble-arrow { border-top-color: var(--border); }

    .bio-input-row { display: flex; align-items: center; gap: 8px; margin-top: 6px; }
    .bio-input-label { font-size: 11px; color: var(--text-muted); }
    .bio-input { width: 80px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 6px 8px; color: var(--text); font-size: 13px; font-family: 'Space Grotesk', sans-serif; text-align: center; outline: none; flex-shrink: 0; }
    .bio-input:focus { border-color: var(--accent-teal); }

    body.day-mode .bio-cat-header { background: rgba(0,0,0,0.03); border-color: rgba(0,0,0,0.08); }
    body.day-mode .bio-cat-body { background: rgba(255,255,255,0.6); border-color: rgba(0,0,0,0.08); }
    body.day-mode .bio-card { border-bottom-color: rgba(0,0,0,0.06); }
    body.day-mode .bio-input { background: rgba(255,255,255,0.8); color: #1f2937; }
    body.day-mode .bio-tooltip { background: rgba(99,102,241,0.08); }

    .sec-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; cursor: pointer; }
    .sec-title { display: flex; align-items: center; gap: 10px; }
    .sec-icon { 
      width: 28px; height: 28px; border-radius: 50%; 
      display: flex; align-items: center; justify-content: center; font-size: 13px; 
      background: linear-gradient(135deg, var(--icon-start, var(--accent-purple)), var(--icon-end, var(--accent-pink)));
      box-shadow: 0 0 12px var(--icon-glow, var(--glow-purple));
    }
    .sec-name { font-size: 14px; font-weight: 600; color: #ffffff; }
    .sec-toggle { color: rgba(255,255,255,0.5); font-size: 11px; transition: transform 0.3s; }
    .sec-head.collapsed .sec-toggle { transform: rotate(-90deg); }
    .sec-content { transition: max-height 0.3s, opacity 0.3s; overflow: hidden; }
    .sec-content.collapsed { max-height: 0; opacity: 0; }
    
    /* Chips - Glowing when active */
    .chips { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip {
      display: flex; align-items: center; gap: 6px; padding: 8px 14px;
      background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: var(--radius-pill);
      cursor: pointer; transition: all 0.3s; user-select: none;
    }
    .chip:hover { background: rgba(255,255,255,0.1); }
    .chip:active { transform: scale(0.97); }
    .chip.on { 
      background: var(--success-soft); 
      border-color: var(--success); 
      box-shadow: 0 0 15px var(--glow-teal);
    }
    .chip-dot { 
      width: 18px; height: 18px; border-radius: 50%; 
      border: 2px solid var(--text-muted); 
      display: flex; align-items: center; justify-content: center; 
      font-size: 10px; transition: all 0.3s; 
    }
    .chip.on .chip-dot { 
      background: var(--success); 
      border-color: var(--success); 
      color: white; 
      box-shadow: 0 0 10px var(--glow-teal);
    }
    .chip-text { font-size: 13px; font-weight: 500; color: var(--text-dim); transition: color 0.3s; }
    .chip.on .chip-text { color: var(--text); }
    .chip input { display: none; }
    
    /* Inputs */
    .field { margin-bottom: 14px; }
    .field-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 6px; display: block; }
    .input { 
      width: 100%; padding: 14px; 
      background: rgba(255,255,255,0.05); 
      border: 1px solid var(--border); 
      border-radius: var(--radius-sm); 
      color: var(--text); font-size: 15px; outline: none; transition: all 0.3s; 
    }
    .input:focus { 
      border-color: var(--accent-teal); 
      box-shadow: 0 0 20px var(--glow-teal);
    }
    .input::placeholder { color: var(--text-muted); }
    textarea.input { min-height: 90px; resize: vertical; font-family: inherit; line-height: 1.5; }
    
    /* Buttons */
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 16px; border-radius: var(--radius-sm); font-size: 13px; font-weight: 600; cursor: pointer; border: none; transition: all 0.3s; }
    .btn-secondary { background: rgba(255,255,255,0.08); color: var(--text-dim); border: 1px solid var(--border); }
    .btn-secondary:hover { background: rgba(255,255,255,0.12); color: var(--text); }
    .btn-secondary.active { background: var(--accent-teal); color: #fff; border-color: var(--accent-teal); box-shadow: 0 0 10px var(--glow-teal); }
    body.day-mode .btn-secondary.active { background: #6366f1; color: #fff; border-color: #6366f1; box-shadow: 0 0 10px var(--glow-purple); }
    .btn-primary { 
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink)); 
      color: white; padding: 14px 24px; 
      box-shadow: 0 4px 20px var(--glow-purple);
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 30px var(--glow-pink); }
    
    /* Items */
    .items { margin-bottom: 12px; }
    .item { 
      display: flex; align-items: center; justify-content: space-between; 
      padding: 12px 14px; 
      background: var(--success-soft); 
      border: 1px solid var(--success); 
      border-radius: var(--radius-sm); 
      margin-bottom: 6px;
      box-shadow: 0 0 10px var(--glow-teal);
    }
    .item-text { font-size: 13px; color: var(--text); }
    .item-time { font-size: 11px; color: var(--text-muted); margin-left: 4px; }
    .item-del { background: none; border: none; color: var(--text-muted); font-size: 16px; cursor: pointer; }
    .item-del:hover { color: var(--accent-pink); }
    body.day-mode .item {
      background: rgba(5, 150, 105, 0.15);
      border-color: var(--success);
      box-shadow: 0 0 8px rgba(5, 150, 105, 0.3);
    }
    
    /* REHIT Calendar */
    .rehit-calendar {
      user-select: none;
    }
    .rehit-cal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    .rehit-cal-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
    }
    .rehit-cal-nav {
      display: flex;
      gap: 8px;
    }
    .rehit-cal-nav button {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-muted);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .rehit-cal-nav button:hover {
      border-color: var(--accent-pink);
      color: var(--accent-pink);
    }
    .rehit-cal-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 8px;
    }
    .rehit-cal-weekday {
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      padding: 4px;
    }
    .rehit-cal-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    .rehit-cal-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-muted);
      border-radius: 50%;
      transition: all 0.2s;
    }
    .rehit-cal-day.other-month {
      color: var(--text-muted);
      opacity: 0.3;
    }
    .rehit-cal-day.today {
      background: var(--accent-orange);
      color: white;
      font-weight: 700;
    }
    .rehit-cal-day.has-rehit {
      border: 2px solid var(--accent-pink);
      color: var(--text);
    }
    .rehit-cal-day.has-rehit.rehit-2x10 {
      border-color: var(--accent-teal);
      box-shadow: 0 0 8px var(--glow-teal);
    }
    .rehit-cal-day.has-rehit.rehit-3x10 {
      border-color: var(--accent-pink);
      background: rgba(255, 107, 157, 0.2);
      box-shadow: 0 0 8px var(--glow-pink);
    }
    .rehit-cal-legend {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      justify-content: center;
    }
    .rehit-cal-legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }
    .rehit-cal-legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid;
    }
    .rehit-cal-legend-dot.dot-2x10 {
      border-color: var(--accent-teal);
    }
    .rehit-cal-legend-dot.dot-3x10 {
      border-color: var(--accent-pink);
      background: rgba(255, 107, 157, 0.2);
    }
    body.day-mode .rehit-cal-day {
      color: #6b7280;
    }
    body.day-mode .rehit-cal-day.has-rehit {
      color: #1f2937;
    }
    body.day-mode .rehit-cal-day.today {
      color: white;
    }
    
    /* Summary Page Styles */
    .summary-overview {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .summary-stat {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 16px;
      text-align: center;
    }
    .summary-stat.full-width {
      grid-column: 1 / -1;
    }
    .summary-stat-value {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 32px;
      font-weight: 700;
      background: linear-gradient(90deg, var(--accent-teal), var(--accent-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .summary-stat-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    .summary-stat-sub {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }
    .goal-stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .goal-stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px;
    }
    .goal-stat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .goal-stat-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }
    .goal-stat-pct {
      font-size: 12px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 10px;
    }
    .goal-stat-pct.good {
      background: rgba(109, 213, 237, 0.2);
      color: var(--accent-teal);
    }
    .goal-stat-pct.ok {
      background: rgba(255, 165, 82, 0.2);
      color: var(--accent-orange);
    }
    .goal-stat-pct.needs-work {
      background: rgba(255, 107, 157, 0.2);
      color: var(--accent-pink);
    }
    .goal-stat-bar {
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      overflow: hidden;
    }
    .goal-stat-bar-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.3s;
    }
    .goal-stat-detail {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
    }
    .goal-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      margin: 4px;
    }
    .goal-badge-icon {
      font-size: 18px;
    }
    .goal-badge-text {
      font-size: 13px;
      color: var(--text);
    }
    .goal-badge-pct {
      font-size: 12px;
      font-weight: 600;
      color: var(--accent-teal);
    }
    body.day-mode .summary-stat {
      background: rgba(255,255,255,0.8);
    }
    body.day-mode .goal-stat-card {
      background: rgba(255,255,255,0.8);
    }
    body.day-mode .goal-stat-bar {
      background: rgba(0,0,0,0.1);
    }
    body.day-mode .goal-badge {
      background: rgba(255,255,255,0.8);
    }
    
    /* Body Grid */
    .body-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .body-cell { background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px; }
    .body-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 4px; }
    .body-input { width: 100%; background: transparent; border: none; font-family: 'Space Grotesk', sans-serif; font-size: 18px; font-weight: 600; color: var(--text); outline: none; transition: color 0.3s; }
    .body-input:focus { color: var(--accent-teal); }
    .body-pct { font-family: 'Space Grotesk', sans-serif; font-size: 18px; font-weight: 600; color: var(--accent-teal); }
    
    /* FAB - Glowing */
    .fab { 
      position: fixed; bottom: 24px; right: 24px; 
      width: 60px; height: 60px; border-radius: 50%; 
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink)); 
      border: none; color: white; font-size: 24px; cursor: pointer; 
      box-shadow: 0 8px 30px var(--glow-purple);
      z-index: 100; transition: all 0.3s; 
      animation: fab-pulse 2s ease-in-out infinite;
    }
    @keyframes fab-pulse {
      0%, 100% { box-shadow: 0 8px 30px var(--glow-purple); }
      50% { box-shadow: 0 8px 40px var(--glow-pink), 0 0 60px var(--glow-purple); }
    }
    .fab:hover { transform: scale(1.1); }
    .fab:active { transform: scale(0.95); }
    .fab.open { transform: rotate(45deg); background: var(--bg-card); animation: none; }
    
    .fab-menu { position: fixed; bottom: 100px; right: 24px; display: flex; flex-direction: column; gap: 10px; opacity: 0; transform: translateY(20px); pointer-events: none; transition: all 0.3s; z-index: 99; }
    .fab-menu.open { opacity: 1; transform: translateY(0); pointer-events: auto; }
    .fab-item { 
      display: flex; align-items: center; gap: 10px; padding: 10px 16px; 
      background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-pill); 
      backdrop-filter: blur(20px); cursor: pointer; transition: all 0.3s; white-space: nowrap; 
    }
    .fab-item:hover { background: var(--bg-card-hover); transform: translateX(-8px); box-shadow: 0 0 20px var(--glow-purple); }
    .fab-icon { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .fab-label { font-size: 14px; font-weight: 600; color: var(--text); }
    
    /* Sticky */
    .sticky { position: fixed; top: 0; left: 0; right: 0; background: rgba(26,26,46,0.95); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); padding: 10px 16px; padding-top: max(60px, calc(14px + env(safe-area-inset-top, 44px))); display: flex; justify-content: space-between; align-items: center; z-index: 1000; transform: translateY(-100%); transition: transform 0.3s; }
    body.day-mode .sticky { background: rgba(255,255,255,0.92); border-bottom-color: #e5e7eb; }
    body.day-mode .sticky-date { color: #6b7280; }
    .sticky.visible { transform: translateY(0); }
    .sticky-date { font-size: 14px; font-weight: 600; }
    .sticky-btns { display: flex; gap: 8px; }
    .sticky-btns button { width: 32px; height: 32px; border-radius: 50%; border: none; background: var(--bg-card); color: var(--text-dim); font-size: 13px; cursor: pointer; }
    
    /* Milestone - Aurora themed */
    .milestone { position: fixed; inset: 0; background: rgba(26,26,46,0.95); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(10px); }
    .milestone.show { opacity: 1; pointer-events: auto; }
    .milestone-box { text-align: center; animation: pop 0.5s cubic-bezier(0.34,1.56,0.64,1); }
    @keyframes pop { 0%{transform:scale(0.5);opacity:0} 100%{transform:scale(1);opacity:1} }
    .milestone-emoji { font-size: 72px; animation: float 2s ease-in-out infinite; }
    @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-15px)} }
    .milestone-title { font-family: 'Space Grotesk', sans-serif; font-size: 26px; font-weight: 700; margin-top: 16px; background: linear-gradient(90deg, var(--accent-teal), var(--accent-purple), var(--accent-pink)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .milestone-sub { font-size: 15px; color: var(--text-dim); margin-top: 8px; }
    .milestone-btn { margin-top: 28px; padding: 14px 32px; background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink)); border: none; border-radius: var(--radius-pill); font-size: 16px; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 8px 30px var(--glow-purple); }
    
    /* Modal */
    .modal { position: fixed; inset: 0; background: rgba(26,26,46,0.9); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(10px); padding: 16px; }
    .modal.show { opacity: 1; pointer-events: auto; }
    .modal-content { background: var(--bg-mid); border: 1px solid var(--border); border-radius: var(--radius); width: 100%; max-width: 360px; animation: pop 0.3s cubic-bezier(0.34,1.56,0.64,1); overflow: hidden; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 18px; border-bottom: 1px solid var(--border); }
    .modal-close { width: 34px; height: 34px; border-radius: 50%; border: none; background: rgba(255,255,255,0.1); color: var(--text-muted); font-size: 16px; cursor: pointer; transition: all 0.3s; }
    .modal-close:hover { background: rgba(255,255,255,0.15); color: var(--text); }
    .modal-body { padding: 18px; }
    .modal-footer { padding: 18px; border-top: 1px solid var(--border); }

    .weekly-review-intro { font-size: 16px; font-weight: 600; color: var(--accent-teal); text-align: center; margin-bottom: 16px; }
    .weekly-review-section { margin-bottom: 14px; }
    .weekly-review-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 8px; }
    .weekly-review-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.06); font-size: 14px; font-weight: 500; }
    .weekly-review-row:last-child { border-bottom: none; }
    .weekly-review-input-wrap { display: flex; align-items: center; gap: 6px; }
    .weekly-review-unit { font-size: 11px; color: var(--text-muted); min-width: 65px; }
    .weekly-review-input-wrap .goal-input { width: 70px; }
    body.day-mode .weekly-review-row { border-bottom-color: rgba(0,0,0,0.06); }
    
    /* Responsive */
    @media (max-width: 430px) {
      body { padding: 12px; padding-top: max(66px, calc(12px + env(safe-area-inset-top, 54px))); padding-bottom: calc(120px + env(safe-area-inset-bottom, 0px)); }
      .quick-grid { gap: 10px; }
      .card { padding: 14px; }
      .card-value { font-size: 28px; }
      .big-input { font-size: 28px; }
    }
    @media (min-width: 768px) { body { max-width: 540px; margin: 0 auto; } }
    
    /* Settings Page Styles */
    .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }
    .setting-row:last-child { border-bottom: none; }
    .setting-label { flex: 1; }
    .setting-title { display: block; font-size: 14px; font-weight: 600; color: var(--text); }
    .setting-desc { display: block; font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    
    .time-input {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 8px 12px;
      color: var(--text);
      font-size: 14px;
      font-family: 'Space Grotesk', sans-serif;
      outline: none;
    }
    .time-input:focus { border-color: var(--accent-teal); }
    
    .goal-input {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 8px 12px;
      color: var(--text);
      font-size: 14px;
      font-family: 'Space Grotesk', sans-serif;
      outline: none;
      width: 80px;
      text-align: center;
    }
    .goal-input:focus { border-color: var(--accent-teal); }
    body.day-mode .goal-input {
      background: rgba(255,255,255,0.8);
      color: #1f2937;
    }
    
    .theme-preview { display: flex; gap: 8px; }
    .theme-btn {
      width: 40px; height: 40px;
      border-radius: 50%;
      border: 2px solid var(--border);
      background: var(--bg-card);
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .theme-btn:hover { border-color: var(--accent-teal); transform: scale(1.1); }
    .theme-btn.active { border-color: var(--accent-teal); box-shadow: 0 0 15px var(--glow-teal); }
    
    /* Section List for Drag & Drop */
    .section-list { }
    .section-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
      cursor: grab;
      transition: all 0.2s;
    }
    .section-item:active { cursor: grabbing; }
    .section-item.dragging {
      opacity: 0.5;
      transform: scale(1.02);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    .section-item.drag-over {
      border-color: var(--accent-teal);
      background: var(--success-soft);
    }
    .section-item-drag {
      color: var(--text-muted);
      font-size: 16px;
      cursor: grab;
    }
    .section-item-icon { font-size: 18px; }
    .section-item-name { flex: 1; font-size: 14px; font-weight: 500; }
    .section-item-toggle {
      position: relative;
      width: 44px;
      height: 24px;
      background: var(--bg-deep);
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .section-item-toggle.on { background: var(--success); }
    .section-item-toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
    }
    .section-item-toggle.on::after { transform: translateX(20px); }
    .section-item-delete {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 16px;
      cursor: pointer;
      padding: 4px;
      opacity: 0.5;
      transition: all 0.2s;
    }
    .section-item-delete:hover { color: var(--accent-pink); opacity: 1; }
  </style>
</head>
<body>
  <!-- Loading Overlay - starts hidden, shown by JS when loading -->
  <div class="loading-overlay hidden" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">Loading...</div>
  </div>
  
  <!-- Debug Error Display -->
  <div id="debugError" style="display:none; position:fixed; bottom:120px; left:16px; right:16px; background:rgba(255,0,0,0.9); color:white; padding:12px; border-radius:8px; font-size:12px; z-index:9999; max-height:200px; overflow:auto;"></div>
  
  <script>
    window.onerror = function(msg, url, line, col, error) {
      const el = document.getElementById('debugError');
      if (el) {
        el.style.display = 'block';
        el.innerHTML += '<b>Error:</b> ' + msg + '<br><small>at line ' + line + '</small><br>';
      }
      return false;
    };
    window.addEventListener('unhandledrejection', function(e) {
      const el = document.getElementById('debugError');
      if (el) {
        el.style.display = 'block';
        el.innerHTML += '<b>Promise Error:</b> ' + (e.reason?.message || e.reason) + '<br>';
      }
    });
  </script>
  
  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <span class="toast-icon"></span>
    <span class="toast-text">Saved</span>
  </div>
  
  <!-- Pull to Refresh Indicator -->
  <div class="pull-indicator" id="pullIndicator">
    <div class="pull-spinner"></div>
    <span>Refreshing...</span>
  </div>

  <div class="theme-indicator" id="themeIndicator"> Day Mode</div>
  
  <svg width="0" height="0" style="position:absolute">
    <defs>
      <linearGradient id="auroraGrad" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" style="stop-color:#c471ed"/>
        <stop offset="50%" style="stop-color:#ff6b9d"/>
        <stop offset="100%" style="stop-color:#6dd5ed"/>
      </linearGradient>
    </defs>
  </svg>

  <div id="stickyDateBar" class="sticky">
    <div class="sticky-date" id="stickyDateDisplay">Today</div>
    <div class="sticky-btns"><button id="stickyPrevBtn"></button><button id="stickyNextBtn"></button></div>
  </div>

  <div id="milestoneOverlay" class="milestone">
    <div class="milestone-box">
      <div class="milestone-emoji" id="milestoneEmoji"></div>
      <div class="milestone-title" id="milestoneTitle">Amazing!</div>
      <div class="milestone-sub" id="milestoneSubtitle">You did something great!</div>
      <button class="milestone-btn" onclick="closeMilestone()">Continue</button>
    </div>
  </div>

  <!-- REHIT Modal -->
  <div id="rehitModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent-pink),var(--accent-orange));display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 0 15px var(--glow-pink)"></div>
          <div>
            <div style="font-family:'Space Grotesk', sans-serif;font-size:18px;font-weight:700">REHIT Stats</div>
            <div style="font-size:12px;color:var(--text-muted)">Enter your workout data</div>
          </div>
        </div>
        <button class="modal-close" onclick="closeRehitModal()"></button>
      </div>
      <div class="modal-body">
        <div class="body-grid">
          <div class="body-cell"><div class="body-label">Fitness Score</div><input type="number" inputmode="decimal" class="body-input" id="fitnessScore" step="0.1" placeholder="0.0"></div>
          <div class="body-cell"><div class="body-label">Calories</div><input type="number" inputmode="numeric" class="body-input" id="calories" placeholder="0"></div>
          <div class="body-cell"><div class="body-label">Peak Watts</div><input type="number" inputmode="numeric" class="body-input" id="peakWatts" placeholder="0"></div>
          <div class="body-cell"><div class="body-label">Watt Seconds</div><input type="number" inputmode="numeric" class="body-input" id="wattSeconds" placeholder="0"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="saveRehitAndClose()" style="width:100%">Save Stats</button>
      </div>
    </div>
  </div>

  <!-- Weekly Goals Review Modal (Sunday) -->
  <div id="weeklyReviewModal" class="modal">
    <div class="modal-content" style="max-width:380px">
      <div class="modal-header">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent-teal),var(--accent-purple));display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 0 15px var(--glow-teal)"></div>
          <div>
            <div style="font-family:'Space Grotesk', sans-serif;font-size:18px;font-weight:700">Weekly Goals</div>
            <div style="font-size:12px;color:var(--text-muted)">Set your intentions for the week</div>
          </div>
        </div>
        <button class="modal-close" onclick="closeWeeklyReview()"></button>
      </div>
      <div class="modal-body">
        <div class="weekly-review-intro">This week I will...</div>
        <div class="weekly-review-section">
          <div class="weekly-review-label">Daily Goals</div>
          <div class="weekly-review-row"><span> Sleep</span><div class="weekly-review-input-wrap"><input type="number" class="goal-input" id="wr-sleep" value="7" min="4" max="12" step="0.5"><span class="weekly-review-unit">hrs/night</span></div></div>
          <div class="weekly-review-row"><span> Water</span><div class="weekly-review-input-wrap"><input type="number" class="goal-input" id="wr-agua" value="6" min="1" max="20"><span class="weekly-review-unit">glasses/day</span></div></div>
          <div class="weekly-review-row"><span> Steps</span><div class="weekly-review-input-wrap"><input type="number" class="goal-input" id="wr-steps" value="7500" min="1000" max="50000" step="500"><span class="weekly-review-unit">steps/day</span></div></div>
          <div class="weekly-review-row"><span> Movement</span><div class="weekly-review-input-wrap"><input type="number" class="goal-input" id="wr-movement" value="2" min="1" max="10"><span class="weekly-review-unit">breaks/day</span></div></div>
        </div>
        <div class="weekly-review-section">
          <div class="weekly-review-label">Weekly Goals</div>
          <div class="weekly-review-row"><span> REHIT</span><div class="weekly-review-input-wrap"><input type="number" class="goal-input" id="wr-rehit" value="4" min="1" max="7"><span class="weekly-review-unit">sessions</span></div></div>
          <div class="weekly-review-row"><span> Reading</span><div class="weekly-review-input-wrap"><input type="number" class="goal-input" id="wr-reading" value="60" min="5" max="500" step="5"><span class="weekly-review-unit">min</span></div></div>
          <div class="weekly-review-row"><span> Meditation</span><div class="weekly-review-input-wrap"><input type="number" class="goal-input" id="wr-meditation" value="60" min="5" max="500" step="5"><span class="weekly-review-unit">min</span></div></div>
        </div>
      </div>
      <div class="modal-footer" style="display:flex;gap:10px">
        <button class="btn btn-secondary" onclick="closeWeeklyReview()" style="flex:1">Keep Current</button>
        <button class="btn btn-primary" onclick="saveWeeklyReview()" style="flex:2">Lock In My Goals</button>
      </div>
    </div>
  </div>

  <header class="header">
    <div class="header-top">
      <div class="brand">
        <div>
          <h1>Habits <span class="version">v6.24</span></h1>
          <div class="tagline">Phase 1</div>
          <div class="phase-day" id="phaseDayCount">Day -- of 21</div>
        </div>
      </div>
      <div class="nav-links">
        <a href="#" id="homeBtn" class="nav-link" title="Home"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M3 12L12 4L21 12" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 10V19C5 19.5523 5.44772 20 6 20H9V15C9 14.4477 9.44772 14 10 14H14C14.5523 14 15 14.4477 15 15V20H18C18.5523 20 19 19.5523 19 19V10" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg></a>
        <a href="#" id="weeklySummaryLink" class="nav-link" title="Summary"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"><circle cx="8" cy="9" r="1" fill="currentColor"/><path d="M10.5 9H17.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><circle cx="8" cy="12" r="1" fill="currentColor"/><path d="M10.5 12H16" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><circle cx="8" cy="15" r="1" fill="currentColor"/><path d="M10.5 15H17.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg></a>
        <a href="#" id="chartsBtn" class="nav-link" title="Charts"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M6.5 17.5V7.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M6.5 17.5H17.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M8.5 14.5L11.2 11.8L13.6 13.4L17.3 9.7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/><circle cx="8.5" cy="14.5" r="0.9" fill="currentColor"/><circle cx="11.2" cy="11.8" r="0.9" fill="currentColor"/><circle cx="13.6" cy="13.4" r="0.9" fill="currentColor"/><circle cx="17.3" cy="9.7" r="0.9" fill="currentColor"/></svg></a>
        <a href="#" id="biomarkersBtn" class="nav-link" title="Biomarkers"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M9 7H17" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M10 7V15.2C10 16.9 11.3 18.2 13 18.2C14.7 18.2 16 16.9 16 15.2V7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/><path d="M10.8 13.2H15.2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg></a>
        <a href="#" id="settingsBtn" class="nav-link" title="Settings"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="2.4" stroke="currentColor" stroke-width="1.8"/><path d="M12 6.8V8.6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M12 15.4V17.2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M6.8 12H8.6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M15.4 12H17.2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M8.4 8.4L9.7 9.7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M14.3 14.3L15.6 15.6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M15.6 8.4L14.3 9.7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M9.7 14.3L8.4 15.6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg></a>
      </div>
    </div>
    <div class="date-nav">
      <button class="date-btn" id="prevBtn"></button>
      <div class="date-center">
        <div class="date-main" id="dateDisplay"></div>
      </div>
      <button class="date-btn" id="nextBtn"></button>
      <div class="ring-wrap">
        <svg class="ring" width="72" height="72" viewBox="0 0 72 72">
          <circle class="ring-bg" cx="36" cy="36" r="32"/>
          <circle class="ring-progress" id="completionProgress" cx="36" cy="36" r="32" stroke-dasharray="201" stroke-dashoffset="201"/>
        </svg>
        <div class="ring-text" id="completionNumber">0</div>
      </div>
      <div class="phase" style="grid-column: 1 / -1;">
        <div class="phase-track"><div class="phase-fill" id="phaseProgressBar" style="width:0%"></div></div>
      </div>
    </div>
  </header>

  <form id="healthForm">
    <div class="quick-grid">
      <div class="card sleep" id="sleepSection">
        <div class="card-head"><div class="card-icon"></div><div class="card-title">Sleep</div></div>
        <div class="input-row"><input type="number" inputmode="decimal" class="big-input" id="sleepHours" step="0.1" placeholder="0"><span class="card-unit">hrs</span></div>
        <div class="card-avg">7-day avg: <span id="avgSleep">--</span></div>
      </div>
      <script>
        window.handleAguaPlus = function() {
          var el = document.getElementById('aguaCount');
          if (!el) return;
          var n = (parseInt(el.textContent) || 0) + 1;
          el.textContent = n;
          if (typeof aguaCount !== 'undefined') aguaCount = n;
          if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
        };
        window.handleAguaMinus = function() {
          var el = document.getElementById('aguaCount');
          if (!el) return;
          var n = Math.max(0, (parseInt(el.textContent) || 0) - 1);
          el.textContent = n;
          if (typeof aguaCount !== 'undefined') aguaCount = n;
          if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
        };
      </script>
      <div class="card water" id="waterSection">
        <div class="card-head"><div class="card-icon"></div><div class="card-title">Water</div></div>
        <div class="water-row">
          <button type="button" class="water-btn" onclick="window.handleAguaMinus()"></button>
          <div class="water-num" id="aguaCount">0</div>
          <button type="button" class="water-btn" onclick="window.handleAguaPlus()">+</button>
        </div>
        <div class="progress-bar-h">
          <div class="progress-bar-h-fill" id="aguaBarFill"></div>
        </div>
      </div>
      <div class="card supplements">
        <div class="card-head"><div class="card-icon"></div><div class="card-title">Supps</div></div>
        <div class="mini-supps-grid">
          <div class="mini-supp" title="Creatine"><input type="checkbox" id="creatine"><span>Creatine</span></div>
          <div class="mini-supp" title="Vitamin D"><input type="checkbox" id="vitaminD"><span>Vit D</span></div>
          <div class="mini-supp" title="NO2"><input type="checkbox" id="no2"><span>NO2</span></div>
          <div class="mini-supp" title="Psyllium"><input type="checkbox" id="psyllium"><span>Psyllium</span></div>
        </div>
      </div>
      <div class="card movement">
        <div class="card-head"><div class="card-icon"></div><div class="card-title">Steps</div></div>
        <div class="input-row"><input type="number" inputmode="numeric" class="big-input" id="steps" placeholder="0"><span class="card-unit">steps</span></div>
        <div class="progress-bar-h">
          <div class="progress-bar-h-fill" id="stepsBarFill"></div>
        </div>
        <div class="card-avg">7-day avg: <span id="avgSteps">--</span></div>
      </div>
    </div>
    
    <div class="card movement rehit-full" id="rehitCard">
      <div class="card-head" style="margin-bottom:0">
        <div class="card-icon"></div>
        <div class="card-title">REHIT</div>
      </div>
      <div class="rehit-dots-row" id="rehitDots">
        <div class="rehit-dot"></div>
        <div class="rehit-dot"></div>
        <div class="rehit-dot"></div>
        <div class="rehit-dot"></div>
      </div>
      <div class="rehit-layout">
        <div class="rehit-left">
          <div class="chips rehit-chips">
            <div class="chip rehit-chip" id="rehit2Chip"><input type="checkbox" id="rehit2"><div class="chip-dot"></div><span class="chip-text">210</span></div>
            <div class="chip rehit-chip" id="rehit3Chip"><input type="checkbox" id="rehit3"><div class="chip-dot"></div><span class="chip-text">310</span></div>
          </div>
          <div class="card-avg rehit-week-count" style="display:none">This week: <span id="rehitWeek">--</span></div>
        </div>
        <div class="rehit-right">
          <div class="rehit-stats-grid">
            <div class="rehit-stat"><span class="rehit-stat-label">Score</span><span id="rehitScoreDisplay" class="rehit-stat-value" style="color:var(--accent-teal)">--</span></div>
            <div class="rehit-stat"><span class="rehit-stat-label">Cals</span><span id="rehitCalsDisplay" class="rehit-stat-value" style="color:var(--accent-orange)">--</span></div>
            <div class="rehit-stat"><span class="rehit-stat-label">Watts</span><span id="rehitWattsDisplay" class="rehit-stat-value" style="color:var(--accent-pink)">--</span></div>
            <div class="rehit-stat"><span class="rehit-stat-label">W-Sec</span><span id="rehitWsDisplay" class="rehit-stat-value" style="color:var(--accent-purple)">--</span></div>
          </div>
          <button type="button" class="rehit-edit-btn" id="editRehitBtn"><span class="chip-dot">+</span><span class="chip-text">Edit</span></button>
        </div>
      </div>
    </div>

    <div class="section" id="greysHabitsSection">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:#ffa552;--icon-end:#ffd93d;--icon-glow:var(--glow-orange)"></div><span class="sec-name">Grey's Habits</span></div><span class="sec-toggle"></span></div>
      <div class="sec-content">
        <div class="mini-supps-grid three-col">
          <div class="mini-supp" title="Inhaler Morning"><input type="checkbox" id="inhalerMorning"><span>Inhaler AM</span></div>
          <div class="mini-supp" title="Inhaler Evening"><input type="checkbox" id="inhalerEvening"><span>Inhaler PM</span></div>
          <div class="mini-supp" title="Math"><input type="checkbox" id="multiplication"><span>Math</span></div>
        </div>
      </div>
    </div>

    <div class="section" id="mealsSection">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:#ffa552;--icon-end:#ff6b9d;--icon-glow:var(--glow-orange)"></div><span class="sec-name">Meals</span></div><span class="sec-toggle"></span></div>
      <div class="sec-content">
        <div class="mini-supps-grid three-col" style="margin-bottom:10px">
          <div class="mini-supp"><input type="checkbox" id="breakfast"><span>Breakfast</span></div>
          <div class="mini-supp"><input type="checkbox" id="lunch"><span>Lunch</span></div>
          <div class="mini-supp"><input type="checkbox" id="dinner"><span>Dinner</span></div>
        </div>
        <div class="mini-supps-grid three-col">
          <div class="mini-supp"><input type="checkbox" id="daySnacks"><span>Day Snacks</span></div>
          <div class="mini-supp"><input type="checkbox" id="nightSnacks"><span>Night Snacks</span></div>
          <div class="mini-supp"><input type="checkbox" id="noAlcohol"><span>No Alcohol</span></div>
        </div>
      </div>
    </div>

    <div class="section" id="movementSection">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:#ff6b9d;--icon-end:#c471ed;--icon-glow:var(--glow-pink)"></div><span class="sec-name">Movement Breaks</span></div><span class="sec-toggle"></span></div>
      <div class="sec-content">
        <div id="movementList" class="items"></div>
        <button type="button" class="btn btn-secondary" id="addMovementBtn">+ Add Movement</button>
        <div class="card-avg" style="margin-top:10px">Daily avg: <span id="avgMovements">--</span></div>
      </div>
    </div>

    <div class="section" id="mentalHabitsSection">
      <div class="sec-head collapsed"><div class="sec-title"><div class="sec-icon" style="--icon-start:#c471ed;--icon-end:#6dd5ed;--icon-glow:var(--glow-purple)"></div><span class="sec-name">Reading</span></div><span class="sec-toggle"></span></div>
      <div class="sec-content collapsed">
        <div id="readingList" class="items"></div>
        <button type="button" class="btn btn-secondary" id="addReadingBtn">+ Add Reading</button>
      </div>
    </div>

    <div class="section" id="meditationSection">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:#ffd93d;--icon-end:#ffa552;--icon-glow:var(--glow-orange)"></div><span class="sec-name">Mindfulness</span></div><span class="sec-toggle"></span></div>
      <div class="sec-content">
        <div class="mini-supps-grid" style="grid-template-columns: 1fr;">
          <div class="mini-supp"><input type="checkbox" id="meditation"><span>Meditated</span></div>
        </div>
      </div>
    </div>

    <div class="section" id="reflectionsSection">
      <div class="sec-head collapsed"><div class="sec-title"><div class="sec-icon" style="--icon-start:#c471ed;--icon-end:#ff6b9d;--icon-glow:var(--glow-purple)"></div><span class="sec-name">Reflections</span></div><span class="sec-toggle"></span></div>
      <div class="sec-content collapsed"><textarea class="input" id="reflections" placeholder="What's on your mind?"></textarea></div>
    </div>

    <div class="section" id="storiesSection">
      <div class="sec-head collapsed"><div class="sec-title"><div class="sec-icon" style="--icon-start:#ff6b9d;--icon-end:#ffa552;--icon-glow:var(--glow-pink)"></div><span class="sec-name">Grey & Sloane</span></div><span class="sec-toggle"></span></div>
      <div class="sec-content collapsed"><textarea class="input" id="stories" placeholder="Capture their moments..."></textarea></div>
    </div>

    <div class="section" id="carlySection">
      <div class="sec-head collapsed"><div class="sec-title"><div class="sec-icon" style="--icon-start:#ffd93d;--icon-end:#ff6b9d;--icon-glow:var(--glow-orange)"></div><span class="sec-name">Carly</span></div><span class="sec-toggle"></span></div>
      <div class="sec-content collapsed"><textarea class="input" id="carly" placeholder="Notes..."></textarea></div>
    </div>

    <div class="section" id="bodyDataSection">
      <div class="sec-head collapsed"><div class="sec-title"><div class="sec-icon" style="--icon-start:#6dd5ed;--icon-end:#c471ed;--icon-glow:var(--glow-teal)"></div><span class="sec-name">Body</span></div><span class="sec-toggle"></span></div>
      <div class="sec-content collapsed">
        <div class="body-grid">
          <div class="body-cell"><div class="body-label">Weight</div><input type="number" inputmode="decimal" class="body-input" id="weight" step="0.1"></div>
          <div class="body-cell"><div class="body-label">Waist</div><input type="number" inputmode="decimal" class="body-input" id="waist" step="0.1"></div>
          <div class="body-cell"><div class="body-label">Lean Mass</div><input type="number" inputmode="decimal" class="body-input" id="leanMass" step="0.1"></div>
          <div class="body-cell"><div class="body-label">Lean %</div><div class="body-pct" id="leanMassPercent">--</div></div>
          <div class="body-cell"><div class="body-label">Body Fat</div><input type="number" inputmode="decimal" class="body-input" id="bodyFat" step="0.1"></div>
          <div class="body-cell"><div class="body-label">Fat %</div><div class="body-pct" id="bodyFatPercent">--</div></div>
          <div class="body-cell"><div class="body-label">Bone Mass</div><input type="number" inputmode="decimal" class="body-input" id="boneMass" step="0.1"></div>
          <div class="body-cell"><div class="body-label">Bone %</div><div class="body-pct" id="boneMassPercent">--</div></div>
          <div class="body-cell"><div class="body-label">Water (lbs)</div><input type="number" inputmode="decimal" class="body-input" id="bodywater" step="0.1"></div>
          <div class="body-cell"><div class="body-label">Water %</div><div class="body-pct" id="bodywaterPercent">--</div></div>
        </div>
      </div>
    </div>

    <div class="section" id="bloodPressureSection">
      <div class="sec-head collapsed"><div class="sec-title"><div class="sec-icon" style="--icon-start:#ff6b9d;--icon-end:#c471ed;--icon-glow:var(--glow-pink)"></div><span class="sec-name">Blood Pressure</span></div><span class="sec-toggle"></span></div>
      <div class="sec-content collapsed">
        <div class="body-grid">
          <div class="body-cell"><div class="body-label">Systolic</div><input type="number" inputmode="numeric" class="body-input" id="systolic"></div>
          <div class="body-cell"><div class="body-label">Diastolic</div><input type="number" inputmode="numeric" class="body-input" id="diastolic"></div>
          <div class="body-cell"><div class="body-label">Heart Rate</div><input type="number" inputmode="numeric" class="body-input" id="heartRate"></div>
          <div class="body-cell"><div class="body-label">Status</div><div class="body-pct" id="bpStatus">--</div></div>
        </div>
      </div>
    </div>
  </form>

  <div id="chartsPage" style="display:none">
    <header class="header">
      <div class="header-top">
        <div class="brand"><div class="logo"></div><div><h1>Charts</h1></div></div>
        <button type="button" id="chartsCloseBtn" class="nav-link"></button>
      </div>
      <div style="display:flex;gap:8px;margin-top:16px">
        <button type="button" class="range-btn btn btn-secondary active" data-range="7">7 Days</button>
        <button type="button" class="range-btn btn btn-secondary" data-range="30">30 Days</button>
        <button type="button" class="range-btn btn btn-secondary" data-range="all">All</button>
      </div>
    </header>
    <div class="section"><div class="sec-name">Weight and Waist</div><canvas id="weightChart" style="max-height:220px"></canvas></div>
    <div class="section"><div class="sec-name">Sleep</div><canvas id="sleepChart" style="max-height:220px"></canvas></div>
    <div class="section"><div class="sec-name">Steps</div><canvas id="stepsChart" style="max-height:220px"></canvas></div>
    <div class="section"><div class="sec-name">REHIT Calendar</div><div id="rehitCalendar" class="rehit-calendar"></div></div>
    <div class="section"><div class="sec-name">Peak Watts</div><canvas id="peakWattsChart" style="max-height:220px"></canvas></div>
    <div class="section"><div class="sec-name">Lean Mass %</div><canvas id="bodyCompChart" style="max-height:220px"></canvas></div>
    <div class="section"><div class="sec-name">Blood Pressure and Pulse</div><canvas id="bpChart" style="max-height:220px"></canvas></div>
  </div>

  <div id="biomarkersPage" style="display:none">
    <header class="header">
      <div class="header-top">
        <div class="brand"><div class="logo"></div><div><h1>Biomarkers</h1><div class="tagline" id="biomarkersSubtitle">Most recent: --</div></div></div>
        <button type="button" id="biomarkersCloseBtn" class="nav-link"></button>
      </div>
    </header>
    <div class="section">
      <div class="field"><label class="field-label">Lab Date</label><input type="text" class="input" id="biomarkersDate" placeholder="M/D/YY"></div>
    </div>
    <div id="biomarkersTable"></div>
    <div class="section" style="margin-top:4px">
      <button type="button" class="btn btn-primary" id="biomarkersSubmitBtn" style="width:100%">Submit</button>
      <div id="biomarkersSaveStatus" style="text-align:center;margin-top:8px;color:var(--accent-teal)"></div>
    </div>
  </div>

  <!-- Biomarker History Chart Modal -->
  <div id="bioHistoryModal" class="modal">
    <div class="modal-content" style="max-width:400px">
      <div class="modal-header">
        <div>
          <div id="bioHistoryTitle" style="font-family:'Space Grotesk', sans-serif;font-size:16px;font-weight:700">Biomarker</div>
          <div id="bioHistoryRange" style="font-size:12px;color:var(--text-muted)">Normal: --</div>
        </div>
        <button class="modal-close" onclick="closeBioHistory()"></button>
      </div>
      <div class="modal-body" style="padding:14px">
        <canvas id="bioHistoryChart" style="max-height:200px"></canvas>
        <div id="bioHistoryTable" style="margin-top:12px"></div>
      </div>
    </div>
  </div>

  <div id="weeklySummaryPage" style="display:none">
    <header class="header">
      <div class="header-top">
        <div class="brand"><div class="logo"></div><div><h1>Summary</h1></div></div>
        <button type="button" id="summaryCloseBtn" class="nav-link"></button>
      </div>
      <div style="display:flex;gap:8px;margin-top:16px">
        <button type="button" class="summary-range-btn btn btn-secondary active" data-range="7">7 Days</button>
        <button type="button" class="summary-range-btn btn btn-secondary" data-range="phase">Phase</button>
        <button type="button" class="summary-range-btn btn btn-secondary" data-range="all">All Time</button>
      </div>
    </header>
    
    <!-- Overview Stats -->
    <div class="section">
      <div class="summary-overview" id="summaryOverview">
        <!-- Populated by JS -->
      </div>
    </div>
    
    <!-- REHIT Calendar -->
    <div class="section">
      <div class="sec-name" style="margin-bottom:12px">REHIT Sessions</div>
      <div id="summaryRehitCalendar" class="rehit-calendar"></div>
    </div>
    
    <!-- Goal Performance -->
    <div class="section">
      <div class="sec-name" style="margin-bottom:12px"> Doing Great</div>
      <div id="goalsDoingWell"></div>
    </div>
    
    <div class="section">
      <div class="sec-name" style="margin-bottom:12px"> Needs Work</div>
      <div id="goalsNeedWork"></div>
    </div>
    
    <!-- Goal Categories -->
    <div class="section">
      <div class="sec-name" style="margin-bottom:12px">Health Goals</div>
      <div id="healthGoalsStats" class="goal-stats-grid"></div>
    </div>
    
    <div class="section">
      <div class="sec-name" style="margin-bottom:12px">Nutrition</div>
      <div id="nutritionStats" class="goal-stats-grid"></div>
    </div>
    
    <div class="section">
      <div class="sec-name" style="margin-bottom:12px">Mindfulness</div>
      <div id="mindfulnessStats" class="goal-stats-grid"></div>
    </div>
    
    <div class="section">
      <div class="sec-name" style="margin-bottom:12px">Kid's Habits</div>
      <div id="kidsHabitsStats" class="goal-stats-grid"></div>
    </div>
    
    <div class="section">
      <div class="sec-name" style="margin-bottom:12px">Writing</div>
      <div id="writingStats" class="goal-stats-grid"></div>
    </div>
  </div>

  <!-- Settings Page -->
  <div id="settingsPage" style="display:none">
    <header class="header">
      <div class="header-top">
        <div class="brand"><div class="logo"></div><div><h1>Settings</h1><div class="tagline">Customize your experience</div></div></div>
        <button type="button" id="settingsCloseBtn" class="nav-link"></button>
      </div>
    </header>
    
    <!-- Goals Settings -->
    <div class="section">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:var(--accent-teal);--icon-end:var(--accent-pink);--icon-glow:var(--glow-teal)"></div><span class="sec-name">Daily Goals</span></div></div>
      <div class="sec-content">
        <div class="setting-row">
          <div class="setting-label">
            <span class="setting-title"> Water Goal</span>
            <span class="setting-desc">Glasses per day</span>
          </div>
          <input type="number" class="goal-input" id="aguaGoal" value="6" min="1" max="20">
        </div>
        <div class="setting-row">
          <div class="setting-label">
            <span class="setting-title"> Steps Goal</span>
            <span class="setting-desc">Steps per day</span>
          </div>
          <input type="number" class="goal-input" id="stepsGoal" value="7500" min="1000" max="50000" step="500">
        </div>
        <div class="setting-row">
          <div class="setting-label">
            <span class="setting-title"> Movement Goal</span>
            <span class="setting-desc">Breaks per day</span>
          </div>
          <input type="number" class="goal-input" id="movementGoal" value="2" min="1" max="10">
        </div>
      </div>
    </div>

    <div class="section">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:var(--accent-purple);--icon-end:var(--accent-orange);--icon-glow:var(--glow-purple)"></div><span class="sec-name">Weekly Goals</span></div></div>
      <div class="sec-content">
        <div class="setting-row">
          <div class="setting-label">
            <span class="setting-title"> REHIT Goal</span>
            <span class="setting-desc">Sessions per week</span>
          </div>
          <input type="number" class="goal-input" id="rehitGoal" value="4" min="1" max="7">
        </div>
        <div class="setting-row">
          <div class="setting-label">
            <span class="setting-title"> Reading Goal</span>
            <span class="setting-desc">Minutes per week</span>
          </div>
          <input type="number" class="goal-input" id="readingGoal" value="60" min="5" max="500" step="5">
        </div>
        <div class="setting-row">
          <div class="setting-label">
            <span class="setting-title"> Meditation Goal</span>
            <span class="setting-desc">Minutes per week</span>
          </div>
          <input type="number" class="goal-input" id="meditationGoal" value="60" min="5" max="500" step="5">
        </div>
      </div>
    </div>

    <!-- Theme Settings -->
    <div class="section">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:var(--accent-orange);--icon-end:var(--accent-yellow);--icon-glow:var(--glow-orange)"></div><span class="sec-name">Theme Schedule</span></div></div>
      <div class="sec-content">
        <div class="setting-row">
          <div class="setting-label">
            <span class="setting-title"> Day Mode Starts</span>
            <span class="setting-desc">When to switch to bright theme</span>
          </div>
          <input type="time" class="time-input" id="dayStartTime" value="06:00">
        </div>
        <div class="setting-row">
          <div class="setting-label">
            <span class="setting-title"> Night Mode Starts</span>
            <span class="setting-desc">When to switch to dark theme</span>
          </div>
          <input type="time" class="time-input" id="nightStartTime" value="18:00">
        </div>
        <div class="setting-row">
          <div class="setting-label">
            <span class="setting-title">Current Theme</span>
            <span class="setting-desc" id="currentThemeDisplay">Auto</span>
          </div>
          <div class="theme-preview">
            <button type="button" class="theme-btn" data-theme="day" title="Day"></button>
            <button type="button" class="theme-btn" data-theme="night" title="Night"></button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Section Management -->
    <div class="section">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:var(--accent-purple);--icon-end:var(--accent-pink);--icon-glow:var(--glow-purple)"></div><span class="sec-name">Manage Sections</span></div></div>
      <div class="sec-content">
        <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px">Drag to reorder  Toggle to show/hide</p>
        <div id="sectionList" class="section-list">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>
    
    <!-- Add Custom Section -->
    <div class="section">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:var(--accent-teal);--icon-end:var(--accent-purple);--icon-glow:var(--glow-teal)"></div><span class="sec-name">Add Custom Section</span></div></div>
      <div class="sec-content">
        <div class="field">
          <label class="field-label">Section Name</label>
          <input type="text" class="input" id="newSectionName" placeholder="e.g., Gratitude, Goals, etc.">
        </div>
        <div class="field">
          <label class="field-label">Section Type</label>
          <select class="input" id="newSectionType">
            <option value="text">Text/Notes</option>
            <option value="checkbox">Checkboxes (multiple)</option>
            <option value="number">Number Input</option>
            <option value="counter">Counter (+/- with goal)</option>
            <option value="log">Log (list of entries)</option>
            <option value="time">Time Input</option>
            <option value="rating">Rating (1-5 stars)</option>
            <option value="toggle">Yes/No Toggle</option>
          </select>
        </div>
        <div class="field">
          <label class="field-label">Icon (emoji)</label>
          <input type="text" class="input" id="newSectionIcon" placeholder="" maxlength="2" style="width:80px">
        </div>
        
        <!-- Dynamic options based on type -->
        <div id="checkboxOptions" class="type-options" style="display:none">
          <div class="field">
            <label class="field-label">Checkbox Names (comma-separated)</label>
            <input type="text" class="input" id="checkboxNames" placeholder="Morning, Afternoon, Evening">
          </div>
        </div>
        
        <div id="counterOptions" class="type-options" style="display:none">
          <div class="field">
            <label class="field-label">Goal Type</label>
            <select class="input" id="counterGoalType">
              <option value="daily">Daily (progress bar)</option>
              <option value="weekly">Weekly (dots)</option>
            </select>
          </div>
          <div class="field">
            <label class="field-label">Goal Number</label>
            <input type="number" class="input" id="counterGoalNumber" placeholder="6" min="1" max="20">
          </div>
          <div class="field">
            <label class="field-label">Unit Label</label>
            <input type="text" class="input" id="counterUnitLabel" placeholder="glasses, sessions, times">
          </div>
        </div>
        
        <div id="logOptions" class="type-options" style="display:none">
          <div class="field">
            <label class="field-label">Fields per Entry</label>
            <div id="logFieldsList">
              <div class="log-field-row" style="display:flex;gap:8px;margin-bottom:8px">
                <input type="text" class="input" placeholder="Field name" style="flex:2">
                <select class="input" style="flex:1">
                  <option value="text">Text</option>
                  <option value="number">Number</option>
                  <option value="select">Dropdown</option>
                </select>
                <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()" style="padding:8px"></button>
              </div>
            </div>
            <button type="button" class="btn btn-secondary" id="addLogFieldBtn" style="width:100%;margin-top:4px">+ Add Field</button>
          </div>
        </div>
        
        <div id="numberOptions" class="type-options" style="display:none">
          <div class="field">
            <label class="field-label">Unit (optional)</label>
            <input type="text" class="input" id="numberUnit" placeholder="lbs, mins, etc.">
          </div>
          <div class="field">
            <label class="field-label">Placeholder</label>
            <input type="text" class="input" id="numberPlaceholder" placeholder="0">
          </div>
        </div>
        
        <div id="ratingOptions" class="type-options" style="display:none">
          <div class="field">
            <label class="field-label">Rating Label</label>
            <input type="text" class="input" id="ratingLabel" placeholder="How was your day?">
          </div>
        </div>
        
        <button type="button" class="btn btn-primary" id="addSectionBtn" style="width:100%;margin-top:12px">Add Section</button>
      </div>
    </div>
    
    <!-- Data Management -->
    <div class="section">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:var(--accent-pink);--icon-end:var(--accent-orange);--icon-glow:var(--glow-pink)"></div><span class="sec-name">Data</span></div></div>
      <div class="sec-content">
        <button type="button" class="btn btn-secondary" id="exportSettingsBtn" style="width:100%;margin-bottom:8px">Export Settings</button>
        <button type="button" class="btn btn-secondary" id="importSettingsBtn" style="width:100%">Import Settings</button>
        <input type="file" id="importSettingsFile" accept=".json" style="display:none">
      </div>
    </div>
  </div>

  <!-- Movement Modal -->
  <div id="movementModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent-pink),var(--accent-purple));display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 0 15px var(--glow-pink)"></div>
          <div>
            <div style="font-family:'Space Grotesk', sans-serif;font-size:18px;font-weight:700">Add Movement</div>
            <div style="font-size:12px;color:var(--text-muted)">Select type and duration</div>
          </div>
        </div>
        <button class="modal-close" onclick="closeMovementModal()"></button>
      </div>
      <div class="modal-body">
        <div class="movement-types">
          <button type="button" class="movement-type-btn" data-type="Walk">
            <span class="type-icon"></span>
            Walk
          </button>
          <button type="button" class="movement-type-btn" data-type="Carol Bike">
            <span class="type-icon"></span>
            Carol Bike
          </button>
          <button type="button" class="movement-type-btn" data-type="Other" style="grid-column: 1 / -1;">
            <span class="type-icon"></span>
            Other
          </button>
        </div>
        <div class="duration-section">
          <div class="duration-label">Duration</div>
          <div class="duration-presets">
            <button type="button" class="duration-preset" data-mins="5">5</button>
            <button type="button" class="duration-preset" data-mins="10">10</button>
            <button type="button" class="duration-preset" data-mins="15">15</button>
            <button type="button" class="duration-preset" data-mins="20">20</button>
            <button type="button" class="duration-preset" data-mins="30">30</button>
          </div>
          <div class="duration-custom-row">
            <input type="number" id="movementCustomMins" placeholder="--" min="1" max="120">
            <span>minutes</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="movementSaveBtn" disabled style="width:100%">Add Movement</button>
      </div>
    </div>
  </div>

  <!-- Reading Modal -->
  <div id="readingModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent-purple),var(--accent-teal));display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 0 15px var(--glow-purple)"></div>
          <div>
            <div style="font-family:'Space Grotesk', sans-serif;font-size:18px;font-weight:700">Add Reading</div>
            <div style="font-size:12px;color:var(--text-muted)">Book title and duration</div>
          </div>
        </div>
        <button class="modal-close" onclick="closeReadingModal()"></button>
      </div>
      <div class="modal-body">
        <div class="reading-field">
          <label class="reading-label" for="readingBookInput">Book Title</label>
          <input type="text" id="readingBookInput" class="reading-input" placeholder="Enter book title...">
        </div>
        <div class="reading-field">
          <label class="reading-label">Duration</label>
          <div class="duration-presets reading-duration-presets">
            <button type="button" class="duration-preset reading-duration-preset" data-mins="10">10</button>
            <button type="button" class="duration-preset reading-duration-preset" data-mins="15">15</button>
            <button type="button" class="duration-preset reading-duration-preset" data-mins="20">20</button>
            <button type="button" class="duration-preset reading-duration-preset" data-mins="30">30</button>
            <button type="button" class="duration-preset reading-duration-preset" data-mins="45">45</button>
          </div>
          <div class="duration-custom-row">
            <input type="number" id="readingCustomMins" placeholder="--" min="1" max="300">
            <span>minutes</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="readingSaveBtn" disabled style="width:100%">Add Reading</button>
      </div>
    </div>
  </div>

  <button id="quickLogFab" class="fab">+</button>
  <div id="quickLogMenu" class="fab-menu">
    <button class="fab-item quick-log-item" data-action="movement"><div class="fab-icon" style="background:linear-gradient(135deg,var(--accent-pink),var(--accent-purple))"></div><span class="fab-label">Movement</span></button>
    <button class="fab-item quick-log-item" data-action="agua"><div class="fab-icon" style="background:linear-gradient(135deg,var(--accent-teal),var(--accent-purple))"></div><span class="fab-label">Water</span></button>
    <button class="fab-item quick-log-item" data-action="reading"><div class="fab-icon" style="background:linear-gradient(135deg,var(--accent-purple),var(--accent-pink))"></div><span class="fab-label">Reading</span></button>
    <button class="fab-item quick-log-item" data-action="rehit"><div class="fab-icon" style="background:linear-gradient(135deg,var(--accent-orange),var(--accent-pink))"></div><span class="fab-label">REHIT</span></button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
  <script src="app.js?v=6.19" defer></script>
  <script>
    // =============================================
    // TOAST NOTIFICATIONS
    // =============================================
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      if (!toast) return;
      
      const icon = toast.querySelector('.toast-icon');
      const text = toast.querySelector('.toast-text');
      
      text.textContent = message;
      icon.textContent = type === 'success' ? '' : type === 'error' ? '' : '';
      
      toast.className = 'toast ' + type;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 2000);
    }
    
    // Make it globally available
    window.showToast = showToast;
    
    // =============================================
    // LOADING OVERLAY
    // =============================================
    function showLoading() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) overlay.classList.remove('hidden');
    }
    
    function hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) overlay.classList.add('hidden');
    }
    
    window.showLoading = showLoading;
    window.hideLoading = hideLoading;
    
    // =============================================
    // PULL TO REFRESH
    // =============================================
    let pullStartY = 0;
    let isPulling = false;
    
    function setupPullToRefresh() {
      const indicator = document.getElementById('pullIndicator');
      if (!indicator) return;
      
      document.addEventListener('touchstart', (e) => {
        if (window.scrollY === 0) {
          pullStartY = e.touches[0].clientY;
          isPulling = true;
        }
      }, { passive: true });
      
      document.addEventListener('touchmove', (e) => {
        if (!isPulling) return;
        const pullDistance = e.touches[0].clientY - pullStartY;
        
        if (pullDistance > 60 && window.scrollY === 0) {
          indicator.classList.add('visible');
        }
      }, { passive: true });
      
      document.addEventListener('touchend', () => {
        if (!isPulling) return;
        isPulling = false;
        
        const indicator = document.getElementById('pullIndicator');
        if (indicator && indicator.classList.contains('visible')) {
          // Trigger refresh
          if (typeof loadDay === 'function') {
            loadDay(window.currentDate || new Date().toISOString().split('T')[0]);
          }
          
          setTimeout(() => {
            indicator.classList.remove('visible');
            showToast('Refreshed', 'success');
          }, 500);
        }
      });
    }
    
    // =============================================
    // SYNC FUNCTIONS
    // =============================================
    // Sync all chip visuals
    function syncAllChips() {
      document.querySelectorAll('.chip').forEach(c => {
        const cb = c.querySelector('input[type="checkbox"]');
        if (cb) c.classList.toggle('on', cb.checked);
      });
    }
    
    // Our own completion ring update (since app.js looks for .checkbox-field)
    function updateCompletionRingAurora() {
      // 9 daily goals: sleep, agua, steps, movement, meals, no alcohol,
      // day snacks, night snacks, supplements
      const total = 9;
      let checked = 0;

      // 1. Sleep  goal
      const sleepVal = parseFloat(document.getElementById('sleepHours')?.value) || 0;
      const sleepGoal = (typeof appSettings !== 'undefined' && appSettings.sleepGoal) ? appSettings.sleepGoal : 7;
      if (sleepVal >= sleepGoal) checked++;

      // 2. Agua  goal
      const aguaGoal = (typeof appSettings !== 'undefined' && appSettings.aguaGoal) ? appSettings.aguaGoal : 6;
      const aguaEl = document.getElementById('aguaCount');
      if ((aguaEl ? parseInt(aguaEl.textContent) || 0 : 0) >= aguaGoal) checked++;

      // 3. Steps  goal
      const stepsVal = parseInt(document.getElementById('steps')?.value) || 0;
      const stepsGoal = (typeof appSettings !== 'undefined' && appSettings.stepsGoal) ? appSettings.stepsGoal : 7500;
      if (stepsVal >= stepsGoal) checked++;

      // 4. Movement breaks  2
      const movementGoal = (typeof appSettings !== 'undefined' && appSettings.movementGoal) ? appSettings.movementGoal : 2;
      const movementItems = document.querySelectorAll('#movementList .item');
      if (movementItems.length >= movementGoal) checked++;

      // 5. Meals: 2 of 3 checked (breakfast, lunch, dinner)
      const mealsChecked = ['breakfast', 'lunch', 'dinner']
        .filter(id => document.getElementById(id)?.checked).length;
      if (mealsChecked >= 2) checked++;

      // 6. No alcohol
      if (document.getElementById('noAlcohol')?.checked) checked++;

      // 7. Healthy day snacks
      if (document.getElementById('daySnacks')?.checked) checked++;

      // 8. Healthy night snacks
      if (document.getElementById('nightSnacks')?.checked) checked++;

      // 9. Supplements: all 4 (creatine, vitD, NO2, psyllium)
      const suppsChecked = ['creatine', 'vitaminD', 'no2', 'psyllium']
        .filter(id => document.getElementById(id)?.checked).length;
      if (suppsChecked === 4) checked++;
      
      // Debug removed
      
      const progress = document.getElementById('completionProgress');
      const number = document.getElementById('completionNumber');
      
      if (progress && number) {
        const circumference = 2 * Math.PI * 32; // r=32 = ~201
        let offset;
        if (total === 0) {
          offset = circumference; // Empty ring
        } else {
          offset = circumference - (checked / total) * circumference;
        }
        // Debug removed
        progress.style.strokeDashoffset = offset;
        number.textContent = checked;
      } else {
        // Debug removed
      }
    }
    
    // Agua progress bar
    function updateAguaBar(){
      const aguaCount = document.getElementById('aguaCount');
      const fill = document.getElementById('aguaBarFill');
      if(!aguaCount || !fill) return;
      const count = parseInt(aguaCount.textContent) || 0;
      const goal = (typeof appSettings !== 'undefined' && appSettings.aguaGoal) ? appSettings.aguaGoal : 6;
      const pct = Math.min(100, (count / goal) * 100);
      fill.style.width = pct + '%';
    }
    
    // Steps progress bar
    function updateStepsBar(){
      const stepsInput = document.getElementById('steps');
      const fill = document.getElementById('stepsBarFill');
      if(!stepsInput || !fill) return;
      const steps = parseInt(stepsInput.value) || 0;
      const goal = (typeof appSettings !== 'undefined' && appSettings.stepsGoal) ? appSettings.stepsGoal : 7500;
      const pct = Math.min(100, (steps / goal) * 100);
      fill.style.width = pct + '%';
    }
    
    // REHIT dots - count sessions this week (goal: 4 sessions per week)
    const REHIT_API = "https://habit-proxy.joeywigs.workers.dev/";
    window._rehitServerCount = 0;  // Count from server
    window._rehitTodaySaved = false; // Whether today's REHIT was saved on server

    // Fetch REHIT count from dedicated endpoint
    async function fetchRehitWeekCount() {
      try {
        const date = window.currentDate || new Date().toISOString().slice(0, 10);
        const resp = await fetch(`${REHIT_API}?action=rehit_week&date=${date}`);
        const data = await resp.json();

        if (data.ok) {
          window._rehitServerCount = data.count;

          // Check if today's REHIT is already in the server count
          const todayStr = date;
          const todayDetail = data.details?.find(d => d.date === todayStr);
          window._rehitTodaySaved = todayDetail?.hasRehit || false;

          // Update display
          updateRehitDotsFromState();
        }
      } catch (err) {
        console.error('Failed to fetch REHIT week count:', err);
      }
    }

    // Calculate display count based on server + current checkbox state
    function updateRehitDotsFromState() {
      const dotsContainer = document.getElementById('rehitDots');
      if (!dotsContainer) return;
      const dots = dotsContainer.querySelectorAll('.rehit-dot');

      // Current checkbox state
      const todayChecked = document.getElementById('rehit2')?.checked || document.getElementById('rehit3')?.checked;

      // Start with server count
      let count = window._rehitServerCount || 0;

      // Adjust for unsaved changes:
      // If today is checked but wasn't saved, add 1
      // If today was saved but now unchecked, subtract 1
      if (todayChecked && !window._rehitTodaySaved) {
        count++;
      } else if (!todayChecked && window._rehitTodaySaved) {
        count--;
      }

      // Update dots (max 4)
      dots.forEach((dot, i) => {
        dot.classList.toggle('on', i < Math.min(count, 4));
      });
    }

    // Called when checkbox changes - update display immediately (optimistic)
    function updateRehitDots() {
      updateRehitDotsFromState();
    }

    // Expose globally
    window.updateRehitDots = updateRehitDots;
    window.fetchRehitWeekCount = fetchRehitWeekCount;
    
    // Hook populateForm - wait for app.js to define it first
    function setupPopulateFormHook() {
      if (typeof window.populateForm === 'function' && !window._populateFormHooked) {
        const originalPopulateForm = window.populateForm;
        window.populateForm = async function(data) {
          // Await the original so loadDataForCurrentDate properly waits
          await originalPopulateForm.call(this, data);

          // Sync our UI after the form is fully populated
          syncAllChips();
          updateAguaBar();
          updateRehitDisplay();
          updateStepsBar();
          updateCompletionRingAurora();
          updateRehitDots();
        };
        window._populateFormHooked = true;
      } else if (!window._populateFormHooked) {
        // Try again in 100ms if app.js hasn't loaded yet
        setTimeout(setupPopulateFormHook, 100);
      }
    }
    
    // =============================================
    // MAIN DOM READY SETUP
    // =============================================
    document.addEventListener('DOMContentLoaded', () => {
      // Setup populateForm hook (must happen before app.js calls loadDataForCurrentDate)
      setupPopulateFormHook();
      
      // Wire up chip toggles
      document.querySelectorAll('.chip').forEach(c => {
        c.addEventListener('click', e => {
          if(e.target.type === 'checkbox') return;
          const cb = c.querySelector('input[type="checkbox"]');
          if(cb) {
            cb.checked = !cb.checked;
            cb.dispatchEvent(new Event('change', {bubbles: true}));
          }
        });
        const cb = c.querySelector('input[type="checkbox"]');
        if(cb) {
          cb.addEventListener('change', () => {
            c.classList.toggle('on', cb.checked);
            updateCompletionRingAurora();
            if(typeof triggerSaveSoon === 'function') triggerSaveSoon();
          });
        }
      });
      
      // Wire up mini supplements
      document.querySelectorAll('.mini-supp').forEach(supp => {
        supp.addEventListener('click', () => {
          const cb = supp.querySelector('input[type="checkbox"]');
          if (cb) {
            cb.checked = !cb.checked;
            updateCompletionRingAurora();
            if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
          }
        });
      });
      
      // Section collapse toggles
      document.querySelectorAll('.sec-head').forEach(h => {
        h.addEventListener('click', () => {
          h.classList.toggle('collapsed');
          const c = h.nextElementSibling;
          if(c && c.classList.contains('sec-content')) c.classList.toggle('collapsed');
        });
      });
      
      // Agua count observer
      const aguaCount = document.getElementById('aguaCount');
      if (aguaCount) {
        const observer = new MutationObserver(() => { updateAguaBar(); updateCompletionRingAurora(); });
        observer.observe(aguaCount, { childList: true, characterData: true, subtree: true });
      }
      
      // Steps input listener
      const stepsInput = document.getElementById('steps');
      if (stepsInput) {
        stepsInput.addEventListener('input', () => { updateStepsBar(); updateCompletionRingAurora(); });
        stepsInput.addEventListener('change', () => { updateStepsBar(); updateCompletionRingAurora(); });
      }

      // Sleep input listener (for completion ring)
      const sleepInput = document.getElementById('sleepHours');
      if (sleepInput) {
        sleepInput.addEventListener('input', updateCompletionRingAurora);
        sleepInput.addEventListener('change', updateCompletionRingAurora);
      }

      // Movement list observer (for completion ring)
      const movementList = document.getElementById('movementList');
      if (movementList) {
        const movObs = new MutationObserver(updateCompletionRingAurora);
        movObs.observe(movementList, { childList: true });
      }
      
      // REHIT week observer
      const rehitWeek = document.getElementById('rehitWeek');
      if (rehitWeek) {
        const rehitObserver = new MutationObserver(updateRehitDots);
        rehitObserver.observe(rehitWeek, { childList: true, characterData: true, subtree: true });
      }
      
      // REHIT checkbox change listeners (chip clicktoggle is handled by generic chip handler at line 2752)
      const rehit2 = document.getElementById('rehit2');
      const rehit3 = document.getElementById('rehit3');
      if (rehit2) rehit2.addEventListener('change', () => { syncAllChips(); updateRehitDots(); updateRehitDisplay(); });
      if (rehit3) rehit3.addEventListener('change', () => { syncAllChips(); updateRehitDots(); updateRehitDisplay(); });
      
      // Initial update after app.js loads data
      setTimeout(() => {
        syncAllChips();
        updateAguaBar();
        updateStepsBar();
        fetchRehitWeekCount(); // Fetch from new endpoint
        updateRehitDisplay();
        updateCompletionRingAurora();
        updatePhaseInfoFixed();
      }, 1500);
      
      // Debug removed
    });
    
    // =============================================
    // MOVEMENT MODAL
    // =============================================
    let selectedMovementType = null;
    let selectedDuration = null;
    
    window.openMovementModal = function() {
      selectedMovementType = null;
      selectedDuration = null;
      
      // Reset UI
      document.querySelectorAll('.movement-type-btn').forEach(b => b.classList.remove('selected'));
      document.querySelectorAll('.duration-preset').forEach(b => b.classList.remove('selected'));
      document.getElementById('movementCustomMins').value = '';
      document.getElementById('movementSaveBtn').disabled = true;
      
      document.getElementById('movementModal').classList.add('show');
    }
    
    window.closeMovementModal = function() {
      document.getElementById('movementModal').classList.remove('show');
    }
    
    function updateMovementSaveBtn() {
      const btn = document.getElementById('movementSaveBtn');
      btn.disabled = !selectedMovementType || !selectedDuration;
    }
    
    // Wire up movement type buttons
    document.querySelectorAll('.movement-type-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.movement-type-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedMovementType = btn.dataset.type;
        updateMovementSaveBtn();
      });
    });
    
    // Wire up duration presets
    document.querySelectorAll('.duration-preset').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.duration-preset').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedDuration = parseInt(btn.dataset.mins, 10);
        document.getElementById('movementCustomMins').value = '';
        updateMovementSaveBtn();
      });
    });
    
    // Wire up custom duration input
    document.getElementById('movementCustomMins')?.addEventListener('input', (e) => {
      const val = parseInt(e.target.value, 10);
      if (val > 0) {
        document.querySelectorAll('.duration-preset').forEach(b => b.classList.remove('selected'));
        selectedDuration = val;
      } else {
        selectedDuration = null;
      }
      updateMovementSaveBtn();
    });
    
    // Wire up save button
    document.getElementById('movementSaveBtn')?.addEventListener('click', () => {
      if (!selectedMovementType || !selectedDuration) return;
      
      // Add to movements array (defined in app.js)
      if (typeof movements !== 'undefined') {
        movements.push({ duration: selectedDuration, type: selectedMovementType, time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true, timeZone: 'America/Chicago' }) });
        if (typeof renderMovements === 'function') renderMovements();
        if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
      }
      
      closeMovementModal();
    });
    
    // Close movement modal when clicking backdrop
    document.getElementById('movementModal')?.addEventListener('click',(e)=>{if(e.target.id==='movementModal')closeMovementModal()});

    // Override promptAddMovement to use our modal
    window.promptAddMovement = openMovementModal;
    
    // Also override quickLogMovement for the FAB
    window.quickLogMovement = async function() {
      openMovementModal();
    };
    
    // =============================================
    // READING MODAL
    // =============================================
    let selectedReadingDuration = null;

    window.openReadingModal = function() {
      selectedReadingDuration = null;

      // Autopopulate book title from last entry
      const bookInput = document.getElementById('readingBookInput');
      if (typeof lastBookTitle !== 'undefined' && lastBookTitle) {
        bookInput.value = lastBookTitle;
      } else {
        bookInput.value = '';
      }

      // Reset duration UI
      document.querySelectorAll('.reading-duration-preset').forEach(b => b.classList.remove('selected'));
      document.getElementById('readingCustomMins').value = '';
      document.getElementById('readingSaveBtn').disabled = true;
      updateReadingSaveBtn();

      document.getElementById('readingModal').classList.add('show');
    };

    window.closeReadingModal = function() {
      document.getElementById('readingModal').classList.remove('show');
    };

    function updateReadingSaveBtn() {
      const btn = document.getElementById('readingSaveBtn');
      const bookInput = document.getElementById('readingBookInput');
      btn.disabled = !selectedReadingDuration || !bookInput.value.trim();
    }

    // Wire up reading duration presets
    document.querySelectorAll('.reading-duration-preset').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.reading-duration-preset').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedReadingDuration = parseInt(btn.dataset.mins, 10);
        document.getElementById('readingCustomMins').value = '';
        updateReadingSaveBtn();
      });
    });

    // Wire up custom reading duration input
    document.getElementById('readingCustomMins')?.addEventListener('input', (e) => {
      const val = parseInt(e.target.value, 10);
      if (val > 0) {
        document.querySelectorAll('.reading-duration-preset').forEach(b => b.classList.remove('selected'));
        selectedReadingDuration = val;
      } else {
        selectedReadingDuration = null;
      }
      updateReadingSaveBtn();
    });

    // Wire up book title input
    document.getElementById('readingBookInput')?.addEventListener('input', updateReadingSaveBtn);

    // Wire up save button
    document.getElementById('readingSaveBtn')?.addEventListener('click', () => {
      const bookInput = document.getElementById('readingBookInput');
      const bookTitle = bookInput.value.trim();
      if (!selectedReadingDuration || !bookTitle) return;

      if (typeof readings !== 'undefined') {
        readings.push({ duration: selectedReadingDuration, book: bookTitle, time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true, timeZone: 'America/Chicago' }) });
        if (typeof window.lastBookTitle !== 'undefined' || true) window.lastBookTitle = bookTitle;
        if (typeof renderReadings === 'function') renderReadings();
        if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
      }

      closeReadingModal();
    });

    // Close reading modal when clicking backdrop
    document.getElementById('readingModal')?.addEventListener('click',(e)=>{if(e.target.id==='readingModal')closeReadingModal()});

    // Override promptAddReading to use our modal
    window.promptAddReading = openReadingModal;

    // Also override quickLogReading for the FAB
    window.quickLogReading = async function() {
      openReadingModal();
    };

    // Also try immediately in case app.js loaded first
    setupPopulateFormHook();
    
    // Hook agua display updates
    function setupAguaHook() {
      if (typeof window.updateAguaDisplay === 'function' && !window._aguaHooked) {
        const origAgua = window.updateAguaDisplay;
        window.updateAguaDisplay = function() {
          origAgua.call(this);
          updateAguaBar();
          updateCompletionRingAurora();
        };
        window._aguaHooked = true;
      } else if (!window._aguaHooked) {
        setTimeout(setupAguaHook, 100);
      }
    }
    setupAguaHook();
    
    // Fixed phase info that always uses today's date
    function updatePhaseInfoFixed() {
      const PHASE_START = new Date("2026-01-19T00:00:00");
      const PHASE_LENGTH = 21;
      const today = new Date();
      today.setHours(0,0,0,0);
      
      const diffTime = today - PHASE_START;
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays < 0) {
        // Before phase start
        const phaseDayEl = document.getElementById("phaseDayCount");
        if (phaseDayEl) phaseDayEl.textContent = "Starting soon";
        return;
      }
      
      const phase = Math.floor(diffDays / PHASE_LENGTH) + 1;
      const dayInPhase = (diffDays % PHASE_LENGTH) + 1;
      const daysRemaining = PHASE_LENGTH - dayInPhase + 1;
      
      // Update the day counter under Phase title
      const phaseDayEl = document.getElementById("phaseDayCount");
      if (phaseDayEl) phaseDayEl.textContent = `Day ${dayInPhase} of ${PHASE_LENGTH}`;
      
      // Update tagline to show current phase number
      const subtitleEl = document.querySelector(".tagline");
      if (subtitleEl) subtitleEl.textContent = `Phase ${phase}`;
      
      // Update progress bar
      const progressBar = document.getElementById("phaseProgressBar");
      if (progressBar) {
        const progress = ((dayInPhase - 1) / PHASE_LENGTH) * 100;
        progressBar.style.width = `${progress}%`;
      }
    }
    
    // Override app.js phase functions to use our fixed version
    // Run immediately and also on window load
    window.updatePhaseInfo = updatePhaseInfoFixed;
    window.loadPhaseProgress = updatePhaseInfoFixed;
    
    window.addEventListener('load', () => {
      // Ensure overrides are in place
      window.updatePhaseInfo = updatePhaseInfoFixed;
      window.loadPhaseProgress = updatePhaseInfoFixed;
      // Run it once
      updatePhaseInfoFixed();
    });
    
    // Also run phase update periodically to override any app.js changes
    setInterval(updatePhaseInfoFixed, 3000);
    
    // Periodically sync chips and update completion ring
    setInterval(() => {
      syncAllChips();
      updateCompletionRingAurora();
    }, 2000);
    
    // REHIT Modal
    function openRehitModal() { document.getElementById('rehitModal').classList.add('show'); }
    function closeRehitModal() { document.getElementById('rehitModal').classList.remove('show'); }
    function saveRehitAndClose() { updateRehitDisplay(); closeRehitModal(); if(typeof triggerSaveSoon==='function')triggerSaveSoon(); }
    
    function updateRehitDisplay() {
      const score=document.getElementById('fitnessScore')?.value;
      const cals=document.getElementById('calories')?.value;
      const watts=document.getElementById('peakWatts')?.value;
      const ws=document.getElementById('wattSeconds')?.value;
      const rehit2=document.getElementById('rehit2')?.checked;
      const rehit3=document.getElementById('rehit3')?.checked;
      const statsDiv=document.getElementById('rehitStats');
      if(statsDiv){const hasData=score||cals||watts||ws;const isChecked=rehit2||rehit3;statsDiv.style.display=(isChecked||hasData)?'block':'none'}
      document.getElementById('rehitScoreDisplay').textContent=score||'--';
      document.getElementById('rehitCalsDisplay').textContent=cals||'--';
      document.getElementById('rehitWattsDisplay').textContent=watts||'--';
      document.getElementById('rehitWsDisplay').textContent=ws?parseInt(ws).toLocaleString():'--';
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      const rehit2=document.getElementById('rehit2');
      const rehit3=document.getElementById('rehit3');
      const editBtn=document.getElementById('editRehitBtn');
      const showModal=(e)=>{if(e.target.checked)setTimeout(openRehitModal,300);updateRehitDisplay()};
      if(rehit2)rehit2.addEventListener('change',showModal);
      if(rehit3)rehit3.addEventListener('change',showModal);
      if(editBtn)editBtn.addEventListener('click',openRehitModal);
      ['fitnessScore','calories','peakWatts','wattSeconds'].forEach(id=>{const el=document.getElementById(id);if(el)el.addEventListener('change',updateRehitDisplay)});
      setTimeout(updateRehitDisplay,1000);
    });
    
    document.getElementById('rehitModal')?.addEventListener('click',(e)=>{if(e.target.id==='rehitModal')closeRehitModal()});
    
    // =============================================
    // SETTINGS & THEME SYSTEM
    // =============================================
    
    // Default settings
    const defaultSettings = {
      dayStartTime: '05:00',
      nightStartTime: '17:00',
      aguaGoal: 6,
      stepsGoal: 7500,
      rehitGoal: 4,
      readingGoal: 60,
      movementGoal: 2,
      meditationGoal: 60,
      sections: [
        { id: 'greysHabitsSection', name: "Grey's Habits", icon: '', visible: true, custom: false },
        { id: 'nutritionSection', name: 'Supplements', icon: '', visible: true, custom: false },
        { id: 'mealsSection', name: 'Meals', icon: '', visible: true, custom: false },
        { id: 'movementSection', name: 'Movement Breaks', icon: '', visible: true, custom: false },
        { id: 'mentalHabitsSection', name: 'Reading', icon: '', visible: true, custom: false },
        { id: 'meditationSection', name: 'Mindfulness', icon: '', visible: true, custom: false },
        { id: 'reflectionsSection', name: 'Reflections', icon: '', visible: true, custom: false },
        { id: 'storiesSection', name: 'Grey & Sloane', icon: '', visible: true, custom: false },
        { id: 'carlySection', name: 'Carly', icon: '', visible: true, custom: false },
        { id: 'bodyDataSection', name: 'Body', icon: '', visible: true, custom: false },
        { id: 'bloodPressureSection', name: 'Blood Pressure', icon: '', visible: true, custom: false },
      ]
    };
    
    // Load settings from localStorage
    function loadSettings() {
      try {
        const saved = localStorage.getItem('elevateSettings');
        if (saved) {
          return { ...defaultSettings, ...JSON.parse(saved) };
        }
      } catch (e) {
        console.error('Error loading settings:', e);
      }
      return { ...defaultSettings };
    }
    
    // Save settings to localStorage
    function saveSettings(settings) {
      try {
        localStorage.setItem('elevateSettings', JSON.stringify(settings));
      } catch (e) {
        console.error('Error saving settings:', e);
      }
    }
    
    let appSettings = loadSettings();

    // Migrate old waterGoal  aguaGoal
    if (appSettings.waterGoal && !appSettings.aguaGoal) {
      appSettings.aguaGoal = appSettings.waterGoal;
      delete appSettings.waterGoal;
      saveSettings(appSettings);
    }

    // Theme functions
    function getCurrentTheme() {
      const now = new Date();
      const currentTime = now.getHours() * 60 + now.getMinutes();
      
      const [dayH, dayM] = appSettings.dayStartTime.split(':').map(Number);
      const [nightH, nightM] = appSettings.nightStartTime.split(':').map(Number);
      
      const dayStart = dayH * 60 + dayM;
      const nightStart = nightH * 60 + nightM;
      
      if (currentTime >= dayStart && currentTime < nightStart) {
        return 'day';
      } else {
        return 'night';
      }
    }
    
    function applyTheme(theme, showIndicator = false) {
      const body = document.body;
      const indicator = document.getElementById('themeIndicator');
      
      body.classList.remove('day-mode', 'sunset-mode');
      
      if (theme === 'day') {
        body.classList.add('day-mode');
        if (indicator) indicator.innerHTML = ' Day Mode';
      } else {
        if (indicator) indicator.innerHTML = ' Night Mode';
      }
      
      // Update theme buttons
      document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.theme === theme);
      });
      
      // Update display
      const display = document.getElementById('currentThemeDisplay');
      if (display) display.textContent = theme === 'day' ? 'Day Mode' : 'Night Mode';
      
      if (showIndicator && indicator) {
        indicator.classList.add('show');
        setTimeout(() => indicator.classList.remove('show'), 2000);
      }
    }
    
    // Initialize theme
    let currentTheme = getCurrentTheme();
    applyTheme(currentTheme, false);
    
    // Check for theme changes every minute
    setInterval(() => {
      const newTheme = getCurrentTheme();
      if (newTheme !== currentTheme) {
        currentTheme = newTheme;
        applyTheme(newTheme, true);
      }
    }, 60000);
    
    // =============================================
    // SETTINGS PAGE
    // =============================================
    
    function openSettingsPage() {
      // Hide all other pages
      const mainPage = document.getElementById('healthForm');
      const chartsPage = document.getElementById('chartsPage');
      const bioPage = document.getElementById('biomarkersPage');
      const summaryPage = document.getElementById('weeklySummaryPage');
      const settingsPage = document.getElementById('settingsPage');
      const fab = document.getElementById('quickLogFab');
      
      if (mainPage) mainPage.style.display = 'none';
      if (chartsPage) chartsPage.style.display = 'none';
      if (bioPage) bioPage.style.display = 'none';
      if (summaryPage) summaryPage.style.display = 'none';
      if (settingsPage) settingsPage.style.display = 'block';
      if (fab) fab.style.display = 'none';
      
      // Populate settings
      document.getElementById('dayStartTime').value = appSettings.dayStartTime;
      document.getElementById('nightStartTime').value = appSettings.nightStartTime;
      document.getElementById('aguaGoal').value = appSettings.aguaGoal || 6;
      document.getElementById('stepsGoal').value = appSettings.stepsGoal || 7500;
      document.getElementById('rehitGoal').value = appSettings.rehitGoal || 4;
      document.getElementById('readingGoal').value = appSettings.readingGoal || 60;
      document.getElementById('movementGoal').value = appSettings.movementGoal || 2;
      document.getElementById('meditationGoal').value = appSettings.meditationGoal || 60;

      window.scrollTo(0, 0);
      renderSectionList();
    }
    
    function closeSettingsPage() {
      document.getElementById('settingsPage').style.display = 'none';
      document.getElementById('healthForm').style.display = 'block';
      document.getElementById('quickLogFab').style.display = 'block';
      
      // Apply section visibility
      applySectionSettings();
      window.scrollTo(0, 0);
    }
    
    function renderSectionList() {
      const list = document.getElementById('sectionList');
      if (!list) return;
      
      list.innerHTML = appSettings.sections.map((sec, idx) => `
        <div class="section-item" draggable="true" data-idx="${idx}" data-id="${sec.id}">
          <span class="section-item-drag"></span>
          <span class="section-item-icon">${sec.icon}</span>
          <span class="section-item-name">${sec.name}</span>
          <div class="section-item-toggle ${sec.visible ? 'on' : ''}" data-idx="${idx}"></div>
          ${sec.custom ? `<button class="section-item-delete" data-idx="${idx}"></button>` : ''}
        </div>
      `).join('');
      
      // Add event listeners
      list.querySelectorAll('.section-item-toggle').forEach(toggle => {
        toggle.addEventListener('click', () => {
          const idx = parseInt(toggle.dataset.idx);
          appSettings.sections[idx].visible = !appSettings.sections[idx].visible;
          toggle.classList.toggle('on');
          saveSettings(appSettings);
        });
      });
      
      list.querySelectorAll('.section-item-delete').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.idx);
          if (confirm('Delete this section?')) {
            appSettings.sections.splice(idx, 1);
            saveSettings(appSettings);
            renderSectionList();
          }
        });
      });
      
      // Drag and drop
      setupDragAndDrop();
    }
    
    function setupDragAndDrop() {
      const items = document.querySelectorAll('.section-item');
      let draggedItem = null;
      
      items.forEach(item => {
        item.addEventListener('dragstart', (e) => {
          draggedItem = item;
          item.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
        });
        
        item.addEventListener('dragend', () => {
          item.classList.remove('dragging');
          document.querySelectorAll('.section-item').forEach(i => i.classList.remove('drag-over'));
          draggedItem = null;
        });
        
        item.addEventListener('dragover', (e) => {
          e.preventDefault();
          if (item !== draggedItem) {
            item.classList.add('drag-over');
          }
        });
        
        item.addEventListener('dragleave', () => {
          item.classList.remove('drag-over');
        });
        
        item.addEventListener('drop', (e) => {
          e.preventDefault();
          if (item !== draggedItem && draggedItem) {
            const fromIdx = parseInt(draggedItem.dataset.idx);
            const toIdx = parseInt(item.dataset.idx);
            
            // Reorder array
            const [moved] = appSettings.sections.splice(fromIdx, 1);
            appSettings.sections.splice(toIdx, 0, moved);
            
            saveSettings(appSettings);
            renderSectionList();
            applySectionSettings();
          }
        });
      });
    }
    
    function applySectionSettings() {
      const form = document.getElementById('healthForm');
      if (!form) return;
      
      // Apply visibility and order
      appSettings.sections.forEach((sec, idx) => {
        const el = document.getElementById(sec.id);
        if (el) {
          el.style.display = sec.visible ? '' : 'none';
          el.style.order = idx;
        }
      });
    }
    
    // Wire up home button
    document.getElementById('homeBtn')?.addEventListener('click', (e) => {
      e.preventDefault();
      // Hide all pages, show main form
      document.getElementById('settingsPage').style.display = 'none';
      document.getElementById('chartsPage').style.display = 'none';
      document.getElementById('biomarkersPage').style.display = 'none';
      document.getElementById('weeklySummaryPage').style.display = 'none';
      document.getElementById('healthForm').style.display = 'block';
      document.getElementById('quickLogFab').style.display = 'block';
      window.scrollTo(0, 0);
    });
    
    // Wire up settings page
    document.getElementById('settingsBtn')?.addEventListener('click', (e) => {
      e.preventDefault();
      openSettingsPage();
    });
    
    document.getElementById('settingsCloseBtn')?.addEventListener('click', closeSettingsPage);
    
    // Time inputs
    document.getElementById('dayStartTime')?.addEventListener('change', (e) => {
      appSettings.dayStartTime = e.target.value;
      saveSettings(appSettings);
      currentTheme = getCurrentTheme();
      applyTheme(currentTheme, true);
    });
    
    document.getElementById('nightStartTime')?.addEventListener('change', (e) => {
      appSettings.nightStartTime = e.target.value;
      saveSettings(appSettings);
      currentTheme = getCurrentTheme();
      applyTheme(currentTheme, true);
    });
    
    // Goal inputs
    document.getElementById('aguaGoal')?.addEventListener('change', (e) => {
      appSettings.aguaGoal = parseInt(e.target.value) || 6;
      saveSettings(appSettings);
      // Update agua bar goal
      if (typeof updateAguaBar === 'function') updateAguaBar();
      showToast('Water goal updated', 'success');
    });
    
    document.getElementById('stepsGoal')?.addEventListener('change', (e) => {
      appSettings.stepsGoal = parseInt(e.target.value) || 7500;
      saveSettings(appSettings);
      // Update steps bar goal
      if (typeof updateStepsBar === 'function') updateStepsBar();
      showToast('Steps goal updated', 'success');
    });
    
    document.getElementById('rehitGoal')?.addEventListener('change', (e) => {
      appSettings.rehitGoal = parseInt(e.target.value) || 4;
      saveSettings(appSettings);
      showToast('REHIT goal updated', 'success');
    });

    document.getElementById('readingGoal')?.addEventListener('change', (e) => {
      appSettings.readingGoal = parseInt(e.target.value) || 60;
      saveSettings(appSettings);
      showToast('Reading goal updated', 'success');
    });

    document.getElementById('movementGoal')?.addEventListener('change', (e) => {
      appSettings.movementGoal = parseInt(e.target.value) || 2;
      saveSettings(appSettings);
      showToast('Movement goal updated', 'success');
    });

    document.getElementById('meditationGoal')?.addEventListener('change', (e) => {
      appSettings.meditationGoal = parseInt(e.target.value) || 60;
      saveSettings(appSettings);
      showToast('Meditation goal updated', 'success');
    });

    // Theme preview buttons
    document.querySelectorAll('.theme-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        currentTheme = btn.dataset.theme;
        applyTheme(currentTheme, true);
      });
    });
    
    // Show/hide type-specific options
    document.getElementById('newSectionType')?.addEventListener('change', (e) => {
      // Hide all options first
      document.querySelectorAll('.type-options').forEach(opt => opt.style.display = 'none');
      
      // Show relevant options
      const type = e.target.value;
      if (type === 'checkbox') {
        document.getElementById('checkboxOptions').style.display = 'block';
      } else if (type === 'counter') {
        document.getElementById('counterOptions').style.display = 'block';
      } else if (type === 'log') {
        document.getElementById('logOptions').style.display = 'block';
      } else if (type === 'number') {
        document.getElementById('numberOptions').style.display = 'block';
      } else if (type === 'rating') {
        document.getElementById('ratingOptions').style.display = 'block';
      }
    });
    
    // Add log field button
    document.getElementById('addLogFieldBtn')?.addEventListener('click', () => {
      const list = document.getElementById('logFieldsList');
      const row = document.createElement('div');
      row.className = 'log-field-row';
      row.style.cssText = 'display:flex;gap:8px;margin-bottom:8px';
      row.innerHTML = `
        <input type="text" class="input" placeholder="Field name" style="flex:2">
        <select class="input" style="flex:1">
          <option value="text">Text</option>
          <option value="number">Number</option>
          <option value="select">Dropdown</option>
        </select>
        <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()" style="padding:8px"></button>
      `;
      list.appendChild(row);
    });
    
    // Add custom section
    document.getElementById('addSectionBtn')?.addEventListener('click', () => {
      const name = document.getElementById('newSectionName').value.trim();
      const type = document.getElementById('newSectionType').value;
      const icon = document.getElementById('newSectionIcon').value || '';
      
      if (!name) {
        alert('Please enter a section name');
        return;
      }
      
      const id = 'custom_' + Date.now();
      
      // Gather type-specific config
      let config = {};
      
      if (type === 'checkbox') {
        const names = document.getElementById('checkboxNames').value;
        config.checkboxes = names.split(',').map(n => n.trim()).filter(n => n);
        if (config.checkboxes.length === 0) {
          alert('Please enter at least one checkbox name');
          return;
        }
      } else if (type === 'counter') {
        config.goalType = document.getElementById('counterGoalType').value;
        config.goalNumber = parseInt(document.getElementById('counterGoalNumber').value) || 6;
        config.unitLabel = document.getElementById('counterUnitLabel').value || 'times';
      } else if (type === 'log') {
        const rows = document.querySelectorAll('#logFieldsList .log-field-row');
        config.fields = [];
        rows.forEach(row => {
          const fname = row.querySelector('input').value.trim();
          const ftype = row.querySelector('select').value;
          if (fname) config.fields.push({ name: fname, type: ftype });
        });
        if (config.fields.length === 0) {
          alert('Please add at least one field for the log');
          return;
        }
      } else if (type === 'number') {
        config.unit = document.getElementById('numberUnit').value || '';
        config.placeholder = document.getElementById('numberPlaceholder').value || '0';
      } else if (type === 'rating') {
        config.label = document.getElementById('ratingLabel').value || 'Rate';
      }
      
      appSettings.sections.push({
        id,
        name,
        icon,
        visible: true,
        custom: true,
        type,
        config
      });
      
      saveSettings(appSettings);
      
      // Create the section element
      createCustomSection(id, name, icon, type, config);
      
      // Clear inputs
      document.getElementById('newSectionName').value = '';
      document.getElementById('newSectionIcon').value = '';
      document.getElementById('checkboxNames').value = '';
      document.getElementById('counterGoalNumber').value = '';
      document.getElementById('counterUnitLabel').value = '';
      document.getElementById('logFieldsList').innerHTML = `
        <div class="log-field-row" style="display:flex;gap:8px;margin-bottom:8px">
          <input type="text" class="input" placeholder="Field name" style="flex:2">
          <select class="input" style="flex:1">
            <option value="text">Text</option>
            <option value="number">Number</option>
            <option value="select">Dropdown</option>
          </select>
          <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()" style="padding:8px"></button>
        </div>
      `;
      document.querySelectorAll('.type-options').forEach(opt => opt.style.display = 'none');
      document.getElementById('newSectionType').value = 'text';
      
      renderSectionList();
    });
    
    // Store custom section data (for logs, counters, etc.)
    window.customSectionData = window.customSectionData || {};
    
    function createCustomSection(id, name, icon, type, config = {}) {
      const form = document.getElementById('healthForm');
      if (!form) return;
      
      // Initialize data storage for this section
      if (!window.customSectionData[id]) {
        window.customSectionData[id] = { value: type === 'counter' ? 0 : null, entries: [] };
      }
      
      const section = document.createElement('div');
      section.className = 'section';
      section.id = id;
      
      let content = '';
      
      if (type === 'text') {
        content = '<textarea class="input" id="' + id + '_input" placeholder="Enter notes..."></textarea>';
      
      } else if (type === 'checkbox') {
        const checkboxes = config.checkboxes || ['Done'];
        let cbHtml = '';
        checkboxes.forEach((cb, i) => {
          cbHtml += '<div class="chip"><input type="checkbox" id="' + id + '_check_' + i + '"><div class="chip-dot"></div><span class="chip-text">' + cb + '</span></div>';
        });
        content = '<div class="chips">' + cbHtml + '</div>';
      
      } else if (type === 'number') {
        const unit = config.unit ? '<span class="card-unit">' + config.unit + '</span>' : '';
        content = '<div style="display:flex;align-items:center;gap:8px"><input type="number" class="big-input" id="' + id + '_input" placeholder="' + (config.placeholder || '0') + '" style="max-width:120px">' + unit + '</div>';
      
      } else if (type === 'counter') {
        const goalNum = config.goalNumber || 6;
        const unit = config.unitLabel || 'times';
        const isWeekly = config.goalType === 'weekly';
        
        if (isWeekly) {
          // Weekly goal with dots
          let dots = '';
          for (let i = 0; i < goalNum; i++) {
            dots += `<div class="counter-dot" data-idx="${i}"></div>`;
          }
          content = `
            <div style="display:flex;align-items:center;gap:12px">
              <button type="button" class="water-btn counter-minus" data-id="${id}"></button>
              <div class="water-num counter-value" id="${id}_value">0</div>
              <button type="button" class="water-btn counter-plus" data-id="${id}">+</button>
              <div class="counter-dots" id="${id}_dots" style="display:flex;gap:6px;margin-left:auto">
                ${dots}
              </div>
            </div>
            <div class="card-avg" style="margin-top:8px">Goal: ${goalNum} ${unit}/week</div>
          `;
        } else {
          // Daily goal with progress bar
          content = `
            <div style="display:flex;align-items:center;gap:12px">
              <button type="button" class="water-btn counter-minus" data-id="${id}"></button>
              <div class="water-num counter-value" id="${id}_value">0</div>
              <button type="button" class="water-btn counter-plus" data-id="${id}">+</button>
              <div class="water-bar-wrap">
                <div class="water-bar-track">
                  <div class="water-bar-fill counter-fill" id="${id}_fill" style="height:0%"></div>
                </div>
                <div class="water-bar-goal">${goalNum}</div>
              </div>
            </div>
            <div class="card-avg" style="margin-top:8px">Goal: ${goalNum} ${unit}/day</div>
          `;
        }
      
      } else if (type === 'log') {
        content = `
          <div class="items" id="${id}_list"></div>
          <button type="button" class="btn btn-secondary" id="${id}_addBtn">+ Add Entry</button>
        `;
      
      } else if (type === 'time') {
        content = `<input type="time" class="input" id="${id}_input">`;
      
      } else if (type === 'rating') {
        const label = config.label || 'Rate';
        content = `
          <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px">${label}</div>
          <div class="rating-stars" id="${id}_stars">
            <span class="star" data-val="1"></span>
            <span class="star" data-val="2"></span>
            <span class="star" data-val="3"></span>
            <span class="star" data-val="4"></span>
            <span class="star" data-val="5"></span>
          </div>
          <input type="hidden" id="${id}_input" value="">
        `;
      
      } else if (type === 'toggle') {
        content = `
          <div class="chips">
            <div class="chip toggle-chip" id="${id}_toggle">
              <input type="checkbox" id="${id}_input">
              <div class="chip-dot"></div>
              <span class="chip-text">Yes</span>
            </div>
          </div>
        `;
      }
      
      section.innerHTML = `
        <div class="sec-head collapsed">
          <div class="sec-title">
            <div class="sec-icon" style="--icon-start:var(--accent-purple);--icon-end:var(--accent-pink)">${icon}</div>
            <span class="sec-name">${name}</span>
          </div>
          <span class="sec-toggle"></span>
        </div>
        <div class="sec-content collapsed">${content}</div>
      `;
      
      form.appendChild(section);
      
      // Wire up collapse
      const head = section.querySelector('.sec-head');
      head.addEventListener('click', () => {
        head.classList.toggle('collapsed');
        section.querySelector('.sec-content').classList.toggle('collapsed');
      });
      
      // Wire up type-specific interactions
      wireUpCustomSection(section, id, type, config);
    }
    
    function wireUpCustomSection(section, id, type, config) {
      if (type === 'checkbox') {
        section.querySelectorAll('.chip').forEach(chip => {
          const cb = chip.querySelector('input');
          chip.addEventListener('click', (e) => {
            if (e.target.type !== 'checkbox') {
              cb.checked = !cb.checked;
              chip.classList.toggle('on', cb.checked);
              updateCompletionRingAurora();
              if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
            }
          });
          cb.addEventListener('change', () => {
            chip.classList.toggle('on', cb.checked);
            updateCompletionRingAurora();
            if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
          });
        });
      
      } else if (type === 'counter') {
        const goalNum = config.goalNumber || 6;
        const isWeekly = config.goalType === 'weekly';
        
        section.querySelector('.counter-plus')?.addEventListener('click', () => {
          const valEl = document.getElementById(`${id}_value`);
          let val = parseInt(valEl.textContent) || 0;
          val++;
          valEl.textContent = val;
          window.customSectionData[id].value = val;
          
          if (isWeekly) {
            // Update dots
            const dots = section.querySelectorAll('.counter-dot');
            dots.forEach((dot, i) => dot.classList.toggle('on', i < val));
          } else {
            // Update progress bar
            const fill = document.getElementById(`${id}_fill`);
            if (fill) fill.style.height = Math.min(100, (val / goalNum) * 100) + '%';
          }
          if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
        });
        
        section.querySelector('.counter-minus')?.addEventListener('click', () => {
          const valEl = document.getElementById(`${id}_value`);
          let val = parseInt(valEl.textContent) || 0;
          if (val > 0) val--;
          valEl.textContent = val;
          window.customSectionData[id].value = val;
          
          if (isWeekly) {
            const dots = section.querySelectorAll('.counter-dot');
            dots.forEach((dot, i) => dot.classList.toggle('on', i < val));
          } else {
            const fill = document.getElementById(`${id}_fill`);
            if (fill) fill.style.height = Math.min(100, (val / goalNum) * 100) + '%';
          }
          if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
        });
      
      } else if (type === 'log') {
        const addBtn = document.getElementById(`${id}_addBtn`);
        addBtn?.addEventListener('click', () => openLogModal(id, config.fields || []));
      
      } else if (type === 'rating') {
        const stars = section.querySelectorAll('.star');
        const input = document.getElementById(`${id}_input`);
        stars.forEach(star => {
          star.addEventListener('click', () => {
            const val = parseInt(star.dataset.val);
            input.value = val;
            window.customSectionData[id].value = val;
            stars.forEach((s, i) => {
              s.textContent = i < val ? '' : '';
              s.classList.toggle('filled', i < val);
            });
            if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
          });
        });
      
      } else if (type === 'toggle') {
        const chip = section.querySelector('.toggle-chip');
        const cb = chip.querySelector('input');
        chip.addEventListener('click', (e) => {
          if (e.target.type !== 'checkbox') {
            cb.checked = !cb.checked;
            chip.classList.toggle('on', cb.checked);
            chip.querySelector('.chip-text').textContent = cb.checked ? 'Yes' : 'No';
            updateCompletionRingAurora();
            if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
          }
        });
        cb.addEventListener('change', () => {
          chip.classList.toggle('on', cb.checked);
          chip.querySelector('.chip-text').textContent = cb.checked ? 'Yes' : 'No';
          updateCompletionRingAurora();
          if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
        });
      
      } else if (type === 'text') {
        const input = document.getElementById(`${id}_input`);
        if (input) {
          // Save on blur (when user clicks away) to avoid interrupting typing
          input.addEventListener('blur', () => {
            window.customSectionData[id] = window.customSectionData[id] || {};
            window.customSectionData[id].value = input.value;
            if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
          });
        }
      
      } else if (type === 'number') {
        const input = document.getElementById(`${id}_input`);
        if (input) {
          input.addEventListener('change', () => {
            window.customSectionData[id] = window.customSectionData[id] || {};
            window.customSectionData[id].value = input.value;
            if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
          });
        }
      
      } else if (type === 'time') {
        const input = document.getElementById(`${id}_input`);
        if (input) {
          input.addEventListener('change', () => {
            window.customSectionData[id] = window.customSectionData[id] || {};
            window.customSectionData[id].value = input.value;
            if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
          });
        }
      }
    }
    
    // Log modal for custom log sections
    function openLogModal(sectionId, fields) {
      // Create modal if doesn't exist
      let modal = document.getElementById('customLogModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'customLogModal';
        modal.className = 'modal';
        modal.innerHTML = `
          <div class="modal-overlay" onclick="closeLogModal()"></div>
          <div class="modal-content">
            <div class="modal-header">
              <h3 id="logModalTitle">Add Entry</h3>
              <button onclick="closeLogModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text)"></button>
            </div>
            <div id="logModalFields"></div>
            <button class="btn btn-primary" id="logModalSaveBtn" style="width:100%;margin-top:12px">Save</button>
          </div>
        `;
        document.body.appendChild(modal);
      }
      
      // Populate fields
      const fieldsContainer = document.getElementById('logModalFields');
      fieldsContainer.innerHTML = fields.map(f => `
        <div class="field">
          <label class="field-label">${f.name}</label>
          ${f.type === 'number' 
            ? `<input type="number" class="input" id="logField_${f.name.replace(/\s/g, '_')}" placeholder="0">`
            : `<input type="text" class="input" id="logField_${f.name.replace(/\s/g, '_')}" placeholder="">`
          }
        </div>
      `).join('');
      
      // Wire up save
      document.getElementById('logModalSaveBtn').onclick = () => {
        const entry = {};
        fields.forEach(f => {
          const input = document.getElementById(`logField_${f.name.replace(/\s/g, '_')}`);
          entry[f.name] = f.type === 'number' ? (parseFloat(input.value) || 0) : input.value;
        });
        
        if (!window.customSectionData[sectionId]) {
          window.customSectionData[sectionId] = { entries: [] };
        }
        window.customSectionData[sectionId].entries.push(entry);
        
        renderLogEntries(sectionId, fields);
        closeLogModal();
        if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
      };
      
      modal.classList.add('show');
    }
    
    function closeLogModal() {
      document.getElementById('customLogModal')?.classList.remove('show');
    }
    
    function renderLogEntries(sectionId, fields) {
      const list = document.getElementById(`${sectionId}_list`);
      if (!list) return;
      
      const entries = window.customSectionData[sectionId]?.entries || [];
      list.innerHTML = entries.map((entry, idx) => {
        const summary = fields.map(f => entry[f.name]).filter(v => v).join('  ');
        return `
          <div class="item">
            <span class="item-text">${summary || 'Entry ' + (idx + 1)}</span>
            <button type="button" class="btn btn-danger" onclick="removeLogEntry('${sectionId}', ${idx})"></button>
          </div>
        `;
      }).join('');
    }
    
    window.removeLogEntry = function(sectionId, idx) {
      if (window.customSectionData[sectionId]?.entries) {
        window.customSectionData[sectionId].entries.splice(idx, 1);
        // Re-render - need to get fields from config
        const sec = appSettings.sections.find(s => s.id === sectionId);
        if (sec?.config?.fields) {
          renderLogEntries(sectionId, sec.config.fields);
        }
        if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
      }
    };
    
    // Load custom sections data from server and update UI
    window.loadCustomSectionsData = function(data) {
      // Reset all custom section data first
      window.customSectionData = {};
      
      // Then load new data if provided
      if (data && typeof data === 'object') {
        window.customSectionData = data;
      }
      
      // Update UI for each custom section
      appSettings.sections.filter(s => s.custom).forEach(sec => {
        const sectionData = window.customSectionData[sec.id] || {};
        
        // Ensure data structure exists
        if (!window.customSectionData[sec.id]) {
          window.customSectionData[sec.id] = { value: null, entries: [] };
        }
        
        const type = sec.type;
        const config = sec.config || {};
        
        if (type === 'counter') {
          const val = sectionData.value || 0;
          const valEl = document.getElementById(`${sec.id}_value`);
          if (valEl) valEl.textContent = val;
          
          if (config.goalType === 'weekly') {
            // Update dots
            const dots = document.querySelectorAll(`#${sec.id} .counter-dot`);
            dots.forEach((dot, i) => dot.classList.toggle('on', i < val));
          } else {
            // Update progress bar
            const fill = document.getElementById(`${sec.id}_fill`);
            const goalNum = config.goalNumber || 6;
            if (fill) fill.style.height = Math.min(100, (val / goalNum) * 100) + '%';
          }
        
        } else if (type === 'checkbox') {
          const checkboxes = config.checkboxes || ['Done'];
          checkboxes.forEach((cb, i) => {
            const input = document.getElementById(`${sec.id}_check_${i}`);
            const chip = input?.closest('.chip');
            const isChecked = sectionData.checkboxes?.[i] || false;
            if (input) {
              input.checked = isChecked;
              chip?.classList.toggle('on', isChecked);
            }
          });
        
        } else if (type === 'text') {
          const input = document.getElementById(`${sec.id}_input`);
          if (input) {
            input.value = sectionData.value || '';
          }
        
        } else if (type === 'number') {
          const input = document.getElementById(`${sec.id}_input`);
          if (input) input.value = sectionData.value || '';
        
        } else if (type === 'time') {
          const input = document.getElementById(`${sec.id}_input`);
          if (input) input.value = sectionData.value || '';
        
        } else if (type === 'rating') {
          const val = sectionData.value || 0;
          const input = document.getElementById(`${sec.id}_input`);
          if (input) input.value = val;
          const stars = document.querySelectorAll(`#${sec.id}_stars .star`);
          stars.forEach((s, i) => {
            s.textContent = i < val ? '' : '';
            s.classList.toggle('filled', i < val);
          });
        
        } else if (type === 'toggle') {
          const input = document.getElementById(`${sec.id}_input`);
          const chip = document.getElementById(`${sec.id}_toggle`);
          const isChecked = sectionData.value || false;
          if (input) {
            input.checked = isChecked;
            chip?.classList.toggle('on', isChecked);
            const textEl = chip?.querySelector('.chip-text');
            if (textEl) textEl.textContent = isChecked ? 'Yes' : 'No';
          }
        
        } else if (type === 'log') {
          if (config.fields) {
            renderLogEntries(sec.id, config.fields);
          }
        }
      });
      
      // Update completion ring
      if (typeof updateCompletionRingAurora === 'function') {
        updateCompletionRingAurora();
      }
      
    };
    
    // Collect custom sections data from UI for saving
    window.collectCustomSectionsData = function() {
      appSettings.sections.filter(s => s.custom).forEach(sec => {
        if (!window.customSectionData[sec.id]) {
          window.customSectionData[sec.id] = { value: null, entries: [] };
        }
        
        const type = sec.type;
        const config = sec.config || {};
        
        if (type === 'checkbox') {
          const checkboxes = config.checkboxes || ['Done'];
          window.customSectionData[sec.id].checkboxes = checkboxes.map((cb, i) => {
            const input = document.getElementById(`${sec.id}_check_${i}`);
            return input?.checked || false;
          });
        
        } else if (type === 'text' || type === 'number' || type === 'time') {
          const input = document.getElementById(`${sec.id}_input`);
          window.customSectionData[sec.id].value = input?.value || '';
        
        } else if (type === 'toggle') {
          const input = document.getElementById(`${sec.id}_input`);
          window.customSectionData[sec.id].value = input?.checked || false;
        }
        // counter, rating, and log already update customSectionData directly
      });
      
      return window.customSectionData;
    };
    
    // Export/Import settings
    document.getElementById('exportSettingsBtn')?.addEventListener('click', () => {
      const data = JSON.stringify(appSettings, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'elevate-settings.json';
      a.click();
      URL.revokeObjectURL(url);
    });
    
    document.getElementById('importSettingsBtn')?.addEventListener('click', () => {
      document.getElementById('importSettingsFile').click();
    });
    
    document.getElementById('importSettingsFile')?.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (evt) => {
        try {
          const imported = JSON.parse(evt.target.result);
          appSettings = { ...defaultSettings, ...imported };
          saveSettings(appSettings);
          renderSectionList();
          applySectionSettings();
          currentTheme = getCurrentTheme();
          applyTheme(currentTheme, true);
          alert('Settings imported successfully!');
        } catch (err) {
          alert('Error importing settings: ' + err.message);
        }
      };
      reader.readAsText(file);
    });
    
    // Initialize section settings on load
    document.addEventListener('DOMContentLoaded', () => {
      applySectionSettings();
      
      // Recreate any custom sections
      appSettings.sections.filter(s => s.custom).forEach(sec => {
        if (!document.getElementById(sec.id)) {
          createCustomSection(sec.id, sec.name, sec.icon, sec.type, sec.config || {});
        }
      });
    });
    
    // Weekly Goals Review (Sunday)
    function getWeekKey() {
      const now = new Date();
      const sun = new Date(now);
      sun.setDate(now.getDate() - now.getDay());
      return 'weeklyReview-' + sun.toISOString().slice(0, 10);
    }

    function checkWeeklyReview() {
      const today = new Date();
      if (today.getDay() !== 0) return; // Only Sundays
      const key = getWeekKey();
      if (localStorage.getItem(key)) return; // Already shown this week
      populateWeeklyReview();
      document.getElementById('weeklyReviewModal').classList.add('show');
    }

    function populateWeeklyReview() {
      document.getElementById('wr-sleep').value = 7;
      document.getElementById('wr-agua').value = appSettings.aguaGoal || 6;
      document.getElementById('wr-steps').value = appSettings.stepsGoal || 7500;
      document.getElementById('wr-movement').value = appSettings.movementGoal || 2;
      document.getElementById('wr-rehit').value = appSettings.rehitGoal || 4;
      document.getElementById('wr-reading').value = appSettings.readingGoal || 60;
      document.getElementById('wr-meditation').value = appSettings.meditationGoal || 60;
    }

    window.closeWeeklyReview = function() {
      document.getElementById('weeklyReviewModal').classList.remove('show');
      localStorage.setItem(getWeekKey(), 'true');
    };

    window.saveWeeklyReview = function() {
      appSettings.aguaGoal = parseInt(document.getElementById('wr-agua').value) || 6;
      appSettings.stepsGoal = parseInt(document.getElementById('wr-steps').value) || 7500;
      appSettings.movementGoal = parseInt(document.getElementById('wr-movement').value) || 2;
      appSettings.rehitGoal = parseInt(document.getElementById('wr-rehit').value) || 4;
      appSettings.readingGoal = parseInt(document.getElementById('wr-reading').value) || 60;
      appSettings.meditationGoal = parseInt(document.getElementById('wr-meditation').value) || 60;
      saveSettings(appSettings);

      // Sync Settings page inputs if they exist
      const wg = document.getElementById('aguaGoal');
      const sg = document.getElementById('stepsGoal');
      const mg = document.getElementById('movementGoal');
      const rg = document.getElementById('rehitGoal');
      const rdg = document.getElementById('readingGoal');
      const mdg = document.getElementById('meditationGoal');
      if (wg) wg.value = appSettings.aguaGoal;
      if (sg) sg.value = appSettings.stepsGoal;
      if (mg) mg.value = appSettings.movementGoal;
      if (rg) rg.value = appSettings.rehitGoal;
      if (rdg) rdg.value = appSettings.readingGoal;
      if (mdg) mdg.value = appSettings.meditationGoal;

      document.getElementById('weeklyReviewModal').classList.remove('show');
      localStorage.setItem(getWeekKey(), 'true');
      if (typeof showToast === 'function') showToast('Goals locked in! Let\'s go.', 'success');
    };

    // Check after a short delay so the page finishes loading
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(checkWeeklyReview, 1500);
      document.getElementById('weeklyReviewModal').addEventListener('click', (e) => {
        if (e.target.id === 'weeklyReviewModal') closeWeeklyReview();
      });
    });

    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then((registration) => {
            console.log('SW registered:', registration.scope);
            // Force the browser to check for a new service worker immediately
            registration.update();
          })
          .catch((error) => {
            console.log('SW registration failed:', error);
          });
      });
    }

  </script>
</body>
</html>
