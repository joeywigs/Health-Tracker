<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Habits - Daily Rituals</title>
  <meta name="theme-color" content="#1a1a2e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="icon" type="image/png" href="apple-touch-icon.png">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="manifest" href="manifest.json">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* === NIGHT MODE (Default - Aurora/Twilight) === */
      --bg-deep: #1a1a2e;
      --bg-mid: #16213e;
      --bg-card: rgba(255,255,255,0.08);
      --bg-card-hover: rgba(255,255,255,0.12);
      
      --text: #ffffff;
      --text-dim: rgba(255,255,255,0.85);
      --text-muted: rgba(255,255,255,0.6);
      
      --accent-pink: #ff6b9d;
      --accent-orange: #ffa552;
      --accent-yellow: #ffd93d;
      --accent-teal: #6dd5ed;
      --accent-purple: #c471ed;
      
      --glow-pink: rgba(255,107,157,0.4);
      --glow-orange: rgba(255,165,82,0.4);
      --glow-teal: rgba(109,213,237,0.4);
      --glow-purple: rgba(196,113,237,0.4);
      
      --success: #6dd5ed;
      --success-soft: rgba(109,213,237,0.2);
      
      --sleep: #c471ed;
      --water: #6dd5ed;
      --movement: #ff6b9d;
      --nutrition: #6dd5ed;
      
      --border: rgba(255,255,255,0.2);
      --radius: 20px;
      --radius-sm: 12px;
      --radius-pill: 100px;
      
      /* Gradient backgrounds */
      --bg-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 25%, #1a1a2e 50%, #2d1b4e 75%, #1a1a2e 100%);
      --bg-aurora: 
        radial-gradient(ellipse at 20% 20%, rgba(196,113,237,0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(255,107,157,0.1) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, rgba(109,213,237,0.08) 0%, transparent 60%);
    }
    
    /* === DAY MODE - Soft Cantaloupe === */
    body.day-mode {
      --bg-deep: #ffeaa7;
      --bg-mid: #fdcb6e;
      --bg-card: rgba(255,255,255,0.6);
      --bg-card-hover: rgba(255,255,255,0.8);
      
      /* Dark text for contrast on light background */
      --text: #1a1a2e;
      --text-dim: rgba(26,26,46,0.8);
      --text-muted: rgba(26,26,46,0.6);
      
      /* Vibrant accents to pop against yellow-orange background */
      --accent-pink: #e11d48;
      --accent-orange: #ea580c;
      --accent-yellow: #ca8a04;
      --accent-teal: #0d9488;
      --accent-purple: #6366f1;
      
      --glow-pink: rgba(225,29,72,0.3);
      --glow-orange: rgba(234,88,12,0.3);
      --glow-teal: rgba(13,148,136,0.3);
      --glow-purple: rgba(99,102,241,0.4);
      
      --success: #059669;
      --success-soft: rgba(5,150,105,0.15);
      
      --sleep: #6366f1;
      --water: #0d9488;
      --movement: #e11d48;
      --nutrition: #059669;
      
      --border: rgba(0,0,0,0.1);
      
      /* Soft Cantaloupe gradient */
      background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 30%, #f9a825 70%, #fdcb6e 100%) !important;
    }
    
    body.day-mode::before {
      background: radial-gradient(ellipse at 30% 20%, rgba(255,234,167,0.5) 0%, transparent 50%) !important;
    }
    
    /* Day mode specific overrides - indigo/purple buttons on cantaloupe background */
    body.day-mode .logo {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      box-shadow: 0 0 20px var(--glow-purple);
    }
    body.day-mode .date-btn {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      box-shadow: 0 4px 15px var(--glow-purple);
      color: white;
    }
    body.day-mode .phase-fill {
      background: linear-gradient(90deg, #6366f1, #8b5cf6, #a855f7);
    }
    body.day-mode .fab {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      box-shadow: 0 8px 25px var(--glow-purple);
      color: white;
    }
    body.day-mode .btn-primary {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
    }
    body.day-mode .ring-progress {
      stroke: #6366f1;
    }
    body.day-mode .ring-text {
      color: #6366f1;
    }
    body.day-mode .chip.on {
      background: rgba(251, 146, 60, 0.25);
      border-color: #f97316;
      box-shadow: 0 0 10px rgba(249, 115, 22, 0.3);
    }
    body.day-mode .chip.on .chip-dot {
      background: #f97316;
      border-color: #f97316;
      color: white;
      box-shadow: 0 0 8px rgba(249, 115, 22, 0.4);
    }
    body.day-mode .water-btn {
      border-color: var(--accent-teal);
      color: var(--accent-teal);
    }
    body.day-mode .water-btn:hover {
      background: var(--accent-teal);
      color: white;
    }
    body.day-mode .water-num {
      color: var(--text);
    }
    body.day-mode .milestone-title {
      background: linear-gradient(90deg, var(--accent-orange), var(--accent-pink), var(--accent-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    body.day-mode .card {
      background: rgba(255,255,255,0.6);
      border-color: rgba(0,0,0,0.08);
    }
    body.day-mode .card-title {
      color: var(--text-muted);
    }
    body.day-mode .card-avg {
      color: var(--text-muted);
    }
    body.day-mode .section {
      background: rgba(255,255,255,0.6);
      border-color: rgba(0,0,0,0.08);
    }
    body.day-mode .sec-name {
      color: var(--text);
    }
    body.day-mode .nav-link {
      background: rgba(255,255,255,0.6);
      border-color: rgba(0,0,0,0.1);
      color: var(--text-dim);
    }
    body.day-mode .nav-link:hover {
      background: rgba(255,255,255,0.8);
      color: var(--accent-orange);
      border-color: var(--accent-orange);
    }
    body.day-mode .date-nav {
      background: rgba(255,255,255,0.6);
      border-color: rgba(0,0,0,0.08);
    }
    body.day-mode .date-main,
    body.day-mode .date-sub {
      color: var(--text);
    }
    body.day-mode .steps-bar-fill {
      background: linear-gradient(to top, #6366f1, #8b5cf6, #a855f7);
    }
    body.day-mode .water-bar-fill {
      background: linear-gradient(to top, var(--accent-teal), #14b8a6, #5eead4);
    }
    body.day-mode .big-input {
      color: var(--text);
    }
    body.day-mode .big-input::placeholder {
      color: var(--text-muted);
    }
    body.day-mode .chip-text {
      color: var(--text-dim);
    }
    body.day-mode .chip.on .chip-text {
      color: #1f2937;
    }
    body.day-mode .chip-dot {
      border-color: var(--text-muted);
    }
    /* Dark empty progress bars in day mode */
    body.day-mode .steps-bar-track,
    body.day-mode .water-bar-track {
      background: rgba(0,0,0,0.15);
    }
    body.day-mode .ring-bg {
      stroke: rgba(0,0,0,0.15);
    }
    body.day-mode .phase-track {
      background: rgba(0,0,0,0.12);
    }
    /* Darker collapse arrows */
    body.day-mode .sec-toggle {
      color: var(--text-dim);
    }
    
    /* === SUNSET TRANSITION MODE === */
    body.sunset-mode {
      --bg-deep: #2d1b4e;
      --bg-mid: #1a1a2e;
      --bg-card: rgba(255,255,255,0.06);
      --bg-card-hover: rgba(255,255,255,0.1);
      
      --text: #f0f0f0;
      --text-dim: rgba(255,255,255,0.7);
      --text-muted: rgba(255,255,255,0.5);
      
      --bg-gradient: linear-gradient(135deg, #2d1b4e 0%, #4a1942 30%, #1a1a2e 70%, #16213e 100%);
      --bg-aurora: 
        radial-gradient(ellipse at 50% 0%, rgba(255,107,157,0.2) 0%, transparent 50%),
        radial-gradient(ellipse at 30% 50%, rgba(255,165,82,0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 70% 80%, rgba(196,113,237,0.15) 0%, transparent 50%);
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    html { overscroll-behavior-y: contain; }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      min-height: 100vh;
      color: var(--text);
      padding: 16px;
      padding-bottom: 120px;
      font-size: 16px;
      line-height: 1.5;
      background: var(--bg-gradient);
      background-attachment: fixed;
      position: relative;
      transition: background 1s ease, color 0.5s ease;
      overscroll-behavior-y: contain;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--bg-aurora);
      pointer-events: none;
      z-index: 0;
      transition: background 1s ease;
    }
    
    body > * { position: relative; z-index: 1; }
    
    /* Theme indicator */
    .theme-indicator {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      color: var(--text-muted);
      background: var(--bg-card);
      padding: 4px 12px;
      border-radius: var(--radius-pill);
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 1001;
      backdrop-filter: blur(10px);
    }
    .theme-indicator.show {
      opacity: 1;
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--bg-deep);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .loading-overlay.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }
    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: var(--accent-pink);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .loading-text {
      margin-top: 16px;
      font-size: 14px;
      color: var(--text-muted);
    }
    body.day-mode .loading-overlay {
      background: linear-gradient(135deg, #fef3e2 0%, #fce7c8 50%, #fff9f0 100%);
    }
    body.day-mode .loading-spinner {
      border-color: rgba(0,0,0,0.1);
      border-top-color: var(--accent-orange);
    }
    body.day-mode .loading-text {
      color: #6b7280;
    }
    
    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 12px 24px;
      border-radius: var(--radius-pill);
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      backdrop-filter: blur(20px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 10000;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .toast.show {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }
    .toast.success {
      border-color: var(--success);
      box-shadow: 0 0 20px var(--glow-teal);
    }
    .toast.error {
      border-color: #ef4444;
      box-shadow: 0 0 20px rgba(239,68,68,0.4);
    }
    body.day-mode .toast {
      background: rgba(255,255,255,0.95);
      color: #1f2937;
    }
    
    /* Pull to Refresh */
    .pull-indicator {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%) translateY(-100%);
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 8px 16px;
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
      font-size: 12px;
      color: var(--text-muted);
      backdrop-filter: blur(10px);
      transition: transform 0.2s;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .pull-indicator.visible {
      transform: translateX(-50%) translateY(0);
    }
    .pull-indicator .pull-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.2);
      border-top-color: var(--accent-teal);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    body.day-mode .pull-indicator {
      background: rgba(255,255,255,0.9);
      color: #6b7280;
    }
    body.day-mode .pull-indicator .pull-spinner {
      border-color: rgba(0,0,0,0.1);
      border-top-color: var(--accent-orange);
    }
      --radius-pill: 100px;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      min-height: 100vh;
      color: var(--text);
      padding: 16px;
      padding-top: max(66px, calc(12px + env(safe-area-inset-top, 54px)));
      padding-bottom: calc(120px + env(safe-area-inset-bottom, 0px));
      padding-left: calc(16px + env(safe-area-inset-left, 0px));
      padding-right: calc(16px + env(safe-area-inset-right, 0px));
      font-size: 16px;
      line-height: 1.5;
      
      /* Aurora gradient background */
      background: linear-gradient(135deg, 
        #1a1a2e 0%, 
        #16213e 25%, 
        #1a1a2e 50%,
        #2d1b4e 75%,
        #1a1a2e 100%
      );
      background-attachment: fixed;
      position: relative;
    }
    
    /* Animated aurora glow overlay */
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: 
        radial-gradient(ellipse at 20% 20%, rgba(196,113,237,0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(255,107,157,0.1) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, rgba(109,213,237,0.08) 0%, transparent 60%);
      pointer-events: none;
      z-index: 0;
    }
    
    body > * { position: relative; z-index: 1; }
    
    /* Header */
    .header { 
      padding: 20px; 
      margin-bottom: 20px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: var(--radius);
      backdrop-filter: blur(20px);
    }
    body.day-mode .header {
      background: rgba(255,255,255,0.6);
      border-color: rgba(0,0,0,0.08);
    }
    .header-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; }
    .brand { display: flex; align-items: center; gap: 12px; }
    .logo {
      width: 48px; height: 48px; border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-pink), var(--accent-purple));
      display: flex; align-items: center; justify-content: center; font-size: 22px;
      box-shadow: 0 0 30px var(--glow-pink), 0 0 60px var(--glow-purple);
      animation: pulse-glow 3s ease-in-out infinite;
    }
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px var(--glow-pink), 0 0 40px var(--glow-purple); }
      50% { box-shadow: 0 0 30px var(--glow-pink), 0 0 60px var(--glow-purple); }
    }
    .brand h1 { font-family: 'Space Grotesk', sans-serif; font-size: 32px; font-weight: 700; letter-spacing: -0.02em; color: white; margin: 0; }
    .brand h1 .version { font-size: 12px; font-weight: 500; color: var(--text-muted); vertical-align: super; margin-left: 4px; }
    body.day-mode .brand h1 { color: #1f2937; }
    .brand .tagline { font-size: 16px; font-weight: 600; color: var(--accent-pink); margin-top: 2px; }
    .phase-day { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    .nav-links { display: flex; gap: 8px; }
    .nav-link {
      width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border);
      background: var(--bg-card); color: var(--text-dim); font-size: 15px; cursor: pointer;
      display: flex; align-items: center; justify-content: center; text-decoration: none;
      transition: all 0.3s; backdrop-filter: blur(10px);
    }
    .nav-link:hover { 
      background: var(--bg-card-hover); 
      color: var(--accent-teal); 
      border-color: var(--accent-teal);
      box-shadow: 0 0 20px var(--glow-teal);
    }
    
    /* Date Nav - Glassmorphism */
    .date-nav {
      display: grid; 
      grid-template-columns: auto 1fr auto auto;
      align-items: center; 
      gap: 12px; 
      padding: 16px;
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius); backdrop-filter: blur(20px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    .date-nav .phase {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }
    .date-btn {
      width: 44px; height: 44px; border-radius: 50%; border: none;
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));
      color: white; font-size: 18px; font-weight: 600;
      cursor: pointer; transition: all 0.3s;
      box-shadow: 0 4px 15px var(--glow-purple);
    }
    .date-btn:hover { transform: scale(1.1); box-shadow: 0 6px 25px var(--glow-pink); }
    .date-btn:active { transform: scale(0.95); }
    .date-center { flex: 1; text-align: center; }
    .date-phase-title { font-family: 'Space Grotesk', sans-serif; font-size: 14px; font-weight: 700; color: var(--accent-green); margin-bottom: 2px; }
    .date-main { font-family: 'Space Grotesk', sans-serif; font-size: 16px; font-weight: 600; color: white; }
    .date-phase-day { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    .freeze-indicator {
      font-size: 10px; color: #6dd5ed; margin-top: 2px;
      font-family: 'JetBrains Mono', monospace;
    }
    .freeze-btn {
      font-size: 12px; padding: 6px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.05);
      color: var(--text-muted);
      font-family: 'Space Grotesk', sans-serif;
      cursor: pointer; transition: all 0.2s;
      white-space: nowrap;
    }
    .freeze-btn:hover { border-color: #6dd5ed; color: #6dd5ed; }
    .freeze-btn.frozen {
      border-color: #6dd5ed;
      background: rgba(109,213,237,0.15);
      color: #6dd5ed;
    }
    .frozen-badge {
      font-size: 11px; color: #6dd5ed;
      font-family: 'JetBrains Mono', monospace;
    }
    body.day-mode .freeze-btn { background: rgba(0,0,0,0.03); }
    body.day-mode .freeze-btn.frozen { background: rgba(109,213,237,0.1); }
    .date-sub { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

    /* Day Lock - prevents accidental edits on past days */
    .day-locked #healthForm input:not([type="hidden"]),
    .day-locked #healthForm textarea,
    .day-locked #healthForm select,
    .day-locked #healthForm button:not(.unlock-day-btn):not(.start-walk-btn),
    .day-locked .mini-supp,
    .day-locked .checkbox-field,
    .day-locked .chip,
    .day-locked .water-btn,
    .day-locked .section-item-drag {
      pointer-events: none;
      opacity: 0.6;
    }
    .day-locked .sec-head { pointer-events: auto; opacity: 1; }
    .unlock-banner {
      display: none;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 10px 16px;
      background: linear-gradient(135deg, rgba(255,159,28,0.15), rgba(230,57,70,0.15));
      border: 1px solid rgba(255,159,28,0.3);
      border-radius: var(--radius);
      margin-bottom: 12px;
      font-size: 13px;
      color: var(--text-muted);
    }
    .day-locked .unlock-banner { display: flex; }
    .unlock-day-btn {
      padding: 6px 14px;
      font-size: 12px;
      font-weight: 600;
      background: linear-gradient(135deg, var(--accent-orange), var(--accent-pink));
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
    }
    .unlock-day-btn:hover { transform: scale(1.05); box-shadow: 0 4px 15px var(--glow-orange); }
    
    /* Progress Ring - Glowing */
    .ring-wrap { position: relative; width: 72px; height: 72px; }
    .ring { transform: rotate(-90deg); }
    .ring-bg { fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 5; }
    .ring-progress { 
      fill: none; 
      stroke: url(#auroraGrad); 
      stroke-width: 5; 
      stroke-linecap: round; 
      transition: stroke-dashoffset 0.6s;
      filter: drop-shadow(0 0 6px var(--glow-teal));
    }
    .ring-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-family: 'Space Grotesk', sans-serif; font-size: 18px; font-weight: 700; color: var(--accent-teal); }
    .ring-text.celebrating { animation: ringTextPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
    @keyframes ringTextPop {
      0% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.5); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }

    /* Ring Completion Celebration */
    .ring-celebration {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9999;
      overflow: hidden;
    }
    .ring-celebration .particle {
      position: absolute;
      border-radius: 50%;
      pointer-events: none;
    }
    .ring-celebration .confetti {
      width: 10px;
      height: 10px;
      animation: confettiFall 3s ease-out forwards;
    }
    @keyframes confettiFall {
      0% { transform: translateY(0) rotate(0deg) scale(1); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg) scale(0); opacity: 0; }
    }
    .ring-celebration .firework {
      width: 6px;
      height: 6px;
      animation: fireworkBurst 1s ease-out forwards;
    }
    @keyframes fireworkBurst {
      0% { transform: translate(0, 0) scale(1); opacity: 1; }
      100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
    }
    .ring-celebration .sparkle {
      width: 4px;
      height: 4px;
      background: gold;
      box-shadow: 0 0 6px gold, 0 0 12px orange;
      animation: sparkleFloat 2s ease-out forwards;
    }
    @keyframes sparkleFloat {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      50% { opacity: 1; }
      100% { transform: translateY(100vh) scale(0.5); opacity: 0; }
    }
    .ring-celebration .star {
      font-size: 24px;
      animation: starBurst 1.5s ease-out forwards;
    }
    @keyframes starBurst {
      0% { transform: translate(0, 0) scale(0) rotate(0deg); opacity: 1; }
      50% { transform: translate(var(--tx), var(--ty)) scale(1.2) rotate(180deg); opacity: 1; }
      100% { transform: translate(calc(var(--tx) * 1.5), calc(var(--ty) * 1.5)) scale(0) rotate(360deg); opacity: 0; }
    }
    .ring-celebration .ring-pulse {
      position: absolute;
      border-radius: 50%;
      border: 3px solid;
      animation: ringPulse 1s ease-out forwards;
    }
    @keyframes ringPulse {
      0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(4); opacity: 0; }
    }
    .ring-celebration .emoji-burst {
      font-size: 32px;
      animation: emojiBurst 2s ease-out forwards;
    }
    @keyframes emojiBurst {
      0% { transform: translate(0, 0) scale(0); opacity: 1; }
      20% { transform: translate(0, 0) scale(1.3); opacity: 1; }
      100% { transform: translate(var(--tx), var(--ty)) scale(0.5); opacity: 0; }
    }
    .ring-glow-burst {
      animation: glowBurst 0.8s ease-out;
    }
    @keyframes glowBurst {
      0% { filter: drop-shadow(0 0 6px var(--glow-teal)); }
      50% { filter: drop-shadow(0 0 30px var(--glow-teal)) drop-shadow(0 0 60px var(--glow-pink)); }
      100% { filter: drop-shadow(0 0 6px var(--glow-teal)); }
    }

    /* Awareness Buttons Section */
    .awareness-section {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: var(--radius);
      padding: 18px;
      margin-bottom: 12px;
      backdrop-filter: blur(20px);
    }
    .awareness-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .cue-detected-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px 6px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: rgba(255,255,255,0.05);
      color: var(--text-muted);
      font-family: 'Space Grotesk', sans-serif;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      gap: 6px;
    }
    .cue-detected-btn:hover {
      background: rgba(196,113,237,0.15);
      border-color: var(--accent-purple);
    }
    .cue-detected-btn:active {
      transform: scale(0.97);
    }
    .cue-detected-btn .cue-icon {
      display: none;
    }
    .habit-spotted-btn:hover {
      background: rgba(109,213,237,0.15);
      border-color: var(--accent-teal);
    }
    body.day-mode .awareness-section {
      background: rgba(255,255,255,0.6);
      border-color: rgba(0,0,0,0.08);
    }
    body.day-mode .cue-detected-btn {
      background: rgba(0,0,0,0.05);
    }
    /* Habit Spotted Grid */
    .habit-spotted-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-bottom: 14px;
    }
    .habit-spotted-item {
      padding: 12px 8px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-family: 'Space Grotesk', sans-serif;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    .habit-spotted-item:hover {
      background: rgba(109,213,237,0.15);
      border-color: var(--accent-teal);
    }
    .habit-spotted-item.selected {
      background: rgba(109,213,237,0.25);
      border-color: var(--accent-teal);
      box-shadow: 0 0 10px var(--glow-teal);
    }
    body.day-mode .habit-spotted-item {
      background: rgba(0,0,0,0.03);
    }
    body.day-mode .habit-spotted-item:hover,
    body.day-mode .habit-spotted-item.selected {
      background: rgba(109,213,237,0.15);
    }

    /* Cue Modal */
    .cue-modal {
      position: fixed;
      inset: 0;
      background: rgba(26,26,46,0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2500;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      backdrop-filter: blur(15px);
      padding: 20px;
    }
    .cue-modal.show {
      opacity: 1;
      pointer-events: auto;
    }
    .cue-modal-content {
      background: var(--bg-mid);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      width: 100%;
      max-width: 400px;
      padding: 24px;
      animation: pop 0.3s cubic-bezier(0.34,1.56,0.64,1);
    }
    .cue-modal-header {
      text-align: center;
      margin-bottom: 20px;
    }
    .cue-modal-header .cue-emoji {
      font-size: 48px;
      margin-bottom: 10px;
    }
    .cue-modal-header h3 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 20px;
      font-weight: 700;
      margin: 0;
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-teal));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .cue-modal-header p {
      color: var(--text-muted);
      font-size: 13px;
      margin: 8px 0 0 0;
    }
    .cue-timestamp {
      text-align: center;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 16px;
      padding: 8px;
      background: rgba(255,255,255,0.05);
      border-radius: var(--radius-sm);
    }
    .cue-note-input {
      width: 100%;
      padding: 14px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 15px;
      resize: none;
      min-height: 100px;
      margin-bottom: 16px;
    }
    .cue-note-input:focus {
      outline: none;
      border-color: var(--accent-purple);
      box-shadow: 0 0 10px var(--glow-purple);
    }
    .cue-note-input::placeholder {
      color: var(--text-muted);
    }
    .cue-modal-buttons {
      display: flex;
      gap: 12px;
    }
    .cue-modal-buttons button {
      flex: 1;
      padding: 12px;
      border-radius: var(--radius);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .cue-cancel-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid var(--border);
      color: var(--text-muted);
    }
    .cue-cancel-btn:hover {
      background: rgba(255,255,255,0.15);
      color: var(--text);
    }
    .cue-save-btn {
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-teal));
      border: none;
      color: white;
    }
    .cue-save-btn:hover {
      box-shadow: 0 0 20px var(--glow-purple);
      transform: scale(1.02);
    }

    /* Full Screen Cue Celebration */
    .cue-celebration {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, rgba(26,26,46,0.98), rgba(50,30,80,0.98));
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s;
      backdrop-filter: blur(20px);
      overflow: hidden;
    }
    .cue-celebration.show {
      opacity: 1;
      pointer-events: auto;
    }
    .cue-celebration-content {
      text-align: center;
      z-index: 1;
      padding: 40px;
    }
    .cue-celebration-emoji {
      font-size: 80px;
      animation: celebrationBounce 0.6s cubic-bezier(0.34,1.56,0.64,1);
    }
    @keyframes celebrationBounce {
      0% { transform: scale(0) rotate(-20deg); }
      60% { transform: scale(1.2) rotate(10deg); }
      100% { transform: scale(1) rotate(0deg); }
    }
    .cue-celebration-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 28px;
      font-weight: 700;
      margin: 20px 0 10px;
      background: linear-gradient(135deg, #ffd93d, #ff6b9d, #c471ed, #6dd5ed);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: titleSlide 0.5s ease-out 0.2s both;
    }
    @keyframes titleSlide {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .cue-celebration-subtitle {
      font-size: 16px;
      color: var(--text-muted);
      max-width: 300px;
      margin: 0 auto;
      animation: titleSlide 0.5s ease-out 0.4s both;
      line-height: 1.5;
    }
    .cue-celebration-dismiss {
      margin-top: 30px;
      padding: 14px 40px;
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));
      border: none;
      border-radius: var(--radius-pill);
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      animation: titleSlide 0.5s ease-out 0.6s both;
      transition: all 0.2s;
    }
    .cue-celebration-dismiss:hover {
      transform: scale(1.05);
      box-shadow: 0 0 30px var(--glow-pink);
    }
    .cue-celebration-particles {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    /* Phase Bar */
    .phase { margin-top: 0; }
    .phase-label { display: flex; justify-content: space-between; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 8px; }
    .phase-track { height: 6px; background: rgba(255,255,255,0.1); border-radius: var(--radius-pill); overflow: hidden; }
    .phase-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-purple), var(--accent-pink), var(--accent-orange));
      border-radius: var(--radius-pill);
      box-shadow: 0 0 20px var(--glow-pink);
      transition: width 0.6s;
    }
    .sync-btns { display: flex; gap: 8px; justify-content: center; margin-top: 8px; }
    .sync-shortcut-btn { padding: 5px 14px; font-size: 11px; font-weight: 600; border: 1px solid var(--border); border-radius: var(--radius-pill); background: rgba(255,255,255,0.04); color: var(--text-muted); cursor: pointer; transition: all 0.2s; }
    .sync-shortcut-btn:hover { background: rgba(255,255,255,0.08); color: var(--text); border-color: var(--accent-teal); }
    .sync-shortcut-btn.syncing { opacity: 0.5; pointer-events: none; }
    .sync-shortcut-btn.done { border-color: var(--accent-teal); color: var(--accent-teal); }
    body.day-mode .sync-shortcut-btn { background: rgba(0,0,0,0.03); }
    body.day-mode .sync-shortcut-btn:hover { background: rgba(0,0,0,0.06); border-color: var(--accent-orange); color: var(--accent-orange); }
    body.day-mode .sync-shortcut-btn.done { border-color: var(--accent-orange); color: var(--accent-orange); }
    
    /* Cards - Glowing borders on hover */
    .quick-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
    
    /* REHIT full-width card */
    .rehit-full {
      margin-bottom: 16px;
      min-height: auto;
    }
    .rehit-freeze-overlay {
      position: absolute;
      inset: 0;
      background: rgba(10, 15, 30, 0.85);
      backdrop-filter: blur(4px);
      border-radius: inherit;
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }
    .rehit-freeze-icon { font-size: 28px; }
    .rehit-freeze-text {
      font-family: 'Space Grotesk', sans-serif;
      font-weight: 600;
      font-size: 15px;
      color: #6dd5ed;
    }
    .rehit-freeze-sub {
      font-size: 11px;
      color: var(--text-muted);
      font-family: 'JetBrains Mono', monospace;
    }
    body.day-mode .rehit-freeze-overlay {
      background: rgba(245, 248, 255, 0.88);
    }
    .summary-freeze-banner {
      background: rgba(109, 213, 237, 0.1);
      border: 1px solid rgba(109, 213, 237, 0.3);
      border-radius: 12px;
      padding: 10px 14px;
      font-size: 12px;
      color: #6dd5ed;
      text-align: center;
      font-family: 'Space Grotesk', sans-serif;
      margin-bottom: 12px;
    }
    body.day-mode .summary-freeze-banner {
      background: rgba(109, 213, 237, 0.08);
      color: #0891b2;
      border-color: rgba(8, 145, 178, 0.2);
    }
    .rehit-layout {
      display: flex;
      gap: 20px;
      align-items: flex-end;
    }
    .rehit-left {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .rehit-chips {
      flex-direction: column;
      gap: 8px;
    }
    .rehit-chip {
      padding: 10px 16px;
    }
    .rehit-chip .chip-dot {
      width: 22px;
      height: 22px;
      font-size: 12px;
    }
    .rehit-chip .chip-text {
      font-size: 15px;
      font-weight: 600;
    }
    .rehit-week-count {
      margin-top: auto;
      padding-top: 0;
    }
    .rehit-right {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding-left: 20px;
      border-left: 1px solid var(--border);
    }
    .rehit-stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px 24px;
    }
    .rehit-stat {
      text-align: center;
    }
    .rehit-stat-label {
      display: block;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: var(--text-muted);
      margin-bottom: 2px;
    }
    .rehit-stat-value {
      display: block;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 20px;
      font-weight: 700;
    }
    .rehit-stat-input {
      display: block;
      width: 100%;
      background: transparent;
      border: none;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 20px;
      font-weight: 700;
      text-align: center;
      outline: none;
    }
    .rehit-stat-input::placeholder { color: var(--text-muted); opacity: 0.5; }
    .rehit-stat-input:focus { background: rgba(255,255,255,0.05); border-radius: 4px; }
    .rehit-edit-btn {
      display: none; /* Hidden - no longer used */
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-pill);
      background: rgba(255,255,255,0.06);
      color: var(--text-dim);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .rehit-edit-btn .chip-dot {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 2px solid var(--accent-pink);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: var(--accent-pink);
      transition: all 0.3s;
    }
    .rehit-edit-btn:hover {
      background: rgba(236, 72, 153, 0.1);
      border-color: var(--accent-pink);
    }
    .rehit-edit-btn:hover .chip-dot {
      background: var(--accent-pink);
      color: white;
      box-shadow: 0 0 10px var(--glow-pink);
    }
    body.day-mode .rehit-edit-btn {
      background: rgba(0,0,0,0.05);
    }
    
    .card {
      background: rgba(255,255,255,0.06); 
      border: 1px solid rgba(255,255,255,0.15); 
      border-radius: var(--radius);
      padding: 18px; 
      position: relative; 
      overflow: hidden; 
      backdrop-filter: blur(20px);
      transition: all 0.3s;
      display: flex;
      flex-direction: column;
      min-height: 140px;
    }
    .card::before { 
      content: ''; 
      position: absolute; 
      top: 0; left: 0; right: 0; 
      height: 3px; 
      background: linear-gradient(90deg, var(--accent-start, var(--accent-purple)), var(--accent-end, var(--accent-pink))); 
      opacity: 0.8; 
    }
    .card:hover { 
      border-color: rgba(255,255,255,0.25);
      box-shadow: 0 0 30px var(--card-glow, var(--glow-purple));
      transform: translateY(-2px);
    }
    .card.sleep { --accent-start: var(--accent-purple); --accent-end: var(--accent-pink); --card-glow: var(--glow-purple); }
    .card.water { --accent-start: var(--accent-teal); --accent-end: var(--accent-purple); --card-glow: var(--glow-teal); }
    .card.movement { --accent-start: var(--accent-pink); --accent-end: var(--accent-orange); --card-glow: var(--glow-pink); }
    
    .card-head { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
    .card-icon { 
      width: 32px; height: 32px; border-radius: 50%; 
      display: flex; align-items: center; justify-content: center; font-size: 15px; 
      background: linear-gradient(135deg, var(--accent-start, var(--accent-purple)), var(--accent-end, var(--accent-pink)));
      box-shadow: 0 0 15px var(--card-glow, var(--glow-purple));
    }
    .card-title { font-size: 12px; font-weight: 600; color: rgba(255,255,255,0.8); text-transform: uppercase; letter-spacing: 0.05em; }
    .card-value { font-family: 'Space Grotesk', sans-serif; font-size: 32px; font-weight: 700; line-height: 1; color: #ffffff; }
    .card-unit { font-size: 13px; color: var(--text); margin-left: 4px; }
    .input-row { display: flex; align-items: baseline; }
    .card-avg { font-size: 11px; color: rgba(255,255,255,0.5); margin-top: auto; padding-top: 8px; }
    
    
    /* Counter dots (for weekly goals) */
    .counter-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      transition: all 0.3s;
    }
    .counter-dot.on {
      background: var(--accent-teal);
      box-shadow: 0 0 8px var(--glow-teal);
    }
    body.day-mode .counter-dot {
      background: rgba(0,0,0,0.15);
    }
    body.day-mode .counter-dot.on {
      background: var(--success);
      box-shadow: 0 0 8px rgba(5,150,105,0.4);
    }
    
    /* Rating stars */
    .rating-stars {
      display: flex;
      gap: 8px;
      font-size: 28px;
    }
    .star {
      cursor: pointer;
      color: rgba(255,255,255,0.3);
      transition: all 0.2s;
    }
    .star:hover, .star.filled {
      color: var(--accent-orange);
      text-shadow: 0 0 10px var(--glow-orange);
    }
    body.day-mode .star {
      color: rgba(0,0,0,0.2);
    }
    body.day-mode .star:hover, body.day-mode .star.filled {
      color: var(--accent-orange);
    }
    
    /* Custom log modal */
    #customLogModal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    #customLogModal.show {
      display: flex;
    }
    #customLogModal .modal-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
    }
    #customLogModal .modal-content {
      position: relative;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }
    #customLogModal .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    #customLogModal .modal-header h3 {
      margin: 0;
      font-size: 18px;
    }
    body.day-mode #customLogModal .modal-content {
      background: rgba(255,255,255,0.95);
    }

    /* Phase System Styles */
    .phase-transition-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 16px;
      z-index: 1000;
      display: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .phase-banner-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 600px;
      margin: 0 auto;
    }
    .phase-banner-content span {
      font-weight: 500;
    }
    .phase-banner-content button {
      background: white;
      color: #667eea;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      cursor: pointer;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(4px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1001;
    }
    .phase-modal {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      max-height: 85vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }
    .modal-header h2 {
      margin: 0;
      font-size: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }
    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }
    .modal-footer {
      display: flex;
      gap: 12px;
      padding: 16px 20px;
      border-top: 1px solid var(--border);
    }
    .modal-footer button {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      border: none;
    }
    .btn-secondary {
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border) !important;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .phase-modal-info {
      margin-bottom: 20px;
    }
    .phase-modal-info p {
      margin: 0 0 8px;
      color: var(--text-muted);
    }
    .phase-dates {
      font-weight: 500;
      color: var(--text) !important;
    }

    .phase-goals-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .phase-goal-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
    }
    .phase-goal-info {
      flex: 1;
    }
    .phase-goal-name {
      display: block;
      font-weight: 500;
      margin-bottom: 4px;
    }
    .phase-goal-current {
      font-size: 12px;
      color: var(--text-muted);
    }
    .phase-goal-input {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .phase-goal-input input[type="number"] {
      width: 70px;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text);
      text-align: center;
      font-size: 16px;
    }
    .phase-goal-input input[type="checkbox"] {
      width: 24px;
      height: 24px;
    }
    .phase-goal-unit {
      font-size: 12px;
      color: var(--text-muted);
    }

    .suggestion-good { color: #4CAF50; font-size: 11px; display: block; margin-top: 4px; }
    .suggestion-ok { color: #FF9800; font-size: 11px; display: block; margin-top: 4px; }
    .suggestion-work { color: #f44336; font-size: 11px; display: block; margin-top: 4px; }

    /* Phase performance review */
    .phase-performance-review {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .phase-stat-row {
      display: flex;
      align-items: flex-start;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }
    .phase-stat-row:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }
    .phase-stat-row:first-of-type {
      padding-top: 0;
    }
    .phase-stat-label {
      width: 100px;
      font-weight: 500;
      color: var(--text);
      font-size: 13px;
      flex-shrink: 0;
    }
    .phase-stat-details {
      flex: 1;
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.5;
    }
    .stat-highlight {
      color: var(--text);
      font-weight: 600;
    }
    .stat-pct {
      color: var(--accent-teal);
      font-weight: 500;
    }
    .stat-avg {
      color: var(--text-muted);
      font-size: 12px;
    }

    /* Phase selector */
    .summary-controls {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      flex-wrap: wrap;
      align-items: stretch;
    }
    .summary-controls .btn {
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .phase-selector {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--card);
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
    }

    /* Phase Comparison */
    .comparison-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .comparison-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-muted);
      cursor: pointer;
    }
    .comparison-selectors {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
    }
    .comparison-vs {
      color: var(--text-muted);
      font-weight: 500;
    }
    .comparison-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .comparison-row {
      display: grid;
      grid-template-columns: 1fr 80px 80px 60px;
      gap: 8px;
      align-items: center;
      padding: 10px 12px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
    }
    .comparison-row.header {
      background: transparent;
      border: none;
      font-weight: 600;
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
    }
    .comparison-goal-name {
      font-weight: 500;
    }
    .comparison-goal-target {
      font-size: 12px;
      color: var(--text-muted);
    }
    .comparison-value {
      text-align: center;
      font-weight: 600;
    }
    .comparison-change {
      text-align: center;
      font-size: 13px;
      font-weight: 600;
    }
    .comparison-change.positive { color: #4CAF50; }
    .comparison-change.negative { color: #f44336; }
    .comparison-change.neutral { color: var(--text-muted); }

    /* Phase Goals Section */
    .phase-goals-content {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 12px;
    }
    .phase-goal-card {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
    }
    .phase-goal-card .goal-icon {
      font-size: 18px;
    }
    .phase-goal-card .goal-details {
      flex: 1;
    }
    .phase-goal-card .goal-name {
      font-size: 12px;
      color: var(--text-muted);
    }
    .phase-goal-card .goal-target {
      font-weight: 600;
      font-size: 12px;
    }
    #phaseGoalsSection .sec-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Mini Supplements (in own card) */
    .mini-supps-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 8px;
    }
    .mini-supp {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px 6px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: rgba(255,255,255,0.05);
      cursor: pointer;
      transition: all 0.2s;
    }
    .mini-supp input {
      display: none;
    }
    .mini-supp span {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
    }
    .mini-supp:has(input:checked) {
      background: var(--success-soft);
      border-color: var(--success);
      box-shadow: 0 0 10px var(--glow-teal);
    }
    .mini-supp:has(input:checked) span {
      color: white;
    }
    body.day-mode .mini-supp {
      background: rgba(0,0,0,0.05);
    }
    body.day-mode .mini-supp:has(input:checked) {
      background: rgba(251, 146, 60, 0.25);
      border-color: #f97316;
      box-shadow: 0 0 8px rgba(249, 115, 22, 0.3);
    }
    body.day-mode .mini-supp:has(input:checked) span {
      color: #1f2937;
    }
    .card.supplements {
      --accent-start: var(--accent-teal);
      --accent-end: var(--accent-purple);
      --card-glow: var(--glow-teal);
    }
    .mini-supps-grid.three-col {
      grid-template-columns: 1fr 1fr 1fr;
    }
    
    /* Horizontal Progress Bars (same style as phase bar) */
    .progress-bar-h {
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: var(--radius-pill);
      overflow: hidden;
      margin-top: 10px;
    }
    .progress-bar-h-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-purple), var(--accent-pink), var(--accent-orange));
      border-radius: var(--radius-pill);
      box-shadow: 0 0 10px var(--glow-pink);
      transition: width 0.5s ease;
      width: 0%;
    }
    body.day-mode .progress-bar-h {
      background: rgba(0,0,0,0.1);
    }
    
    /* Movement Modal */
    .movement-types {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }
    .movement-type-btn {
      padding: 20px 10px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg-card);
      color: var(--text);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .movement-type-btn .type-icon {
      font-size: 28px;
    }
    .movement-type-btn.selected {
      border-color: var(--accent-teal);
      background: rgba(45, 212, 191, 0.15);
      box-shadow: 0 0 20px var(--glow-teal);
    }
    .duration-section {
      margin-bottom: 0;
    }
    .duration-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 12px;
    }
    .duration-presets {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .duration-preset {
      flex: 1;
      min-width: 50px;
      padding: 12px 8px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg-card);
      color: var(--text);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    .duration-preset.selected {
      border-color: var(--accent-pink);
      background: rgba(236, 72, 153, 0.15);
      box-shadow: 0 0 15px var(--glow-pink);
    }
    .duration-custom-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 12px;
    }
    .duration-custom-row input {
      width: 80px;
      padding: 10px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg-card);
      color: var(--text);
      font-size: 18px;
      font-weight: 600;
      text-align: center;
    }
    .duration-custom-row input:focus {
      outline: none;
      border-color: var(--accent-pink);
    }
    .duration-custom-row span {
      color: var(--text-muted);
      font-size: 14px;
    }
    #movementModal .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    body.day-mode .movement-type-btn,
    body.day-mode .duration-preset,
    body.day-mode .duration-custom-row input {
      background: rgba(255,255,255,0.5);
    }

    /* Reading Modal */
    .reading-field {
      margin-bottom: 20px;
    }
    .reading-field:last-child {
      margin-bottom: 0;
    }
    .reading-label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 10px;
    }
    .reading-input {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg-card);
      color: var(--text);
      font-size: 15px;
      font-family: 'Inter', -apple-system, sans-serif;
    }
    .reading-input:focus {
      outline: none;
      border-color: var(--accent-purple);
      box-shadow: 0 0 15px var(--glow-purple);
    }
    .reading-input::placeholder {
      color: var(--text-muted);
    }
    #readingModal .duration-preset.selected {
      border-color: var(--accent-purple);
      background: rgba(196, 113, 237, 0.15);
      box-shadow: 0 0 15px var(--glow-purple);
    }
    #readingModal .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    body.day-mode .reading-input {
      background: rgba(255,255,255,0.5);
    }

    .big-input { width: auto; flex: 1; min-width: 0; background: transparent; border: none; font-family: 'Space Grotesk', sans-serif; font-size: 32px; font-weight: 700; color: white; outline: none; transition: color 0.3s; }
    .big-input::placeholder { color: var(--text-muted); }
    .big-input:focus { color: var(--accent-teal); }
    
    /* Water */
    .water-row { display: flex; align-items: center; gap: 12px; justify-content: center; }
    .water-btn { 
      width: 44px; height: 44px; border-radius: 50%; 
      border: 2px solid var(--accent-teal); background: transparent; 
      color: var(--accent-teal); font-size: 18px; cursor: pointer; transition: all 0.3s; 
    }
    .water-btn:hover { 
      background: var(--accent-teal); 
      color: var(--bg-deep); 
      box-shadow: 0 0 20px var(--glow-teal);
    }
    .water-btn:active { transform: scale(0.9); }
    .water-num { font-family: 'Space Grotesk', sans-serif; font-size: 32px; font-weight: 700; min-width: 44px; text-align: center; color: white; }
    
    /* Sections */
    .section {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: var(--radius);
      padding: 18px;
      margin-bottom: 12px;
      backdrop-filter: blur(20px);
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }
    .section::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--icon-start, var(--accent-purple)), var(--icon-end, var(--accent-pink)));
      opacity: 0.8;
    }
    .section:hover { border-color: rgba(255,255,255,0.2); }

    .reminder-card {
      background: rgba(249, 115, 22, 0.35);
      border: 1px solid rgba(249, 115, 22, 0.55);
      border-radius: var(--radius);
      padding: 18px;
      margin-bottom: 12px;
      text-align: center;
      backdrop-filter: blur(20px);
    }
    .reminder-card .reminder-icon { font-size: 28px; margin-bottom: 6px; }
    .reminder-card .reminder-title { font-size: 15px; font-weight: 600; color: var(--text); }
    .reminder-card .reminder-sub { font-size: 12px; color: var(--text-dim); margin-top: 4px; }
    .reminder-card .reminder-close { position: absolute; top: 8px; right: 12px; background: none; border: none; color: var(--text-dim); font-size: 16px; cursor: pointer; }
    .reminder-card { position: relative; }
    body.day-mode .reminder-card {
      background: rgba(99, 102, 241, 0.32);
      border-color: rgba(99, 102, 241, 0.55);
    }
    /* Friday Grooming Section */
    .grooming-card {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: var(--radius);
      padding: 18px;
      margin-bottom: 12px;
      backdrop-filter: blur(20px);
      transition: all 0.3s;
    }
    .grooming-card:hover { border-color: rgba(255,255,255,0.2); }
    .grooming-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 14px;
    }
    .grooming-icon {
      width: 28px; height: 28px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; font-size: 13px;
      background: linear-gradient(135deg, #a78bfa, #818cf8);
      box-shadow: 0 0 12px rgba(167,139,250,0.4);
    }
    .grooming-title { font-size: 14px; font-weight: 600; color: #ffffff; }
    .grooming-items {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .grooming-item {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px 6px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: rgba(255,255,255,0.05);
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
      -webkit-user-select: none;
      user-select: none;
    }
    .grooming-item input[type="checkbox"] { display: none; }
    .grooming-check { display: none; }
    .grooming-item:has(input:checked) {
      background: var(--success-soft);
      border-color: var(--success);
      box-shadow: 0 0 10px var(--glow-teal);
    }
    .grooming-item:has(input:checked) span {
      color: white;
    }
    .grooming-card.all-done {
      opacity: 0.5;
      border-style: dashed;
    }
    body.day-mode .grooming-card {
      background: rgba(255,255,255,0.6);
      border-color: rgba(0,0,0,0.08);
    }
    body.day-mode .grooming-item {
      background: rgba(0,0,0,0.05);
    }
    body.day-mode .grooming-item:has(input:checked) {
      background: rgba(167,139,250,0.25);
      border-color: #8b5cf6;
      box-shadow: 0 0 8px rgba(139,92,246,0.3);
    }
    body.day-mode .grooming-item:has(input:checked) span {
      color: #1f2937;
    }
    body.day-mode .grooming-title {
      color: var(--text);
    }

    /* Morning Habit Stack */
    .morning-routine {
      background: linear-gradient(135deg, rgba(255,183,77,0.15), rgba(255,138,101,0.1));
      border: 1px solid rgba(255,183,77,0.3);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 16px;
      display: none;
    }
    .morning-routine.show { display: block; }
    .morning-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .morning-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .morning-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ffb74d, #ff8a65);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      box-shadow: 0 0 15px rgba(255,183,77,0.4);
    }
    .morning-label {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 16px;
      font-weight: 700;
    }
    .morning-sublabel {
      font-size: 11px;
      color: var(--text-muted);
    }
    .morning-done-btn {
      padding: 6px 14px;
      background: rgba(255,255,255,0.1);
      border: 1px solid var(--border);
      border-radius: var(--radius-pill);
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .morning-done-btn:hover {
      background: rgba(255,183,77,0.2);
      border-color: #ffb74d;
      color: #ffb74d;
    }
    .morning-prompt-btns {
      display: flex;
      gap: 10px;
    }
    .morning-yes-btn, .morning-no-btn {
      flex: 1;
      padding: 12px;
      border-radius: var(--radius);
      font-family: 'Space Grotesk', sans-serif;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    .morning-yes-btn {
      background: linear-gradient(135deg, #ffb74d, #ff8a65);
      color: #1a1a2e;
    }
    .morning-yes-btn:hover {
      transform: scale(1.02);
      box-shadow: 0 0 20px rgba(255,183,77,0.4);
    }
    .morning-no-btn {
      background: rgba(255,255,255,0.08);
      color: var(--text-muted);
      border: 1px solid var(--border);
    }
    .morning-no-btn:hover {
      background: rgba(255,255,255,0.12);
    }
    .morning-items {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .morning-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      transition: all 0.2s;
    }
    .morning-item.checked {
      background: rgba(255,183,77,0.1);
      border-color: #ffb74d;
    }
    .morning-item.checked .morning-item-label {
      text-decoration: line-through;
      color: var(--text-muted);
    }
    .morning-checkbox {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .morning-item.checked .morning-checkbox {
      background: linear-gradient(135deg, #ffb74d, #ff8a65);
      border-color: #ffb74d;
      color: white;
      font-size: 12px;
    }
    .morning-item-label {
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      white-space: nowrap;
      min-width: 50px;
    }
    .morning-item-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      justify-content: flex-end;
    }
    .morning-inline-input {
      width: 60px;
      padding: 4px 8px;
      background: rgba(255,255,255,0.08);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 13px;
      text-align: center;
    }
    .morning-inline-input:focus {
      border-color: #ffb74d;
      outline: none;
      box-shadow: 0 0 8px rgba(255,183,77,0.3);
    }
    .morning-inline-input::placeholder {
      color: var(--text-muted);
    }
    .morning-chips {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .morning-chip {
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      background: rgba(255,255,255,0.08);
      border: 1px solid var(--border);
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .morning-chip:hover {
      background: rgba(255,255,255,0.12);
    }
    .morning-chip.active {
      background: rgba(255,183,77,0.2);
      border-color: #ffb74d;
      color: #ffb74d;
    }
    .morning-bp-inputs {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .morning-bp-inputs .morning-inline-input {
      width: 55px;
    }
    .morning-metrics-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }
    .morning-metric {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .morning-metric-label {
      font-size: 11px;
      color: var(--text-muted);
      min-width: 35px;
    }
    body.day-mode .morning-routine {
      background: linear-gradient(135deg, rgba(255,183,77,0.12), rgba(255,138,101,0.08));
      border-color: rgba(255,183,77,0.25);
      box-shadow: 0 4px 16px rgba(255,152,0,0.15), 0 1px 4px rgba(0,0,0,0.08);
    }
    body.day-mode .morning-item {
      background: rgba(255,255,255,0.5);
    }
    body.day-mode .morning-item.checked {
      background: rgba(255,183,77,0.15);
      border-color: #ffb74d;
    }

    /* Biomarkers Page */
    .bio-category { margin-bottom: 14px; }
    .bio-cat-header { display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius) var(--radius) 0 0; cursor: pointer; }
    .bio-cat-header .bio-cat-icon { font-size: 16px; }
    .bio-cat-header .bio-cat-name { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-dim); flex: 1; }
    .bio-cat-header .bio-cat-toggle { font-size: 10px; color: var(--text-muted); transition: transform 0.3s; }
    .bio-cat-header.collapsed .bio-cat-toggle { transform: rotate(-90deg); }
    .bio-cat-body { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-top: none; border-radius: 0 0 var(--radius) var(--radius); overflow: hidden; }
    .bio-cat-body.collapsed { display: none; }

    .bio-card { padding: 14px; border-bottom: 1px solid rgba(255,255,255,0.06); }
    .bio-card:last-child { border-bottom: none; }
    .bio-card-top { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
    .bio-name { font-size: 14px; font-weight: 600; color: var(--accent-teal); flex: 1; cursor: pointer; }
    .bio-name:active { opacity: 0.7; }
    .bio-history-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.06); font-size: 13px; }
    .bio-history-row:last-child { border-bottom: none; }
    .bio-history-date { color: var(--text-muted); }
    .bio-history-val { font-weight: 600; }
    .bio-history-val.in-range { color: #52b788; }
    .bio-history-val.out-range { color: #d4a017; }
    body.day-mode .bio-history-row { border-bottom-color: rgba(0,0,0,0.06); }
    body.day-mode .bio-name { color: #6366f1; }
    .bio-info-btn { width: 22px; height: 22px; border-radius: 50%; border: 1px solid var(--text-muted); background: none; color: var(--text-muted); font-size: 11px; font-style: italic; font-family: Georgia, serif; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .bio-info-btn:hover, .bio-info-btn.active { border-color: var(--accent-teal); color: var(--accent-teal); }
    .bio-range-text { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; }
    .bio-desc { font-size: 11px; color: var(--text-muted); line-height: 1.4; margin-bottom: 10px; }
    .bio-no-data-badge { font-size: 10px; padding: 2px 6px; background: rgba(212,160,23,0.2); color: #d4a017; border-radius: 4px; font-weight: 500; }
    .bio-card.no-data { opacity: 0.6; }

    .bio-bar-wrap { position: relative; height: 14px; border-radius: 7px; overflow: visible; margin: 0 8px 4px; display: flex; }
    .bio-bar-low { background: #d4a017; border-radius: 7px 0 0 7px; height: 100%; }
    .bio-bar-normal { background: #52b788; height: 100%; }
    .bio-bar-high { background: #d4a017; border-radius: 0 7px 7px 0; height: 100%; flex: 1; }
    .bio-bar-labels { display: flex; justify-content: space-between; padding: 0 8px; margin-bottom: 8px; }
    .bio-bar-label { font-size: 10px; color: var(--text-muted); }

    .bio-bubble-wrap { position: absolute; top: -28px; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; pointer-events: none; }
    .bio-bubble { padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: 700; color: #fff; white-space: nowrap; }
    .bio-bubble-arrow { width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 5px solid; }
    .bio-bubble.in-range { background: #52b788; }
    .bio-bubble.in-range + .bio-bubble-arrow { border-top-color: #52b788; }
    .bio-bubble.out-range { background: #d4a017; }
    .bio-bubble.out-range + .bio-bubble-arrow { border-top-color: #d4a017; }
    .bio-bubble.no-result { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-muted); }
    .bio-bubble.no-result + .bio-bubble-arrow { border-top-color: var(--border); }

    .bio-input-row { display: flex; align-items: center; gap: 8px; margin-top: 6px; }
    .bio-input-label { font-size: 11px; color: var(--text-muted); }
    .bio-input { width: 80px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 6px 8px; color: var(--text); font-size: 13px; font-family: 'Space Grotesk', sans-serif; text-align: center; outline: none; flex-shrink: 0; }
    .bio-input:focus { border-color: var(--accent-teal); }

    body.day-mode .bio-cat-header { background: rgba(0,0,0,0.03); border-color: rgba(0,0,0,0.08); }
    body.day-mode .bio-cat-body { background: rgba(255,255,255,0.6); border-color: rgba(0,0,0,0.08); }
    body.day-mode .bio-card { border-bottom-color: rgba(0,0,0,0.06); }
    body.day-mode .bio-input { background: rgba(255,255,255,0.8); color: #1f2937; }

    .sec-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; cursor: pointer; }
    .sec-title { display: flex; align-items: center; gap: 10px; }
    .sec-icon { 
      width: 28px; height: 28px; border-radius: 50%; 
      display: flex; align-items: center; justify-content: center; font-size: 13px; 
      background: linear-gradient(135deg, var(--icon-start, var(--accent-purple)), var(--icon-end, var(--accent-pink)));
      box-shadow: 0 0 12px var(--icon-glow, var(--glow-purple));
    }
    .sec-name { font-size: 14px; font-weight: 600; color: #ffffff; }
    .streak-badge {
      font-size: 11px;
      font-weight: 500;
      color: #ffa552;
      margin-left: 8px;
      animation: streak-glow 2s ease-in-out infinite;
    }
    @keyframes streak-glow {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .sec-toggle { color: rgba(255,255,255,0.5); font-size: 11px; transition: transform 0.3s; }
    .sec-head.collapsed .sec-toggle { transform: rotate(-90deg); }
    .sec-content { transition: max-height 0.3s, opacity 0.3s; overflow: hidden; }
    .sec-content.collapsed { max-height: 0; opacity: 0; }
    
    /* Chips - Glowing when active */
    .chips { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip {
      display: flex; align-items: center; gap: 6px; padding: 8px 14px;
      background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: var(--radius-pill);
      cursor: pointer; transition: all 0.3s; user-select: none;
    }
    .chip:hover { background: rgba(255,255,255,0.1); }
    .chip:active { transform: scale(0.97); }
    .chip.on { 
      background: var(--success-soft); 
      border-color: var(--success); 
      box-shadow: 0 0 15px var(--glow-teal);
    }
    .chip-dot { 
      width: 18px; height: 18px; border-radius: 50%; 
      border: 2px solid var(--text-muted); 
      display: flex; align-items: center; justify-content: center; 
      font-size: 10px; transition: all 0.3s; 
    }
    .chip.on .chip-dot { 
      background: var(--success); 
      border-color: var(--success); 
      color: white; 
      box-shadow: 0 0 10px var(--glow-teal);
    }
    .chip-text { font-size: 13px; font-weight: 500; color: var(--text-dim); transition: color 0.3s; }
    .chip.on .chip-text { color: var(--text); }
    .chip input { display: none; }
    
    /* Inputs */
    .field { margin-bottom: 14px; }
    .field-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 6px; display: block; }
    .input { 
      width: 100%; padding: 14px; 
      background: rgba(255,255,255,0.05); 
      border: 1px solid var(--border); 
      border-radius: var(--radius-sm); 
      color: var(--text); font-size: 15px; outline: none; transition: all 0.3s; 
    }
    .input:focus { 
      border-color: var(--accent-teal); 
      box-shadow: 0 0 20px var(--glow-teal);
    }
    .input::placeholder { color: var(--text-muted); }
    textarea.input { min-height: 90px; resize: vertical; font-family: inherit; line-height: 1.5; }
    
    /* Buttons */
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 16px; border-radius: var(--radius-sm); font-size: 13px; font-weight: 600; cursor: pointer; border: none; transition: all 0.3s; }
    .btn-secondary { background: rgba(255,255,255,0.08); color: var(--text-dim); border: 1px solid var(--border); }
    .btn-secondary:hover { background: rgba(255,255,255,0.12); color: var(--text); }
    .btn-secondary.active { background: var(--accent-teal); color: #fff; border-color: var(--accent-teal); box-shadow: 0 0 10px var(--glow-teal); }
    body.day-mode .btn-secondary.active { background: #6366f1; color: #fff; border-color: #6366f1; box-shadow: 0 0 10px var(--glow-purple); }
    .btn-primary { 
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink)); 
      color: white; padding: 14px 24px; 
      box-shadow: 0 4px 20px var(--glow-purple);
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 30px var(--glow-pink); }
    
    /* Items */
    .items { margin-bottom: 12px; }
    .item { 
      display: flex; align-items: center; justify-content: space-between; 
      padding: 12px 14px; 
      background: var(--success-soft); 
      border: 1px solid var(--success); 
      border-radius: var(--radius-sm); 
      margin-bottom: 6px;
      box-shadow: 0 0 10px var(--glow-teal);
    }
    .item-text { font-size: 13px; color: var(--text); }
    .item-time { font-size: 11px; color: var(--text-muted); margin-left: 4px; }
    .item-del { background: none; border: none; color: var(--text-muted); font-size: 16px; cursor: pointer; }
    .item-del:hover { color: var(--accent-pink); }
    body.day-mode .item {
      background: rgba(5, 150, 105, 0.15);
      border-color: var(--success);
      box-shadow: 0 0 8px rgba(5, 150, 105, 0.3);
    }
    
    /* REHIT Calendar */
    .rehit-calendar {
      user-select: none;
    }
    .rehit-cal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    .rehit-cal-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
    }
    .rehit-cal-nav {
      display: flex;
      gap: 8px;
    }
    .rehit-cal-nav button {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-muted);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .rehit-cal-nav button:hover {
      border-color: var(--accent-pink);
      color: var(--accent-pink);
    }
    .rehit-cal-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 8px;
    }
    .rehit-cal-weekday {
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      padding: 4px;
    }
    .rehit-cal-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    .rehit-cal-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-muted);
      border-radius: 50%;
      transition: all 0.2s;
    }
    .rehit-cal-day.other-month {
      color: var(--text-muted);
      opacity: 0.3;
    }
    .rehit-cal-day.future {
      opacity: 0.35;
    }
    .rehit-cal-day.today {
      background: var(--accent-orange);
      color: white;
      font-weight: 700;
    }
    .rehit-cal-day.has-rehit {
      border: 2px solid var(--accent-pink);
      color: var(--text);
    }
    .rehit-cal-day.has-rehit.rehit-2x10 {
      border-color: #ec4899;
      background: rgba(236, 72, 153, 0.2);
      box-shadow: 0 0 8px rgba(236, 72, 153, 0.5);
    }
    .rehit-cal-day.has-rehit.rehit-3x10 {
      border-color: #f97316;
      background: rgba(249, 115, 22, 0.2);
      box-shadow: 0 0 8px rgba(249, 115, 22, 0.5);
    }
    .rehit-cal-day.frozen {
      background: rgba(109, 213, 237, 0.15);
      border: 1px dashed rgba(109, 213, 237, 0.5);
      color: #6dd5ed;
      opacity: 0.6;
    }
    body.day-mode .rehit-cal-day.frozen {
      background: rgba(109, 213, 237, 0.1);
      color: #0891b2;
      border-color: rgba(8, 145, 178, 0.3);
    }
    .rehit-cal-legend {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      justify-content: center;
    }
    .rehit-cal-legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }
    .rehit-cal-legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid;
    }
    .rehit-cal-legend-dot.dot-2x10 {
      border-color: #ec4899;
      background: rgba(236, 72, 153, 0.2);
    }
    .rehit-cal-legend-dot.dot-3x10 {
      border-color: #f97316;
      background: rgba(249, 115, 22, 0.2);
    }
    .rehit-cal-legend-dot.dot-frozen {
      border-color: #6dd5ed;
      border-style: dashed;
      background: rgba(109, 213, 237, 0.15);
    }
    body.day-mode .rehit-cal-day {
      color: #6b7280;
    }
    body.day-mode .rehit-cal-day.has-rehit {
      color: #1f2937;
    }
    body.day-mode .rehit-cal-day.today {
      color: white;
    }

    /* REHIT Progress Card */
    .rehit-progress-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 16px;
    }
    .rehit-progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .rehit-progress-title {
      font-weight: 600;
      font-size: 14px;
    }
    .rehit-progress-count {
      font-family: 'JetBrains Mono', monospace;
      font-size: 18px;
      font-weight: 700;
      color: var(--accent-orange);
    }
    .rehit-progress-bar {
      height: 8px;
      background: var(--bg-input);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 12px;
    }
    .rehit-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-orange), var(--accent-pink));
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    .rehit-progress-breakdown {
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    .rehit-type-badge {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 500;
    }
    .rehit-type-badge.type-2x10 {
      background: rgba(236, 72, 153, 0.2);
      color: #ec4899;
    }
    .rehit-type-badge.type-3x10 {
      background: rgba(249, 115, 22, 0.2);
      color: #f97316;
    }

    /* Summary Page Styles */
    .summary-overview {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .summary-stat {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 16px;
      text-align: center;
    }
    .summary-stat.full-width {
      grid-column: 1 / -1;
    }
    .summary-stat-value {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 32px;
      font-weight: 700;
      background: linear-gradient(90deg, var(--accent-teal), var(--accent-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .summary-stat-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    .summary-stat-sub {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* Habit Grid */
    .habit-grid-container {
      background: var(--bg-card);
      border-radius: var(--radius);
      padding: 16px;
      border: 1px solid var(--border);
    }
    .habit-grid-banner {
      background: linear-gradient(135deg, #2a1f1a 0%, var(--bg-card) 100%);
      border: 1px solid #4a3520;
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }
    .habit-grid-banner::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 2px;
      background: linear-gradient(90deg, #ff9f1c, #e76f51);
    }
    .banner-header { margin-bottom: 10px; }
    .banner-title {
      font-size: 14px;
      font-weight: 600;
      color: #ff9f1c;
    }
    .banner-subtitle {
      font-size: 12px;
      color: #998877;
      margin-top: 2px;
    }
    .banner-habits { display: flex; flex-direction: column; gap: 6px; }
    .banner-habit {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: rgba(255,159,28,0.08);
      border-radius: 8px;
      border: 1px solid rgba(255,159,28,0.15);
    }
    .banner-habit-icon { font-size: 14px; }
    .banner-habit-name { font-size: 12px; font-weight: 500; color: var(--text); }
    .banner-streak-note { font-size: 10px; color: #887766; margin-left: auto; }

    .habit-grid-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .habit-grid-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .habit-grid-dates {
      font-size: 10px;
      color: var(--text-muted);
      font-family: 'JetBrains Mono', monospace;
    }
    .habit-grid-row {
      display: grid;
      grid-template-columns: 90px repeat(7, 1fr);
      gap: 3px;
      align-items: center;
      margin-bottom: 2px;
    }
    .habit-grid-labels { margin-bottom: 4px; }
    .habit-grid-day-label {
      text-align: center;
      font-size: 9px;
      font-weight: 600;
      color: var(--text-muted);
      font-family: 'JetBrains Mono', monospace;
    }
    .habit-grid-day-label.today { color: var(--accent-green); }
    .habit-grid-name {
      display: flex;
      align-items: center;
      gap: 5px;
      overflow: hidden;
    }
    .habit-grid-icon { font-size: 12px; flex-shrink: 0; }
    .habit-grid-label {
      font-size: 10px;
      font-weight: 500;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .habit-streak-pill {
      display: inline-flex;
      align-items: center;
      gap: 2px;
      font-size: 9px;
      font-weight: 600;
      padding: 1px 5px;
      border-radius: 6px;
      background: rgba(82,183,136,0.15);
      color: #52b788;
      font-family: 'JetBrains Mono', monospace;
      flex-shrink: 0;
    }
    .habit-grid-cell {
      aspect-ratio: 1;
      border-radius: 3px;
      transition: transform 0.15s ease;
    }
    .habit-grid-cell:hover {
      transform: scale(1.2);
      z-index: 2;
    }
    .habit-grid-cell.goal-met {
      background: #d1fae5;
      border: 1px solid #6ee7b7;
    }
    .habit-grid-cell.partial {
      background: #fef3c7;
      border: 1px solid #fcd34d;
    }
    .habit-grid-cell.miss {
      background: #fee2e2;
      border: 1px solid #fca5a5;
    }
    .habit-grid-cell.today {
      background: var(--bg-input);
      border: 1.5px dashed var(--text-muted);
    }
    .habit-grid-cell.no-data {
      background: var(--bg-input);
      opacity: 0.5;
    }
    .habit-grid-pct-row {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--border);
    }
    .habit-grid-pct {
      text-align: center;
      font-size: 9px;
      font-weight: 600;
      font-family: 'JetBrains Mono', monospace;
    }
    .habit-pct-bar {
      height: 2px;
      background: var(--bg-input);
      border-radius: 1px;
      margin-top: 2px;
      overflow: hidden;
    }
    .habit-pct-fill {
      height: 100%;
      border-radius: 1px;
      transition: width 0.5s ease;
    }
    .habit-grid-legend {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 10px;
      color: var(--text-muted);
    }
    .legend-cell {
      width: 10px;
      height: 10px;
      border-radius: 2px;
    }
    .legend-cell.goal-met { background: #d1fae5; border: 1px solid #6ee7b7; }
    .legend-cell.partial { background: #fef3c7; border: 1px solid #fcd34d; }
    .legend-cell.miss { background: #fee2e2; border: 1px solid #fca5a5; }
    .legend-cell.today { border: 1.5px dashed var(--text-muted); }

    /* Day mode habit grid */
    body.day-mode .habit-grid-container {
      background: var(--bg-card);
    }
    body.day-mode .habit-grid-banner {
      background: linear-gradient(135deg, #fff5eb 0%, var(--bg-card) 100%);
      border-color: #e8d5c4;
    }
    body.day-mode .banner-habit {
      background: rgba(255,159,28,0.1);
      border-color: rgba(255,159,28,0.2);
    }

    .goal-stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .goal-stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px;
    }
    .goal-stat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .goal-stat-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }
    .goal-stat-pct {
      font-size: 12px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 10px;
    }
    .goal-stat-pct.good {
      background: rgba(109, 213, 237, 0.2);
      color: var(--accent-teal);
    }
    .goal-stat-pct.ok {
      background: rgba(255, 165, 82, 0.2);
      color: var(--accent-orange);
    }
    .goal-stat-pct.needs-work {
      background: rgba(255, 107, 157, 0.2);
      color: var(--accent-pink);
    }
    .goal-stat-bar {
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      overflow: hidden;
    }
    .goal-stat-bar-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.3s;
    }
    .goal-stat-detail {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
    }
    .goal-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      margin: 4px;
    }
    .goal-badge-icon {
      font-size: 18px;
    }
    .goal-badge-text {
      font-size: 13px;
      color: var(--text);
    }
    .goal-badge-pct {
      font-size: 12px;
      font-weight: 600;
      color: var(--accent-teal);
    }
    body.day-mode .summary-stat {
      background: rgba(255,255,255,0.8);
    }
    body.day-mode .goal-stat-card {
      background: rgba(255,255,255,0.8);
    }
    body.day-mode .goal-stat-bar {
      background: rgba(0,0,0,0.1);
    }
    body.day-mode .goal-badge {
      background: rgba(255,255,255,0.8);
    }
    
    /* Body Grid */
    .body-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .body-cell { background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px; }
    .body-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 4px; }
    .body-input { width: 100%; background: transparent; border: none; font-family: 'Space Grotesk', sans-serif; font-size: 18px; font-weight: 600; color: var(--text); outline: none; transition: color 0.3s; }
    .body-input:focus { color: var(--accent-teal); }
    .body-pct { font-family: 'Space Grotesk', sans-serif; font-size: 18px; font-weight: 600; color: var(--accent-teal); }

    /* Movement Breaks List */
    .movement-list { display: flex; flex-direction: column; gap: 6px; }
    .movement-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 13px;
      color: var(--text);
    }
    .movement-item-type { font-weight: 600; }
    .movement-item-duration { color: var(--text-muted); margin-left: auto; }
    .movement-item-remove {
      background: none; border: none; color: var(--text-dim);
      font-size: 14px; cursor: pointer; padding: 0 4px;
      opacity: 0.5; transition: opacity 0.2s;
    }
    .movement-item-remove:hover { opacity: 1; color: #ff6b6b; }
    .movement-add-row {
      display: flex; align-items: center; gap: 8px; margin-top: 8px;
    }
    .movement-add-row select {
      flex: 1;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 8px 10px;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 13px;
      color: var(--text);
      outline: none;
    }
    .movement-add-row input[type="number"] {
      width: 60px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 8px;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 13px;
      color: var(--text);
      text-align: center;
      outline: none;
    }
    .movement-add-btn {
      width: 34px; height: 34px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.08);
      color: var(--text);
      font-size: 18px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s;
    }
    .movement-add-btn:hover { background: rgba(255,107,157,0.2); border-color: #ff6b9d; }
    body.day-mode .movement-item { background: rgba(0,0,0,0.03); }
    body.day-mode .movement-add-row select,
    body.day-mode .movement-add-row input[type="number"] { background: rgba(255,255,255,0.8); color: #1f2937; }
    body.day-mode .movement-add-btn { background: rgba(0,0,0,0.05); }

    /* Email Sprint */
    .email-sprint-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
    }
    .email-sprint-count {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 16px;
      color: var(--text);
    }
    .email-sprint-count span:first-child {
      font-size: 28px;
      font-weight: 700;
      color: #4d9de0;
    }
    .email-sprint-label {
      color: var(--text-muted);
      font-size: 14px;
    }
    .email-sprint-timer {
      font-family: 'JetBrains Mono', monospace;
      font-size: 40px;
      font-weight: 700;
      color: var(--text-muted);
      transition: color 0.3s;
    }
    .email-sprint-timer.running {
      color: #4d9de0;
    }
    .email-sprint-timer.done {
      color: #52b788;
    }
    .email-sprint-btn {
      padding: 12px 32px;
      border-radius: var(--radius-sm);
      border: 1px solid #4d9de0;
      background: rgba(77, 157, 224, 0.15);
      color: #4d9de0;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .email-sprint-btn:hover { background: rgba(77, 157, 224, 0.25); }
    .email-sprint-btn.running {
      border-color: #ff6b6b;
      background: rgba(255, 107, 107, 0.15);
      color: #ff6b6b;
    }
    .email-sprint-btn.running:hover { background: rgba(255, 107, 107, 0.25); }
    body.day-mode .email-sprint-timer { color: #9ca3af; }
    body.day-mode .email-sprint-timer.running { color: #4d9de0; }
    body.day-mode .email-sprint-btn { background: rgba(77, 157, 224, 0.1); }

    /* FAB - Glowing */
    .fab { 
      position: fixed; bottom: 24px; right: 24px; 
      width: 60px; height: 60px; border-radius: 50%; 
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink)); 
      border: none; color: white; font-size: 24px; cursor: pointer; 
      box-shadow: 0 8px 30px var(--glow-purple);
      z-index: 100; transition: all 0.3s; 
      animation: fab-pulse 2s ease-in-out infinite;
    }
    @keyframes fab-pulse {
      0%, 100% { box-shadow: 0 8px 30px var(--glow-purple); }
      50% { box-shadow: 0 8px 40px var(--glow-pink), 0 0 60px var(--glow-purple); }
    }
    .fab:hover { transform: scale(1.1); }
    .fab:active { transform: scale(0.95); }
    .fab.open { transform: rotate(45deg); background: var(--bg-card); animation: none; }
    
    .fab-menu { position: fixed; bottom: 100px; right: 24px; display: flex; flex-direction: column; gap: 10px; opacity: 0; transform: translateY(20px); pointer-events: none; transition: all 0.3s; z-index: 99; }
    .fab-menu.open { opacity: 1; transform: translateY(0); pointer-events: auto; }
    .fab-item { 
      display: flex; align-items: center; gap: 10px; padding: 10px 16px; 
      background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-pill); 
      backdrop-filter: blur(20px); cursor: pointer; transition: all 0.3s; white-space: nowrap; 
    }
    .fab-item:hover { background: var(--bg-card-hover); transform: translateX(-8px); box-shadow: 0 0 20px var(--glow-purple); }
    .fab-icon { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .fab-label { font-size: 14px; font-weight: 600; color: var(--text); }
    
    /* Sticky */
    .sticky { position: fixed; top: 0; left: 0; right: 0; background: rgba(26,26,46,0.95); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); padding: 10px 16px; padding-top: max(60px, calc(14px + env(safe-area-inset-top, 44px))); display: flex; justify-content: space-between; align-items: center; z-index: 1000; transform: translateY(-100%); transition: transform 0.3s; }
    body.day-mode .sticky { background: rgba(255,255,255,0.92); border-bottom-color: #e5e7eb; }
    body.day-mode .sticky-date { color: #6b7280; }
    .sticky.visible { transform: translateY(0); }
    .sticky-date { font-size: 14px; font-weight: 600; }
    .sticky-btns { display: flex; gap: 8px; align-items: center; }
    .sticky-btns button { width: 32px; height: 32px; border-radius: 50%; border: none; background: var(--bg-card); color: var(--text-dim); font-size: 13px; cursor: pointer; }

    /* Hamburger Menu */
    .hamburger-btn { width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-dim); font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
    .hamburger-btn:hover { background: var(--bg-card-hover); color: var(--accent-teal); border-color: var(--accent-teal); }
    body.day-mode .hamburger-btn { background: rgba(255,255,255,0.6); border-color: rgba(0,0,0,0.1); color: var(--text-dim); }
    .nav-drawer { position: fixed; top: 0; right: 0; bottom: 0; width: 280px; background: var(--bg-deep); border-left: 1px solid var(--border); z-index: 2001; transform: translateX(100%); transition: transform 0.3s ease; box-shadow: -4px 0 30px rgba(0,0,0,0.3); display: flex; flex-direction: column; }
    .nav-drawer.open { transform: translateX(0); }
    .nav-drawer-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
    .nav-drawer-backdrop.open { opacity: 1; pointer-events: auto; }
    .nav-drawer-header { padding: 20px; padding-top: max(60px, calc(20px + env(safe-area-inset-top, 44px))); border-bottom: 1px solid var(--border); }
    .nav-drawer-header h2 { font-family: 'Space Grotesk', sans-serif; font-size: 22px; font-weight: 700; margin: 0; }
    .nav-drawer-header .tagline { font-size: 13px; color: var(--text-muted); margin-top: 2px; }
    .nav-drawer-items { flex: 1; padding: 12px; overflow-y: auto; }
    .nav-drawer-item { display: flex; align-items: center; gap: 14px; padding: 14px 16px; border-radius: 12px; cursor: pointer; transition: all 0.2s; color: var(--text); text-decoration: none; }
    .nav-drawer-item:hover, .nav-drawer-item.active { background: rgba(255,255,255,0.05); }
    .nav-drawer-item.active { color: var(--accent-teal); }
    .nav-drawer-item .nav-icon { width: 36px; height: 36px; border-radius: 10px; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .nav-drawer-item.active .nav-icon { background: rgba(109,213,237,0.15); }
    .nav-drawer-item span { font-size: 15px; font-weight: 600; }
    body.day-mode .nav-drawer { background: #fff; border-left-color: #e5e7eb; }
    body.day-mode .nav-drawer-item:hover, body.day-mode .nav-drawer-item.active { background: rgba(0,0,0,0.04); }
    body.day-mode .nav-drawer-item.active .nav-icon { background: rgba(249,115,22,0.1); }
    body.day-mode .nav-drawer-item.active { color: var(--accent-orange); }

    /* Settings Card Grid */
    .settings-card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 0 16px 16px; }
    .settings-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 20px 16px; cursor: pointer; transition: all 0.3s; text-align: center; }
    .settings-card:hover { background: var(--bg-card-hover); transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
    .settings-card-icon { font-size: 28px; margin-bottom: 8px; }
    .settings-card-label { font-size: 13px; font-weight: 600; color: var(--text); }
    .settings-card-desc { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
    body.day-mode .settings-card { background: rgba(255,255,255,0.8); }
    .settings-subpage { display: none; }
    .settings-subpage.active { display: block; }
    .settings-back-btn { display: flex; align-items: center; gap: 8px; padding: 12px 16px; cursor: pointer; font-size: 14px; font-weight: 600; color: var(--accent-teal); background: none; border: none; }
    body.day-mode .settings-back-btn { color: var(--accent-orange); }
    
    /* Milestone - Aurora themed */
    .milestone { position: fixed; inset: 0; background: rgba(26,26,46,0.95); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(10px); }
    .milestone.show { opacity: 1; pointer-events: auto; }
    .milestone-box { text-align: center; animation: pop 0.5s cubic-bezier(0.34,1.56,0.64,1); }
    @keyframes pop { 0%{transform:scale(0.5);opacity:0} 100%{transform:scale(1);opacity:1} }
    .milestone-emoji { font-size: 72px; animation: float 2s ease-in-out infinite; }
    @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-15px)} }
    .milestone-title { font-family: 'Space Grotesk', sans-serif; font-size: 26px; font-weight: 700; margin-top: 16px; background: linear-gradient(90deg, var(--accent-teal), var(--accent-purple), var(--accent-pink)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .milestone-sub { font-size: 15px; color: var(--text-dim); margin-top: 8px; }
    .milestone-btn { margin-top: 28px; padding: 14px 32px; background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink)); border: none; border-radius: var(--radius-pill); font-size: 16px; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 8px 30px var(--glow-purple); }
    
    /* Modal */
    .modal { position: fixed; inset: 0; background: rgba(26,26,46,0.9); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(10px); padding: 16px; }
    .modal.show { opacity: 1; pointer-events: auto; }
    .modal-content { background: var(--bg-mid); border: 1px solid var(--border); border-radius: var(--radius); width: 100%; max-width: 360px; animation: pop 0.3s cubic-bezier(0.34,1.56,0.64,1); overflow: hidden; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 18px; border-bottom: 1px solid var(--border); }
    .modal-close { width: 34px; height: 34px; border-radius: 50%; border: none; background: rgba(255,255,255,0.1); color: var(--text-muted); font-size: 16px; cursor: pointer; transition: all 0.3s; }
    .modal-close:hover { background: rgba(255,255,255,0.15); color: var(--text); }
    .modal-body { padding: 18px; }
    .modal-footer { padding: 18px; border-top: 1px solid var(--border); }

    .weekly-review-intro { font-size: 16px; font-weight: 600; color: var(--accent-teal); text-align: center; margin-bottom: 16px; }
    .weekly-review-section { margin-bottom: 14px; }
    .weekly-review-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 8px; }
    .weekly-review-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.06); font-size: 14px; font-weight: 500; }
    .weekly-review-row:last-child { border-bottom: none; }
    .weekly-review-input-wrap { display: flex; align-items: center; gap: 6px; }
    .weekly-review-unit { font-size: 11px; color: var(--text-muted); min-width: 65px; }
    .weekly-review-input-wrap .goal-input { width: 70px; }
    body.day-mode .weekly-review-row { border-bottom-color: rgba(0,0,0,0.06); }

    /* Bedtime Routine Section */
    .bedtime-routine {
      background: linear-gradient(135deg, rgba(196,113,237,0.15), rgba(109,213,237,0.1));
      border: 1px solid rgba(196,113,237,0.3);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 16px;
      display: none;
    }
    .bedtime-routine.show { display: block; }
    .bedtime-routine.done-state {
      background: linear-gradient(135deg, rgba(109,213,237,0.1), rgba(196,113,237,0.05));
      padding: 12px 16px;
    }
    .bedtime-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .bedtime-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .bedtime-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-teal));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      box-shadow: 0 0 15px var(--glow-purple);
    }
    .bedtime-label {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 16px;
      font-weight: 700;
    }
    .bedtime-sublabel {
      font-size: 11px;
      color: var(--text-muted);
    }
    .bedtime-done-btn {
      padding: 6px 14px;
      background: rgba(255,255,255,0.1);
      border: 1px solid var(--border);
      border-radius: var(--radius-pill);
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .bedtime-done-btn:hover {
      background: rgba(255,255,255,0.15);
      color: var(--text);
    }
    .bedtime-items {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .bedtime-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s;
    }
    .bedtime-item:hover {
      background: rgba(255,255,255,0.08);
    }
    .bedtime-item.checked {
      background: rgba(109,213,237,0.1);
      border-color: var(--accent-teal);
    }
    .bedtime-item.checked .bedtime-item-text {
      text-decoration: line-through;
      color: var(--text-muted);
    }
    .bedtime-checkbox {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .bedtime-item.checked .bedtime-checkbox {
      background: linear-gradient(135deg, var(--accent-teal), var(--accent-purple));
      border-color: var(--accent-teal);
      color: white;
      font-size: 12px;
    }
    .bedtime-item-text {
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }
    .bedtime-done-message {
      text-align: center;
      font-size: 14px;
      color: var(--accent-teal);
      font-weight: 600;
    }
    body.day-mode .bedtime-routine {
      background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(13,148,136,0.08));
      border-color: rgba(99,102,241,0.2);
    }
    body.day-mode .bedtime-item {
      background: rgba(255,255,255,0.5);
    }
    body.day-mode .bedtime-item.checked {
      background: rgba(13,148,136,0.15);
      border-color: var(--accent-teal);
    }

    /* Bedtime Celebration Animation */
    .bedtime-celebration {
      position: fixed;
      inset: 0;
      background: rgba(26,26,46,0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s;
      backdrop-filter: blur(15px);
    }
    .bedtime-celebration.show {
      opacity: 1;
      pointer-events: auto;
    }
    .celebration-content {
      text-align: center;
      animation: celebrationPop 0.6s cubic-bezier(0.34,1.56,0.64,1);
    }
    @keyframes celebrationPop {
      0% { transform: scale(0.3) rotate(-10deg); opacity: 0; }
      50% { transform: scale(1.1) rotate(3deg); }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    .celebration-emoji {
      font-size: 80px;
      animation: celebrationBounce 0.8s ease-in-out infinite;
    }
    @keyframes celebrationBounce {
      0%, 100% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-20px) scale(1.1); }
    }
    .celebration-stars {
      position: absolute;
      inset: 0;
      overflow: hidden;
      pointer-events: none;
    }
    .celebration-star {
      position: absolute;
      font-size: 24px;
      animation: starFloat 2s ease-out forwards;
    }
    @keyframes starFloat {
      0% { transform: translateY(100vh) scale(0); opacity: 1; }
      100% { transform: translateY(-100px) scale(1); opacity: 0; }
    }
    .celebration-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 28px;
      font-weight: 700;
      margin-top: 20px;
      background: linear-gradient(90deg, var(--accent-purple), var(--accent-teal), var(--accent-pink));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmer 2s ease-in-out infinite;
    }
    @keyframes shimmer {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.3); }
    }
    .celebration-subtitle {
      font-size: 16px;
      color: var(--text-dim);
      margin-top: 10px;
      opacity: 0;
      animation: fadeInUp 0.5s ease-out 0.3s forwards;
    }
    @keyframes fadeInUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .celebration-dismiss {
      margin-top: 30px;
      padding: 14px 36px;
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-teal));
      border: none;
      border-radius: var(--radius-pill);
      font-size: 16px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      box-shadow: 0 8px 30px var(--glow-purple);
      opacity: 0;
      animation: fadeInUp 0.5s ease-out 0.5s forwards;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .celebration-dismiss:hover {
      transform: scale(1.05);
      box-shadow: 0 12px 40px var(--glow-purple);
    }

    /* Responsive */
    @media (max-width: 430px) {
      body { padding: 12px; padding-top: max(66px, calc(12px + env(safe-area-inset-top, 54px))); padding-bottom: calc(120px + env(safe-area-inset-bottom, 0px)); }
      .quick-grid { gap: 10px; }
      .card { padding: 14px; }
      .card-value { font-size: 28px; }
      .big-input { font-size: 28px; }
    }

    /* Tablet */
    @media (min-width: 768px) {
      body { max-width: 720px; margin: 0 auto; }
      .quick-grid { grid-template-columns: repeat(2, 1fr); }
    }

    /* Mobile base: flex column so CSS order property works for section reordering */
    #healthForm { display: flex; flex-direction: column; }

    /* Desktop */
    @media (min-width: 1024px) {
      body { max-width: 960px; margin: 0 auto; padding: 24px; padding-top: 80px; }

      /* Two-column layout for sections */
      #healthForm {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        align-items: start;
      }

      /* Quick grid and section rows span full width */
      .quick-grid, .section-row {
        grid-column: 1 / -1;
      }
      .quick-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
      }

      /* REHIT card spans full width */
      .rehit-full {
        grid-column: 1 / -1;
      }

      /* Header spans full width */
      .header {
        grid-column: 1 / -1;
      }

      /* Larger cards */
      .card { padding: 20px; }
      .section { padding: 20px; }

      /* Better text sizes */
      .card-title { font-size: 16px; }
      .sec-name { font-size: 16px; }

      /* Expand all sections on desktop */
      .sec-content.collapsed {
        max-height: none !important;
        opacity: 1 !important;
        overflow: visible !important;
      }
      .sec-head.collapsed .sec-toggle {
        transform: rotate(0deg);
      }
    }

    /* Large Desktop */
    @media (min-width: 1400px) {
      body { max-width: 1200px; }

      .quick-grid {
        grid-template-columns: repeat(4, 1fr);
      }

      #healthForm {
        grid-template-columns: 1fr 1fr 1fr;
      }
    }
    
    /* Settings Page Styles */
    .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }
    .setting-row:last-child { border-bottom: none; }
    .setting-label { flex: 1; }
    .setting-title { display: block; font-size: 14px; font-weight: 600; color: var(--text); }
    .setting-desc { display: block; font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    
    .time-input {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 8px 12px;
      color: var(--text);
      font-size: 14px;
      font-family: 'Space Grotesk', sans-serif;
      outline: none;
    }
    .time-input:focus { border-color: var(--accent-teal); }
    
    .goal-input {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 8px 12px;
      color: var(--text);
      font-size: 14px;
      font-family: 'Space Grotesk', sans-serif;
      outline: none;
      width: 80px;
      text-align: center;
    }
    .goal-input:focus { border-color: var(--accent-teal); }
    body.day-mode .goal-input {
      background: rgba(255,255,255,0.8);
      color: #1f2937;
    }

    /* Goal Settings Rows */
    .goal-setting-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }
    .goal-setting-row:last-child { border-bottom: none; }
    .goal-day-overrides {
      display: none;
      width: 100%;
      padding: 8px 0 4px 38px;
      gap: 4px;
    }
    .goal-day-overrides.open { display: flex; flex-wrap: wrap; }
    .goal-day-override-cell {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }
    .goal-day-override-cell label {
      font-size: 10px;
      color: var(--text-muted);
      font-weight: 600;
    }
    .goal-day-override-cell input {
      width: 36px;
      text-align: center;
      font-size: 12px;
      padding: 3px 2px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--input-bg, rgba(255,255,255,0.06));
      color: var(--text);
    }
    body.day-mode .goal-day-override-cell input {
      background: #f1f5f9;
      border-color: #e2e8f0;
    }
    .goal-day-toggle {
      font-size: 10px;
      color: var(--accent-teal);
      cursor: pointer;
      margin-left: 6px;
      white-space: nowrap;
    }
    .goal-setting-info {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
    }
    .goal-setting-icon {
      font-size: 18px;
      width: 28px;
      text-align: center;
    }
    .goal-setting-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
    }
    .goal-setting-controls {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .goal-setting-controls .goal-input {
      width: 65px;
    }
    .goal-unit {
      font-size: 11px;
      color: var(--text-muted);
      min-width: 50px;
    }
    .goal-freq {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: 12px;
      padding: 6px 8px;
      min-width: 70px;
    }
    .goal-freq:focus { border-color: var(--accent-teal); }
    body.day-mode .goal-freq {
      background: rgba(255,255,255,0.8);
      color: #1f2937;
    }

    /* Habit Notes */
    .habit-notes-input-row {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 16px;
    }
    .habit-note-input {
      width: 100%;
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 14px;
      resize: none;
      min-height: 70px;
      font-family: inherit;
    }
    .habit-note-input:focus {
      outline: none;
      border-color: var(--accent-orange);
      box-shadow: 0 0 10px var(--glow-orange);
    }
    .habit-note-input::placeholder {
      color: var(--text-muted);
    }
    .habit-note-add-btn {
      align-self: flex-end;
      padding: 10px 20px;
    }
    .habit-notes-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .habit-note-item {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      position: relative;
    }
    .habit-note-item:hover {
      border-color: rgba(255,255,255,0.2);
    }
    .habit-note-text {
      font-size: 14px;
      line-height: 1.5;
      color: var(--text);
      margin-bottom: 8px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .habit-note-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .habit-note-time {
      font-size: 11px;
      color: var(--text-muted);
    }
    .habit-note-delete {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px 8px;
      font-size: 12px;
      border-radius: var(--radius-sm);
      transition: all 0.2s;
    }
    .habit-note-delete:hover {
      background: rgba(255,107,157,0.2);
      color: #ff6b9d;
    }
    .habit-notes-empty {
      text-align: center;
      color: var(--text-muted);
      font-size: 13px;
      padding: 20px;
      font-style: italic;
    }
    body.day-mode .habit-note-input {
      background: rgba(255,255,255,0.8);
      color: #1f2937;
    }
    body.day-mode .habit-note-item {
      background: rgba(255,255,255,0.6);
    }

    .theme-preview { display: flex; gap: 8px; }
    .theme-btn {
      width: 40px; height: 40px;
      border-radius: 50%;
      border: 2px solid var(--border);
      background: var(--bg-card);
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .theme-btn:hover { border-color: var(--accent-teal); transform: scale(1.1); }
    .theme-btn.active { border-color: var(--accent-teal); box-shadow: 0 0 15px var(--glow-teal); }
    
    /* Section List for Drag & Drop */
    .section-list { }
    .section-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
      cursor: grab;
      transition: all 0.2s;
    }
    .section-item:active { cursor: grabbing; }
    .section-item.dragging {
      opacity: 0.5;
      transform: scale(1.02);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    .section-item.drag-over {
      border-color: var(--accent-teal);
      background: var(--success-soft);
    }
    .section-item-drag {
      color: var(--text-muted);
      font-size: 16px;
      cursor: grab;
    }
    .section-item-icon { font-size: 18px; }
    .section-item-name { flex: 1; font-size: 14px; font-weight: 500; }
    .section-item-toggle {
      position: relative;
      width: 44px;
      height: 24px;
      background: var(--bg-deep);
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .section-item-toggle.on { background: var(--success); }
    .section-item-toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
    }
    .section-item-toggle.on::after { transform: translateX(20px); }
    .section-item-delete {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 16px;
      cursor: pointer;
      padding: 4px;
      opacity: 0.5;
      transition: all 0.2s;
    }
    .section-item-delete:hover { color: var(--accent-pink); opacity: 1; }
    .section-item-edit {
      background: none; border: none; color: var(--text-muted);
      font-size: 14px; cursor: pointer; padding: 4px; opacity: 0.5; transition: all 0.2s;
    }
    .section-item-edit:hover { color: var(--accent-teal); opacity: 1; }
    .section-field-editor {
      margin: 0 0 8px 0;
    }
    .field-editor-panel {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
    }
    .field-editor-header {
      display: flex; gap: 8px; align-items: flex-end; margin-bottom: 10px;
    }
    .field-editor-header .field { margin-bottom: 0; flex: 1; }
    .field-row {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
      margin-bottom: 6px;
    }
    body.day-mode .field-row { background: rgba(0,0,0,0.02); }
    .day-picker { display: flex; gap: 4px; flex-wrap: wrap; }
    .day-chip {
      width: 36px; height: 36px; border-radius: 50%; border: 1px solid var(--border);
      background: var(--bg-deep); color: var(--text-muted); font-size: 11px; font-weight: 600;
      display: flex; align-items: center; justify-content: center; cursor: pointer;
      transition: all 0.2s; user-select: none;
    }
    .day-chip.selected { background: var(--accent-teal); color: #fff; border-color: var(--accent-teal); }
    body.day-mode .day-chip { background: rgba(0,0,0,0.04); }
    body.day-mode .day-chip.selected { background: var(--accent-teal); color: #fff; }
    .custom-layout-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .custom-layout-row.full { grid-template-columns: 1fr; }
    .custom-layout-cell {
      background: rgba(255,255,255,0.04); border: 1px solid var(--border);
      border-radius: 12px; padding: 12px;
    }
    body.day-mode .custom-layout-cell { background: rgba(0,0,0,0.02); }
    .section-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-auto-rows: 1fr;
      grid-auto-flow: dense;
      gap: 16px;
      margin-bottom: 12px;
    }
    .section-row > .section { margin-bottom: 0; }
    .section-row > .card { margin-bottom: 0; }
    .section-size-2 { grid-row: span 2; }
    @media (min-width: 1024px) { .section-wide { grid-column: span 2; } }
    .section-group {
      border: 1px dashed var(--accent-teal); border-radius: 12px;
      padding: 6px; margin-bottom: 8px; background: rgba(109,213,237,0.04);
    }
    .section-group .section-item { margin-bottom: 4px; }
    .section-group .section-item:last-of-type { margin-bottom: 0; }
    .section-group-label {
      display: flex; justify-content: space-between; align-items: center;
      padding: 2px 8px 4px; font-size: 10px; color: var(--accent-teal);
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;
    }
    .section-group-unlink {
      background: none; border: 1px solid var(--border); border-radius: 6px;
      color: var(--text-muted); font-size: 10px; padding: 2px 8px; cursor: pointer;
      transition: all 0.2s;
    }
    .section-group-unlink:hover { color: var(--accent-pink); border-color: var(--accent-pink); }
    .section-item.drag-group-target { border-color: var(--accent-teal); box-shadow: 0 0 8px var(--glow-teal); }

    /* Homepage section drag-to-reorder */
    .section-drag-handle {
      color: var(--text-muted);
      font-size: 14px;
      cursor: grab;
      opacity: 0.3;
      user-select: none;
      touch-action: none;
      padding: 2px;
      letter-spacing: -2px;
      line-height: 1;
    }
    .section-drag-handle:active { cursor: grabbing; opacity: 0.8; }
    .section-dragging { opacity: 0.35 !important; transform: scale(0.97); transition: opacity 0.15s, transform 0.15s; }
    .section-drop-above { box-shadow: 0 -3px 0 0 var(--accent-teal), 0 0 12px -2px var(--glow-teal) !important; }
    .section-drop-below { box-shadow: 0 3px 0 0 var(--accent-teal), 0 0 12px -2px var(--glow-teal) !important; }
    .section-drop-group { outline: 2px dashed var(--accent-teal); outline-offset: -2px; box-shadow: 0 0 16px var(--glow-teal) !important; }
  </style>
</head>
<body>
  <!-- Loading Overlay - starts hidden, shown by JS when loading -->
  <div class="loading-overlay hidden" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">Loading...</div>
  </div>
  
  <!-- Debug Error Display -->
  <div id="debugError" style="display:none; position:fixed; bottom:120px; left:16px; right:16px; background:rgba(255,0,0,0.9); color:white; padding:12px; border-radius:8px; font-size:12px; z-index:9999; max-height:200px; overflow:auto;"></div>
  
  <script>
    window.onerror = function(msg, url, line, col, error) {
      const el = document.getElementById('debugError');
      if (el) {
        el.style.display = 'block';
        el.innerHTML += '<b>Error:</b> ' + msg + '<br><small>at line ' + line + '</small><br>';
      }
      return false;
    };
    window.addEventListener('unhandledrejection', function(e) {
      const el = document.getElementById('debugError');
      if (el) {
        el.style.display = 'block';
        el.innerHTML += '<b>Promise Error:</b> ' + (e.reason?.message || e.reason) + '<br>';
      }
    });
  </script>
  
  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <span class="toast-icon"></span>
    <span class="toast-text">Saved</span>
  </div>
  
  <!-- Pull to Refresh Indicator -->
  <div class="pull-indicator" id="pullIndicator">
    <div class="pull-spinner"></div>
    <span>Refreshing...</span>
  </div>

  <div class="theme-indicator" id="themeIndicator"> Day Mode</div>
  
  <svg width="0" height="0" style="position:absolute">
    <defs>
      <linearGradient id="auroraGrad" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" style="stop-color:#c471ed"/>
        <stop offset="50%" style="stop-color:#ff6b9d"/>
        <stop offset="100%" style="stop-color:#6dd5ed"/>
      </linearGradient>
    </defs>
  </svg>

  <div id="stickyDateBar" class="sticky">
    <div class="sticky-date" id="stickyDateDisplay">Today</div>
    <div class="sticky-btns"><button id="stickyPrevBtn"></button><button id="stickyNextBtn"></button><button class="hamburger-btn" id="stickyMenuBtn"></button></div>
  </div>

  <!-- Navigation Drawer -->
  <div class="nav-drawer-backdrop" id="navDrawerBackdrop"></div>
  <div class="nav-drawer" id="navDrawer">
    <div class="nav-drawer-header">
      <h2>Habits</h2>
      <div class="tagline">v2.8</div>
    </div>
    <div class="nav-drawer-items">
      <a class="nav-drawer-item active" data-page="home"><div class="nav-icon"></div><span>Home</span></a>
      <a class="nav-drawer-item" data-page="writing"><div class="nav-icon"></div><span>Writing</span></a>
      <a class="nav-drawer-item" data-page="summary"><div class="nav-icon"></div><span>Phase Summary</span></a>
      <a class="nav-drawer-item" data-page="charts"><div class="nav-icon"></div><span>Charts</span></a>
      <a class="nav-drawer-item" data-page="biomarkers"><div class="nav-icon"></div><span>Biomarkers</span></a>
      <a class="nav-drawer-item" data-page="settings"><div class="nav-icon"></div><span>Settings</span></a>
    </div>
  </div>

  <div id="milestoneOverlay" class="milestone">
    <div class="milestone-box">
      <div class="milestone-emoji" id="milestoneEmoji"></div>
      <div class="milestone-title" id="milestoneTitle">Amazing!</div>
      <div class="milestone-sub" id="milestoneSubtitle">You did something great!</div>
      <button class="milestone-btn" onclick="closeMilestone()">Continue</button>
    </div>
  </div>

  <!-- Weekly Goals Review Modal (Sunday) -->
  <div id="weeklyReviewModal" class="modal">
    <div class="modal-content" style="max-width:380px">
      <div class="modal-header">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent-teal),var(--accent-purple));display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 0 15px var(--glow-teal)"></div>
          <div>
            <div style="font-family:'Space Grotesk', sans-serif;font-size:18px;font-weight:700">Weekly Goals</div>
            <div style="font-size:12px;color:var(--text-muted)">Set your intentions for the week</div>
          </div>
        </div>
        <button class="modal-close" onclick="closeWeeklyReview()"></button>
      </div>
      <div class="modal-body">
        <div class="weekly-review-intro">This week I will...</div>
        <div class="weekly-review-section">
          <div class="weekly-review-label">Daily Goals</div>
          <div class="weekly-review-row"><span> Sleep</span><div class="weekly-review-input-wrap"><input type="number" class="goal-input" id="wr-sleep" value="7" min="4" max="12" step="0.5"><span class="weekly-review-unit">hrs/night</span></div></div>
          <div class="weekly-review-row"><span> Water</span><div class="weekly-review-input-wrap"><input type="number" class="goal-input" id="wr-agua" value="6" min="1" max="20"><span class="weekly-review-unit">glasses/day</span></div></div>
          <div class="weekly-review-row"><span> Steps</span><div class="weekly-review-input-wrap"><input type="number" class="goal-input" id="wr-steps" value="7500" min="1000" max="50000" step="500"><span class="weekly-review-unit">steps/day</span></div></div>
          <div class="weekly-review-row"><span> Movement</span><div class="weekly-review-input-wrap"><input type="number" class="goal-input" id="wr-movement" value="2" min="1" max="10"><span class="weekly-review-unit">breaks/day</span></div></div>
        </div>
        <div class="weekly-review-section">
          <div class="weekly-review-label">Weekly Goals</div>
          <div class="weekly-review-row"><span> REHIT</span><div class="weekly-review-input-wrap"><input type="number" class="goal-input" id="wr-rehit" value="4" min="1" max="7"><span class="weekly-review-unit">sessions</span></div></div>
          <div class="weekly-review-row"><span> Reading</span><div class="weekly-review-input-wrap"><input type="number" class="goal-input" id="wr-reading" value="60" min="5" max="500" step="5"><span class="weekly-review-unit">min</span></div></div>
          <div class="weekly-review-row"><span> Meditation</span><div class="weekly-review-input-wrap"><input type="number" class="goal-input" id="wr-meditation" value="60" min="5" max="500" step="5"><span class="weekly-review-unit">min</span></div></div>
        </div>
      </div>
      <div class="modal-footer" style="display:flex;gap:10px">
        <button class="btn btn-secondary" onclick="closeWeeklyReview()" style="flex:1">Keep Current</button>
        <button class="btn btn-primary" onclick="saveWeeklyReview()" style="flex:2">Lock In My Goals</button>
      </div>
    </div>
  </div>

  <header class="header">
    <div class="header-top">
      <div class="brand">
        <div>
          <h1>Habits</h1>
          <div class="tagline">v2.8</div>
        </div>
      </div>
      <button class="hamburger-btn" id="headerMenuBtn"></button>
    </div>
    <div class="date-nav">
      <button class="date-btn" id="prevBtn"></button>
      <div class="date-center">
        <div class="date-phase-title" id="phaseTitle">Phase 1</div>
        <div class="date-main" id="dateDisplay"></div>
        <div class="date-phase-day" id="phaseDayCount">Day -- of 21</div>
        <div class="freeze-indicator" id="freezeIndicator" style="display:none"> Phase Frozen</div>
      </div>
      <button class="date-btn" id="nextBtn"></button>
      <div class="ring-wrap">
        <svg class="ring" width="72" height="72" viewBox="0 0 72 72">
          <circle class="ring-bg" cx="36" cy="36" r="32"/>
          <circle class="ring-progress" id="completionProgress" cx="36" cy="36" r="32" stroke-dasharray="201" stroke-dashoffset="201"/>
        </svg>
        <div class="ring-text" id="completionNumber">0</div>
      </div>
      <div class="phase" style="grid-column: 1 / -1;">
        <div class="phase-track"><div class="phase-fill" id="phaseProgressBar" style="width:0%"></div></div>
      </div>
    </div>
  </header>

  <!-- Ring Completion Celebration Container -->
  <div id="ringCelebration" class="ring-celebration"></div>

  <!-- Bedtime Routine Section -->
  <div id="bedtimeRoutine" class="bedtime-routine">
    <div class="bedtime-header">
      <div class="bedtime-title">
        <div class="bedtime-icon"></div>
        <div>
          <div class="bedtime-label">Bedtime Routine</div>
          <div class="bedtime-sublabel">Wind down for a great tomorrow</div>
        </div>
      </div>
      <button type="button" class="bedtime-done-btn" onclick="dismissBedtimeRoutine()">Done</button>
    </div>
    <div class="bedtime-items" id="bedtimeItems">
      <!-- Items populated by JS -->
    </div>
  </div>

  <!-- Bedtime Celebration Overlay -->
  <div id="bedtimeCelebration" class="bedtime-celebration">
    <div class="celebration-stars" id="celebrationStars"></div>
    <div class="celebration-content">
      <div class="celebration-emoji"></div>
      <div class="celebration-title">Goodnight!</div>
      <div class="celebration-subtitle">Have a great workout in the morning!</div>
      <button type="button" class="celebration-dismiss" onclick="dismissCelebration()">Sweet Dreams</button>
    </div>
  </div>

  <!-- Morning Habit Stack (outside form, matching bedtime pattern) -->
  <div id="morningRoutine" class="morning-routine">
    <div id="morningPrompt">
      <div class="morning-header">
        <div class="morning-title">
          <div class="morning-icon"></div>
          <div>
            <div class="morning-label">Morning Habit Stack</div>
            <div class="morning-sublabel">Ready to start your morning routine?</div>
          </div>
        </div>
      </div>
      <div class="morning-prompt-btns">
        <button type="button" class="morning-yes-btn" onclick="acceptMorningRoutine()">Yes, let's go!</button>
        <button type="button" class="morning-no-btn" onclick="dismissMorningRoutine()">Not today</button>
      </div>
    </div>
    <div id="morningStack" style="display:none">
      <div class="morning-header">
        <div class="morning-title">
          <div class="morning-icon"></div>
          <div>
            <div class="morning-label">Morning Habit Stack</div>
            <div class="morning-sublabel">Start your day right</div>
          </div>
        </div>
        <button type="button" class="morning-done-btn" onclick="dismissMorningRoutine()">Done</button>
      </div>
      <div class="morning-items" id="morningItems">
        <!-- Items populated by JS -->
      </div>
    </div>
  </div>

  <!-- Morning Celebration Overlay -->
  <div id="morningCelebration" class="bedtime-celebration">
    <div class="celebration-stars"></div>
    <div class="celebration-content">
      <div class="celebration-emoji"></div>
      <div class="celebration-title">Crushed It!</div>
      <div class="celebration-subtitle">Morning routine complete - let's have a great day!</div>
      <button type="button" class="celebration-dismiss" onclick="dismissMorningCelebration()">Let's Go!</button>
    </div>
  </div>

  <!-- Standalone morning routine init: separate script so errors in the main script can't block it -->
  <script>
  (function() {
    try {
      var key = 'morningState-' + new Date().toISOString().slice(0, 10);
      var state = localStorage.getItem(key);
      if (state === 'dismissed') return;
      var section = document.getElementById('morningRoutine');
      if (!section) return;
      section.classList.add('show');
      var prompt = document.getElementById('morningPrompt');
      var stack = document.getElementById('morningStack');
      if (state === 'accepted') {
        if (prompt) prompt.style.display = 'none';
        if (stack) stack.style.display = 'block';
      } else {
        if (prompt) prompt.style.display = 'block';
        if (stack) stack.style.display = 'none';
      }
    } catch(e) { console.error('morning init error:', e); }
  })();
  </script>

  <!-- Cue Detection Modal -->
  <div id="cueModal" class="cue-modal">
    <div class="cue-modal-content">
      <div class="cue-modal-header">
        <div class="cue-emoji"></div>
        <h3>Cue Detected!</h3>
        <p>What triggered this awareness?</p>
      </div>
      <div class="cue-timestamp" id="cueTimestamp"></div>
      <textarea class="cue-note-input" id="cueNoteInput" placeholder="What cue did you notice? (e.g., feeling stressed, saw a snack, phone notification...)"></textarea>
      <div class="cue-modal-buttons">
        <button type="button" class="cue-cancel-btn" onclick="closeCueModal()">Cancel</button>
        <button type="button" class="cue-save-btn" onclick="saveCueAndCelebrate()">Log It! </button>
      </div>
    </div>
  </div>

  <!-- Cue Celebration Full Screen -->
  <div id="cueCelebration" class="cue-celebration">
    <div class="cue-celebration-particles" id="cueCelebrationParticles"></div>
    <div class="cue-celebration-content">
      <div class="cue-celebration-emoji" id="cueCelebrationEmoji"></div>
      <div class="cue-celebration-title" id="cueCelebrationTitle">Amazing Awareness!</div>
      <div class="cue-celebration-subtitle" id="cueCelebrationSubtitle">You just took the first step to building a better habit.</div>
      <button type="button" class="cue-celebration-dismiss" onclick="dismissCueCelebration()">Keep Going! </button>
    </div>
  </div>

  <!-- Habit Spotted Modal -->
  <div id="habitSpottedModal" class="cue-modal">
    <div class="cue-modal-content">
      <div class="cue-modal-header">
        <div class="cue-emoji"></div>
        <h3>Habit Spotted!</h3>
        <p>Which habit did you catch yourself doing?</p>
      </div>
      <div class="cue-timestamp" id="habitSpottedTimestamp"></div>
      <div class="habit-spotted-grid">
        <button type="button" class="habit-spotted-item" data-habit="sleep"> Sleep Routine</button>
        <button type="button" class="habit-spotted-item" data-habit="water"> Drank Water</button>
        <button type="button" class="habit-spotted-item" data-habit="steps"> Went for Walk</button>
        <button type="button" class="habit-spotted-item" data-habit="movement"> Movement Break</button>
        <button type="button" class="habit-spotted-item" data-habit="reading"> Read</button>
        <button type="button" class="habit-spotted-item" data-habit="meditation"> Meditated</button>
        <button type="button" class="habit-spotted-item" data-habit="meals"> Healthy Meal</button>
        <button type="button" class="habit-spotted-item" data-habit="noAlcohol"> Skipped Drink</button>
        <button type="button" class="habit-spotted-item" data-habit="supps"> Took Supps</button>
      </div>
      <textarea class="cue-note-input" id="habitSpottedNote" placeholder="Any notes? (optional)"></textarea>
      <div class="cue-modal-buttons">
        <button type="button" class="cue-cancel-btn" onclick="closeHabitSpottedModal()">Cancel</button>
      </div>
    </div>
  </div>

  <form id="healthForm">
    <div class="unlock-banner" id="unlockBanner">
      <span> This day is locked to prevent accidental edits</span>
      <button type="button" class="unlock-day-btn" onclick="unlockDay()">Unlock</button>
    </div>

    <!-- Cue & Habit Buttons -->
    <div class="awareness-section">
      <div class="awareness-buttons">
        <button type="button" class="cue-detected-btn" onclick="openCueModal()">
          <span>Cue Detected</span>
        </button>
        <button type="button" class="cue-detected-btn habit-spotted-btn" onclick="openHabitSpottedModal()">
          <span>Habit Spotted</span>
        </button>
      </div>
    </div>

    <!-- Friday Grooming Section -->
    <div id="groomingCard" class="grooming-card" style="display:none">
      <div class="grooming-header">
        <div class="grooming-icon"></div>
        <span class="grooming-title">Friday Grooming</span>
      </div>
      <div class="grooming-items">
        <label class="grooming-item">
          <input type="checkbox" id="groomingHaircut">
          <span class="grooming-check"></span>
          <span>Haircut</span>
        </label>
        <label class="grooming-item">
          <input type="checkbox" id="groomingBeardTrim">
          <span class="grooming-check"></span>
          <span>Beard Trim</span>
        </label>
      </div>
    </div>

    <script>
      window.handleAguaPlus = function() {
        var el = document.getElementById('aguaCount');
        if (!el) return;
        var n = (parseInt(el.textContent) || 0) + 1;
        el.textContent = n;
        if (typeof aguaCount !== 'undefined') aguaCount = n;
        if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
        if (typeof checkWaterGoal === 'function') checkWaterGoal();
      };
      window.handleAguaMinus = function() {
        var el = document.getElementById('aguaCount');
        if (!el) return;
        var n = Math.max(0, (parseInt(el.textContent) || 0) - 1);
        el.textContent = n;
        if (typeof aguaCount !== 'undefined') aguaCount = n;
        if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
      };
    </script>

    <div class="card sleep" id="sleepSection">
      <div class="card-head"><div class="card-icon"></div><div class="card-title">Sleep</div></div>
      <div class="input-row"><input type="number" inputmode="decimal" class="big-input" id="sleepHours" step="0.1" placeholder="0"><span class="card-unit">hrs</span></div>
      <div class="card-avg">7-day avg: <span id="avgSleep">--</span></div>
    </div>
    <div class="card water" id="waterSection">
      <div class="card-head"><div class="card-icon"></div><div class="card-title">Water</div></div>
      <div class="water-row">
        <button type="button" class="water-btn" onclick="window.handleAguaMinus()"></button>
        <div class="water-num" id="aguaCount">0</div>
        <button type="button" class="water-btn" onclick="window.handleAguaPlus()">+</button>
      </div>
      <div class="progress-bar-h">
        <div class="progress-bar-h-fill" id="aguaBarFill"></div>
      </div>
    </div>
    <div class="card supplements" id="supplementsCard">
      <div class="card-head"><div class="card-icon"></div><div class="card-title">Supps</div></div>
      <div class="mini-supps-grid">
        <div class="mini-supp" title="Creatine"><input type="checkbox" id="creatine"><span>Creatine</span></div>
        <div class="mini-supp" title="Vitamin D"><input type="checkbox" id="vitaminD"><span>Vit D</span></div>
        <div class="mini-supp" title="NO2"><input type="checkbox" id="no2"><span>NO2</span></div>
        <div class="mini-supp" title="Psyllium"><input type="checkbox" id="psyllium"><span>Psyllium</span></div>
        <div class="mini-supp" title="Zinc"><input type="checkbox" id="zinc"><span>Zinc</span></div>
        <div class="mini-supp" title="Prebiotic"><input type="checkbox" id="prebiotic"><span>Prebiotic</span></div>
      </div>
    </div>
    <div class="card movement" id="stepsCard">
      <div class="card-head"><div class="card-icon"></div><div class="card-title">Steps</div></div>
      <div class="input-row"><input type="number" inputmode="numeric" class="big-input" id="steps" placeholder="0"><span class="card-unit">steps</span></div>
      <div class="progress-bar-h">
        <div class="progress-bar-h-fill" id="stepsBarFill"></div>
      </div>
      <div class="card-avg">7-day avg: <span id="avgSteps">--</span></div>
    </div>
    
    <div class="card movement rehit-full" id="rehitCard" style="position:relative">
      <div id="rehitFreezeOverlay" class="rehit-freeze-overlay" style="display:none">
        <div class="rehit-freeze-icon"></div>
        <div class="rehit-freeze-text">REHIT Paused</div>
        <div class="rehit-freeze-sub">Phase is frozen  enjoy your vacation!</div>
      </div>
      <div class="card-head" style="margin-bottom:0">
        <div class="card-icon"></div>
        <div class="card-title">REHIT</div>
      </div>
      <div class="rehit-layout">
        <div class="rehit-left">
          <div class="chips rehit-chips">
            <div class="chip rehit-chip" id="rehit2Chip"><input type="checkbox" id="rehit2"><div class="chip-dot"></div><span class="chip-text">210</span></div>
            <div class="chip rehit-chip" id="rehit3Chip"><input type="checkbox" id="rehit3"><div class="chip-dot"></div><span class="chip-text">310</span></div>
          </div>
          <div class="card-avg rehit-week-count">This week: <span id="rehitWeek">--</span></div>
        </div>
        <div class="rehit-right">
          <div class="rehit-stats-grid">
            <div class="rehit-stat">
              <span class="rehit-stat-label">Score</span>
              <input type="number" id="fitnessScore" class="rehit-stat-input" inputmode="decimal" step="0.1" placeholder="--" style="color:var(--accent-teal)">
            </div>
            <div class="rehit-stat">
              <span class="rehit-stat-label">Cals</span>
              <input type="number" id="calories" class="rehit-stat-input" inputmode="numeric" placeholder="--" style="color:var(--accent-orange)">
            </div>
            <div class="rehit-stat">
              <span class="rehit-stat-label">Watts</span>
              <input type="number" id="peakWatts" class="rehit-stat-input" inputmode="numeric" placeholder="--" style="color:var(--accent-pink)">
            </div>
            <div class="rehit-stat">
              <span class="rehit-stat-label">W-Sec</span>
              <input type="number" id="wattSeconds" class="rehit-stat-input" inputmode="numeric" placeholder="--" style="color:var(--accent-purple)">
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="section" id="greysHabitsSection">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:#ffa552;--icon-end:#ffd93d;--icon-glow:var(--glow-orange)"></div><span class="sec-name">Grey's Habits</span></div><span class="sec-toggle"></span></div>
      <div class="sec-content">
        <div class="mini-supps-grid three-col">
          <div class="mini-supp" title="Inhaler Morning"><input type="checkbox" id="inhalerMorning"><span>Inhaler AM</span></div>
          <div class="mini-supp" title="Inhaler Evening"><input type="checkbox" id="inhalerEvening"><span>Inhaler PM</span></div>
          <div class="mini-supp" title="Math"><input type="checkbox" id="multiplication"><span>Math</span></div>
        </div>
      </div>
    </div>

    <div class="section" id="mealsSection">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:#ffa552;--icon-end:#ff6b9d;--icon-glow:var(--glow-orange)"></div><span class="sec-name">Meals</span></div><span class="sec-toggle"></span></div>
      <div class="sec-content">
        <div class="mini-supps-grid three-col" style="margin-bottom:10px">
          <div class="mini-supp"><input type="checkbox" id="breakfast"><span>Breakfast</span></div>
          <div class="mini-supp"><input type="checkbox" id="lunch"><span>Lunch</span></div>
          <div class="mini-supp"><input type="checkbox" id="dinner"><span>Dinner</span></div>
        </div>
        <div class="mini-supps-grid three-col">
          <div class="mini-supp"><input type="checkbox" id="daySnacks"><span>Day Snacks</span></div>
          <div class="mini-supp"><input type="checkbox" id="nightSnacks"><span>Night Snacks</span></div>
          <div class="mini-supp"><input type="checkbox" id="noAlcohol"><span>No Alcohol</span></div>
        </div>
      </div>
    </div>

    <div class="section" id="movementSection">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:#ff6b9d;--icon-end:#c471ed;--icon-glow:var(--glow-pink)"></div><span class="sec-name">Movement Breaks</span></div><span class="sec-toggle"></span></div>
      <div class="sec-content">
        <div id="movementList" class="movement-list"></div>
        <div class="movement-add-row">
          <select id="movementAddType">
            <option value="Walk">Walk</option>
            <option value="Carol Bike">Carol Bike</option>
            <option value="Other">Other</option>
          </select>
          <input type="number" id="movementAddDuration" placeholder="min" min="1" max="120" inputmode="numeric">
          <button type="button" class="movement-add-btn" id="movementAddBtn">+</button>
        </div>
        <div class="sync-btns" style="margin-top:10px">
          <button type="button" class="sync-shortcut-btn" id="startWalkBtn"> Start Walk</button>
          <button type="button" class="sync-shortcut-btn" id="startCyclingBtn"> Start Cycling</button>
        </div>
        <div class="card-avg" style="margin-top:10px">Daily avg: <span id="avgMovements">--</span> min</div>
      </div>
    </div>

    <div class="section" id="mentalHabitsSection">
      <div class="sec-head collapsed"><div class="sec-title"><div class="sec-icon" style="--icon-start:#c471ed;--icon-end:#6dd5ed;--icon-glow:var(--glow-purple)"></div><span class="sec-name">Reading</span></div><span class="sec-toggle"></span></div>
      <div class="sec-content collapsed">
        <div id="readingList" class="items"></div>
        <button type="button" class="btn btn-secondary" id="addReadingBtn">+ Add Reading</button>
      </div>
    </div>

    <div class="section" id="meditationSection">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:#ffd93d;--icon-end:#ffa552;--icon-glow:var(--glow-orange)"></div><span class="sec-name">Mindfulness</span></div><span class="sec-toggle"></span></div>
      <div class="sec-content">
        <div class="mini-supps-grid" style="grid-template-columns: 1fr;">
          <div class="mini-supp"><input type="checkbox" id="meditation"><span>Meditated</span></div>
        </div>
      </div>
    </div>

    <div class="section" id="emailSprintSection">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:#4d9de0;--icon-end:#6dd5ed;--icon-glow:var(--glow-teal)"></div><span class="sec-name">Email Sprints</span></div><span class="sec-toggle"></span></div>
      <div class="sec-content">
        <div class="email-sprint-container">
          <div class="email-sprint-count"><span id="emailSprintCount">0</span><span class="email-sprint-label"> sprints today</span></div>
          <div class="email-sprint-timer" id="emailSprintTimer">2:00</div>
          <button type="button" class="email-sprint-btn" id="emailSprintBtn">Start Sprint</button>
        </div>
      </div>
    </div>

    <!-- Reflections, Grey & Sloane, Carly moved to Writing page -->

    <div class="section" id="bodyDataSection">
      <div class="sec-head collapsed"><div class="sec-title"><div class="sec-icon" style="--icon-start:#6dd5ed;--icon-end:#c471ed;--icon-glow:var(--glow-teal)"></div><span class="sec-name">Body</span></div><span class="sec-toggle"></span></div>
      <div class="sec-content collapsed">
        <div class="body-grid">
          <div class="body-cell"><div class="body-label">Weight</div><input type="number" inputmode="decimal" class="body-input" id="weight" step="0.1"></div>
          <div class="body-cell"><div class="body-label">Waist</div><input type="number" inputmode="decimal" class="body-input" id="waist" step="0.1"></div>
          <div class="body-cell"><div class="body-label">Lean Mass</div><input type="number" inputmode="decimal" class="body-input" id="leanMass" step="0.1"></div>
          <div class="body-cell"><div class="body-label">Lean %</div><div class="body-pct" id="leanMassPercent">--</div></div>
          <div class="body-cell"><div class="body-label">Body Fat</div><input type="number" inputmode="decimal" class="body-input" id="bodyFat" step="0.1"></div>
          <div class="body-cell"><div class="body-label">Fat %</div><div class="body-pct" id="bodyFatPercent">--</div></div>
          <div class="body-cell"><div class="body-label">Bone Mass</div><input type="number" inputmode="decimal" class="body-input" id="boneMass" step="0.1"></div>
          <div class="body-cell"><div class="body-label">Bone %</div><div class="body-pct" id="boneMassPercent">--</div></div>
          <div class="body-cell"><div class="body-label">Water (lbs)</div><input type="number" inputmode="decimal" class="body-input" id="bodywater" step="0.1"></div>
          <div class="body-cell"><div class="body-label">Water %</div><div class="body-pct" id="bodywaterPercent">--</div></div>
        </div>
      </div>
    </div>

    <div class="section" id="bloodPressureSection">
      <div class="sec-head collapsed"><div class="sec-title"><div class="sec-icon" style="--icon-start:#ff6b9d;--icon-end:#c471ed;--icon-glow:var(--glow-pink)"></div><span class="sec-name">Blood Pressure</span></div><span class="sec-toggle"></span></div>
      <div class="sec-content collapsed">
        <div class="body-grid">
          <div class="body-cell"><div class="body-label">Systolic</div><input type="number" inputmode="numeric" class="body-input" id="systolic"></div>
          <div class="body-cell"><div class="body-label">Diastolic</div><input type="number" inputmode="numeric" class="body-input" id="diastolic"></div>
          <div class="body-cell"><div class="body-label">Heart Rate</div><input type="number" inputmode="numeric" class="body-input" id="heartRate"></div>
          <div class="body-cell"><div class="body-label">Status</div><div class="body-pct" id="bpStatus">--</div></div>
        </div>
      </div>
    </div>
  </form>

  <div id="chartsPage" style="display:none">
    <header class="header">
      <div class="header-top">
        <div class="brand"><div class="logo"></div><div><h1>Charts</h1></div></div>
        <button type="button" id="chartsCloseBtn" class="nav-link"></button>
      </div>
      <div style="display:flex;gap:8px;margin-top:16px">
        <button type="button" class="range-btn btn btn-secondary active" data-range="7">7 Days</button>
        <button type="button" class="range-btn btn btn-secondary" data-range="30">30 Days</button>
        <button type="button" class="range-btn btn btn-secondary" data-range="all">All</button>
      </div>
    </header>
    <div class="section"><div class="sec-name">Weight and Waist</div><canvas id="weightChart" style="max-height:220px"></canvas></div>
    <div class="section"><div class="sec-name">Sleep</div><canvas id="sleepChart" style="max-height:220px"></canvas></div>
    <div class="section"><div class="sec-name">Steps</div><canvas id="stepsChart" style="max-height:220px"></canvas></div>
    <div class="section"><div class="sec-name">Movement Breaks</div><canvas id="movementChart" style="max-height:220px"></canvas></div>
    <div class="section"><div class="sec-name">REHIT Calendar</div><div id="rehitCalendar" class="rehit-calendar"></div></div>
    <div class="section"><div class="sec-name">Peak Watts</div><canvas id="peakWattsChart" style="max-height:220px"></canvas></div>
    <div class="section"><div class="sec-name">Lean Mass %</div><canvas id="bodyCompChart" style="max-height:220px"></canvas></div>
    <div class="section"><div class="sec-name">Blood Pressure and Pulse</div><canvas id="bpChart" style="max-height:220px"></canvas></div>
  </div>

  <div id="biomarkersPage" style="display:none">
    <header class="header">
      <div class="header-top">
        <div class="brand"><div class="logo"></div><div><h1>Biomarkers</h1><div class="tagline" id="biomarkersSubtitle">Most recent: --</div></div></div>
        <button type="button" id="biomarkersCloseBtn" class="nav-link"></button>
      </div>
    </header>
    <div class="section">
      <div class="field"><label class="field-label">Lab Date</label><input type="text" class="input" id="biomarkersDate" placeholder="M/D/YY"></div>
    </div>
    <div id="biomarkersTable"></div>
    <div class="section" style="margin-top:4px">
      <button type="button" class="btn btn-primary" id="biomarkersSubmitBtn" style="width:100%">Submit</button>
      <button type="button" class="btn" id="biomarkersExportBtn" style="width:100%;margin-top:8px;background:var(--bg-card);border:1px solid var(--border-color)">Export Latest Results (CSV)</button>
      <div id="biomarkersSaveStatus" style="text-align:center;margin-top:8px;color:var(--accent-teal)"></div>
    </div>
  </div>

  <!-- Biomarker History Chart Modal -->
  <div id="bioHistoryModal" class="modal">
    <div class="modal-content" style="max-width:400px">
      <div class="modal-header">
        <div>
          <div id="bioHistoryTitle" style="font-family:'Space Grotesk', sans-serif;font-size:16px;font-weight:700">Biomarker</div>
          <div id="bioHistoryRange" style="font-size:12px;color:var(--text-muted)">Normal: --</div>
        </div>
        <button class="modal-close" onclick="closeBioHistory()"></button>
      </div>
      <div class="modal-body" style="padding:14px">
        <canvas id="bioHistoryChart" style="max-height:200px"></canvas>
        <div id="bioHistoryTable" style="margin-top:12px"></div>
      </div>
    </div>
  </div>

  <!-- Writing Page -->
  <div id="writingPage" style="display:none">
    <header class="header">
      <div class="header-top">
        <div class="brand"><div class="logo"></div><div><h1>Writing</h1><div class="tagline" id="writingDateDisplay"></div></div></div>
        <button type="button" id="writingCloseBtn" class="nav-link"></button>
      </div>
    </header>

    <div class="section" id="writingReflectionsSection">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:#c471ed;--icon-end:#ff6b9d;--icon-glow:var(--glow-purple)"></div><span class="sec-name">Reflections</span></div></div>
      <div class="sec-content"><textarea class="input" id="reflections" placeholder="What's on your mind?" style="min-height:120px"></textarea></div>
    </div>

    <div class="section" id="writingStoriesSection">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:#ff6b9d;--icon-end:#ffa552;--icon-glow:var(--glow-pink)"></div><span class="sec-name">Grey & Sloane</span></div></div>
      <div class="sec-content"><textarea class="input" id="stories" placeholder="Capture their moments..." style="min-height:120px"></textarea></div>
    </div>

    <div class="section" id="writingCarlySection">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:#ffd93d;--icon-end:#ff6b9d;--icon-glow:var(--glow-orange)"></div><span class="sec-name">Carly</span></div></div>
      <div class="sec-content"><textarea class="input" id="carly" placeholder="Notes..." style="min-height:120px"></textarea></div>
    </div>
  </div>

  <div id="weeklySummaryPage" style="display:none">
    <header class="header">
      <div class="header-top">
        <div class="brand"><div class="logo"></div><div><h1>Phase Summary</h1></div></div>
        <button type="button" id="summaryCloseBtn" class="nav-link"></button>
      </div>
      <div class="summary-controls" style="display:flex;gap:8px;">
        <select id="phaseSelector" class="phase-selector" style="display:none;">
          <!-- Populated by JS -->
        </select>
        <button type="button" class="summary-range-btn btn btn-secondary active" data-range="phase" style="flex:1;">Current Phase</button>
        <button type="button" class="summary-range-btn btn btn-secondary" data-range="all" style="flex:1;">All Time</button>
        <button type="button" id="comparePhaseBtn" class="btn btn-secondary" style="flex:1;">Compare</button>
      </div>
    </header>

    <!-- Phase Comparison Section (hidden by default) -->
    <div id="phaseComparisonSection" class="section" style="display:none">
      <div class="comparison-header">
        <div class="sec-name">Phase Comparison</div>
        <button type="button" id="closeComparisonBtn" class="comparison-close">&times;</button>
      </div>
      <div class="comparison-selectors">
        <select id="comparePhase1" class="phase-selector"></select>
        <span class="comparison-vs">vs</span>
        <select id="comparePhase2" class="phase-selector"></select>
      </div>
      <div id="phaseComparisonContent"></div>
    </div>

    <!-- Overview Stats -->
    <div class="section">
      <div class="summary-overview" id="summaryOverview">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Habit Grid -->
    <div class="section">
      <div id="habitGridContainer" class="habit-grid-container">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Phase Goals (shows targets for selected phase) -->
    <div id="phaseGoalsSection" class="section">
      <div class="sec-head" style="cursor:pointer" onclick="togglePhaseGoals()">
        <div class="sec-name"> Phase Goals</div>
        <span class="sec-toggle" id="phaseGoalsToggle"></span>
      </div>
      <div id="phaseGoalsContent" class="phase-goals-content">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- REHIT Calendar -->
    <div class="section">
      <div class="sec-name" style="margin-bottom:12px">REHIT Sessions</div>
      <div id="summaryRehitCalendar" class="rehit-calendar"></div>
    </div>
    
    <!-- Goal Performance -->
    <div class="section">
      <div class="sec-name" style="margin-bottom:12px"> Doing Great</div>
      <div id="goalsDoingWell"></div>
    </div>
    
    <div class="section">
      <div class="sec-name" style="margin-bottom:12px"> Needs Work</div>
      <div id="goalsNeedWork"></div>
    </div>
    
    <!-- Goal Categories -->
    <div class="section">
      <div class="sec-name" style="margin-bottom:12px">Health Goals</div>
      <div id="healthGoalsStats" class="goal-stats-grid"></div>
    </div>
    
    <div class="section">
      <div class="sec-name" style="margin-bottom:12px">Nutrition</div>
      <div id="nutritionStats" class="goal-stats-grid"></div>
    </div>
    
    <div class="section">
      <div class="sec-name" style="margin-bottom:12px">Mindfulness</div>
      <div id="mindfulnessStats" class="goal-stats-grid"></div>
    </div>
    
    <div class="section">
      <div class="sec-name" style="margin-bottom:12px">Kid's Habits</div>
      <div id="kidsHabitsStats" class="goal-stats-grid"></div>
    </div>
    
    <div class="section">
      <div class="sec-name" style="margin-bottom:12px">Writing</div>
      <div id="writingStats" class="goal-stats-grid"></div>
    </div>
  </div>

  <!-- Settings Page -->
  <div id="settingsPage" style="display:none">
    <header class="header">
      <div class="header-top">
        <div class="brand"><div class="logo"></div><div><h1 id="settingsTitle">Settings</h1><div class="tagline" id="settingsSubtitle">Customize your experience</div></div></div>
        <button type="button" id="settingsCloseBtn" class="nav-link"></button>
      </div>
    </header>

    <!-- Settings Main View (Card Grid) -->
    <div id="settingsMainView">
      <div class="settings-card-grid">
        <div class="settings-card" data-settings-page="goals">
          <div class="settings-card-icon"></div>
          <div class="settings-card-label">Goals</div>
          <div class="settings-card-desc">Targets & frequency</div>
        </div>
        <div class="settings-card" data-settings-page="sections">
          <div class="settings-card-icon"></div>
          <div class="settings-card-label">Manage Sections</div>
          <div class="settings-card-desc">Reorder, add & edit</div>
        </div>
        <div class="settings-card" data-settings-page="habitStacks">
          <div class="settings-card-icon"></div>
          <div class="settings-card-label">Habit Stacks</div>
          <div class="settings-card-desc">Bedtime & morning</div>
        </div>
        <div class="settings-card" data-settings-page="theme">
          <div class="settings-card-icon"></div>
          <div class="settings-card-label">Appearance</div>
          <div class="settings-card-desc">Theme & schedule</div>
        </div>
        <div class="settings-card" data-settings-page="phase">
          <div class="settings-card-icon"></div>
          <div class="settings-card-label">Phase Freeze</div>
          <div class="settings-card-desc">Pause tracking</div>
        </div>
        <div class="settings-card" data-settings-page="notes">
          <div class="settings-card-icon"></div>
          <div class="settings-card-label">Habit Notes</div>
          <div class="settings-card-desc">Insights & triggers</div>
        </div>
        <div class="settings-card" data-settings-page="data">
          <div class="settings-card-icon"></div>
          <div class="settings-card-label">Data</div>
          <div class="settings-card-desc">Export & import</div>
        </div>
      </div>
    </div>

    <!-- Subpage: Goals -->
    <div class="settings-subpage" id="settingsSub_goals">
      <button type="button" class="settings-back-btn" onclick="showSettingsMain()"> Back to Settings</button>
      <div class="section">
        <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:var(--accent-teal);--icon-end:var(--accent-pink);--icon-glow:var(--glow-teal)"></div><span class="sec-name">Goal Settings</span></div></div>
        <div class="sec-content">
          <p style="color:var(--text-muted);font-size:12px;margin:0 0 16px 0">Set your target for each goal and choose daily or weekly frequency.</p>
          <div class="goal-setting-row"><div class="goal-setting-info"><span class="goal-setting-icon"></span><span class="goal-setting-name">Sleep</span></div><div class="goal-setting-controls"><input type="number" class="goal-input" id="sleepGoal" value="7" min="4" max="12"><span class="goal-unit">hrs</span><select class="goal-freq" id="sleepFreq"><option value="daily" selected>Daily</option><option value="weekly">Weekly</option></select></div></div>
          <div class="goal-setting-row"><div class="goal-setting-info"><span class="goal-setting-icon"></span><span class="goal-setting-name">Water</span></div><div class="goal-setting-controls"><input type="number" class="goal-input" id="aguaGoal" value="6" min="1" max="20"><span class="goal-unit">glasses</span><select class="goal-freq" id="aguaFreq"><option value="daily" selected>Daily</option><option value="weekly">Weekly</option></select></div></div>
          <div class="goal-setting-row"><div class="goal-setting-info"><span class="goal-setting-icon"></span><span class="goal-setting-name">Steps</span></div><div class="goal-setting-controls"><input type="number" class="goal-input" id="stepsGoal" value="5000" min="1000" max="50000" step="500"><span class="goal-unit">steps</span><select class="goal-freq" id="stepsFreq"><option value="daily" selected>Daily</option><option value="weekly">Weekly</option></select></div></div>
          <div class="goal-setting-row"><div class="goal-setting-info"><span class="goal-setting-icon"></span><span class="goal-setting-name">Movement</span></div><div class="goal-setting-controls"><input type="number" class="goal-input" id="movementGoal" value="2" min="1" max="10"><span class="goal-unit">sessions</span><select class="goal-freq" id="movementFreq"><option value="daily" selected>Daily</option><option value="weekly">Weekly</option></select></div></div>
          <div class="goal-setting-row"><div class="goal-setting-info"><span class="goal-setting-icon"></span><span class="goal-setting-name">Meals</span></div><div class="goal-setting-controls"><input type="number" class="goal-input" id="mealsGoal" value="2" min="1" max="3"><span class="goal-unit">meals</span><select class="goal-freq" id="mealsFreq"><option value="daily" selected>Daily</option><option value="weekly">Weekly</option></select></div></div>
          <div class="goal-setting-row"><div class="goal-setting-info"><span class="goal-setting-icon"></span><span class="goal-setting-name">Healthy Snacks</span></div><div class="goal-setting-controls"><input type="number" class="goal-input" id="snacksGoal" value="2" min="1" max="2"><span class="goal-unit">checks</span><select class="goal-freq" id="snacksFreq"><option value="daily" selected>Daily</option><option value="weekly">Weekly</option></select></div></div>
          <div class="goal-setting-row"><div class="goal-setting-info"><span class="goal-setting-icon"></span><span class="goal-setting-name">No Alcohol</span></div><div class="goal-setting-controls"><input type="number" class="goal-input" id="noAlcoholGoal" value="7" min="1" max="7"><span class="goal-unit">days</span><select class="goal-freq" id="noAlcoholFreq"><option value="weekly" selected>Weekly</option><option value="daily">Daily</option></select></div></div>
          <div class="goal-setting-row"><div class="goal-setting-info"><span class="goal-setting-icon"></span><span class="goal-setting-name">REHIT 2x10</span></div><div class="goal-setting-controls"><input type="number" class="goal-input" id="rehit2x10Goal" value="2" min="0" max="7"><span class="goal-unit">sessions</span><select class="goal-freq" id="rehit2x10Freq"><option value="daily">Daily</option><option value="weekly" selected>Weekly</option></select></div></div>
          <div class="goal-setting-row"><div class="goal-setting-info"><span class="goal-setting-icon"></span><span class="goal-setting-name">REHIT 3x10</span></div><div class="goal-setting-controls"><input type="number" class="goal-input" id="rehit3x10Goal" value="3" min="0" max="7"><span class="goal-unit">sessions</span><select class="goal-freq" id="rehit3x10Freq"><option value="daily">Daily</option><option value="weekly" selected>Weekly</option></select></div></div>
          <div class="goal-setting-row"><div class="goal-setting-info"><span class="goal-setting-icon"></span><span class="goal-setting-name">Reading</span></div><div class="goal-setting-controls"><input type="number" class="goal-input" id="readingGoal" value="60" min="5" max="500" step="5"><span class="goal-unit">min</span><select class="goal-freq" id="readingFreq"><option value="daily">Daily</option><option value="weekly" selected>Weekly</option></select></div></div>
          <div class="goal-setting-row"><div class="goal-setting-info"><span class="goal-setting-icon"></span><span class="goal-setting-name">Meditation</span></div><div class="goal-setting-controls"><input type="number" class="goal-input" id="meditationGoal" value="3" min="1" max="7"><span class="goal-unit">sessions</span><select class="goal-freq" id="meditationFreq"><option value="daily">Daily</option><option value="weekly" selected>Weekly</option></select></div></div>
          <div class="goal-setting-row"><div class="goal-setting-info"><span class="goal-setting-icon"></span><span class="goal-setting-name">Email Sprints</span></div><div class="goal-setting-controls"><input type="number" class="goal-input" id="emailSprintGoal" value="3" min="1" max="10"><span class="goal-unit">sprints</span><select class="goal-freq" id="emailSprintFreq"><option value="daily" selected>Daily</option><option value="weekly">Weekly</option></select></div></div>
        </div>
      </div>
      <div class="section">
        <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:var(--accent-teal);--icon-end:var(--accent-orange);--icon-glow:var(--glow-teal)"></div><span class="sec-name">Custom Section Goals</span></div></div>
        <div class="sec-content">
          <div id="goalsList" style="min-height:32px">
            <p style="font-size:13px;color:var(--text-muted)">No custom goals tracked yet. Create a custom section with "Track as Goal" enabled.</p>
          </div>
        </div>
      </div>
      <div class="section">
        <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:var(--accent-teal);--icon-end:var(--accent-purple);--icon-glow:var(--glow-teal)"></div><span class="sec-name">About Goals</span></div></div>
        <div class="sec-content">
          <p style="color:var(--text-muted);font-size:13px;margin:0;line-height:1.5">These are your default goals. When you create a new Phase, these values are used as starting points. Each Phase can have its own targets that you set during the Phase planning process.<br><br><strong>Supplements</strong> (all 4 daily) is tracked separately as a fixed goal.</p>
        </div>
      </div>
    </div>

    <!-- Subpage: Manage Sections -->
    <div class="settings-subpage" id="settingsSub_sections">
      <button type="button" class="settings-back-btn" onclick="showSettingsMain()"> Back to Settings</button>
      <div class="section">
        <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:var(--accent-purple);--icon-end:var(--accent-pink);--icon-glow:var(--glow-purple)"></div><span class="sec-name">Manage Sections</span></div></div>
        <div class="sec-content">
          <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px">Toggle to show/hide  Reorder sections on the home page</p>
          <div id="sectionList" class="section-list"></div>
        </div>
      </div>
      <div class="section">
        <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:var(--accent-teal);--icon-end:var(--accent-purple);--icon-glow:var(--glow-teal)"></div><span class="sec-name">Add Custom Section</span></div></div>
        <div class="sec-content">
          <div class="field"><label class="field-label">Section Name</label><input type="text" class="input" id="newSectionName" placeholder="e.g., Gratitude, Goals, etc."></div>
          <div class="field"><label class="field-label">Section Type</label><select class="input" id="newSectionType"><option value="text">Text/Notes</option><option value="checkbox">Checkboxes (multiple)</option><option value="number">Number Input</option><option value="counter">Counter (+/- with goal)</option><option value="log">Log (list of entries)</option><option value="time">Time Input</option><option value="rating">Rating (1-5 stars)</option><option value="toggle">Yes/No Toggle</option></select></div>
          <div class="field"><label class="field-label">Icon (emoji)</label><input type="text" class="input" id="newSectionIcon" placeholder="" maxlength="2" style="width:80px"></div>
          <div class="field"><label class="field-label">Show on Days</label><div class="day-picker" id="newSectionDays"><span class="day-chip selected" data-day="0">S</span><span class="day-chip selected" data-day="1">M</span><span class="day-chip selected" data-day="2">T</span><span class="day-chip selected" data-day="3">W</span><span class="day-chip selected" data-day="4">T</span><span class="day-chip selected" data-day="5">F</span><span class="day-chip selected" data-day="6">S</span></div></div>
          <div id="checkboxOptions" class="type-options" style="display:none"><div class="field"><label class="field-label">Checkbox Names (comma-separated)</label><input type="text" class="input" id="checkboxNames" placeholder="Morning, Afternoon, Evening"></div></div>
          <div id="counterOptions" class="type-options" style="display:none"><div class="field"><label class="field-label">Goal Type</label><select class="input" id="counterGoalType"><option value="daily">Daily (progress bar)</option><option value="weekly">Weekly (dots)</option><option value="phase">Per Phase (phase total)</option><option value="alltime">All-time (running total)</option></select></div><div class="field"><label class="field-label">Goal Number</label><input type="number" class="input" id="counterGoalNumber" placeholder="6" min="1" max="20"></div><div class="field"><label class="field-label">Unit Label</label><input type="text" class="input" id="counterUnitLabel" placeholder="glasses, sessions, times"></div></div>
          <div id="logOptions" class="type-options" style="display:none"><div class="field"><label class="field-label">Fields per Entry</label><div id="logFieldsList"><div class="log-field-row" style="display:flex;gap:8px;margin-bottom:8px"><input type="text" class="input" placeholder="Field name" style="flex:2"><select class="input" style="flex:1"><option value="text">Text</option><option value="number">Number</option><option value="select">Dropdown</option></select><button type="button" class="btn btn-danger" onclick="this.parentElement.remove()" style="padding:8px"></button></div></div><button type="button" class="btn btn-secondary" id="addLogFieldBtn" style="width:100%;margin-top:4px">+ Add Field</button></div></div>
          <div id="numberOptions" class="type-options" style="display:none"><div class="field"><label class="field-label">Unit (optional)</label><input type="text" class="input" id="numberUnit" placeholder="lbs, mins, etc."></div><div class="field"><label class="field-label">Placeholder</label><input type="text" class="input" id="numberPlaceholder" placeholder="0"></div></div>
          <div id="ratingOptions" class="type-options" style="display:none"><div class="field"><label class="field-label">Rating Label</label><input type="text" class="input" id="ratingLabel" placeholder="How was your day?"></div></div>
          <div style="border-top:1px solid var(--border);margin-top:16px;padding-top:16px">
            <div class="field">
              <div style="display:flex;align-items:center;justify-content:space-between">
                <label class="field-label" style="margin-bottom:0">Track as Goal</label>
                <label style="position:relative;width:44px;height:24px;display:inline-block">
                  <input type="checkbox" id="newSectionTrackGoal" style="opacity:0;width:0;height:0">
                  <span style="position:absolute;cursor:pointer;inset:0;background:var(--border);border-radius:24px;transition:.3s"></span>
                  <span style="position:absolute;height:18px;width:18px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s" id="goalToggleKnob"></span>
                </label>
              </div>
            </div>
            <div id="goalOptions" style="display:none">
              <div class="field"><label class="field-label">Goal Description</label><input type="text" class="input" id="newSectionGoalDesc" placeholder="e.g., Meditate 5 times this week"></div>
              <div class="field"><label class="field-label">Timeframe</label><select class="input" id="newSectionGoalFreq"><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="phase">Per Phase (21 days)</option></select></div>
              <div class="field"><label class="field-label">Evaluation Mode</label><select class="input" id="newSectionGoalMode"><option value="days_met">Days Met (checkbox checked / toggle yes)</option><option value="cumulative_sum">Cumulative Sum (number / counter total)</option><option value="average">Average (number avg over period)</option><option value="count_entries">Count Entries (log entry count)</option></select></div>
              <div class="field" id="goalThresholdField"><label class="field-label">Target</label><input type="number" class="input" id="newSectionGoalThreshold" placeholder="e.g., 5" min="1" max="9999" step="any"><span style="font-size:11px;color:var(--text-muted)" id="goalThresholdHint">Number of days the checkbox must be checked</span></div>
              <div class="field"><label class="field-label">Comparator</label><select class="input" id="newSectionGoalComparator"><option value="gte">At least (&ge;)</option><option value="lte">At most (&le;)</option><option value="eq">Exactly (=)</option></select></div>
            </div>
          </div>
          <button type="button" class="btn btn-primary" id="addSectionBtn" style="width:100%;margin-top:12px">Add Section</button>
        </div>
      </div>
    </div>

    <!-- Subpage: Habit Stacks -->
    <div class="settings-subpage" id="settingsSub_habitStacks">
      <button type="button" class="settings-back-btn" onclick="showSettingsMain()"> Back to Settings</button>
      <div class="section">
        <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:var(--accent-purple);--icon-end:var(--accent-teal);--icon-glow:var(--glow-purple)"></div><span class="sec-name">Bedtime Habit Stack</span></div></div>
        <div class="sec-content">
          <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px">Shows every night 9:45pm-midnight. Drag to reorder.</p>
          <div id="bedtimeItemsList" class="section-list"></div>
          <div style="display:flex;gap:8px;margin-top:12px"><input type="text" class="input" id="newBedtimeItem" placeholder="New item name..." style="flex:1"><button type="button" class="btn btn-primary" id="addBedtimeItemBtn" style="padding:8px 16px">Add</button></div>
        </div>
      </div>
      <div class="section">
        <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:#ffb74d;--icon-end:#ff8a65;--icon-glow:rgba(255,183,77,0.4)"></div><span class="sec-name">Morning Habit Stack</span></div></div>
        <div class="sec-content">
          <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px">Shows when you choose to start your morning routine. Drag to reorder.</p>
          <div id="morningItemsList" class="section-list"></div>
          <div style="display:flex;gap:8px;margin-top:12px"><input type="text" class="input" id="newMorningItem" placeholder="New item name..." style="flex:1"><button type="button" class="btn btn-primary" id="addMorningItemBtn" style="padding:8px 16px">Add</button></div>
          <button type="button" id="showMorningRoutineBtn" class="btn" onclick="resetMorningRoutine()" style="margin-top:16px;width:100%;padding:10px;background:rgba(255,183,77,0.15);border:1px solid rgba(255,183,77,0.3);color:var(--text);border-radius:8px;font-size:13px;cursor:pointer"> Show Morning Routine Again</button>
        </div>
      </div>
    </div>

    <!-- Subpage: Appearance -->
    <div class="settings-subpage" id="settingsSub_theme">
      <button type="button" class="settings-back-btn" onclick="showSettingsMain()"> Back to Settings</button>
      <div class="section">
        <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:var(--accent-orange);--icon-end:var(--accent-yellow);--icon-glow:var(--glow-orange)"></div><span class="sec-name">Theme Schedule</span></div></div>
        <div class="sec-content">
          <div class="setting-row"><div class="setting-label"><span class="setting-title"> Day Mode Starts</span><span class="setting-desc">When to switch to bright theme</span></div><input type="time" class="time-input" id="dayStartTime" value="06:00"></div>
          <div class="setting-row"><div class="setting-label"><span class="setting-title"> Night Mode Starts</span><span class="setting-desc">When to switch to dark theme</span></div><input type="time" class="time-input" id="nightStartTime" value="18:00"></div>
          <div class="setting-row"><div class="setting-label"><span class="setting-title">Current Theme</span><span class="setting-desc" id="currentThemeDisplay">Auto</span></div><div class="theme-preview"><button type="button" class="theme-btn" data-theme="day" title="Day"></button><button type="button" class="theme-btn" data-theme="night" title="Night"></button></div></div>
        </div>
      </div>
    </div>

    <!-- Subpage: Phase Freeze -->
    <div class="settings-subpage" id="settingsSub_phase">
      <button type="button" class="settings-back-btn" onclick="showSettingsMain()"> Back to Settings</button>
      <div class="section">
        <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:#6dd5ed;--icon-end:#2193b0;--icon-glow:rgba(109,213,237,0.4)"></div><span class="sec-name">Phase Freeze</span></div></div>
        <div class="sec-content">
          <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px">Freeze your phase during vacations. Frozen days extend the phase end date and REHIT is paused  other goals still track normally.</p>
          <div class="setting-row" style="flex-direction:column;gap:8px;align-items:stretch">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <div class="setting-label"><span class="setting-title" id="freezeStatusTitle">Phase Active</span><span class="setting-desc" id="freezeStatusDesc">Tap to freeze your current phase</span></div>
              <button type="button" class="freeze-btn" id="freezePhaseBtn" onclick="togglePhaseFreeze()">Freeze Phase</button>
            </div>
            <div id="freezeInfoRow" style="display:none;display:flex;align-items:center;justify-content:space-between">
              <span class="frozen-badge" id="frozenDaysBadge" style="display:none"></span>
              <button type="button" class="freeze-btn" id="clearFrozenBtn" onclick="clearFrozenDays()" style="font-size:10px;padding:3px 10px;color:var(--accent-pink);border-color:var(--accent-pink)">Clear Frozen Days</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Subpage: Habit Notes -->
    <div class="settings-subpage" id="settingsSub_notes">
      <button type="button" class="settings-back-btn" onclick="showSettingsMain()"> Back to Settings</button>
      <div class="section">
        <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:var(--accent-yellow);--icon-end:var(--accent-orange);--icon-glow:var(--glow-orange)"></div><span class="sec-name">Habit Notes</span></div></div>
        <div class="sec-content">
          <p style="color:var(--text-muted);font-size:12px;margin:0 0 12px 0">Quick notes about your habits, triggers, or insights.</p>
          <div class="habit-notes-input-row"><textarea class="habit-note-input" id="newHabitNote" placeholder="Write a note about your habits..."></textarea><button type="button" class="btn btn-primary habit-note-add-btn" id="addHabitNoteBtn">Add Note</button></div>
          <div id="habitNotesList" class="habit-notes-list"></div>
        </div>
      </div>
    </div>

    <!-- Subpage: Data -->
    <div class="settings-subpage" id="settingsSub_data">
      <button type="button" class="settings-back-btn" onclick="showSettingsMain()"> Back to Settings</button>
      <div class="section">
        <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:var(--accent-pink);--icon-end:var(--accent-orange);--icon-glow:var(--glow-pink)"></div><span class="sec-name">Data</span></div></div>
        <div class="sec-content">
          <button type="button" class="btn btn-secondary" id="exportSettingsBtn" style="width:100%;margin-bottom:8px">Export Settings</button>
          <button type="button" class="btn btn-secondary" id="importSettingsBtn" style="width:100%;margin-bottom:8px">Import Settings</button>
          <input type="file" id="importSettingsFile" accept=".json" style="display:none">
        </div>
      </div>
    </div>
  </div>

  <!-- Reading Modal -->
  <div id="readingModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent-purple),var(--accent-teal));display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 0 15px var(--glow-purple)"></div>
          <div>
            <div style="font-family:'Space Grotesk', sans-serif;font-size:18px;font-weight:700">Add Reading</div>
            <div style="font-size:12px;color:var(--text-muted)">Book title and duration</div>
          </div>
        </div>
        <button class="modal-close" onclick="closeReadingModal()"></button>
      </div>
      <div class="modal-body">
        <div class="reading-field">
          <label class="reading-label" for="readingBookInput">Book Title</label>
          <input type="text" id="readingBookInput" class="reading-input" placeholder="Enter book title...">
        </div>
        <div class="reading-field">
          <label class="reading-label">Duration</label>
          <div class="duration-presets reading-duration-presets">
            <button type="button" class="duration-preset reading-duration-preset" data-mins="10">10</button>
            <button type="button" class="duration-preset reading-duration-preset" data-mins="15">15</button>
            <button type="button" class="duration-preset reading-duration-preset" data-mins="20">20</button>
            <button type="button" class="duration-preset reading-duration-preset" data-mins="30">30</button>
            <button type="button" class="duration-preset reading-duration-preset" data-mins="45">45</button>
          </div>
          <div class="duration-custom-row">
            <input type="number" id="readingCustomMins" placeholder="--" min="1" max="300" inputmode="numeric">
            <span>minutes</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="readingSaveBtn" disabled style="width:100%">Add Reading</button>
      </div>
    </div>
  </div>

  <!-- Trash Reminder Modal -->
  <div id="trashReminderModal" class="modal">
    <div class="modal-content" style="max-width:340px">
      <div class="modal-header">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent-orange),var(--accent-pink));display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 0 15px var(--glow-orange)"></div>
          <div>
            <div style="font-family:'Space Grotesk', sans-serif;font-size:18px;font-weight:700">Trash Night!</div>
            <div style="font-size:12px;color:var(--text-muted)">Tuesday reminder</div>
          </div>
        </div>
        <button class="modal-close" onclick="dismissTrashReminder()"></button>
      </div>
      <div class="modal-body" style="text-align:center;padding:24px">
        <div style="font-size:48px;margin-bottom:12px"></div>
        <div style="font-size:16px;font-weight:600;color:var(--text)">Take out the trash!</div>
        <div style="font-size:13px;color:var(--text-muted);margin-top:6px">Don't forget to put the bins out tonight</div>
      </div>
      <div class="modal-footer" style="padding:14px 18px">
        <button type="button" class="btn btn-primary" onclick="dismissTrashReminder()" style="width:100%;background:linear-gradient(135deg,var(--accent-orange),var(--accent-pink))">Got it!</button>
      </div>
    </div>
  </div>

  <button id="quickLogFab" class="fab">+</button>
  <div id="quickLogMenu" class="fab-menu">
    <button class="fab-item quick-log-item" data-action="movement"><div class="fab-icon" style="background:linear-gradient(135deg,var(--accent-pink),var(--accent-purple))"></div><span class="fab-label">Movement</span></button>
    <button class="fab-item quick-log-item" data-action="agua"><div class="fab-icon" style="background:linear-gradient(135deg,var(--accent-teal),var(--accent-purple))"></div><span class="fab-label">Water</span></button>
    <button class="fab-item quick-log-item" data-action="reading"><div class="fab-icon" style="background:linear-gradient(135deg,var(--accent-purple),var(--accent-pink))"></div><span class="fab-label">Reading</span></button>
    <button class="fab-item quick-log-item" data-action="rehit"><div class="fab-icon" style="background:linear-gradient(135deg,var(--accent-orange),var(--accent-pink))"></div><span class="fab-label">REHIT</span></button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
  <script src="app.js?v=1.8.1" defer></script>
  <script>
    // =============================================
    // TOAST NOTIFICATIONS
    // =============================================
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      if (!toast) return;
      
      const icon = toast.querySelector('.toast-icon');
      const text = toast.querySelector('.toast-text');
      
      text.textContent = message;
      icon.textContent = type === 'success' ? '' : type === 'error' ? '' : '';
      
      toast.className = 'toast ' + type;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 2000);
    }
    
    // Make it globally available
    window.showToast = showToast;
    
    // =============================================
    // LOADING OVERLAY
    // =============================================
    function showLoading() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) overlay.classList.remove('hidden');
    }
    
    function hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) overlay.classList.add('hidden');
    }
    
    window.showLoading = showLoading;
    window.hideLoading = hideLoading;
    
    // =============================================
    // PULL TO REFRESH
    // =============================================
    let pullStartY = 0;
    let isPulling = false;
    
    function setupPullToRefresh() {
      const indicator = document.getElementById('pullIndicator');
      if (!indicator) return;
      
      document.addEventListener('touchstart', (e) => {
        if (window.scrollY === 0) {
          pullStartY = e.touches[0].clientY;
          isPulling = true;
        }
      }, { passive: true });
      
      document.addEventListener('touchmove', (e) => {
        if (!isPulling) return;
        const pullDistance = e.touches[0].clientY - pullStartY;
        
        if (pullDistance > 60 && window.scrollY === 0) {
          indicator.classList.add('visible');
        }
      }, { passive: true });
      
      document.addEventListener('touchend', () => {
        if (!isPulling) return;
        isPulling = false;
        
        const indicator = document.getElementById('pullIndicator');
        if (indicator && indicator.classList.contains('visible')) {
          // Trigger refresh
          if (typeof loadDay === 'function') {
            loadDay(window.currentDate || new Date().toISOString().split('T')[0]);
          }
          
          setTimeout(() => {
            indicator.classList.remove('visible');
            showToast('Refreshed', 'success');
          }, 500);
        }
      });
    }
    
    // =============================================
    // SYNC FUNCTIONS
    // =============================================
    // Sync all chip visuals
    function syncAllChips() {
      document.querySelectorAll('.chip').forEach(c => {
        const cb = c.querySelector('input[type="checkbox"]');
        if (cb) c.classList.toggle('on', cb.checked);
      });
    }
    
    // Our own completion ring update (since app.js looks for .checkbox-field)
    // Exposed globally so app.js movement list can call it
    window.updateCompletionRingAurora = updateCompletionRingAurora;
    function updateCompletionRingAurora() {
      // 10 daily goals: sleep, agua, steps, movement, meals, no alcohol,
      // day snacks, night snacks, supplements, email sprints
      const total = 10;
      let checked = 0;

      // 1. Sleep  goal
      const sleepVal = parseFloat(document.getElementById('sleepHours')?.value) || 0;
      const sleepGoal = typeof getGoalForToday === 'function' ? getGoalForToday('sleepGoal', 7) : ((typeof appSettings !== 'undefined' && appSettings.sleepGoal) ? appSettings.sleepGoal : 7);
      if (sleepVal >= sleepGoal) checked++;

      // 2. Agua  goal
      const aguaGoal = typeof getGoalForToday === 'function' ? getGoalForToday('aguaGoal', 6) : ((typeof appSettings !== 'undefined' && appSettings.aguaGoal) ? appSettings.aguaGoal : 6);
      const aguaEl = document.getElementById('aguaCount');
      if ((aguaEl ? parseInt(aguaEl.textContent) || 0 : 0) >= aguaGoal) checked++;

      // 3. Steps  goal
      const stepsVal = parseInt(document.getElementById('steps')?.value) || 0;
      const stepsGoal = typeof getGoalForToday === 'function' ? getGoalForToday('stepsGoal', 7500) : ((typeof appSettings !== 'undefined' && appSettings.stepsGoal) ? appSettings.stepsGoal : 7500);
      if (stepsVal >= stepsGoal) checked++;

      // 4. Movement breaks  goal
      const movementGoal = typeof getGoalForToday === 'function' ? getGoalForToday('movementGoal', 2) : ((typeof appSettings !== 'undefined' && appSettings.movementGoal) ? appSettings.movementGoal : 2);
      const movementCount = (typeof currentMovements !== 'undefined' && Array.isArray(currentMovements)) ? currentMovements.length : 0;
      if (movementCount >= movementGoal) checked++;

      // 5. Meals: breakfast, lunch, dinner checked >= goal
      const mealsGoal = typeof getGoalForToday === 'function' ? getGoalForToday('mealsGoal', 2) : ((typeof appSettings !== 'undefined' && appSettings.mealsGoal) ? appSettings.mealsGoal : 2);
      const mealsChecked = ['breakfast', 'lunch', 'dinner']
        .filter(id => document.getElementById(id)?.checked).length;
      if (mealsChecked >= mealsGoal) checked++;

      // 6. No alcohol
      if (document.getElementById('noAlcohol')?.checked) checked++;

      // 7. Healthy day snacks
      if (document.getElementById('daySnacks')?.checked) checked++;

      // 8. Healthy night snacks
      if (document.getElementById('nightSnacks')?.checked) checked++;

      // 9. Supplements: all 6 (creatine, vitD, NO2, psyllium, zinc, prebiotic)
      const suppsChecked = ['creatine', 'vitaminD', 'no2', 'psyllium', 'zinc', 'prebiotic']
        .filter(id => document.getElementById(id)?.checked).length;
      if (suppsChecked === 6) checked++;

      // 10. Email sprints  goal
      const emailSprintGoalVal = typeof getGoalForToday === 'function' ? getGoalForToday('emailSprintGoal', 3) : ((typeof appSettings !== 'undefined' && appSettings.emailSprintGoal) ? appSettings.emailSprintGoal : 3);
      const emailSprintsCount = (typeof emailSprintCount !== 'undefined') ? emailSprintCount : 0;
      if (emailSprintsCount >= emailSprintGoalVal) checked++;
      
      const progress = document.getElementById('completionProgress');
      const number = document.getElementById('completionNumber');
      
      if (progress && number) {
        const circumference = 2 * Math.PI * 32; // r=32 = ~201
        let offset;
        if (total === 0) {
          offset = circumference; // Empty ring
        } else {
          offset = circumference - (checked / total) * circumference;
        }
        progress.style.strokeDashoffset = offset;
        number.textContent = checked;

        // Trigger celebration when ring is complete!
        if (checked === total && total > 0 && !window._ringCelebratedToday) {
          window._ringCelebratedToday = true;
          triggerRingCelebration();
        }
      }
    }

    // Track if we've celebrated today (resets on date change)
    window._ringCelebratedToday = false;

    // Ring completion celebration with random animations
    function triggerRingCelebration() {
      const container = document.getElementById('ringCelebration');
      if (!container) return;

      // Haptic feedback
      if (navigator.vibrate) {
        navigator.vibrate([50, 30, 100, 30, 150]); // Celebratory pattern
      }

      // Glow burst on the ring
      const ringProgress = document.getElementById('completionProgress');
      const ringText = document.getElementById('completionNumber');
      if (ringProgress) {
        ringProgress.classList.add('ring-glow-burst');
        setTimeout(() => ringProgress.classList.remove('ring-glow-burst'), 800);
      }
      if (ringText) {
        ringText.classList.add('celebrating');
        setTimeout(() => ringText.classList.remove('celebrating'), 600);
      }

      // Pick random celebration type
      const celebrations = [
        createConfettiExplosion,
        createFireworks,
        createGoldenShower,
        createEmojiParty,
        createPulseWave
      ];
      const celebrate = celebrations[Math.floor(Math.random() * celebrations.length)];
      celebrate(container);

      // Clean up after animation
      setTimeout(() => {
        container.innerHTML = '';
      }, 3500);
    }

    function createConfettiExplosion(container) {
      const colors = ['#ff6b9d', '#c471ed', '#6dd5ed', '#ffd93d', '#6bcf63', '#ff9f43', '#ee5a5a'];
      const ringRect = document.querySelector('.ring-wrap')?.getBoundingClientRect();
      const centerX = ringRect ? ringRect.left + ringRect.width / 2 : window.innerWidth / 2;
      const centerY = ringRect ? ringRect.top + ringRect.height / 2 : 100;

      for (let i = 0; i < 60; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'particle confetti';
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.left = centerX + (Math.random() - 0.5) * 100 + 'px';
        confetti.style.top = centerY + 'px';
        confetti.style.animationDelay = Math.random() * 0.3 + 's';
        confetti.style.animationDuration = (2 + Math.random() * 1.5) + 's';
        if (Math.random() > 0.5) {
          confetti.style.borderRadius = '2px';
          confetti.style.width = '8px';
          confetti.style.height = '14px';
        }
        container.appendChild(confetti);
      }
    }

    function createFireworks(container) {
      const colors = ['#ff6b9d', '#c471ed', '#6dd5ed', '#ffd93d', '#fff'];
      const positions = [
        { x: window.innerWidth * 0.3, y: 120 },
        { x: window.innerWidth * 0.5, y: 80 },
        { x: window.innerWidth * 0.7, y: 140 }
      ];

      positions.forEach((pos, idx) => {
        setTimeout(() => {
          for (let i = 0; i < 30; i++) {
            const spark = document.createElement('div');
            spark.className = 'particle firework';
            spark.style.background = colors[Math.floor(Math.random() * colors.length)];
            spark.style.boxShadow = `0 0 6px ${spark.style.background}`;
            spark.style.left = pos.x + 'px';
            spark.style.top = pos.y + 'px';
            const angle = (i / 30) * Math.PI * 2;
            const distance = 80 + Math.random() * 60;
            spark.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
            spark.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
            container.appendChild(spark);
          }
          // Extra haptic for each burst
          if (navigator.vibrate) navigator.vibrate(30);
        }, idx * 200);
      });
    }

    function createGoldenShower(container) {
      for (let i = 0; i < 50; i++) {
        const sparkle = document.createElement('div');
        sparkle.className = 'particle sparkle';
        sparkle.style.left = Math.random() * window.innerWidth + 'px';
        sparkle.style.top = -10 + 'px';
        sparkle.style.animationDelay = Math.random() * 1 + 's';
        sparkle.style.animationDuration = (1.5 + Math.random() * 1) + 's';
        container.appendChild(sparkle);
      }
    }

    function createEmojiParty(container) {
      const emojis = ['', '', '', '', '', '', '', '', '', ''];
      const ringRect = document.querySelector('.ring-wrap')?.getBoundingClientRect();
      const centerX = ringRect ? ringRect.left + ringRect.width / 2 : window.innerWidth / 2;
      const centerY = ringRect ? ringRect.top + ringRect.height / 2 : 100;

      for (let i = 0; i < 15; i++) {
        const emoji = document.createElement('div');
        emoji.className = 'emoji-burst';
        emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
        emoji.style.position = 'absolute';
        emoji.style.left = centerX + 'px';
        emoji.style.top = centerY + 'px';
        const angle = (i / 15) * Math.PI * 2;
        const distance = 100 + Math.random() * 80;
        emoji.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
        emoji.style.setProperty('--ty', Math.sin(angle) * distance - 50 + 'px');
        emoji.style.animationDelay = Math.random() * 0.2 + 's';
        container.appendChild(emoji);
      }
    }

    function createPulseWave(container) {
      const colors = ['#6dd5ed', '#c471ed', '#ff6b9d', '#ffd93d'];
      const ringRect = document.querySelector('.ring-wrap')?.getBoundingClientRect();
      const centerX = ringRect ? ringRect.left + ringRect.width / 2 : window.innerWidth / 2;
      const centerY = ringRect ? ringRect.top + ringRect.height / 2 : 100;

      for (let i = 0; i < 4; i++) {
        setTimeout(() => {
          const pulse = document.createElement('div');
          pulse.className = 'ring-pulse';
          pulse.style.left = centerX + 'px';
          pulse.style.top = centerY + 'px';
          pulse.style.width = '60px';
          pulse.style.height = '60px';
          pulse.style.borderColor = colors[i];
          pulse.style.boxShadow = `0 0 20px ${colors[i]}`;
          container.appendChild(pulse);
          if (navigator.vibrate) navigator.vibrate(20);
        }, i * 150);
      }
    }

    // Reset celebration flag on date change
    window.addEventListener('dateChanged', () => {
      window._ringCelebratedToday = false;
    });

    // ===== CUE DETECTION SYSTEM =====
    let cueTimestamp = null;

    // Haptic feedback helper (works on Android, not iOS Safari)
    function triggerHaptic(pattern) {
      if ('vibrate' in navigator) {
        try {
          navigator.vibrate(pattern);
        } catch (e) {
          console.log('Haptic not supported');
        }
      }
    }

    window.openCueModal = function() {
      const modal = document.getElementById('cueModal');
      const timestampEl = document.getElementById('cueTimestamp');
      const noteInput = document.getElementById('cueNoteInput');

      cueTimestamp = new Date();
      const timeStr = cueTimestamp.toLocaleTimeString('en-US', {
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      });
      const dateStr = cueTimestamp.toLocaleDateString('en-US', {
        weekday: 'short',
        month: 'short',
        day: 'numeric'
      });

      timestampEl.textContent = ` ${dateStr} at ${timeStr}`;
      noteInput.value = '';
      modal.classList.add('show');

      // Focus the input after animation
      setTimeout(() => noteInput.focus(), 300);

      triggerHaptic(50);
    };

    window.closeCueModal = function() {
      document.getElementById('cueModal').classList.remove('show');
      cueTimestamp = null;
    };

    window.saveCueAndCelebrate = function() {
      const noteInput = document.getElementById('cueNoteInput');
      const note = noteInput.value.trim();
      if (!note) {
        noteInput.style.borderColor = '#ff6b9d';
        noteInput.placeholder = 'Please describe the cue you noticed...';
        triggerHaptic([50, 50, 50]);
        setTimeout(() => {
          noteInput.style.borderColor = '';
          noteInput.placeholder = 'What cue did you notice? (e.g., feeling stressed, saw a snack, phone notification...)';
        }, 2000);
        return;
      }

      // Save the cue log
      saveCueLog({
        timestamp: cueTimestamp.toISOString(),
        note: note,
        date: cueTimestamp.toLocaleDateString()
      });

      // Close modal
      closeCueModal();

      // Show celebration
      showCueCelebration();
    };

    async function saveCueLog(cueData) {
      // Get existing cue logs from localStorage
      let cueLogs = [];
      try {
        const stored = localStorage.getItem('cueLogs');
        if (stored) cueLogs = JSON.parse(stored);
      } catch (e) {}

      cueLogs.push(cueData);
      localStorage.setItem('cueLogs', JSON.stringify(cueLogs));

      // Save to KV storage
      try {
        await apiPost('cue_log_save', { cueData: cueData });
      } catch (e) {
        console.log('Cue log saved locally only');
      }
    }

    // ===== HABIT SPOTTED =====
    let habitSpottedTimestamp = null;

    window.openHabitSpottedModal = function() {
      const modal = document.getElementById('habitSpottedModal');
      const timestampEl = document.getElementById('habitSpottedTimestamp');
      const noteInput = document.getElementById('habitSpottedNote');

      habitSpottedTimestamp = new Date();
      const timeStr = habitSpottedTimestamp.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
      const dateStr = habitSpottedTimestamp.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

      timestampEl.textContent = ` ${dateStr} at ${timeStr}`;
      noteInput.value = '';
      // Clear previous selections
      modal.querySelectorAll('.habit-spotted-item').forEach(btn => btn.classList.remove('selected'));
      modal.classList.add('show');
      triggerHaptic(50);
    };

    window.closeHabitSpottedModal = function() {
      document.getElementById('habitSpottedModal').classList.remove('show');
      habitSpottedTimestamp = null;
    };

    // Handle habit item selection
    document.querySelectorAll('.habit-spotted-item').forEach(btn => {
      btn.addEventListener('click', function() {
        const habit = this.dataset.habit;
        const note = document.getElementById('habitSpottedNote').value.trim();

        // Save the habit log
        saveHabitSpottedLog({
          timestamp: habitSpottedTimestamp.toISOString(),
          habit: habit,
          note: note,
          date: habitSpottedTimestamp.toLocaleDateString()
        });

        // Close modal
        closeHabitSpottedModal();

        // Show celebration reusing cue celebration
        const habitNames = {
          sleep: ' Sleep Routine', water: ' Water', steps: ' Walking',
          movement: ' Movement', reading: ' Reading', meditation: ' Meditation',
          meals: ' Healthy Meal', noAlcohol: ' No Alcohol', supps: ' Supplements'
        };
        const celebrationEl = document.getElementById('cueCelebration');
        document.getElementById('cueCelebrationEmoji').textContent = '';
        document.getElementById('cueCelebrationTitle').textContent = 'Habit Spotted!';
        document.getElementById('cueCelebrationSubtitle').textContent =
          `You noticed yourself doing "${habitNames[habit] || habit}". That's identity reinforcement!`;
        celebrationEl.classList.add('show');
        triggerHaptic([100, 50, 100]);
        setTimeout(() => dismissCueCelebration(), 3000);
      });
    });

    async function saveHabitSpottedLog(logData) {
      let logs = [];
      try {
        const stored = localStorage.getItem('habitSpottedLogs');
        if (stored) logs = JSON.parse(stored);
      } catch (e) {}
      logs.push(logData);
      localStorage.setItem('habitSpottedLogs', JSON.stringify(logs));

      try {
        await apiPost('habit_spotted_save', { logData: logData });
      } catch (e) {
        console.log('Habit spotted log saved locally only');
      }
    }

    async function loadCueLogs() {
      try {
        const result = await apiGet('cue_logs_load');
        if (result && result.logs) {
          // Merge with local storage (KV is source of truth)
          localStorage.setItem('cueLogs', JSON.stringify(result.logs));
          return result.logs;
        }
      } catch (e) {
        console.log('Loading cue logs from localStorage');
      }
      // Fallback to localStorage
      try {
        const stored = localStorage.getItem('cueLogs');
        if (stored) return JSON.parse(stored);
      } catch (e) {}
      return [];
    }

    const cueCelebrations = [
      {
        emoji: '',
        title: 'Amazing Awareness!',
        subtitle: 'You just took the first step to building a better habit.'
      },
      {
        emoji: '',
        title: 'Great Job Detecting That Cue!',
        subtitle: 'Awareness is the foundation of all change.'
      },
      {
        emoji: '',
        title: 'Cue Spotted!',
        subtitle: 'Now you can choose how to respond. That\'s real power!'
      },
      {
        emoji: '',
        title: 'Brilliant Catch!',
        subtitle: 'Every cue you notice is a chance to create a new habit.'
      },
      {
        emoji: '',
        title: 'You\'re On Fire!',
        subtitle: 'Self-awareness is a superpower. Keep using it!'
      },
      {
        emoji: '',
        title: 'Lightning Reflexes!',
        subtitle: 'You caught that cue before it controlled you.'
      },
      {
        emoji: '',
        title: 'Champion Mindset!',
        subtitle: 'The best habit builders notice their triggers. You\'re one of them!'
      },
      {
        emoji: '',
        title: 'Star Performer!',
        subtitle: 'That awareness just rewired a tiny part of your brain. For real!'
      },
      {
        emoji: '',
        title: 'Mental Muscle Flexed!',
        subtitle: 'Each time you notice a cue, your self-control grows stronger.'
      },
      {
        emoji: '',
        title: 'Launching New Habits!',
        subtitle: 'You\'ve identified a trigger. Now you can build something amazing.'
      },
      {
        emoji: '',
        title: 'Mindfulness Master!',
        subtitle: 'Being present in the moment is a gift. You just gave it to yourself.'
      },
      {
        emoji: '',
        title: 'Celebration Time!',
        subtitle: 'You\'re breaking the autopilot cycle. That deserves applause!'
      }
    ];

    function showCueCelebration() {
      const celebration = document.getElementById('cueCelebration');
      const particles = document.getElementById('cueCelebrationParticles');
      const emojiEl = document.getElementById('cueCelebrationEmoji');
      const titleEl = document.getElementById('cueCelebrationTitle');
      const subtitleEl = document.getElementById('cueCelebrationSubtitle');

      // Pick random celebration
      const cel = cueCelebrations[Math.floor(Math.random() * cueCelebrations.length)];
      emojiEl.textContent = cel.emoji;
      titleEl.textContent = cel.title;
      subtitleEl.textContent = cel.subtitle;

      // Clear and create particles
      particles.innerHTML = '';
      createCueParticles(particles);

      // Show celebration
      celebration.classList.add('show');

      // Haptic celebration pattern
      triggerHaptic([100, 50, 100, 50, 200]);
    }

    function createCueParticles(container) {
      const colors = ['#ffd93d', '#ff6b9d', '#c471ed', '#6dd5ed', '#6bcf63'];
      const emojis = ['', '', '', '', '', '', '', ''];

      // Create sparkles
      for (let i = 0; i < 30; i++) {
        const sparkle = document.createElement('div');
        sparkle.className = 'particle sparkle';
        sparkle.style.left = Math.random() * 100 + '%';
        sparkle.style.top = Math.random() * 100 + '%';
        sparkle.style.background = colors[Math.floor(Math.random() * colors.length)];
        sparkle.style.animationDelay = Math.random() * 2 + 's';
        sparkle.style.animationDuration = (1.5 + Math.random() * 2) + 's';
        container.appendChild(sparkle);
      }

      // Create floating emojis
      for (let i = 0; i < 12; i++) {
        const emoji = document.createElement('div');
        emoji.className = 'emoji-burst';
        emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
        emoji.style.position = 'absolute';
        emoji.style.left = Math.random() * 100 + '%';
        emoji.style.top = Math.random() * 100 + '%';
        emoji.style.fontSize = (20 + Math.random() * 20) + 'px';
        emoji.style.setProperty('--tx', (Math.random() - 0.5) * 200 + 'px');
        emoji.style.setProperty('--ty', (Math.random() - 0.5) * 200 + 'px');
        emoji.style.animationDelay = Math.random() * 0.5 + 's';
        container.appendChild(emoji);
      }
    }

    window.dismissCueCelebration = function() {
      const celebration = document.getElementById('cueCelebration');
      celebration.classList.remove('show');
      document.getElementById('cueCelebrationParticles').innerHTML = '';
      triggerHaptic(30);
    };

    // Agua progress bar
    function updateAguaBar(){
      const aguaCount = document.getElementById('aguaCount');
      const fill = document.getElementById('aguaBarFill');
      if(!aguaCount || !fill) return;
      const count = parseInt(aguaCount.textContent) || 0;
      const goal = typeof getGoalForToday === 'function' ? getGoalForToday('aguaGoal', 6) : ((typeof appSettings !== 'undefined' && appSettings.aguaGoal) ? appSettings.aguaGoal : 6);
      const pct = Math.min(100, (count / goal) * 100);
      fill.style.width = pct + '%';
    }

    // Steps progress bar
    function updateStepsBar(){
      const stepsInput = document.getElementById('steps');
      const fill = document.getElementById('stepsBarFill');
      if(!stepsInput || !fill) return;
      const steps = parseInt(stepsInput.value) || 0;
      const goal = typeof getGoalForToday === 'function' ? getGoalForToday('stepsGoal', 7500) : ((typeof appSettings !== 'undefined' && appSettings.stepsGoal) ? appSettings.stepsGoal : 7500);
      const pct = Math.min(100, (steps / goal) * 100);
      fill.style.width = pct + '%';
    }
    
    // Hook populateForm - wait for app.js to define it first
    function setupPopulateFormHook() {
      if (typeof window.populateForm === 'function' && !window._populateFormHooked) {
        const originalPopulateForm = window.populateForm;
        window.populateForm = async function(data) {
          // Await the original so loadDataForCurrentDate properly waits
          await originalPopulateForm.call(this, data);

          // Sync our UI after the form is fully populated
          syncAllChips();
          updateAguaBar();
          updateRehitDisplay();
          updateStepsBar();
          updateCompletionRingAurora();
        };
        window._populateFormHooked = true;
      } else if (!window._populateFormHooked) {
        // Try again in 100ms if app.js hasn't loaded yet
        setTimeout(setupPopulateFormHook, 100);
      }
    }
    
    // =============================================
    // MAIN DOM READY SETUP
    // =============================================
    document.addEventListener('DOMContentLoaded', () => {
      // Setup populateForm hook (must happen before app.js calls loadDataForCurrentDate)
      setupPopulateFormHook();

      // Sync settings from KV (async - will update UI when complete)
      if (typeof syncSettingsFromKV === 'function') syncSettingsFromKV();

      // Wire up chip toggles
      document.querySelectorAll('.chip').forEach(c => {
        c.addEventListener('click', e => {
          if(e.target.type === 'checkbox') return;
          const cb = c.querySelector('input[type="checkbox"]');
          if(cb) {
            cb.checked = !cb.checked;
            cb.dispatchEvent(new Event('change', {bubbles: true}));
          }
        });
        const cb = c.querySelector('input[type="checkbox"]');
        if(cb) {
          cb.addEventListener('change', () => {
            c.classList.toggle('on', cb.checked);
            updateCompletionRingAurora();
            if(typeof triggerSaveSoon === 'function') triggerSaveSoon();
          });
        }
      });
      
      // Wire up mini supplements
      document.querySelectorAll('.mini-supp').forEach(supp => {
        supp.addEventListener('click', () => {
          const cb = supp.querySelector('input[type="checkbox"]');
          if (cb) {
            cb.checked = !cb.checked;
            cb.dispatchEvent(new Event('change', { bubbles: true }));
            updateCompletionRingAurora();
            if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
          }
        });
      });
      
      // Propagate icon color variables to parent .section for accent bar
      document.querySelectorAll('.section .sec-icon[style]').forEach(icon => {
        const section = icon.closest('.section');
        if (!section) return;
        const raw = icon.getAttribute('style') || '';
        const m = raw.match(/--icon-start\s*:\s*([^;]+)/);
        const m2 = raw.match(/--icon-end\s*:\s*([^;]+)/);
        if (m) section.style.setProperty('--icon-start', m[1].trim());
        if (m2) section.style.setProperty('--icon-end', m2[1].trim());
      });

      // Section collapse toggles
      document.querySelectorAll('.sec-head').forEach(h => {
        h.addEventListener('click', () => {
          h.classList.toggle('collapsed');
          const c = h.nextElementSibling;
          if(c && c.classList.contains('sec-content')) c.classList.toggle('collapsed');
        });
      });
      
      // Agua count observer
      const aguaCount = document.getElementById('aguaCount');
      if (aguaCount) {
        const observer = new MutationObserver(() => { updateAguaBar(); updateCompletionRingAurora(); });
        observer.observe(aguaCount, { childList: true, characterData: true, subtree: true });
      }
      
      // Steps input listener
      const stepsInput = document.getElementById('steps');
      if (stepsInput) {
        stepsInput.addEventListener('input', () => { updateStepsBar(); updateCompletionRingAurora(); });
        stepsInput.addEventListener('change', () => { updateStepsBar(); updateCompletionRingAurora(); });
      }

      // Sleep input listener (for completion ring)
      const sleepInput = document.getElementById('sleepHours');
      if (sleepInput) {
        sleepInput.addEventListener('input', updateCompletionRingAurora);
        sleepInput.addEventListener('change', updateCompletionRingAurora);
      }

      // Movement list updates trigger completion ring via renderMovementList -> updateCompletionRing
      
      // REHIT checkbox change listeners (chip clicktoggle is handled by generic chip handler)
      const rehit2 = document.getElementById('rehit2');
      const rehit3 = document.getElementById('rehit3');
      if (rehit2) rehit2.addEventListener('change', () => { syncAllChips(); updateRehitDisplay(); });
      if (rehit3) rehit3.addEventListener('change', () => { syncAllChips(); updateRehitDisplay(); });

      // Initial update after app.js loads data
      setTimeout(() => {
        syncAllChips();
        updateAguaBar();
        updateStepsBar();
        updateRehitDisplay();
        updateCompletionRingAurora();
        updatePhaseInfoFixed();
      }, 1500);
      
      // Debug removed
    });
    
    // =============================================
    // MOVEMENT LIST  handled by setupMovementUI() in app.js
    // =============================================


    // =============================================
    // READING MODAL
    // =============================================
    let selectedReadingDuration = null;

    window.openReadingModal = function() {
      selectedReadingDuration = null;

      // Autopopulate book title from last entry
      const bookInput = document.getElementById('readingBookInput');
      if (typeof lastBookTitle !== 'undefined' && lastBookTitle) {
        bookInput.value = lastBookTitle;
      } else {
        bookInput.value = '';
      }

      // Reset duration UI
      document.querySelectorAll('.reading-duration-preset').forEach(b => b.classList.remove('selected'));
      document.getElementById('readingCustomMins').value = '';
      document.getElementById('readingSaveBtn').disabled = true;
      updateReadingSaveBtn();

      document.getElementById('readingModal').classList.add('show');
    };

    window.closeReadingModal = function() {
      document.getElementById('readingModal').classList.remove('show');
    };

    function updateReadingSaveBtn() {
      const btn = document.getElementById('readingSaveBtn');
      const bookInput = document.getElementById('readingBookInput');
      btn.disabled = !selectedReadingDuration || !bookInput.value.trim();
    }

    // Wire up reading duration presets
    document.querySelectorAll('.reading-duration-preset').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.reading-duration-preset').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedReadingDuration = parseInt(btn.dataset.mins, 10);
        document.getElementById('readingCustomMins').value = '';
        updateReadingSaveBtn();
      });
    });

    // Wire up custom reading duration input
    document.getElementById('readingCustomMins')?.addEventListener('input', (e) => {
      const val = parseInt(e.target.value, 10);
      if (val > 0) {
        document.querySelectorAll('.reading-duration-preset').forEach(b => b.classList.remove('selected'));
        selectedReadingDuration = val;
      } else {
        selectedReadingDuration = null;
      }
      updateReadingSaveBtn();
    });

    // Wire up book title input
    document.getElementById('readingBookInput')?.addEventListener('input', updateReadingSaveBtn);

    // Wire up save button
    document.getElementById('readingSaveBtn')?.addEventListener('click', () => {
      const bookInput = document.getElementById('readingBookInput');
      const bookTitle = bookInput.value.trim();
      if (!selectedReadingDuration || !bookTitle) return;

      if (typeof readings !== 'undefined') {
        readings.push({ duration: selectedReadingDuration, book: bookTitle, time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true, timeZone: 'America/Chicago' }) });
        lastBookTitle = bookTitle;
        localStorage.setItem('lastBookTitle', bookTitle);
        if (typeof renderReadings === 'function') renderReadings();
        if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
      }

      closeReadingModal();
    });

    // Close reading modal when clicking backdrop
    document.getElementById('readingModal')?.addEventListener('click',(e)=>{if(e.target.id==='readingModal')closeReadingModal()});

    // Override promptAddReading to use our modal
    window.promptAddReading = openReadingModal;

    // Also override quickLogReading for the FAB
    window.quickLogReading = async function() {
      openReadingModal();
    };

    // Also try immediately in case app.js loaded first
    setupPopulateFormHook();
    
    // Hook agua display updates
    function setupAguaHook() {
      if (typeof window.updateAguaDisplay === 'function' && !window._aguaHooked) {
        const origAgua = window.updateAguaDisplay;
        window.updateAguaDisplay = function() {
          origAgua.call(this);
          updateAguaBar();
          updateCompletionRingAurora();
        };
        window._aguaHooked = true;
      } else if (!window._aguaHooked) {
        setTimeout(setupAguaHook, 100);
      }
    }
    setupAguaHook();
    
    // Phase info using phasesData from app.js (with frozen days support)
    function updatePhaseInfoFixed() {
      const phase = (typeof getCurrentPhase === 'function') ? getCurrentPhase() : null;
      if (!phase) {
        const phaseTitleEl = document.getElementById("phaseTitle");
        if (phaseTitleEl) phaseTitleEl.textContent = "Phase 1";
        const phaseDayEl = document.getElementById("phaseDayCount");
        if (phaseDayEl) phaseDayEl.textContent = "Loading...";
        return;
      }

      const phaseStart = (typeof parseDataDate === 'function') ? parseDataDate(phase.start) : new Date(phase.start);
      const today = new Date();
      today.setHours(0,0,0,0);

      const msPerDay = 1000 * 60 * 60 * 24;
      const calendarDays = Math.floor((today - phaseStart) / msPerDay) + 1;
      const frozenDays = (typeof getPhaseFrozenDays === 'function') ? getPhaseFrozenDays(phase) : [];
      // Count frozen days up to today
      const frozenBeforeToday = frozenDays.filter(fd => {
        const d = (typeof parseDataDate === 'function') ? parseDataDate(fd) : new Date(fd);
        return d >= phaseStart && d <= today;
      }).length;
      const activeDays = Math.max(1, calendarDays - frozenBeforeToday);
      const dayInPhase = Math.min(phase.length, activeDays);
      const totalLength = phase.length;

      const phaseTitleEl = document.getElementById("phaseTitle");
      if (phaseTitleEl) phaseTitleEl.textContent = phase.name;

      const phaseDayEl = document.getElementById("phaseDayCount");
      if (phaseDayEl) {
        const frozenLabel = frozenDays.length > 0 ? ` (${frozenDays.length}d frozen)` : '';
        phaseDayEl.textContent = `Day ${dayInPhase} of ${totalLength}${frozenLabel}`;
      }

      const progressBar = document.getElementById("phaseProgressBar");
      if (progressBar) {
        const progress = ((dayInPhase - 1) / totalLength) * 100;
        progressBar.style.width = `${Math.round(progress)}%`;
      }

      if (typeof updateFreezeButton === 'function') updateFreezeButton();
      if (typeof updateFreezeOverlay === 'function') updateFreezeOverlay();
    }
    
    // Override app.js phase functions to use our fixed version
    // Run immediately and also on window load
    window.updatePhaseInfo = updatePhaseInfoFixed;
    window.loadPhaseProgress = updatePhaseInfoFixed;
    
    window.addEventListener('load', () => {
      // Ensure overrides are in place
      window.updatePhaseInfo = updatePhaseInfoFixed;
      window.loadPhaseProgress = updatePhaseInfoFixed;
      // Run it once
      updatePhaseInfoFixed();
    });
    
    // Also run phase update periodically to override any app.js changes
    setInterval(updatePhaseInfoFixed, 3000);
    
    // Periodically sync chips and update completion ring
    setInterval(() => {
      syncAllChips();
      updateCompletionRingAurora();
    }, 2000);
    
    // REHIT inline inputs - wire up autosave
    function updateRehitDisplay() {
      // No longer needed - inputs show their own values
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Wire up REHIT stat inputs to trigger save
      ['fitnessScore','calories','peakWatts','wattSeconds'].forEach(id=>{
        const el=document.getElementById(id);
        if(el) el.addEventListener('change', () => {
          if(typeof triggerSaveSoon==='function') triggerSaveSoon();
        });
      });
    });
    
    // =============================================
    // SETTINGS & THEME SYSTEM
    // =============================================

    // API URL for settings (same as app.js)
    const SETTINGS_API_URL = "https://habit-proxy.joeywigs.workers.dev/";

    // Simple fetch helpers for settings
    async function settingsApiGet(action) {
      const url = new URL(SETTINGS_API_URL);
      url.searchParams.set("action", action);
      const res = await fetch(url.toString(), { method: "GET" });
      return await res.json();
    }

    async function settingsApiPost(action, payload = {}) {
      const res = await fetch(SETTINGS_API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action, ...payload })
      });
      return await res.json();
    }

    // Default settings
    const defaultSettings = {
      dayStartTime: '05:00',
      nightStartTime: '17:00',
      // Goal values
      sleepGoal: 7,
      aguaGoal: 6,
      stepsGoal: 5000,
      movementGoal: 2,
      mealsGoal: 2,
      snacksGoal: 2,
      noAlcoholGoal: 7,
      rehit2x10Goal: 2,
      rehit3x10Goal: 3,
      rehitGoal: 4, // legacy - combined total
      readingGoal: 60,
      meditationGoal: 3,
      emailSprintGoal: 3,
      // Goal frequencies
      sleepFreq: 'daily',
      aguaFreq: 'daily',
      stepsFreq: 'daily',
      movementFreq: 'daily',
      mealsFreq: 'daily',
      snacksFreq: 'daily',
      noAlcoholFreq: 'weekly',
      rehit2x10Freq: 'weekly',
      rehit3x10Freq: 'weekly',
      readingFreq: 'weekly',
      meditationFreq: 'weekly',
      emailSprintFreq: 'daily',
      sections: [
        { id: 'sleepSection', name: 'Sleep', icon: '', visible: true, custom: false, group: 1 },
        { id: 'waterSection', name: 'Water', icon: '', visible: true, custom: false, group: 1 },
        { id: 'supplementsCard', name: 'Supplements', icon: '', visible: true, custom: false, group: 2 },
        { id: 'stepsCard', name: 'Steps', icon: '', visible: true, custom: false, group: 2 },
        { id: 'rehitCard', name: 'REHIT', icon: '', visible: true, custom: false },
        { id: 'greysHabitsSection', name: "Grey's Habits", icon: '', visible: true, custom: false },
        { id: 'mealsSection', name: 'Meals', icon: '', visible: true, custom: false },
        { id: 'movementSection', name: 'Movement Breaks', icon: '', visible: true, custom: false },
        { id: 'mentalHabitsSection', name: 'Reading', icon: '', visible: true, custom: false },
        { id: 'meditationSection', name: 'Mindfulness', icon: '', visible: true, custom: false },
        { id: 'bodyDataSection', name: 'Body', icon: '', visible: true, custom: false },
        { id: 'bloodPressureSection', name: 'Blood Pressure', icon: '', visible: true, custom: false },
        { id: 'emailSprintSection', name: 'Email Sprints', icon: '', visible: true, custom: false },
      ]
    };
    
    // Load settings from localStorage (sync, for initial load)
    function loadSettingsFromLocal() {
      try {
        const saved = localStorage.getItem('elevateSettings');
        if (saved) {
          return { ...defaultSettings, ...JSON.parse(saved) };
        }
      } catch (e) {
        console.error('Error loading settings from localStorage:', e);
      }
      return { ...defaultSettings };
    }

    // Load settings from KV (async, called after page load)
    async function loadSettingsFromKV() {
      try {
        const result = await settingsApiGet('settings_load');
        if (result.settings) {
          // Merge KV settings with defaults
          const kvSettings = { ...defaultSettings, ...result.settings };
          // Update localStorage cache
          localStorage.setItem('elevateSettings', JSON.stringify(kvSettings));
          return kvSettings;
        }
      } catch (e) {
        console.error('Error loading settings from KV:', e);
      }
      return null;
    }

    // Sync wrapper for initial load
    function loadSettings() {
      return loadSettingsFromLocal();
    }

    // Save settings to both KV and localStorage
    function saveSettings(settings) {
      try {
        localStorage.setItem('elevateSettings', JSON.stringify(settings));
      } catch (e) {
        console.error('Error saving settings to localStorage:', e);
      }
      // Also save to KV (async, fire and forget)
      settingsApiPost('settings_save', { settings }).catch(e => {
        console.error('Error saving settings to KV:', e);
      });
    }

    let appSettings = loadSettings();
    window.appSettings = appSettings;

    // Load settings from KV after page load and merge
    async function syncSettingsFromKV() {
      const kvSettings = await loadSettingsFromKV();
      if (kvSettings) {
        // Merge KV settings into appSettings
        Object.assign(appSettings, kvSettings);
        window.appSettings = appSettings;
        // Update UI elements that depend on settings
        if (typeof updateAguaBar === 'function') updateAguaBar();
        if (typeof updateStepsBar === 'function') updateStepsBar();
        if (typeof updateCompletionRingAurora === 'function') updateCompletionRingAurora();
        console.log(' Settings synced from KV');
      }
    }

    // Migrate old waterGoal  aguaGoal
    if (appSettings.waterGoal && !appSettings.aguaGoal) {
      appSettings.aguaGoal = appSettings.waterGoal;
      delete appSettings.waterGoal;
      saveSettings(appSettings);
    }

    // Theme functions
    function getCurrentTheme() {
      const now = new Date();
      const currentTime = now.getHours() * 60 + now.getMinutes();
      
      const [dayH, dayM] = appSettings.dayStartTime.split(':').map(Number);
      const [nightH, nightM] = appSettings.nightStartTime.split(':').map(Number);
      
      const dayStart = dayH * 60 + dayM;
      const nightStart = nightH * 60 + nightM;
      
      if (currentTime >= dayStart && currentTime < nightStart) {
        return 'day';
      } else {
        return 'night';
      }
    }
    
    function applyTheme(theme, showIndicator = false) {
      const body = document.body;
      const indicator = document.getElementById('themeIndicator');
      
      body.classList.remove('day-mode', 'sunset-mode');
      
      if (theme === 'day') {
        body.classList.add('day-mode');
        if (indicator) indicator.innerHTML = ' Day Mode';
      } else {
        if (indicator) indicator.innerHTML = ' Night Mode';
      }
      
      // Update theme buttons
      document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.theme === theme);
      });
      
      // Update display
      const display = document.getElementById('currentThemeDisplay');
      if (display) display.textContent = theme === 'day' ? 'Day Mode' : 'Night Mode';
      
      if (showIndicator && indicator) {
        indicator.classList.add('show');
        setTimeout(() => indicator.classList.remove('show'), 2000);
      }
    }
    
    // Initialize theme
    let currentTheme = getCurrentTheme();
    applyTheme(currentTheme, false);
    
    // Check for theme changes every minute
    setInterval(() => {
      const newTheme = getCurrentTheme();
      if (newTheme !== currentTheme) {
        currentTheme = newTheme;
        applyTheme(newTheme, true);
      }
    }, 60000);
    
    // =============================================
    // SETTINGS PAGE
    // =============================================
    
    function openSettingsPage() {
      hideAllPages();
      const settingsPage = document.getElementById('settingsPage');
      if (settingsPage) settingsPage.style.display = 'block';

      // Reset to main view
      showSettingsMain();
      setActiveNav('settings');
      
      // Populate settings
      document.getElementById('dayStartTime').value = appSettings.dayStartTime;
      document.getElementById('nightStartTime').value = appSettings.nightStartTime;

      // Goal values - use ?? instead of || to allow 0 values
      document.getElementById('sleepGoal').value = appSettings.sleepGoal ?? 7;
      document.getElementById('aguaGoal').value = appSettings.aguaGoal ?? 6;
      document.getElementById('stepsGoal').value = appSettings.stepsGoal ?? 5000;
      document.getElementById('movementGoal').value = appSettings.movementGoal ?? 2;
      document.getElementById('mealsGoal').value = appSettings.mealsGoal ?? 2;
      document.getElementById('snacksGoal').value = appSettings.snacksGoal ?? 2;
      document.getElementById('noAlcoholGoal').value = appSettings.noAlcoholGoal ?? 7;
      document.getElementById('rehit2x10Goal').value = appSettings.rehit2x10Goal ?? 2;
      document.getElementById('rehit3x10Goal').value = appSettings.rehit3x10Goal ?? 3;
      document.getElementById('readingGoal').value = appSettings.readingGoal ?? 60;
      document.getElementById('meditationGoal').value = appSettings.meditationGoal ?? 3;
      document.getElementById('emailSprintGoal').value = appSettings.emailSprintGoal ?? 3;

      // Goal frequencies
      document.getElementById('sleepFreq').value = appSettings.sleepFreq || 'daily';
      document.getElementById('aguaFreq').value = appSettings.aguaFreq || 'daily';
      document.getElementById('stepsFreq').value = appSettings.stepsFreq || 'daily';
      document.getElementById('movementFreq').value = appSettings.movementFreq || 'daily';
      document.getElementById('mealsFreq').value = appSettings.mealsFreq || 'daily';
      document.getElementById('snacksFreq').value = appSettings.snacksFreq || 'daily';
      document.getElementById('noAlcoholFreq').value = appSettings.noAlcoholFreq || 'weekly';
      document.getElementById('rehit2x10Freq').value = appSettings.rehit2x10Freq || 'weekly';
      document.getElementById('rehit3x10Freq').value = appSettings.rehit3x10Freq || 'weekly';
      document.getElementById('readingFreq').value = appSettings.readingFreq || 'weekly';
      document.getElementById('meditationFreq').value = appSettings.meditationFreq || 'weekly';
      document.getElementById('emailSprintFreq').value = appSettings.emailSprintFreq || 'daily';

      window.scrollTo(0, 0);
      renderSectionList();
      loadHabitNotes(); // Reload habit notes when settings page opens
    }

    function closeSettingsPage() {
      // Blur active element to flush any pending change events on goal inputs
      if (document.activeElement) document.activeElement.blur();

      document.getElementById('settingsPage').style.display = 'none';
      document.getElementById('healthForm').style.display = '';
      document.getElementById('quickLogFab').style.display = 'block';

      // Apply section visibility
      applySectionSettings();
      setActiveNav('home');
      window.scrollTo(0, 0);
    }
    
    function migrateSection(sec) {
      // Convert old single-type format to multi-field format
      if (sec.custom && sec.type && !sec.fields) {
        sec.fields = [{
          id: 'f_' + Date.now() + '_0',
          name: sec.name,
          type: sec.type,
          config: sec.config || {}
        }];
        delete sec.type;
        delete sec.config;
      }
      return sec;
    }

    function ensureMigrated() {
      let changed = false;

      // Migrate old custom section format
      appSettings.sections.forEach(sec => {
        if (sec.custom && sec.type && !sec.fields) {
          migrateSection(sec);
          changed = true;
        }
      });

      // Rename old nutritionSection  supplementsCard
      appSettings.sections.forEach(sec => {
        if (sec.id === 'nutritionSection') {
          sec.id = 'supplementsCard';
          changed = true;
        }
      });

      // Add any missing built-in sections
      const builtinIds = defaultSettings.sections.filter(s => !s.custom).map(s => s.id);
      const existingIds = new Set(appSettings.sections.map(s => s.id));
      builtinIds.forEach(id => {
        if (!existingIds.has(id)) {
          const def = defaultSettings.sections.find(s => s.id === id);
          if (def) {
            appSettings.sections.push({ ...def });
            changed = true;
          }
        }
      });

      // Remove entries that reference non-existent HTML elements (stale custom sections excluded)
      const validBuiltinIds = new Set(builtinIds);
      appSettings.sections = appSettings.sections.filter(sec => {
        if (sec.custom) return true; // keep all custom sections
        return validBuiltinIds.has(sec.id);
      });

      if (changed) saveSettings(appSettings);
    }

    // Run migration on load
    ensureMigrated();

    function renderSectionList() {
      const list = document.getElementById('sectionList');
      if (!list) return;

      const dayAbbr = ['S','M','T','W','T','F','S'];
      list.innerHTML = appSettings.sections.map((sec, idx) => {
        const daysLabel = (sec.days && sec.days.length < 7)
          ? `<span style="font-size:10px;color:var(--text-muted);margin-left:4px">${sec.days.map(d => dayAbbr[d]).join('')}</span>`
          : '';
        const groupLabel = (sec.group != null)
          ? `<span style="font-size:9px;color:var(--accent-teal);margin-left:4px">paired${sec.size === 2 ? '  tall' : ''}</span>`
          : '';
        return `
        <div class="section-item" data-idx="${idx}" data-id="${sec.id}">
          <span class="section-item-icon">${sec.icon}</span>
          <span class="section-item-name">${sec.name}${daysLabel}${groupLabel}</span>
          <button class="section-item-edit" data-idx="${idx}" title="Edit fields"></button>
          <div class="section-item-toggle ${sec.visible ? 'on' : ''}" data-idx="${idx}"></div>
          ${sec.custom ? `<button class="section-item-delete" data-idx="${idx}"></button>` : ''}
        </div>
        <div class="section-field-editor" id="fieldEditor_${idx}" style="display:none"></div>
      `}).join('');

      // Toggle visibility
      list.querySelectorAll('.section-item-toggle').forEach(toggle => {
        toggle.addEventListener('click', () => {
          const idx = parseInt(toggle.dataset.idx);
          appSettings.sections[idx].visible = !appSettings.sections[idx].visible;
          toggle.classList.toggle('on');
          saveSettings(appSettings);
          applySectionSettings();
        });
      });

      // Delete custom sections
      list.querySelectorAll('.section-item-delete').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.idx);
          if (confirm('Delete this section?')) {
            const sec = appSettings.sections[idx];
            const el = document.getElementById(sec.id);
            if (el) el.remove();
            appSettings.sections.splice(idx, 1);
            saveSettings(appSettings);
            renderSectionList();
            applySectionSettings();
          }
        });
      });

      // Edit fields
      list.querySelectorAll('.section-item-edit').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.idx);
          const editor = document.getElementById(`fieldEditor_${idx}`);
          if (!editor) return;
          const isOpen = editor.style.display !== 'none';
          list.querySelectorAll('.section-field-editor').forEach(e => e.style.display = 'none');
          if (!isOpen) {
            renderFieldEditor(idx);
            editor.style.display = 'block';
          }
        });
      });
    }

    const FIELD_TYPES = [
      { value: 'text', label: 'Text/Notes' },
      { value: 'checkbox', label: 'Checkboxes' },
      { value: 'number', label: 'Number' },
      { value: 'counter', label: 'Counter (+/-)' },
      { value: 'time', label: 'Time' },
      { value: 'rating', label: 'Rating (1-5)' },
      { value: 'toggle', label: 'Yes/No Toggle' }
    ];

    function renderFieldEditor(sectionIdx) {
      const sec = appSettings.sections[sectionIdx];
      if (!sec) return;
      const editor = document.getElementById(`fieldEditor_${sectionIdx}`);
      if (!editor) return;

      const fields = sec.fields || [];
      const typeOptions = FIELD_TYPES.map(t => `<option value="${t.value}">${t.label}</option>`).join('');
      const isCustom = sec.custom;

      const dayNames = ['S','M','T','W','T','F','S'];
      const secDays = sec.days || [0,1,2,3,4,5,6];
      const dayPickerHtml = isCustom ? `
          <div class="field" style="margin-bottom:8px">
            <label class="field-label">Show on Days</label>
            <div class="day-picker" id="editSecDays_${sectionIdx}">
              ${dayNames.map((d,i) => `<span class="day-chip${secDays.includes(i) ? ' selected' : ''}" data-day="${i}">${d}</span>`).join('')}
            </div>
          </div>` : '';

      const headerHtml = isCustom ? `
          <div class="field-editor-header">
            <div class="field" style="margin-bottom:8px">
              <label class="field-label">Section Name</label>
              <input type="text" class="input" id="editSecName_${sectionIdx}" value="${sec.name}">
            </div>
            <div class="field" style="margin-bottom:8px">
              <label class="field-label">Icon</label>
              <input type="text" class="input" id="editSecIcon_${sectionIdx}" value="${sec.icon}" maxlength="2" style="width:60px">
            </div>
          </div>
          ${dayPickerHtml}` : '';

      const fieldsLabel = isCustom ? 'Fields' : 'Additional Fields';
      const noFieldsHint = !isCustom && fields.length === 0
        ? '<p style="font-size:11px;color:var(--text-muted);margin:4px 0 8px">Add custom inputs to this section</p>' : '';

      const curSize = sec.size || 1;
      const curWidth = sec.width || 1;
      const chipStyle = 'style="width:auto;border-radius:8px;padding:4px 12px;font-size:11px"';
      const sizePickerHtml = `
          <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:8px">
            <div class="field" style="margin-bottom:0;flex:1;min-width:120px">
              <label class="field-label">Width</label>
              <div class="day-picker" id="editSecWidth_${sectionIdx}">
                <span class="day-chip${curWidth === 1 ? ' selected' : ''}" data-size="1" ${chipStyle}>Half</span>
                <span class="day-chip${curWidth === 2 ? ' selected' : ''}" data-size="2" ${chipStyle}>Full</span>
              </div>
            </div>
            <div class="field" style="margin-bottom:0;flex:1;min-width:120px">
              <label class="field-label">Height when paired</label>
              <div class="day-picker" id="editSecSize_${sectionIdx}">
                <span class="day-chip${curSize === 1 ? ' selected' : ''}" data-size="1" ${chipStyle}>1 row</span>
                <span class="day-chip${curSize === 2 ? ' selected' : ''}" data-size="2" ${chipStyle}>2 rows</span>
              </div>
            </div>
          </div>`;

      editor.innerHTML = `
        <div class="field-editor-panel">
          ${headerHtml}
          ${sizePickerHtml}
          <div class="field-label" style="margin-bottom:6px;font-weight:600">${fieldsLabel}</div>
          ${noFieldsHint}
          <div id="fieldList_${sectionIdx}">
            ${fields.map((f, fi) => renderFieldRow(sectionIdx, fi, f, typeOptions)).join('')}
          </div>
          <button type="button" class="btn btn-secondary" style="width:100%;margin-top:8px;font-size:12px" onclick="addFieldToSection(${sectionIdx})">+ Add Field</button>
          <button type="button" class="btn btn-primary" style="width:100%;margin-top:8px;font-size:12px" onclick="saveFieldEditor(${sectionIdx})">Save Changes</button>
        </div>
      `;
    }

    function renderFieldRow(sectionIdx, fieldIdx, field, typeOptions) {
      const configHtml = getFieldConfigHtml(sectionIdx, fieldIdx, field);
      return `
        <div class="field-row" data-fi="${fieldIdx}">
          <div style="display:flex;gap:6px;align-items:center;margin-bottom:4px">
            <input type="text" class="input" value="${field.name}" placeholder="Field name"
              id="fieldName_${sectionIdx}_${fieldIdx}" style="flex:2;font-size:12px;padding:6px 8px">
            <select class="input" id="fieldType_${sectionIdx}_${fieldIdx}"
              onchange="onFieldTypeChange(${sectionIdx},${fieldIdx})"
              style="flex:1;font-size:12px;padding:6px 8px">
              ${typeOptions.replace(`value="${field.type}"`, `value="${field.type}" selected`)}
            </select>
            <button type="button" class="btn btn-danger" onclick="removeField(${sectionIdx},${fieldIdx})" style="padding:4px 8px;font-size:14px"></button>
          </div>
          <div id="fieldConfig_${sectionIdx}_${fieldIdx}" style="padding-left:8px;margin-bottom:8px">${configHtml}</div>
        </div>
      `;
    }

    function getFieldConfigHtml(si, fi, field) {
      const t = field.type;
      const c = field.config || {};
      let typeConfig = '';

      if (t === 'checkbox') {
        typeConfig = `<input type="text" class="input" placeholder="Names (comma-separated)" id="fieldCfg_${si}_${fi}_cb" value="${(c.checkboxes || []).join(', ')}" style="font-size:11px;padding:4px 8px">`;
      } else if (t === 'counter') {
        typeConfig = `<div style="display:flex;gap:6px">
          <input type="number" class="input" id="fieldCfg_${si}_${fi}_goalNum" placeholder="Goal #" value="${c.goalNumber || 6}" min="1" style="font-size:11px;padding:4px;width:60px">
          <input type="text" class="input" id="fieldCfg_${si}_${fi}_unit" placeholder="Unit" value="${c.unitLabel || 'times'}" style="font-size:11px;padding:4px;flex:1">
        </div>`;
      } else if (t === 'number') {
        typeConfig = `<div style="display:flex;gap:6px">
          <input type="text" class="input" id="fieldCfg_${si}_${fi}_unit" placeholder="Unit (optional)" value="${c.unit || ''}" style="font-size:11px;padding:4px;flex:1">
          <input type="text" class="input" id="fieldCfg_${si}_${fi}_ph" placeholder="Placeholder" value="${c.placeholder || '0'}" style="font-size:11px;padding:4px;flex:1">
        </div>`;
      } else if (t === 'rating') {
        typeConfig = `<input type="text" class="input" id="fieldCfg_${si}_${fi}_label" placeholder="Rating label" value="${c.label || 'Rate'}" style="font-size:11px;padding:4px">`;
      }

      // Universal goal config for all field types
      const hasGoal = c.goalEnabled || false;
      const needsTarget = ['counter', 'number', 'rating'].includes(t);
      const goalTarget = c.goalTarget || c.goalNumber || '';
      const goalFreq = c.goalFreq || c.goalType || 'daily';
      const goalUnit = c.goalUnit || c.unitLabel || '';

      const goalConfig = `
        <div style="margin-top:6px;padding-top:6px;border-top:1px solid var(--border)">
          <label style="display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text-muted);cursor:pointer">
            <input type="checkbox" id="fieldCfg_${si}_${fi}_goalEnabled" ${hasGoal ? 'checked' : ''} onchange="toggleGoalConfig(${si},${fi})">
            Track as goal
          </label>
          <div id="fieldCfg_${si}_${fi}_goalOpts" style="display:${hasGoal ? 'flex' : 'none'};gap:6px;margin-top:4px">
            <select class="input" id="fieldCfg_${si}_${fi}_goalFreq" style="font-size:11px;padding:4px;flex:1">
              <option value="daily" ${goalFreq === 'daily' ? 'selected' : ''}>Daily</option>
              <option value="weekly" ${goalFreq === 'weekly' ? 'selected' : ''}>Weekly</option>
              <option value="phase" ${goalFreq === 'phase' ? 'selected' : ''}>Per Phase</option>
            </select>
            ${needsTarget ? `<input type="number" class="input" id="fieldCfg_${si}_${fi}_goalTarget" placeholder="Target" value="${goalTarget}" min="1" style="font-size:11px;padding:4px;width:55px">` : ''}
            ${needsTarget ? `<input type="text" class="input" id="fieldCfg_${si}_${fi}_goalUnit" placeholder="Unit" value="${goalUnit}" style="font-size:11px;padding:4px;flex:1">` : ''}
          </div>
        </div>`;

      return typeConfig + goalConfig;
    }

    window.toggleGoalConfig = function(si, fi) {
      const cb = document.getElementById(`fieldCfg_${si}_${fi}_goalEnabled`);
      const opts = document.getElementById(`fieldCfg_${si}_${fi}_goalOpts`);
      if (opts) opts.style.display = cb?.checked ? 'flex' : 'none';
    };

    window.onFieldTypeChange = function(si, fi) {
      const sel = document.getElementById(`fieldType_${si}_${fi}`);
      const container = document.getElementById(`fieldConfig_${si}_${fi}`);
      if (!sel || !container) return;
      const field = { type: sel.value, config: {} };
      container.innerHTML = getFieldConfigHtml(si, fi, field);
    };

    window.addFieldToSection = function(si) {
      const sec = appSettings.sections[si];
      if (!sec.fields) sec.fields = [];
      sec.fields.push({ id: 'f_' + Date.now(), name: '', type: 'text', config: {} });
      renderFieldEditor(si);
    };

    window.removeField = function(si, fi) {
      const sec = appSettings.sections[si];
      if (!sec.fields) return;
      if (sec.custom && sec.fields.length <= 1) {
        alert('Custom section must have at least one field');
        return;
      }
      sec.fields.splice(fi, 1);
      renderFieldEditor(si);
    };

    function collectFieldEditorData(si) {
      const sec = appSettings.sections[si];
      if (!sec) return;

      // Update name, icon, and days for custom sections
      if (sec.custom) {
        const nameInput = document.getElementById(`editSecName_${si}`);
        const iconInput = document.getElementById(`editSecIcon_${si}`);
        if (nameInput?.value.trim()) sec.name = nameInput.value.trim();
        if (iconInput?.value) sec.icon = iconInput.value;
        // Collect day-of-week selection
        const dayPicker = document.getElementById(`editSecDays_${si}`);
        if (dayPicker) {
          const selectedDays = Array.from(dayPicker.querySelectorAll('.day-chip.selected')).map(c => parseInt(c.dataset.day));
          sec.days = selectedDays.length > 0 && selectedDays.length < 7 ? selectedDays : undefined;
        }
      }

      // Update section width and height  applies to all sections
      const widthPicker = document.getElementById(`editSecWidth_${si}`);
      if (widthPicker) {
        const sel = widthPicker.querySelector('.day-chip.selected');
        const w = sel ? parseInt(sel.dataset.size) : 1;
        if (w === 2) sec.width = 2; else delete sec.width;
      }
      const sizePicker = document.getElementById(`editSecSize_${si}`);
      if (sizePicker) {
        const sel = sizePicker.querySelector('.day-chip.selected');
        const sz = sel ? parseInt(sel.dataset.size) : 1;
        if (sz === 2) sec.size = 2; else delete sec.size;
      }

      // Update fields
      const fields = sec.fields || [];
      fields.forEach((f, fi) => {
        const nameEl = document.getElementById(`fieldName_${si}_${fi}`);
        const typeEl = document.getElementById(`fieldType_${si}_${fi}`);
        if (nameEl) f.name = nameEl.value.trim() || f.name;
        if (typeEl) f.type = typeEl.value;

        f.config = {};
        if (f.type === 'checkbox') {
          const val = document.getElementById(`fieldCfg_${si}_${fi}_cb`)?.value || '';
          f.config.checkboxes = val.split(',').map(s => s.trim()).filter(s => s);
        } else if (f.type === 'counter') {
          f.config.goalNumber = parseInt(document.getElementById(`fieldCfg_${si}_${fi}_goalNum`)?.value) || 6;
          f.config.unitLabel = document.getElementById(`fieldCfg_${si}_${fi}_unit`)?.value || 'times';
        } else if (f.type === 'number') {
          f.config.unit = document.getElementById(`fieldCfg_${si}_${fi}_unit`)?.value || '';
          f.config.placeholder = document.getElementById(`fieldCfg_${si}_${fi}_ph`)?.value || '0';
        } else if (f.type === 'rating') {
          f.config.label = document.getElementById(`fieldCfg_${si}_${fi}_label`)?.value || 'Rate';
        }

        // Universal goal config for all field types
        const goalEnabled = document.getElementById(`fieldCfg_${si}_${fi}_goalEnabled`)?.checked || false;
        f.config.goalEnabled = goalEnabled;
        if (goalEnabled) {
          f.config.goalFreq = document.getElementById(`fieldCfg_${si}_${fi}_goalFreq`)?.value || 'daily';
          const goalTarget = document.getElementById(`fieldCfg_${si}_${fi}_goalTarget`)?.value;
          if (goalTarget) f.config.goalTarget = parseInt(goalTarget) || 0;
          const goalUnit = document.getElementById(`fieldCfg_${si}_${fi}_goalUnit`)?.value;
          if (goalUnit) f.config.goalUnit = goalUnit;
          // Keep counter goalType in sync with universal goalFreq
          if (f.type === 'counter') {
            f.config.goalType = f.config.goalFreq;
          }
        } else if (f.type === 'counter') {
          // Counter always needs goalType for rendering
          f.config.goalType = document.getElementById(`fieldCfg_${si}_${fi}_goalFreq`)?.value || 'daily';
        }
      });
    }

    window.saveFieldEditor = function(si) {
      const sec = appSettings.sections[si];
      if (!sec) return;

      collectFieldEditorData(si);
      saveSettings(appSettings);

      if (sec.custom) {
        // Custom sections: destroy and recreate fully
        const oldEl = document.getElementById(sec.id);
        if (oldEl) oldEl.remove();
        createCustomSection(sec.id, sec.name, sec.icon, sec.fields);
      } else {
        // Built-in sections: append/rebuild custom fields container
        appendFieldsToBuiltinSection(sec);
      }
      applySectionSettings();

      renderSectionList();
      if (typeof showToast === 'function') showToast('Section updated', 'success');
    };

    function appendFieldsToBuiltinSection(sec) {
      const sectionEl = document.getElementById(sec.id);
      if (!sectionEl) return;
      const content = sectionEl.querySelector('.sec-content');
      if (!content) return;

      // Remove old custom fields container if present
      const oldContainer = content.querySelector('.builtin-extra-fields');
      if (oldContainer) oldContainer.remove();

      const fields = sec.fields || [];
      if (fields.length === 0) return;

      // Build and append
      const container = document.createElement('div');
      container.className = 'builtin-extra-fields';
      container.style.borderTop = '1px solid var(--border)';
      container.style.marginTop = '12px';
      container.style.paddingTop = '12px';

      fields.forEach(f => {
        const fieldId = `${sec.id}__${f.id}`;
        const wrap = document.createElement('div');
        wrap.className = 'custom-field-wrap';
        wrap.dataset.fieldId = f.id;
        wrap.innerHTML = buildFieldHtml(fieldId, f);
        container.appendChild(wrap);
      });

      content.appendChild(container);

      // Wire up each field
      fields.forEach(f => {
        const fieldId = `${sec.id}__${f.id}`;
        wireUpField(sectionEl, sec.id, fieldId, f);
      });

      // Init data storage
      if (!window.customSectionData[sec.id]) window.customSectionData[sec.id] = {};
    }
    
    function applySectionSettings() {
      const form = document.getElementById('healthForm');
      if (!form) return;

      // Day-of-week for the currently viewed date
      let viewingDay;
      try {
        viewingDay = (typeof currentDate !== 'undefined' && currentDate instanceof Date)
          ? currentDate.getDay()
          : new Date().getDay();
      } catch(e) { viewingDay = new Date().getDay(); }

      // 1. Pull any sections currently inside .section-row wrappers back into the form
      form.querySelectorAll('.section-row').forEach(row => {
        while (row.firstChild) form.insertBefore(row.firstChild, row);
        row.remove();
      });

      // 2. Build ordered list of visible items, grouping consecutive same-group sections
      let orderIdx = 0;
      const groups = []; // array of { group, secs: [{sec, el}] }
      appSettings.sections.forEach(sec => {
        const el = document.getElementById(sec.id);
        if (!el) return;

        let show = sec.visible;
        if (show && sec.days && Array.isArray(sec.days)) {
          show = sec.days.includes(viewingDay);
        }
        if (!show) { el.style.display = 'none'; el.style.order = ''; return; }
        el.style.display = '';

        // Group consecutive sections with the same group number
        if (sec.group != null) {
          const last = groups[groups.length - 1];
          if (last && last.group === sec.group) {
            last.secs.push({ sec, el });
            return;
          }
        }
        groups.push({ group: sec.group, secs: [{ sec, el }] });
      });

      // 3. Apply CSS order + wrap groups with 2+ items in a .section-row
      groups.forEach(g => {
        if (g.secs.length >= 2) {
          const wrapper = document.createElement('div');
          wrapper.className = 'section-row';
          wrapper.style.order = orderIdx++;
          form.insertBefore(wrapper, g.secs[0].el);
          g.secs.forEach(({ sec, el }) => {
            el.style.order = '';
            el.classList.toggle('section-size-2', sec.size === 2);
            el.classList.remove('section-wide');
            wrapper.appendChild(el);
          });
        } else {
          g.secs[0].el.classList.remove('section-size-2');
          g.secs[0].el.classList.toggle('section-wide', g.secs[0].sec.width === 2);
          g.secs[0].el.style.order = orderIdx++;
        }
      });

      // Refresh drag handles after layout changes
      if (typeof setupHomepageDrag === 'function') setupHomepageDrag();
    }
    window.applySectionSettings = applySectionSettings;

    // =============================================
    // HOMEPAGE SECTION DRAG-TO-REORDER
    // =============================================
    // Determine drop zone: top 30% = 'above', bottom 30% = 'below', middle 40% = 'group'
    function dropZone(rect, y) {
      const pct = (y - rect.top) / rect.height;
      if (pct < 0.3) return 'above';
      if (pct > 0.7) return 'below';
      return 'group';
    }

    const DROP_CLASSES = ['section-drop-above', 'section-drop-below', 'section-drop-group'];
    function clearDropClasses(container, except) {
      container.querySelectorAll('.' + DROP_CLASSES.join(', .')).forEach(x => {
        if (x !== except) DROP_CLASSES.forEach(c => x.classList.remove(c));
      });
    }
    function setDropClass(el, zone) {
      DROP_CLASSES.forEach(c => el.classList.remove(c));
      el.classList.add('section-drop-' + zone);
    }

    function setupHomepageDrag() {
      const form = document.getElementById('healthForm');
      if (!form) return;

      // Clean up existing handles
      form.querySelectorAll('.section-drag-handle').forEach(h => h.remove());

      let dragSrcId = null;

      appSettings.sections.forEach(sec => {
        const el = document.getElementById(sec.id);
        if (!el || el.style.display === 'none') return;

        // Find header  .sec-head for sections, .card-head for cards
        const secHead = el.querySelector('.sec-head');
        const cardHead = el.querySelector('.card-head');
        if (!secHead && !cardHead) return;

        // Create drag handle
        const handle = document.createElement('span');
        handle.className = 'section-drag-handle';
        handle.textContent = '';
        handle.setAttribute('title', 'Drag to reorder or drop on center to pair side-by-side');
        handle.addEventListener('click', e => { e.stopPropagation(); e.preventDefault(); });

        // Insert handle: inside .sec-title for sections, at start of .card-head for cards
        if (secHead) {
          const secTitle = secHead.querySelector('.sec-title');
          if (secTitle) secTitle.insertBefore(handle, secTitle.firstChild);
          else secHead.insertBefore(handle, secHead.firstChild);
        } else {
          cardHead.insertBefore(handle, cardHead.firstChild);
        }

        // === Desktop HTML5 Drag ===
        handle.draggable = true;

        handle.addEventListener('dragstart', e => {
          e.stopPropagation();
          dragSrcId = sec.id;
          if (e.dataTransfer.setDragImage) e.dataTransfer.setDragImage(el, 20, 20);
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', sec.id);
          requestAnimationFrame(() => el.classList.add('section-dragging'));
        });

        handle.addEventListener('dragend', () => {
          el.classList.remove('section-dragging');
          clearDropClasses(form);
          dragSrcId = null;
        });

        el.addEventListener('dragover', e => {
          if (!dragSrcId || dragSrcId === sec.id) return;
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
          const zone = dropZone(el.getBoundingClientRect(), e.clientY);
          clearDropClasses(form, el);
          setDropClass(el, zone);
        });

        el.addEventListener('dragleave', e => {
          if (!el.contains(e.relatedTarget)) {
            DROP_CLASSES.forEach(c => el.classList.remove(c));
          }
        });

        el.addEventListener('drop', e => {
          e.preventDefault();
          DROP_CLASSES.forEach(c => el.classList.remove(c));
          if (!dragSrcId || dragSrcId === sec.id) return;
          const zone = dropZone(el.getBoundingClientRect(), e.clientY);
          handleSectionDrop(dragSrcId, sec.id, zone);
          dragSrcId = null;
        });

        // === Mobile Touch Drag ===
        let touchActive = false;

        handle.addEventListener('touchstart', e => {
          e.preventDefault();
          e.stopPropagation();
          touchActive = true;
          dragSrcId = sec.id;
          el.classList.add('section-dragging');
          if (navigator.vibrate) navigator.vibrate(30);
        }, { passive: false });

        handle.addEventListener('touchmove', e => {
          if (!touchActive) return;
          e.preventDefault();
          const touchY = e.touches[0].clientY;
          appSettings.sections.forEach(other => {
            if (other.id === sec.id) return;
            const otherEl = document.getElementById(other.id);
            if (!otherEl || otherEl.style.display === 'none') return;
            const rect = otherEl.getBoundingClientRect();
            if (touchY >= rect.top && touchY <= rect.bottom) {
              const zone = dropZone(rect, touchY);
              setDropClass(otherEl, zone);
            } else {
              DROP_CLASSES.forEach(c => otherEl.classList.remove(c));
            }
          });
        }, { passive: false });

        handle.addEventListener('touchend', e => {
          if (!touchActive) return;
          touchActive = false;
          el.classList.remove('section-dragging');
          const touchY = e.changedTouches[0].clientY;
          let targetId = null, zone = 'above';
          appSettings.sections.forEach(other => {
            if (other.id === sec.id) return;
            const otherEl = document.getElementById(other.id);
            if (!otherEl || otherEl.style.display === 'none') return;
            const rect = otherEl.getBoundingClientRect();
            if (touchY >= rect.top && touchY <= rect.bottom) {
              targetId = other.id;
              zone = dropZone(rect, touchY);
            }
            DROP_CLASSES.forEach(c => otherEl.classList.remove(c));
          });
          if (targetId) handleSectionDrop(sec.id, targetId, zone);
          dragSrcId = null;
        });
      });
    }

    function handleSectionDrop(fromId, toId, zone) {
      if (zone === 'group') {
        // Pair side-by-side: assign matching group numbers, place them adjacent
        const toSec = appSettings.sections.find(s => s.id === toId);
        const fromSec = appSettings.sections.find(s => s.id === fromId);
        if (!toSec || !fromSec) return;

        // Pick a group number: reuse target's group, or generate a new one
        const groupNum = toSec.group != null
          ? toSec.group
          : Math.max(0, ...appSettings.sections.map(s => s.group || 0)) + 1;
        toSec.group = groupNum;
        fromSec.group = groupNum;

        // Move dragged section to be right next to the target (consecutive = same row)
        const fromIdx = appSettings.sections.indexOf(fromSec);
        appSettings.sections.splice(fromIdx, 1);
        const toIdx = appSettings.sections.indexOf(toSec);
        appSettings.sections.splice(toIdx + 1, 0, fromSec);
      } else {
        // Reorder: move + ungroup the dragged section
        const fromIdx = appSettings.sections.findIndex(s => s.id === fromId);
        if (fromIdx === -1) return;
        const [moved] = appSettings.sections.splice(fromIdx, 1);
        delete moved.group; // ungroup when dragged to an edge
        let toIdx = appSettings.sections.findIndex(s => s.id === toId);
        if (toIdx === -1) { appSettings.sections.push(moved); }
        else {
          if (zone === 'below') toIdx++;
          appSettings.sections.splice(toIdx, 0, moved);
        }
      }
      saveSettings(appSettings);
      applySectionSettings();
      if (navigator.vibrate) navigator.vibrate(50);
    }

    // =============================================
    // NAVIGATION DRAWER
    // =============================================
    const navDrawer = document.getElementById('navDrawer');
    const navBackdrop = document.getElementById('navDrawerBackdrop');

    function openNavDrawer() {
      navDrawer?.classList.add('open');
      navBackdrop?.classList.add('open');
    }
    function closeNavDrawer() {
      navDrawer?.classList.remove('open');
      navBackdrop?.classList.remove('open');
    }

    window.hideAllPages = function() {
      ['healthForm', 'settingsPage', 'chartsPage', 'biomarkersPage', 'weeklySummaryPage', 'writingPage'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
      });
      const fab = document.getElementById('quickLogFab');
      if (fab) fab.style.display = 'none';
    };

    window.setActiveNav = function(page) {
      document.querySelectorAll('.nav-drawer-item').forEach(item => {
        item.classList.toggle('active', item.dataset.page === page);
      });
    };

    function navigateTo(page) {
      closeNavDrawer();
      if (page === 'home') {
        hideAllPages();
        document.getElementById('healthForm').style.display = '';
        document.getElementById('quickLogFab').style.display = 'block';
        window.scrollTo(0, 0);
      } else if (page === 'writing') {
        hideAllPages();
        showWritingPage();
      } else if (page === 'summary') {
        showWeeklySummaryPage();
      } else if (page === 'charts') {
        showChartsPage();
      } else if (page === 'biomarkers') {
        showBiomarkersPage();
      } else if (page === 'settings') {
        openSettingsPage();
      }
      setActiveNav(page);
    }

    // Writing page
    function showWritingPage() {
      hideAllPages();
      const wp = document.getElementById('writingPage');
      if (wp) wp.style.display = 'block';
      // Show current date
      const dateDisp = document.getElementById('writingDateDisplay');
      if (dateDisp) dateDisp.textContent = document.getElementById('dateDisplay')?.textContent || '';
      setActiveNav('writing');
      window.scrollTo(0, 0);
    }
    document.getElementById('writingCloseBtn')?.addEventListener('click', () => navigateTo('home'));

    // Settings subpage navigation
    window.showSettingsMain = function() {
      document.querySelectorAll('.settings-subpage').forEach(sp => sp.classList.remove('active'));
      document.getElementById('settingsMainView').style.display = '';
      document.getElementById('settingsTitle').textContent = 'Settings';
      document.getElementById('settingsSubtitle').textContent = 'Customize your experience';
      window.scrollTo(0, 0);
    };

    function openSettingsSubpage(pageName) {
      document.getElementById('settingsMainView').style.display = 'none';
      document.querySelectorAll('.settings-subpage').forEach(sp => sp.classList.remove('active'));
      const sub = document.getElementById('settingsSub_' + pageName);
      if (sub) sub.classList.add('active');
      if (pageName === 'sections') renderSectionList();
      if (pageName === 'goals') { renderGoalsList(); initGoalDayOverrides(); }
      if (pageName === 'notes') loadHabitNotes();
      window.scrollTo(0, 0);
    }

    document.querySelectorAll('.settings-card').forEach(card => {
      card.addEventListener('click', () => {
        const page = card.dataset.settingsPage;
        if (page) openSettingsSubpage(page);
      });
    });

    // Hamburger menu buttons
    document.getElementById('headerMenuBtn')?.addEventListener('click', openNavDrawer);
    document.getElementById('stickyMenuBtn')?.addEventListener('click', openNavDrawer);
    navBackdrop?.addEventListener('click', closeNavDrawer);

    // Start workout shortcut buttons (x-callback-url returns to app)
    const appReturnUrl = encodeURIComponent(window.location.href.split('?')[0]);
    document.getElementById('startWalkBtn')?.addEventListener('click', function() {
      localStorage.setItem('pendingWorkout', JSON.stringify({ type: 'Walk', startTime: Date.now() }));
      window.location.href = `shortcuts://x-callback-url/run-shortcut?name=${encodeURIComponent('Start Outdoor Walk')}&x-success=${appReturnUrl}`;
    });
    document.getElementById('startCyclingBtn')?.addEventListener('click', function() {
      localStorage.setItem('pendingWorkout', JSON.stringify({ type: 'Carol Bike', startTime: Date.now() }));
      window.location.href = `shortcuts://x-callback-url/run-shortcut?name=${encodeURIComponent('Start Cycling')}&x-success=${appReturnUrl}`;
    });

    // Drawer navigation items
    document.querySelectorAll('.nav-drawer-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        navigateTo(item.dataset.page);
      });
    });

    // Close buttons on subpages
    document.getElementById('settingsCloseBtn')?.addEventListener('click', () => {
      closeSettingsPage();
      setActiveNav('home');
    });
    
    // Time inputs
    document.getElementById('dayStartTime')?.addEventListener('change', (e) => {
      appSettings.dayStartTime = e.target.value;
      saveSettings(appSettings);
      currentTheme = getCurrentTheme();
      applyTheme(currentTheme, true);
    });
    
    document.getElementById('nightStartTime')?.addEventListener('change', (e) => {
      appSettings.nightStartTime = e.target.value;
      saveSettings(appSettings);
      currentTheme = getCurrentTheme();
      applyTheme(currentTheme, true);
    });
    
    // Goal inputs - unified handler
    const goalInputConfigs = [
      { id: 'sleepGoal', key: 'sleepGoal', default: 7, name: 'Sleep', updateRing: true },
      { id: 'aguaGoal', key: 'aguaGoal', default: 6, name: 'Water', updateRing: true, updateAguaBar: true },
      { id: 'stepsGoal', key: 'stepsGoal', default: 5000, name: 'Steps', updateRing: true, updateStepsBar: true },
      { id: 'movementGoal', key: 'movementGoal', default: 2, name: 'Movement', updateRing: true },
      { id: 'mealsGoal', key: 'mealsGoal', default: 2, name: 'Meals', updateRing: true },
      { id: 'snacksGoal', key: 'snacksGoal', default: 2, name: 'Snacks', updateRing: true },
      { id: 'noAlcoholGoal', key: 'noAlcoholGoal', default: 7, name: 'No Alcohol' },
      { id: 'rehit2x10Goal', key: 'rehit2x10Goal', default: 2, name: 'REHIT 2x10' },
      { id: 'rehit3x10Goal', key: 'rehit3x10Goal', default: 3, name: 'REHIT 3x10' },
      { id: 'readingGoal', key: 'readingGoal', default: 60, name: 'Reading' },
      { id: 'meditationGoal', key: 'meditationGoal', default: 3, name: 'Meditation' },
      { id: 'emailSprintGoal', key: 'emailSprintGoal', default: 3, name: 'Email Sprints', updateRing: true }
    ];

    goalInputConfigs.forEach(config => {
      const el = document.getElementById(config.id);
      if (!el) return;
      const handler = (e) => {
        const parsed = parseInt(e.target.value);
        appSettings[config.key] = isNaN(parsed) ? config.default : parsed;
        window.appSettings = appSettings;
        saveSettings(appSettings);
        if (config.updateRing && typeof updateCompletionRingAurora === 'function') updateCompletionRingAurora();
        if (config.updateAguaBar && typeof updateAguaBar === 'function') updateAguaBar();
        if (config.updateStepsBar && typeof updateStepsBar === 'function') updateStepsBar();
      };
      el.addEventListener('change', handler);
      el.addEventListener('input', handler);
    });

    // Per-day goal overrides
    function getGoalForToday(key, defaultVal, date) {
      const d = date || (window.currentDate || new Date());
      const dayOfWeek = d.getDay(); // 0=Sun, 6=Sat
      const overrides = appSettings[key + 'DayOverrides'];
      if (overrides && overrides[dayOfWeek] !== undefined && overrides[dayOfWeek] !== null && overrides[dayOfWeek] !== '') {
        return parseFloat(overrides[dayOfWeek]);
      }
      return (typeof appSettings !== 'undefined' && appSettings[key] !== undefined) ? appSettings[key] : defaultVal;
    }
    window.getGoalForToday = getGoalForToday;

    function initGoalDayOverrides() {
      const dayLabels = ['S','M','T','W','T','F','S'];
      goalInputConfigs.forEach(config => {
        const goalInput = document.getElementById(config.id);
        if (!goalInput) return;
        const row = goalInput.closest('.goal-setting-row');
        if (!row || row.querySelector('.goal-day-overrides')) return; // Already initialized

        // Add "per day" toggle link next to the controls
        const controls = row.querySelector('.goal-setting-controls');
        if (!controls) return;
        const toggle = document.createElement('span');
        toggle.className = 'goal-day-toggle';
        toggle.textContent = 'per day';
        toggle.addEventListener('click', () => {
          const overrideDiv = row.querySelector('.goal-day-overrides');
          if (overrideDiv) {
            overrideDiv.classList.toggle('open');
            toggle.textContent = overrideDiv.classList.contains('open') ? 'hide' : 'per day';
          }
        });
        controls.appendChild(toggle);

        // Create per-day override inputs
        const overrideDiv = document.createElement('div');
        overrideDiv.className = 'goal-day-overrides';
        const existingOverrides = appSettings[config.key + 'DayOverrides'] || {};
        const hasOverrides = Object.keys(existingOverrides).length > 0;

        dayLabels.forEach((label, dayIdx) => {
          const cell = document.createElement('div');
          cell.className = 'goal-day-override-cell';
          const lbl = document.createElement('label');
          lbl.textContent = label;
          const input = document.createElement('input');
          input.type = 'number';
          input.placeholder = '-';
          input.min = '0';
          input.dataset.day = dayIdx;
          input.dataset.goalKey = config.key;
          const overrideVal = existingOverrides[dayIdx];
          if (overrideVal !== undefined && overrideVal !== null && overrideVal !== '') {
            input.value = overrideVal;
          }
          input.addEventListener('change', () => {
            if (!appSettings[config.key + 'DayOverrides']) {
              appSettings[config.key + 'DayOverrides'] = {};
            }
            if (input.value === '') {
              delete appSettings[config.key + 'DayOverrides'][dayIdx];
              if (Object.keys(appSettings[config.key + 'DayOverrides']).length === 0) {
                delete appSettings[config.key + 'DayOverrides'];
              }
            } else {
              appSettings[config.key + 'DayOverrides'][dayIdx] = parseFloat(input.value);
            }
            window.appSettings = appSettings;
            saveSettings(appSettings);
            if (config.updateRing && typeof updateCompletionRingAurora === 'function') updateCompletionRingAurora();
            if (config.updateAguaBar && typeof updateAguaBar === 'function') updateAguaBar();
            if (config.updateStepsBar && typeof updateStepsBar === 'function') updateStepsBar();
          });
          cell.appendChild(lbl);
          cell.appendChild(input);
          overrideDiv.appendChild(cell);
        });

        // If overrides exist, show them open
        if (hasOverrides) {
          overrideDiv.classList.add('open');
          toggle.textContent = 'hide';
        }

        row.appendChild(overrideDiv);
      });
    }
    initGoalDayOverrides();

    // Goal frequency selectors
    const freqConfigs = [
      'sleepFreq', 'aguaFreq', 'stepsFreq', 'movementFreq', 'mealsFreq',
      'snacksFreq', 'noAlcoholFreq', 'rehit2x10Freq', 'rehit3x10Freq', 'readingFreq', 'meditationFreq', 'emailSprintFreq'
    ];

    freqConfigs.forEach(freqId => {
      document.getElementById(freqId)?.addEventListener('change', (e) => {
        appSettings[freqId] = e.target.value;
        saveSettings(appSettings);
        showToast('Frequency updated', 'success');
      });
    });

    // ===== HABIT NOTES =====
    let habitNotes = [];

    async function loadHabitNotes() {
      try {
        const result = await apiGet('habit_notes_load');
        habitNotes = result.notes || [];
      } catch (e) {
        console.error('Failed to load habit notes:', e);
        // Fall back to localStorage
        try {
          const stored = localStorage.getItem('habitNotes');
          if (stored) habitNotes = JSON.parse(stored);
        } catch (e2) {
          habitNotes = [];
        }
      }
      renderHabitNotes();
    }

    async function saveHabitNotes() {
      // Save to localStorage as backup
      localStorage.setItem('habitNotes', JSON.stringify(habitNotes));
      // Save to KV
      try {
        await apiPost('habit_notes_save', { notes: habitNotes });
      } catch (e) {
        console.error('Failed to save habit notes to KV:', e);
      }
    }

    function renderHabitNotes() {
      const list = document.getElementById('habitNotesList');
      if (!list) return;

      if (habitNotes.length === 0) {
        list.innerHTML = '<div class="habit-notes-empty">No notes yet. Add your first habit note above!</div>';
        return;
      }

      // Show newest first
      const sortedNotes = [...habitNotes].reverse();
      list.innerHTML = sortedNotes.map((note, idx) => {
        const realIdx = habitNotes.length - 1 - idx; // Get actual index
        const date = new Date(note.timestamp);
        const timeStr = date.toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric'
        }) + ' at ' + date.toLocaleTimeString('en-US', {
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        });
        return `
          <div class="habit-note-item" data-idx="${realIdx}">
            <div class="habit-note-text">${escapeHtml(note.text)}</div>
            <div class="habit-note-meta">
              <span class="habit-note-time"> ${timeStr}</span>
              <button type="button" class="habit-note-delete" onclick="deleteHabitNote(${realIdx})"> Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    window.addHabitNote = function() {
      const input = document.getElementById('newHabitNote');
      const text = input.value.trim();

      if (!text) {
        input.style.borderColor = '#ff6b9d';
        setTimeout(() => input.style.borderColor = '', 1500);
        return;
      }

      habitNotes.push({
        text: text,
        timestamp: new Date().toISOString()
      });

      saveHabitNotes();
      renderHabitNotes();
      input.value = '';
      showToast('Note added!', 'success');
    };

    window.deleteHabitNote = function(idx) {
      if (idx >= 0 && idx < habitNotes.length) {
        habitNotes.splice(idx, 1);
        saveHabitNotes();
        renderHabitNotes();
        showToast('Note deleted', 'success');
      }
    };

    // Initialize habit notes
    document.getElementById('addHabitNoteBtn')?.addEventListener('click', addHabitNote);
    document.getElementById('newHabitNote')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        addHabitNote();
      }
    });
    loadHabitNotes();

    // Theme preview buttons
    document.querySelectorAll('.theme-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        currentTheme = btn.dataset.theme;
        applyTheme(currentTheme, true);
      });
    });
    
    // Show/hide type-specific options
    document.getElementById('newSectionType')?.addEventListener('change', (e) => {
      // Hide all options first
      document.querySelectorAll('.type-options').forEach(opt => opt.style.display = 'none');
      
      // Show relevant options
      const type = e.target.value;
      if (type === 'checkbox') {
        document.getElementById('checkboxOptions').style.display = 'block';
      } else if (type === 'counter') {
        document.getElementById('counterOptions').style.display = 'block';
      } else if (type === 'log') {
        document.getElementById('logOptions').style.display = 'block';
      } else if (type === 'number') {
        document.getElementById('numberOptions').style.display = 'block';
      } else if (type === 'rating') {
        document.getElementById('ratingOptions').style.display = 'block';
      }
    });

    // Goal tracking toggle
    const goalToggle = document.getElementById('newSectionTrackGoal');
    const goalKnob = document.getElementById('goalToggleKnob');
    const goalOptionsDiv = document.getElementById('goalOptions');

    function updateGoalFormForType() {
      const type = document.getElementById('newSectionType')?.value;
      const modeSelect = document.getElementById('newSectionGoalMode');
      const hintEl = document.getElementById('goalThresholdHint');
      if (!modeSelect) return;
      if (type === 'checkbox' || type === 'toggle') {
        modeSelect.value = 'days_met';
        if (hintEl) hintEl.textContent = 'Number of days the checkbox must be checked';
      } else if (type === 'number' || type === 'counter') {
        modeSelect.value = 'cumulative_sum';
        if (hintEl) hintEl.textContent = 'Target total for the timeframe';
      } else if (type === 'log') {
        modeSelect.value = 'count_entries';
        if (hintEl) hintEl.textContent = 'Minimum number of log entries';
      } else if (type === 'rating') {
        modeSelect.value = 'average';
        if (hintEl) hintEl.textContent = 'Target average rating';
      }
    }

    if (goalToggle) {
      goalToggle.addEventListener('change', () => {
        goalOptionsDiv.style.display = goalToggle.checked ? 'block' : 'none';
        if (goalKnob) {
          goalKnob.style.transform = goalToggle.checked ? 'translateX(20px)' : 'translateX(0)';
          goalKnob.parentElement.previousElementSibling.style.background = goalToggle.checked ? 'var(--accent-teal)' : 'var(--border)';
        }
        if (goalToggle.checked) updateGoalFormForType();
      });
    }
    document.getElementById('newSectionType')?.addEventListener('change', () => {
      if (goalToggle?.checked) updateGoalFormForType();
    });
    document.getElementById('newSectionGoalMode')?.addEventListener('change', () => {
      const mode = document.getElementById('newSectionGoalMode').value;
      const hintEl = document.getElementById('goalThresholdHint');
      if (!hintEl) return;
      const hints = { days_met: 'Number of days the condition must be met', cumulative_sum: 'Target total for the timeframe', average: 'Target average value', count_entries: 'Minimum number of log entries' };
      hintEl.textContent = hints[mode] || '';
    });

    // Day-picker chip toggle (works for both the "add" form and field editor)
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('day-chip')) {
        // Size chips: radio behavior (only one selected)
        if (e.target.dataset.size) {
          e.target.parentElement.querySelectorAll('.day-chip').forEach(c => c.classList.remove('selected'));
          e.target.classList.add('selected');
        } else {
          e.target.classList.toggle('selected');
        }
      }
    });

    // Add log field button
    document.getElementById('addLogFieldBtn')?.addEventListener('click', () => {
      const list = document.getElementById('logFieldsList');
      const row = document.createElement('div');
      row.className = 'log-field-row';
      row.style.cssText = 'display:flex;gap:8px;margin-bottom:8px';
      row.innerHTML = `
        <input type="text" class="input" placeholder="Field name" style="flex:2">
        <select class="input" style="flex:1">
          <option value="text">Text</option>
          <option value="number">Number</option>
          <option value="select">Dropdown</option>
        </select>
        <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()" style="padding:8px"></button>
      `;
      list.appendChild(row);
    });
    
    // Add custom section
    document.getElementById('addSectionBtn')?.addEventListener('click', () => {
      const name = document.getElementById('newSectionName').value.trim();
      const type = document.getElementById('newSectionType').value;
      const icon = document.getElementById('newSectionIcon').value || '';
      
      if (!name) {
        alert('Please enter a section name');
        return;
      }
      
      const id = 'custom_' + Date.now();

      // Read selected days (default to all days if none selected)
      const dayChips = document.querySelectorAll('#newSectionDays .day-chip.selected');
      const days = Array.from(dayChips).map(c => parseInt(c.dataset.day));

      // Gather type-specific config
      let config = {};
      
      if (type === 'checkbox') {
        const names = document.getElementById('checkboxNames').value;
        config.checkboxes = names.split(',').map(n => n.trim()).filter(n => n);
        if (config.checkboxes.length === 0) {
          alert('Please enter at least one checkbox name');
          return;
        }
      } else if (type === 'counter') {
        config.goalType = document.getElementById('counterGoalType').value;
        config.goalNumber = parseInt(document.getElementById('counterGoalNumber').value) || 6;
        config.unitLabel = document.getElementById('counterUnitLabel').value || 'times';
        config.goalEnabled = true;
        config.goalFreq = config.goalType;
        config.goalTarget = config.goalNumber;
      } else if (type === 'log') {
        const rows = document.querySelectorAll('#logFieldsList .log-field-row');
        config.fields = [];
        rows.forEach(row => {
          const fname = row.querySelector('input').value.trim();
          const ftype = row.querySelector('select').value;
          if (fname) config.fields.push({ name: fname, type: ftype });
        });
        if (config.fields.length === 0) {
          alert('Please add at least one field for the log');
          return;
        }
      } else if (type === 'number') {
        config.unit = document.getElementById('numberUnit').value || '';
        config.placeholder = document.getElementById('numberPlaceholder').value || '0';
      } else if (type === 'rating') {
        config.label = document.getElementById('ratingLabel').value || 'Rate';
      }

      // Toggle type defaults to goal enabled
      if (type === 'toggle') {
        config.goalEnabled = true;
        config.goalFreq = 'daily';
      }

      // Goal tracking config
      const trackGoal = document.getElementById('newSectionTrackGoal')?.checked || false;
      const sectionGoal = {};
      if (trackGoal) {
        sectionGoal.trackAsGoal = true;
        sectionGoal.goalDescription = document.getElementById('newSectionGoalDesc')?.value || '';
        sectionGoal.goal = {
          timeframe: document.getElementById('newSectionGoalFreq')?.value || 'daily',
          mode: document.getElementById('newSectionGoalMode')?.value || 'days_met',
          comparator: document.getElementById('newSectionGoalComparator')?.value || 'gte',
          threshold: parseFloat(document.getElementById('newSectionGoalThreshold')?.value) || 1
        };
      }

      const fieldId = 'f_' + Date.now();
      const sectionDef = {
        id,
        name,
        icon,
        visible: true,
        custom: true,
        days: days.length > 0 && days.length < 7 ? days : undefined,
        fields: [{ id: fieldId, name: name, type, config }]
      };
      if (sectionGoal.trackAsGoal) {
        sectionDef.trackAsGoal = true;
        sectionDef.goalDescription = sectionGoal.goalDescription;
        sectionDef.goal = sectionGoal.goal;
      }
      appSettings.sections.push(sectionDef);

      saveSettings(appSettings);

      // Create the section element
      createCustomSection(id, name, icon, [{ id: fieldId, name: name, type, config }]);
      
      // Clear inputs
      document.getElementById('newSectionName').value = '';
      document.getElementById('newSectionIcon').value = '';
      document.getElementById('checkboxNames').value = '';
      document.getElementById('counterGoalNumber').value = '';
      document.getElementById('counterUnitLabel').value = '';
      document.getElementById('logFieldsList').innerHTML = `
        <div class="log-field-row" style="display:flex;gap:8px;margin-bottom:8px">
          <input type="text" class="input" placeholder="Field name" style="flex:2">
          <select class="input" style="flex:1">
            <option value="text">Text</option>
            <option value="number">Number</option>
            <option value="select">Dropdown</option>
          </select>
          <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()" style="padding:8px"></button>
        </div>
      `;
      document.querySelectorAll('.type-options').forEach(opt => opt.style.display = 'none');
      document.getElementById('newSectionType').value = 'text';
      // Reset day chips to all selected
      document.querySelectorAll('#newSectionDays .day-chip').forEach(c => c.classList.add('selected'));
      // Reset goal tracking fields
      const goalCb = document.getElementById('newSectionTrackGoal');
      if (goalCb) { goalCb.checked = false; goalCb.dispatchEvent(new Event('change')); }
      document.getElementById('newSectionGoalDesc').value = '';
      document.getElementById('newSectionGoalFreq').value = 'daily';
      document.getElementById('newSectionGoalMode').value = 'days_met';
      document.getElementById('newSectionGoalThreshold').value = '';
      document.getElementById('newSectionGoalComparator').value = 'gte';

      renderSectionList();
      renderGoalsList();
      applySectionSettings();

      // Trigger a save so the new section's data frame gets persisted to KV
      if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
    });
    
    // Store custom section data (for logs, counters, etc.)
    window.customSectionData = window.customSectionData || {};
    
    function buildFieldHtml(fieldId, field) {
      const t = field.type;
      const c = field.config || {};
      const fLabel = field.name ? `<div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;font-family:'Space Grotesk',sans-serif">${field.name}</div>` : '';

      if (t === 'text') {
        return fLabel + `<textarea class="input" id="${fieldId}_input" placeholder="Enter notes..."></textarea>`;
      } else if (t === 'checkbox') {
        const names = c.checkboxes || ['Done'];
        const colClass = names.length >= 3 ? ' three-col' : '';
        const cbs = names.map((cb, i) =>
          `<div class="mini-supp" title="${cb}"><input type="checkbox" id="${fieldId}_check_${i}"><span>${cb}</span></div>`
        ).join('');
        return fLabel + `<div class="mini-supps-grid${colClass}">${cbs}</div>`;
      } else if (t === 'number') {
        const unit = c.unit ? `<span class="card-unit">${c.unit}</span>` : '';
        return fLabel + `<div style="display:flex;align-items:center;gap:8px"><input type="number" class="big-input" id="${fieldId}_input" placeholder="${c.placeholder || '0'}" style="max-width:120px">${unit}</div>`;
      } else if (t === 'counter') {
        const goalNum = c.goalNumber || 6;
        const unit = c.unitLabel || 'times';
        const gType = c.goalType || 'daily';
        if (gType === 'alltime') {
          return fLabel + `
            <div style="display:flex;align-items:center;gap:12px">
              <button type="button" class="water-btn counter-minus" data-id="${fieldId}"></button>
              <div class="water-num counter-value" id="${fieldId}_value">0</div>
              <button type="button" class="water-btn counter-plus" data-id="${fieldId}">+</button>
            </div>
            <div class="progress-bar-h" style="margin-top:10px"><div class="progress-bar-h-fill" id="${fieldId}_fill" style="width:0%"></div></div>
            <div class="card-avg" id="${fieldId}_label" style="margin-top:6px">0 of ${goalNum} ${unit}</div>`;
        } else if (gType === 'phase') {
          return fLabel + `
            <div style="display:flex;align-items:center;gap:12px">
              <button type="button" class="water-btn counter-minus" data-id="${fieldId}"></button>
              <div class="water-num counter-value" id="${fieldId}_value">0</div>
              <button type="button" class="water-btn counter-plus" data-id="${fieldId}">+</button>
            </div>
            <div class="progress-bar-h" style="margin-top:10px"><div class="progress-bar-h-fill" id="${fieldId}_fill" style="width:0%"></div></div>
            <div class="card-avg" id="${fieldId}_label" style="margin-top:6px">0 of ${goalNum} ${unit} this phase</div>`;
        } else if (gType === 'weekly') {
          let dots = '';
          for (let i = 0; i < goalNum; i++) dots += `<div class="counter-dot" data-idx="${i}"></div>`;
          return fLabel + `
            <div style="display:flex;align-items:center;gap:12px">
              <button type="button" class="water-btn counter-minus" data-id="${fieldId}"></button>
              <div class="water-num counter-value" id="${fieldId}_value">0</div>
              <button type="button" class="water-btn counter-plus" data-id="${fieldId}">+</button>
              <div class="counter-dots" id="${fieldId}_dots" style="display:flex;gap:6px;margin-left:auto">${dots}</div>
            </div>
            <div class="card-avg" style="margin-top:8px">Goal: ${goalNum} ${unit}/week</div>`;
        } else {
          return fLabel + `
            <div style="display:flex;align-items:center;gap:12px">
              <button type="button" class="water-btn counter-minus" data-id="${fieldId}"></button>
              <div class="water-num counter-value" id="${fieldId}_value">0</div>
              <button type="button" class="water-btn counter-plus" data-id="${fieldId}">+</button>
              <div class="water-bar-wrap"><div class="water-bar-track"><div class="water-bar-fill counter-fill" id="${fieldId}_fill" style="height:0%"></div></div><div class="water-bar-goal">${goalNum}</div></div>
            </div>
            <div class="card-avg" style="margin-top:8px">Goal: ${goalNum} ${unit}/day</div>`;
        }
      } else if (t === 'log') {
        return fLabel + `<div class="items" id="${fieldId}_list"></div><button type="button" class="btn btn-secondary" id="${fieldId}_addBtn">+ Add Entry</button>`;
      } else if (t === 'time') {
        return fLabel + `<input type="time" class="input" id="${fieldId}_input">`;
      } else if (t === 'rating') {
        const label = c.label || 'Rate';
        return `<div style="font-size:12px;color:var(--text-muted);margin-bottom:8px">${label}</div>
          <div class="rating-stars" id="${fieldId}_stars">
            <span class="star" data-val="1"></span><span class="star" data-val="2"></span><span class="star" data-val="3"></span><span class="star" data-val="4"></span><span class="star" data-val="5"></span>
          </div><input type="hidden" id="${fieldId}_input" value="">`;
      } else if (t === 'toggle') {
        return fLabel + `<div class="chips"><div class="chip toggle-chip" id="${fieldId}_toggle"><input type="checkbox" id="${fieldId}_input"><div class="chip-dot"></div><span class="chip-text">Yes</span></div></div>`;
      }
      return '';
    }

    // Classify how much space a field needs so we can pair small ones
    function getFieldSize(field) {
      const t = field.type;
      const c = field.config || {};
      if (t === 'toggle' || t === 'time' || t === 'rating') return 'compact';
      if (t === 'number') return 'compact';
      if (t === 'checkbox') {
        const count = (c.checkboxes || []).length;
        return count <= 4 ? 'compact' : 'wide';
      }
      if (t === 'counter') return 'medium';
      // text, log  always full width
      return 'wide';
    }

    // Arrange fields into rows: pair compact fields side-by-side, give others a full row
    // =============================================
    // GOAL EVALUATION ENGINE
    // =============================================
    function resolveWindow(timeframe) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      if (timeframe === 'daily') {
        return { startDate: new Date(today), endDate: new Date(today) };
      } else if (timeframe === 'weekly') {
        const start = new Date(today);
        start.setDate(today.getDate() - today.getDay());
        const end = new Date(start);
        end.setDate(start.getDate() + 6);
        return { startDate: start, endDate: end };
      } else if (timeframe === 'phase') {
        const phaseStart = new Date('2026-01-19T00:00:00');
        const daysSince = Math.floor((today - phaseStart) / 86400000);
        const dayInPhase = ((daysSince % 21) + 21) % 21;
        const start = new Date(today);
        start.setDate(today.getDate() - dayInPhase);
        const end = new Date(start);
        end.setDate(start.getDate() + 20);
        return { startDate: start, endDate: end };
      }
      return { startDate: new Date(today), endDate: new Date(today) };
    }

    function goalDateStr(d) {
      return typeof formatDateForAPI === 'function'
        ? formatDateForAPI(d)
        : `${d.getMonth() + 1}/${d.getDate()}/${String(d.getFullYear()).slice(-2)}`;
    }

    async function loadDayData(dateStr) {
      try {
        if (typeof cacheGet === 'function') {
          const cached = cacheGet(dateStr);
          if (cached) return cached;
        }
        if (typeof apiGet === 'function') {
          return await apiGet('load', { date: dateStr });
        }
      } catch (e) { /* skip */ }
      return null;
    }

    function extractDayValue(sectionId, fields, dayData) {
      const sd = dayData?.customSections?.[sectionId];
      if (!sd) return null;
      // Use first field for goal evaluation
      const f = fields[0];
      if (!f) return null;
      const t = f.type;
      const c = f.config || {};
      // Data may be in new format (sd[fieldId]) or legacy format (sd.value/sd.checkboxes)
      const fd = sd[f.id] || sd;
      if (t === 'checkbox') {
        const cbs = fd.checkboxes;
        if (cbs) {
          const allChecked = cbs.every(v => v === true);
          return { met: allChecked, allChecked };
        }
        return null;
      } else if (t === 'toggle') {
        return { met: fd.value === true, value: fd.value };
      } else if (t === 'number' || t === 'counter' || t === 'time') {
        const v = t === 'counter' ? (fd.value ?? null) : (fd.value !== '' && fd.value !== undefined ? parseFloat(fd.value) : null);
        return v !== null && !isNaN(v) ? { value: v } : null;
      } else if (t === 'rating') {
        const v = fd.value ? parseInt(fd.value) : null;
        return v ? { value: v } : null;
      } else if (t === 'log') {
        const entries = fd.entries || [];
        return { count: entries.length, entries };
      }
      return null;
    }

    async function evaluateGoal(sectionId, fields, goal) {
      if (!goal) return { status: 'INSUFFICIENT_DATA', progress: 0, current: 0, threshold: 0 };
      const { startDate, endDate } = resolveWindow(goal.timeframe);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const checkEnd = endDate > today ? today : endDate;
      const msPerDay = 86400000;
      const daysToCheck = Math.floor((checkEnd - startDate) / msPerDay) + 1;
      const totalDaysInWindow = Math.floor((endDate - startDate) / msPerDay) + 1;

      let daysMet = 0, sum = 0, valuesCount = 0, entryCount = 0;

      for (let i = 0; i < daysToCheck; i++) {
        const d = new Date(startDate);
        d.setDate(startDate.getDate() + i);
        const dateStr = goalDateStr(d);
        const dayData = await loadDayData(dateStr);
        const extracted = extractDayValue(sectionId, fields, dayData);
        if (!extracted) continue;

        const t = fields[0]?.type;
        if (t === 'checkbox' || t === 'toggle') {
          if (extracted.met) daysMet++;
        } else if (t === 'number' || t === 'counter' || t === 'time' || t === 'rating') {
          if (extracted.value !== undefined && extracted.value !== null) {
            sum += extracted.value; valuesCount++; daysMet++;
          }
        } else if (t === 'log') {
          entryCount += extracted.count;
          if (extracted.count > 0) { daysMet++; }
        }
      }

      const mode = goal.mode;
      const threshold = goal.threshold || 1;
      const comparator = goal.comparator || 'gte';
      let current = 0;
      if (mode === 'days_met') current = daysMet;
      else if (mode === 'cumulative_sum') current = sum;
      else if (mode === 'average') current = valuesCount > 0 ? sum / valuesCount : 0;
      else if (mode === 'count_entries') current = entryCount;

      const compare = (a, op, b) => {
        if (op === 'gte') return a >= b;
        if (op === 'lte') return a <= b;
        if (op === 'eq') return a === b;
        return a >= b;
      };
      const met = compare(current, comparator, threshold);
      const progress = threshold > 0 ? Math.min(1, current / threshold) : (met ? 1 : 0);
      return {
        status: met ? 'SUCCESS' : 'FAIL',
        progress,
        current: Math.round(current * 100) / 100,
        threshold, comparator, daysMet,
        daysInWindow: totalDaysInWindow,
        daysChecked: daysToCheck, mode
      };
    }

    async function updateGoalProgress(sectionId, fields, goal) {
      const progressEl = document.getElementById(`${sectionId}_goalProgress`);
      if (!progressEl) return;
      const result = await evaluateGoal(sectionId, fields, goal);
      const comparatorSymbol = { gte: '\u2265', lte: '\u2264', eq: '=' }[goal.comparator] || '\u2265';
      let label = '';
      if (goal.mode === 'days_met') {
        const timeLabel = goal.timeframe === 'weekly' ? 'this week' : goal.timeframe === 'phase' ? 'this phase' : 'today';
        label = `${result.current} of ${result.threshold} days ${timeLabel}`;
      } else if (goal.mode === 'cumulative_sum') {
        label = `${result.current} / ${result.threshold} total`;
      } else if (goal.mode === 'average') {
        label = `avg ${result.current} (goal ${comparatorSymbol} ${result.threshold})`;
      } else if (goal.mode === 'count_entries') {
        label = `${result.current} / ${result.threshold} entries`;
      }
      const statusColor = result.status === 'SUCCESS' ? 'var(--accent-teal)' : 'var(--text-muted)';
      const statusIcon = result.status === 'SUCCESS' ? '\u2713 ' : '';
      progressEl.innerHTML = `<span style="color:${statusColor};font-weight:600">${statusIcon}${label}</span>`;
      const barFill = document.getElementById(`${sectionId}_goalBarFill`);
      if (barFill) {
        barFill.style.width = Math.round(result.progress * 100) + '%';
        barFill.style.background = result.status === 'SUCCESS' ? 'var(--accent-teal)' : 'var(--accent-purple)';
      }
    }

    function triggerGoalUpdate(sectionId) {
      const sec = appSettings.sections.find(s => s.id === sectionId);
      if (sec?.trackAsGoal && sec?.goal && sec?.fields) {
        setTimeout(() => updateGoalProgress(sectionId, sec.fields, sec.goal), 1500);
      }
    }

    function renderGoalsList() {
      const list = document.getElementById('goalsList');
      if (!list) return;
      const goals = appSettings.sections.filter(s => s.trackAsGoal && s.goal);
      if (goals.length === 0) {
        list.innerHTML = '<p style="font-size:13px;color:var(--text-muted)">No custom goals tracked yet. Create a custom section with "Track as Goal" enabled.</p>';
        return;
      }
      list.innerHTML = goals.map(g => {
        const goal = g.goal || {};
        const tf = goal.timeframe || 'daily';
        const mode = goal.mode || 'days_met';
        const comp = goal.comparator || 'gte';
        const threshold = goal.threshold || 1;
        const desc = g.goalDescription || '';
        const freqColor = tf === 'daily' ? 'var(--accent-teal)' : 'var(--accent-purple)';
        const sectionIdx = appSettings.sections.indexOf(g);
        return `
          <div style="padding:12px 0;border-bottom:1px solid var(--border)" data-goal-section-idx="${sectionIdx}">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
              <span style="font-size:20px">${g.icon}</span>
              <div style="flex:1">
                <div style="font-weight:600;font-size:14px">${g.name}</div>
                ${desc ? `<div style="font-size:12px;color:var(--text-muted)">${desc}</div>` : ''}
              </div>
              <span style="font-size:10px;background:${freqColor};color:#fff;padding:2px 8px;border-radius:8px;font-weight:600">${tf}</span>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:12px">
              <div>
                <label style="color:var(--text-muted);font-size:10px;display:block;margin-bottom:2px">Timeframe</label>
                <select class="input goal-edit-tf" data-idx="${sectionIdx}" style="font-size:12px;padding:4px 6px">
                  <option value="daily" ${tf==='daily'?'selected':''}>Daily</option>
                  <option value="weekly" ${tf==='weekly'?'selected':''}>Weekly</option>
                  <option value="phase" ${tf==='phase'?'selected':''}>Per Phase</option>
                </select>
              </div>
              <div>
                <label style="color:var(--text-muted);font-size:10px;display:block;margin-bottom:2px">Mode</label>
                <select class="input goal-edit-mode" data-idx="${sectionIdx}" style="font-size:12px;padding:4px 6px">
                  <option value="days_met" ${mode==='days_met'?'selected':''}>Days Met</option>
                  <option value="cumulative_sum" ${mode==='cumulative_sum'?'selected':''}>Cumulative Sum</option>
                  <option value="average" ${mode==='average'?'selected':''}>Average</option>
                  <option value="count_entries" ${mode==='count_entries'?'selected':''}>Count Entries</option>
                </select>
              </div>
              <div>
                <label style="color:var(--text-muted);font-size:10px;display:block;margin-bottom:2px">Comparator</label>
                <select class="input goal-edit-comp" data-idx="${sectionIdx}" style="font-size:12px;padding:4px 6px">
                  <option value="gte" ${comp==='gte'?'selected':''}>At least (\u2265)</option>
                  <option value="lte" ${comp==='lte'?'selected':''}>At most (\u2264)</option>
                  <option value="eq" ${comp==='eq'?'selected':''}>Exactly (=)</option>
                </select>
              </div>
              <div>
                <label style="color:var(--text-muted);font-size:10px;display:block;margin-bottom:2px">Target</label>
                <input type="number" class="input goal-edit-threshold" data-idx="${sectionIdx}" value="${threshold}" min="0" step="any" style="font-size:12px;padding:4px 6px">
              </div>
            </div>
          </div>
        `;
      }).join('');
      // Wire up goal edit handlers
      list.querySelectorAll('.goal-edit-tf, .goal-edit-mode, .goal-edit-comp, .goal-edit-threshold').forEach(el => {
        el.addEventListener('change', () => {
          const idx = parseInt(el.dataset.idx);
          const sec = appSettings.sections[idx];
          if (!sec) return;
          if (!sec.goal) sec.goal = {};
          const row = el.closest('[data-goal-section-idx]');
          sec.goal.timeframe = row.querySelector('.goal-edit-tf').value;
          sec.goal.mode = row.querySelector('.goal-edit-mode').value;
          sec.goal.comparator = row.querySelector('.goal-edit-comp').value;
          sec.goal.threshold = parseFloat(row.querySelector('.goal-edit-threshold').value) || 1;
          saveSettings(appSettings);
        });
      });
    }

    function layoutFields(id, fields) {
      if (fields.length <= 1) {
        // Single field: no grid, just render directly
        return fields.map(f => {
          const fieldId = `${id}__${f.id}`;
          return `<div class="custom-field-wrap" data-field-id="${f.id}">${buildFieldHtml(fieldId, f)}</div>`;
        }).join('');
      }

      const rows = [];
      let compactQueue = [];

      const flushCompact = () => {
        while (compactQueue.length >= 2) {
          rows.push({ type: 'pair', fields: compactQueue.splice(0, 2) });
        }
        if (compactQueue.length === 1) {
          rows.push({ type: 'single', fields: compactQueue.splice(0, 1) });
        }
      };

      fields.forEach(f => {
        const size = getFieldSize(f);
        if (size === 'compact') {
          compactQueue.push(f);
        } else {
          // flush any pending compacts before placing a medium/wide
          flushCompact();
          rows.push({ type: size === 'medium' ? 'single' : 'full', fields: [f] });
        }
      });
      flushCompact();

      return rows.map(row => {
        if (row.type === 'pair') {
          const cells = row.fields.map(f => {
            const fieldId = `${id}__${f.id}`;
            return `<div class="custom-layout-cell custom-field-wrap" data-field-id="${f.id}">${buildFieldHtml(fieldId, f)}</div>`;
          }).join('');
          return `<div class="custom-layout-row">${cells}</div>`;
        } else if (row.type === 'single') {
          const f = row.fields[0];
          const fieldId = `${id}__${f.id}`;
          return `<div class="custom-layout-row"><div class="custom-layout-cell custom-field-wrap" data-field-id="${f.id}">${buildFieldHtml(fieldId, f)}</div></div>`;
        } else {
          // full-width  no cell wrapper (text/log like to breathe)
          const f = row.fields[0];
          const fieldId = `${id}__${f.id}`;
          return `<div class="custom-field-wrap" data-field-id="${f.id}" style="margin-bottom:10px">${buildFieldHtml(fieldId, f)}</div>`;
        }
      }).join('');
    }

    // createCustomSection accepts either old format (id, name, icon, type, config)
    // or new format (id, name, icon, fieldsArray)
    function createCustomSection(id, name, icon, typeOrFields, config) {
      const form = document.getElementById('healthForm');
      if (!form) return;

      let fields;
      if (Array.isArray(typeOrFields)) {
        fields = typeOrFields;
      } else {
        // Old format: single type + config
        fields = [{ id: 'f_default', name: name, type: typeOrFields, config: config || {} }];
      }

      // Initialize data storage
      if (!window.customSectionData[id]) {
        window.customSectionData[id] = {};
      }

      const section = document.createElement('div');
      section.className = 'section';
      section.id = id;
      section.style.setProperty('--icon-start', 'var(--accent-purple)');
      section.style.setProperty('--icon-end', 'var(--accent-pink)');

      // Build content with smart layout
      let contentParts = layoutFields(id, fields);

      // Look up goal config from settings
      const secDef = appSettings.sections.find(s => s.id === id);
      const isGoalTracked = secDef?.trackAsGoal && secDef?.goal;
      const goalObj = secDef?.goal || {};

      // Goal progress bar for tracked goals
      if (isGoalTracked) {
        contentParts += `
          <div style="margin-top:10px">
            <div style="height:4px;background:var(--border);border-radius:2px;overflow:hidden">
              <div id="${id}_goalBarFill" style="height:100%;width:0%;border-radius:2px;transition:width .5s,background .3s;background:var(--accent-purple)"></div>
            </div>
            <div class="card-avg" style="margin-top:4px" id="${id}_goalProgress">--</div>
          </div>
        `;
      }

      // Goal badge
      const tf = goalObj.timeframe || 'daily';
      const goalBadge = isGoalTracked
        ? `<span style="font-size:10px;background:var(--accent-teal);color:#fff;padding:2px 6px;border-radius:8px;margin-left:8px;font-weight:600">${tf}</span>`
        : '';
      const goalDesc = isGoalTracked && secDef.goalDescription
        ? `<div style="font-size:12px;color:var(--text-muted);padding:8px 12px 0;font-style:italic">Goal: ${secDef.goalDescription}</div>`
        : '';

      section.innerHTML = `
        <div class="sec-head collapsed">
          <div class="sec-title">
            <div class="sec-icon">${icon}</div>
            <span class="sec-name">${name}${goalBadge}</span>
          </div>
          <span class="sec-toggle"></span>
        </div>
        <div class="sec-content collapsed">${goalDesc}${contentParts}</div>
      `;

      form.appendChild(section);

      // Wire up collapse
      const head = section.querySelector('.sec-head');
      head.addEventListener('click', () => {
        head.classList.toggle('collapsed');
        section.querySelector('.sec-content').classList.toggle('collapsed');
      });

      // Wire up each field
      fields.forEach(f => {
        const fieldId = `${id}__${f.id}`;
        wireUpField(section, id, fieldId, f);
      });

      // Trigger goal progress update
      if (isGoalTracked) {
        setTimeout(() => updateGoalProgress(id, fields, goalObj), 2000);
      }
    }
    
    function wireUpField(section, sectionId, fieldId, field) {
      const t = field.type;
      const c = field.config || {};
      const fid = field.id;
      const sd = () => { window.customSectionData[sectionId] = window.customSectionData[sectionId] || {}; return window.customSectionData[sectionId]; };

      if (t === 'checkbox') {
        const wrap = document.getElementById(`${fieldId}_check_0`)?.closest('.custom-field-wrap') || section;
        wrap.querySelectorAll('.mini-supp').forEach(supp => {
          supp.addEventListener('click', () => {
            const cb = supp.querySelector('input[type="checkbox"]');
            if (cb) { cb.checked = !cb.checked; cb.dispatchEvent(new Event('change', { bubbles: true })); }
          });
          const cb = supp.querySelector('input[type="checkbox"]');
          cb?.addEventListener('change', () => { updateCompletionRingAurora(); if (typeof triggerSaveSoon === 'function') triggerSaveSoon(); triggerGoalUpdate(sectionId); });
        });

      } else if (t === 'counter') {
        const goalNum = c.goalNumber || 6;
        const gType = c.goalType || 'daily';
        const isAlltime = gType === 'alltime';
        const isWeekly = gType === 'weekly';
        const plus = document.querySelector(`[data-id="${fieldId}"].counter-plus`) || section.querySelector(`.counter-plus[data-id="${fieldId}"]`);
        const minus = document.querySelector(`[data-id="${fieldId}"].counter-minus`) || section.querySelector(`.counter-minus[data-id="${fieldId}"]`);

        // For alltime counters, store in settings so it persists across days
        const getAlltimeKey = () => `alltime_${sectionId}_${fid}`;
        const unit = c.unitLabel || 'times';
        const updateAlltimeBar = (val) => {
          const fill = document.getElementById(`${fieldId}_fill`);
          if (fill) fill.style.width = Math.min(100, (val / goalNum) * 100) + '%';
          const label = document.getElementById(`${fieldId}_label`);
          if (label) label.textContent = `${val} of ${goalNum} ${unit}`;
        };
        if (isAlltime) {
          const valEl = document.getElementById(`${fieldId}_value`);
          const stored = appSettings[getAlltimeKey()] || 0;
          if (valEl) valEl.textContent = stored;
          updateAlltimeBar(stored);
        }

        plus?.addEventListener('click', () => {
          const valEl = document.getElementById(`${fieldId}_value`);
          let val = parseInt(valEl.textContent) || 0; val++;
          valEl.textContent = val;
          if (isAlltime) {
            appSettings[getAlltimeKey()] = val;
            updateAlltimeBar(val);
            saveSettings(appSettings);
          } else {
            sd()[fid] = { value: val };
            if (isWeekly) { section.querySelectorAll(`#${CSS.escape(fieldId)}_dots .counter-dot`).forEach((d,i) => d.classList.toggle('on', i < val)); }
            else { const fill = document.getElementById(`${fieldId}_fill`); if (fill) fill.style.height = Math.min(100, (val/goalNum)*100)+'%'; }
            if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
            triggerGoalUpdate(sectionId);
          }
        });
        minus?.addEventListener('click', () => {
          const valEl = document.getElementById(`${fieldId}_value`);
          let val = parseInt(valEl.textContent) || 0; if (val > 0) val--;
          valEl.textContent = val;
          if (isAlltime) {
            appSettings[getAlltimeKey()] = val;
            updateAlltimeBar(val);
            saveSettings(appSettings);
          } else {
            sd()[fid] = { value: val };
            if (isWeekly) { section.querySelectorAll(`#${CSS.escape(fieldId)}_dots .counter-dot`).forEach((d,i) => d.classList.toggle('on', i < val)); }
            else { const fill = document.getElementById(`${fieldId}_fill`); if (fill) fill.style.height = Math.min(100, (val/goalNum)*100)+'%'; }
            if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
            triggerGoalUpdate(sectionId);
          }
        });

      } else if (t === 'log') {
        const addBtn = document.getElementById(`${fieldId}_addBtn`);
        addBtn?.addEventListener('click', () => openLogModal(sectionId, fid, fieldId, c.fields || []));

      } else if (t === 'rating') {
        const stars = document.querySelectorAll(`#${CSS.escape(fieldId)}_stars .star`);
        const input = document.getElementById(`${fieldId}_input`);
        stars.forEach(star => {
          star.addEventListener('click', () => {
            const val = parseInt(star.dataset.val); input.value = val; sd()[fid] = { value: val };
            stars.forEach((s,i) => { s.textContent = i < val ? '' : ''; s.classList.toggle('filled', i < val); });
            if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
            triggerGoalUpdate(sectionId);
          });
        });

      } else if (t === 'toggle') {
        const chip = document.getElementById(`${fieldId}_toggle`);
        if (!chip) return;
        const cb = chip.querySelector('input');
        chip.addEventListener('click', (e) => { if (e.target.type !== 'checkbox') { cb.checked = !cb.checked; chip.classList.toggle('on', cb.checked); chip.querySelector('.chip-text').textContent = cb.checked ? 'Yes' : 'No'; updateCompletionRingAurora(); if (typeof triggerSaveSoon === 'function') triggerSaveSoon(); triggerGoalUpdate(sectionId); }});
        cb.addEventListener('change', () => { chip.classList.toggle('on', cb.checked); chip.querySelector('.chip-text').textContent = cb.checked ? 'Yes' : 'No'; updateCompletionRingAurora(); if (typeof triggerSaveSoon === 'function') triggerSaveSoon(); triggerGoalUpdate(sectionId); });

      } else if (t === 'text') {
        const input = document.getElementById(`${fieldId}_input`);
        if (input) input.addEventListener('blur', () => { sd()[fid] = { value: input.value }; if (typeof triggerSaveSoon === 'function') triggerSaveSoon(); });

      } else if (t === 'number') {
        const input = document.getElementById(`${fieldId}_input`);
        if (input) input.addEventListener('change', () => { sd()[fid] = { value: input.value }; if (typeof triggerSaveSoon === 'function') triggerSaveSoon(); triggerGoalUpdate(sectionId); });

      } else if (t === 'time') {
        const input = document.getElementById(`${fieldId}_input`);
        if (input) input.addEventListener('change', () => { sd()[fid] = { value: input.value }; if (typeof triggerSaveSoon === 'function') triggerSaveSoon(); triggerGoalUpdate(sectionId); });
      }
    }
    
    // Log modal for custom log sections
    function openLogModal(sectionId, fieldKey, fieldDomId, logFields) {
      let modal = document.getElementById('customLogModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'customLogModal';
        modal.className = 'modal';
        modal.innerHTML = `
          <div class="modal-overlay" onclick="closeLogModal()"></div>
          <div class="modal-content">
            <div class="modal-header">
              <h3 id="logModalTitle">Add Entry</h3>
              <button onclick="closeLogModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text)"></button>
            </div>
            <div id="logModalFields"></div>
            <button class="btn btn-primary" id="logModalSaveBtn" style="width:100%;margin-top:12px">Save</button>
          </div>
        `;
        document.body.appendChild(modal);
      }

      const fieldsContainer = document.getElementById('logModalFields');
      fieldsContainer.innerHTML = logFields.map(f => `
        <div class="field">
          <label class="field-label">${f.name}</label>
          ${f.type === 'number'
            ? `<input type="number" class="input" id="logField_${f.name.replace(/\s/g, '_')}" placeholder="0">`
            : `<input type="text" class="input" id="logField_${f.name.replace(/\s/g, '_')}" placeholder="">`
          }
        </div>
      `).join('');

      document.getElementById('logModalSaveBtn').onclick = () => {
        const entry = {};
        logFields.forEach(f => {
          const input = document.getElementById(`logField_${f.name.replace(/\s/g, '_')}`);
          entry[f.name] = f.type === 'number' ? (parseFloat(input.value) || 0) : input.value;
        });

        if (!window.customSectionData[sectionId]) window.customSectionData[sectionId] = {};
        if (!window.customSectionData[sectionId][fieldKey]) window.customSectionData[sectionId][fieldKey] = { entries: [] };
        window.customSectionData[sectionId][fieldKey].entries.push(entry);

        renderLogEntries(fieldDomId, sectionId, fieldKey, logFields);
        closeLogModal();
        if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
      };

      modal.classList.add('show');
    }
    
    function closeLogModal() {
      document.getElementById('customLogModal')?.classList.remove('show');
    }
    
    function renderLogEntries(fieldDomId, sectionId, fieldKey, logFields) {
      const list = document.getElementById(`${fieldDomId}_list`);
      if (!list) return;

      const entries = window.customSectionData[sectionId]?.[fieldKey]?.entries || [];
      list.innerHTML = entries.map((entry, idx) => {
        const summary = logFields.map(f => entry[f.name]).filter(v => v).join('  ');
        return `
          <div class="item">
            <span class="item-text">${summary || 'Entry ' + (idx + 1)}</span>
            <button type="button" class="btn btn-danger" onclick="removeLogEntry('${sectionId}', '${fieldKey}', '${fieldDomId}', ${idx})"></button>
          </div>
        `;
      }).join('');
    }

    window.removeLogEntry = function(sectionId, fieldKey, fieldDomId, idx) {
      if (window.customSectionData[sectionId]?.[fieldKey]?.entries) {
        window.customSectionData[sectionId][fieldKey].entries.splice(idx, 1);
        const sec = appSettings.sections.find(s => s.id === sectionId);
        const field = sec?.fields?.find(f => f.id === fieldKey);
        if (field?.config?.fields) {
          renderLogEntries(fieldDomId, sectionId, fieldKey, field.config.fields);
        }
        if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
      }
    };
    
    // Load custom sections data from server and update UI
    window.loadCustomSectionsData = function(data) {
      window.customSectionData = {};
      if (data && typeof data === 'object') {
        window.customSectionData = data;
      }

      appSettings.sections.filter(s => s.custom || (s.fields && s.fields.length > 0)).forEach(sec => {
        const sectionData = window.customSectionData[sec.id] || {};
        if (!window.customSectionData[sec.id]) window.customSectionData[sec.id] = {};

        const fields = sec.fields || [];

        // Legacy compat: if sectionData has old flat format (value, entries, checkboxes), map to first field
        if (fields.length > 0 && (sectionData.value !== undefined || sectionData.entries || sectionData.checkboxes) && !sectionData[fields[0].id]) {
          sectionData[fields[0].id] = {
            value: sectionData.value,
            entries: sectionData.entries || [],
            checkboxes: sectionData.checkboxes
          };
          window.customSectionData[sec.id] = sectionData;
        }

        fields.forEach(f => {
          const fieldId = `${sec.id}__${f.id}`;
          const fd = sectionData[f.id] || {};
          const t = f.type;
          const c = f.config || {};

          if (t === 'counter') {
            if (c.goalType === 'alltime') return; // alltime counters load from appSettings in wireUpField
            const val = fd.value || 0;
            const valEl = document.getElementById(`${fieldId}_value`);
            if (valEl) valEl.textContent = val;
            if (c.goalType === 'weekly') {
              document.querySelectorAll(`#${CSS.escape(fieldId)}_dots .counter-dot`).forEach((d,i) => d.classList.toggle('on', i < val));
            } else {
              const fill = document.getElementById(`${fieldId}_fill`);
              if (fill) fill.style.height = Math.min(100, (val/(c.goalNumber||6))*100)+'%';
            }
          } else if (t === 'checkbox') {
            (c.checkboxes || ['Done']).forEach((cb, i) => {
              const input = document.getElementById(`${fieldId}_check_${i}`);
              const isChecked = fd.checkboxes?.[i] || false;
              if (input) input.checked = isChecked;
            });
          } else if (t === 'text' || t === 'number' || t === 'time') {
            const input = document.getElementById(`${fieldId}_input`);
            if (input) input.value = fd.value || '';
          } else if (t === 'rating') {
            const val = fd.value || 0;
            const input = document.getElementById(`${fieldId}_input`);
            if (input) input.value = val;
            document.querySelectorAll(`#${CSS.escape(fieldId)}_stars .star`).forEach((s,i) => {
              s.textContent = i < val ? '' : ''; s.classList.toggle('filled', i < val);
            });
          } else if (t === 'toggle') {
            const input = document.getElementById(`${fieldId}_input`);
            const chip = document.getElementById(`${fieldId}_toggle`);
            const isChecked = fd.value || false;
            if (input) {
              input.checked = isChecked; chip?.classList.toggle('on', isChecked);
              const te = chip?.querySelector('.chip-text'); if (te) te.textContent = isChecked ? 'Yes' : 'No';
            }
          } else if (t === 'log') {
            if (c.fields) renderLogEntries(fieldId, sec.id, f.id, c.fields);
          }
        });
      });

      if (typeof updateCompletionRingAurora === 'function') updateCompletionRingAurora();

      // Update goal progress for all goal-tracked sections
      appSettings.sections.filter(s => s.trackAsGoal && s.goal && s.fields).forEach(sec => {
        setTimeout(() => updateGoalProgress(sec.id, sec.fields, sec.goal), 500);
      });
    };

    // Collect custom sections data from UI for saving
    window.collectCustomSectionsData = function() {
      appSettings.sections.filter(s => s.custom || (s.fields && s.fields.length > 0)).forEach(sec => {
        if (!window.customSectionData[sec.id]) window.customSectionData[sec.id] = {};

        const fields = sec.fields || [];
        fields.forEach(f => {
          const fieldId = `${sec.id}__${f.id}`;
          const t = f.type;
          const c = f.config || {};

          if (t === 'checkbox') {
            const cbs = (c.checkboxes || ['Done']).map((cb, i) => {
              const input = document.getElementById(`${fieldId}_check_${i}`);
              return input?.checked || false;
            });
            window.customSectionData[sec.id][f.id] = { checkboxes: cbs };
          } else if (t === 'text' || t === 'number' || t === 'time') {
            const input = document.getElementById(`${fieldId}_input`);
            window.customSectionData[sec.id][f.id] = { value: input?.value || '' };
          } else if (t === 'toggle') {
            const input = document.getElementById(`${fieldId}_input`);
            window.customSectionData[sec.id][f.id] = { value: input?.checked || false };
          }
          // counter, rating, and log already update customSectionData directly via wireUpField
        });
      });

      return window.customSectionData;
    };
    
    // Export/Import settings
    document.getElementById('exportSettingsBtn')?.addEventListener('click', () => {
      const data = JSON.stringify(appSettings, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'elevate-settings.json';
      a.click();
      URL.revokeObjectURL(url);
    });
    
    document.getElementById('importSettingsBtn')?.addEventListener('click', () => {
      document.getElementById('importSettingsFile').click();
    });
    
    document.getElementById('importSettingsFile')?.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (evt) => {
        try {
          const imported = JSON.parse(evt.target.result);
          appSettings = { ...defaultSettings, ...imported };
          saveSettings(appSettings);
          renderSectionList();
          applySectionSettings();
          currentTheme = getCurrentTheme();
          applyTheme(currentTheme, true);
          alert('Settings imported successfully!');
        } catch (err) {
          alert('Error importing settings: ' + err.message);
        }
      };
      reader.readAsText(file);
    });
    
    // Initialize section settings on load
    document.addEventListener('DOMContentLoaded', () => {
      // Recreate any custom sections first (migrate if needed)
      ensureMigrated();
      appSettings.sections.forEach(sec => {
        if (sec.custom) {
          if (!document.getElementById(sec.id)) {
            createCustomSection(sec.id, sec.name, sec.icon, sec.fields || []);
          }
        } else if (sec.fields && sec.fields.length > 0) {
          appendFieldsToBuiltinSection(sec);
        }
      });
      // Apply order + drag handles after all sections exist in the DOM
      applySectionSettings();
    });
    
    // Weekly Goals Review (Sunday)
    function getWeekKey() {
      const now = new Date();
      const sun = new Date(now);
      sun.setDate(now.getDate() - now.getDay());
      return 'weeklyReview-' + sun.toISOString().slice(0, 10);
    }

    function checkWeeklyReview() {
      const today = new Date();
      if (today.getDay() !== 0) return; // Only Sundays
      const key = getWeekKey();
      if (localStorage.getItem(key)) return; // Already shown this week
      populateWeeklyReview();
      document.getElementById('weeklyReviewModal').classList.add('show');
    }

    function populateWeeklyReview() {
      document.getElementById('wr-sleep').value = 7;
      document.getElementById('wr-agua').value = appSettings.aguaGoal ?? 6;
      document.getElementById('wr-steps').value = appSettings.stepsGoal ?? 7500;
      document.getElementById('wr-movement').value = appSettings.movementGoal ?? 2;
      document.getElementById('wr-rehit').value = appSettings.rehitGoal ?? 4;
      document.getElementById('wr-reading').value = appSettings.readingGoal ?? 60;
      document.getElementById('wr-meditation').value = appSettings.meditationGoal ?? 60;
    }

    window.closeWeeklyReview = function() {
      document.getElementById('weeklyReviewModal').classList.remove('show');
      localStorage.setItem(getWeekKey(), 'true');
    };

    window.saveWeeklyReview = function() {
      appSettings.aguaGoal = parseInt(document.getElementById('wr-agua').value) || 6;
      appSettings.stepsGoal = parseInt(document.getElementById('wr-steps').value) || 7500;
      appSettings.movementGoal = parseInt(document.getElementById('wr-movement').value) || 2;
      appSettings.rehitGoal = parseInt(document.getElementById('wr-rehit').value) || 4;
      appSettings.readingGoal = parseInt(document.getElementById('wr-reading').value) || 60;
      appSettings.meditationGoal = parseInt(document.getElementById('wr-meditation').value) || 60;
      saveSettings(appSettings);

      // Sync Settings page inputs if they exist
      const wg = document.getElementById('aguaGoal');
      const sg = document.getElementById('stepsGoal');
      const mg = document.getElementById('movementGoal');
      const rg = document.getElementById('rehitGoal');
      const rdg = document.getElementById('readingGoal');
      const mdg = document.getElementById('meditationGoal');
      if (wg) wg.value = appSettings.aguaGoal;
      if (sg) sg.value = appSettings.stepsGoal;
      if (mg) mg.value = appSettings.movementGoal;
      if (rg) rg.value = appSettings.rehitGoal;
      if (rdg) rdg.value = appSettings.readingGoal;
      if (mdg) mdg.value = appSettings.meditationGoal;

      document.getElementById('weeklyReviewModal').classList.remove('show');
      localStorage.setItem(getWeekKey(), 'true');
      if (typeof showToast === 'function') showToast('Goals locked in! Let\'s go.', 'success');
    };

    // Check after a short delay so the page finishes loading
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(checkWeeklyReview, 1500);
      document.getElementById('weeklyReviewModal').addEventListener('click', (e) => {
        if (e.target.id === 'weeklyReviewModal') closeWeeklyReview();
      });
    });

    // Trash Reminder (Tuesday after 6 PM)
    // ===== Bedtime Routine =====
    let bedtimeItems = [];
    let bedtimeCheckedState = {};

    // Get tonight's key for localStorage dismissal
    function getBedtimeKey() {
      const now = new Date();
      return 'bedtimeDismissed-' + now.toISOString().slice(0, 10);
    }

    // Check if bedtime routine should show (every night 9:45pm-midnight)
    function shouldShowBedtimeRoutine() {
      const now = new Date();
      const hour = now.getHours();
      const minute = now.getMinutes();

      // Only 9:45pm (21:45) to midnight
      if (hour < 21) return false;
      if (hour === 21 && minute < 45) return false;

      // Already dismissed tonight?
      if (localStorage.getItem(getBedtimeKey())) return false;

      return true;
    }

    // Load bedtime items from KV
    async function loadBedtimeItems() {
      try {
        const result = await apiGet('bedtime_items_load');
        bedtimeItems = result.items || [];
        bedtimeItems.sort((a, b) => (a.order || 0) - (b.order || 0));
        renderBedtimeItems();
        renderBedtimeSettings();
        checkBedtimeRoutine();
      } catch (err) {
        console.error('Failed to load bedtime items:', err);
        // Use defaults
        bedtimeItems = [
          { id: 1, name: "Brush Teeth", order: 0 },
          { id: 2, name: "Pick Clothes", order: 1 },
          { id: 3, name: "Computer", order: 2 },
          { id: 4, name: "Supplements", order: 3 },
          { id: 5, name: "Water", order: 4 }
        ];
        renderBedtimeItems();
        renderBedtimeSettings();
        checkBedtimeRoutine();
      }
    }

    // Save bedtime items to KV
    async function saveBedtimeItems() {
      try {
        await apiPost('bedtime_items_save', { items: bedtimeItems });
      } catch (err) {
        console.error('Failed to save bedtime items:', err);
      }
    }

    // Render bedtime items in the routine section
    function renderBedtimeItems() {
      const container = document.getElementById('bedtimeItems');
      if (!container) return;

      container.innerHTML = bedtimeItems.map(item => `
        <div class="bedtime-item ${bedtimeCheckedState[item.id] ? 'checked' : ''}" data-id="${item.id}" onclick="toggleBedtimeItem(${item.id})">
          <div class="bedtime-checkbox">${bedtimeCheckedState[item.id] ? '' : ''}</div>
          <span class="bedtime-item-text">${item.name}</span>
        </div>
      `).join('');
    }

    // Toggle a bedtime item
    window.toggleBedtimeItem = function(id) {
      bedtimeCheckedState[id] = !bedtimeCheckedState[id];
      renderBedtimeItems();

      // Check if all items are checked
      const allChecked = bedtimeItems.every(item => bedtimeCheckedState[item.id]);
      if (allChecked && bedtimeItems.length > 0) {
        showBedtimeCelebration();
      }
    };

    // Check and show bedtime routine if conditions are met
    function checkBedtimeRoutine() {
      const section = document.getElementById('bedtimeRoutine');
      if (!section) return;

      if (shouldShowBedtimeRoutine()) {
        section.classList.add('show');
        section.classList.remove('done-state');
      } else {
        section.classList.remove('show');
      }
    }

    // Dismiss bedtime routine (Done button)
    window.dismissBedtimeRoutine = function() {
      localStorage.setItem(getBedtimeKey(), 'true');
      const section = document.getElementById('bedtimeRoutine');
      if (section) {
        section.classList.remove('show');
      }
    };

    // Show celebration animation
    function showBedtimeCelebration() {
      const celebration = document.getElementById('bedtimeCelebration');
      const starsContainer = document.getElementById('celebrationStars');

      // Generate random stars
      starsContainer.innerHTML = '';
      const starEmojis = ['', '', '', '', '', '', ''];
      for (let i = 0; i < 30; i++) {
        const star = document.createElement('div');
        star.className = 'celebration-star';
        star.textContent = starEmojis[Math.floor(Math.random() * starEmojis.length)];
        star.style.left = Math.random() * 100 + '%';
        star.style.animationDelay = Math.random() * 2 + 's';
        star.style.animationDuration = (1.5 + Math.random()) + 's';
        starsContainer.appendChild(star);
      }

      celebration.classList.add('show');
    }

    // Dismiss celebration
    window.dismissCelebration = function() {
      const celebration = document.getElementById('bedtimeCelebration');
      celebration.classList.remove('show');
      dismissBedtimeRoutine();
    };

    // ===== Bedtime Settings Management =====
    function renderBedtimeSettings() {
      const list = document.getElementById('bedtimeItemsList');
      if (!list) return;

      list.innerHTML = bedtimeItems.map((item, idx) => `
        <div class="section-item" draggable="true" data-idx="${idx}" data-id="${item.id}">
          <span class="section-item-drag"></span>
          <input type="text" class="input bedtime-edit-input" value="${item.name}" data-id="${item.id}" style="flex:1;padding:6px 10px;font-size:13px;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:6px;color:var(--text)">
          <button class="section-item-delete" data-id="${item.id}"></button>
        </div>
      `).join('');

      // Add change handlers for editing names
      list.querySelectorAll('.bedtime-edit-input').forEach(input => {
        input.addEventListener('change', (e) => {
          const id = parseInt(e.target.dataset.id);
          const item = bedtimeItems.find(i => i.id === id);
          if (item) {
            item.name = e.target.value.trim() || item.name;
            saveBedtimeItems();
            renderBedtimeItems();
          }
        });
      });

      // Add delete handlers
      list.querySelectorAll('.section-item-delete').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = parseInt(btn.dataset.id);
          deleteBedtimeItem(id);
        });
      });

      // Setup drag and drop
      setupBedtimeDragDrop();
    }

    // Setup drag and drop for bedtime settings (desktop + mobile touch)
    function setupBedtimeDragDrop() {
      const list = document.getElementById('bedtimeItemsList');
      if (!list) return;

      let draggedItem = null;
      let touchStartY = 0;
      let touchCurrentItem = null;
      let placeholder = null;

      list.querySelectorAll('.section-item').forEach(item => {
        // Desktop drag events
        item.addEventListener('dragstart', (e) => {
          draggedItem = item;
          item.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
        });

        item.addEventListener('dragend', () => {
          item.classList.remove('dragging');
          list.querySelectorAll('.section-item').forEach(i => i.classList.remove('drag-over'));
          draggedItem = null;
        });

        item.addEventListener('dragover', (e) => {
          e.preventDefault();
          if (draggedItem && draggedItem !== item) {
            item.classList.add('drag-over');
          }
        });

        item.addEventListener('dragleave', () => {
          item.classList.remove('drag-over');
        });

        item.addEventListener('drop', (e) => {
          e.preventDefault();
          item.classList.remove('drag-over');
          if (!draggedItem || draggedItem === item) return;

          const fromIdx = parseInt(draggedItem.dataset.idx);
          const toIdx = parseInt(item.dataset.idx);

          const [moved] = bedtimeItems.splice(fromIdx, 1);
          bedtimeItems.splice(toIdx, 0, moved);
          bedtimeItems.forEach((item, i) => item.order = i);
          saveBedtimeItems();
          renderBedtimeSettings();
          renderBedtimeItems();
        });

        // Mobile touch events - only on the drag handle
        const dragHandle = item.querySelector('.section-item-drag');
        if (dragHandle) {
          dragHandle.addEventListener('touchstart', (e) => {
            e.preventDefault();
            touchCurrentItem = item;
            touchStartY = e.touches[0].clientY;
            item.classList.add('dragging');

            // Haptic feedback
            if (navigator.vibrate) navigator.vibrate(30);
          }, { passive: false });

          dragHandle.addEventListener('touchmove', (e) => {
            if (!touchCurrentItem) return;
            e.preventDefault();

            const touchY = e.touches[0].clientY;
            const items = Array.from(list.querySelectorAll('.section-item'));

            // Find which item we're over
            items.forEach(otherItem => {
              if (otherItem === touchCurrentItem) return;
              const rect = otherItem.getBoundingClientRect();
              const midY = rect.top + rect.height / 2;

              if (touchY > rect.top && touchY < rect.bottom) {
                otherItem.classList.add('drag-over');
              } else {
                otherItem.classList.remove('drag-over');
              }
            });
          }, { passive: false });

          dragHandle.addEventListener('touchend', (e) => {
            if (!touchCurrentItem) return;

            const touchY = e.changedTouches[0].clientY;
            const items = Array.from(list.querySelectorAll('.section-item'));

            // Find target item
            let targetItem = null;
            items.forEach(otherItem => {
              if (otherItem === touchCurrentItem) return;
              const rect = otherItem.getBoundingClientRect();
              if (touchY > rect.top && touchY < rect.bottom) {
                targetItem = otherItem;
              }
            });

            // Perform the swap
            if (targetItem) {
              const fromIdx = parseInt(touchCurrentItem.dataset.idx);
              const toIdx = parseInt(targetItem.dataset.idx);

              const [moved] = bedtimeItems.splice(fromIdx, 1);
              bedtimeItems.splice(toIdx, 0, moved);
              bedtimeItems.forEach((item, i) => item.order = i);
              saveBedtimeItems();
              renderBedtimeSettings();
              renderBedtimeItems();

              // Haptic feedback on successful drop
              if (navigator.vibrate) navigator.vibrate(50);
            }

            // Cleanup
            touchCurrentItem.classList.remove('dragging');
            items.forEach(i => i.classList.remove('drag-over'));
            touchCurrentItem = null;
          });
        }
      });
    }

    // Add new bedtime item
    window.addBedtimeItem = function() {
      const input = document.getElementById('newBedtimeItem');
      const name = input.value.trim();
      if (!name) return;

      const maxId = bedtimeItems.reduce((max, i) => Math.max(max, i.id), 0);
      bedtimeItems.push({
        id: maxId + 1,
        name: name,
        order: bedtimeItems.length
      });

      saveBedtimeItems();
      renderBedtimeSettings();
      renderBedtimeItems();
      input.value = '';
    };

    // Delete bedtime item
    window.deleteBedtimeItem = function(id) {
      bedtimeItems = bedtimeItems.filter(i => i.id !== id);
      bedtimeItems.forEach((item, i) => item.order = i);
      saveBedtimeItems();
      renderBedtimeSettings();
      renderBedtimeItems();
    };

    // Initialize bedtime routine on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadBedtimeItems();

      // Add button click handler
      document.getElementById('addBedtimeItemBtn')?.addEventListener('click', addBedtimeItem);

      // Allow Enter key to add item
      document.getElementById('newBedtimeItem')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          addBedtimeItem();
        }
      });

      // Check every minute if bedtime routine should show
      setInterval(checkBedtimeRoutine, 60000);
    });

    // ===== Morning Habit Stack =====
    let morningItems = [
      { id: 1, name: "Pulse", type: "pulse", order: 0 },
      { id: 2, name: "Blood Pressure", type: "bloodPressure", order: 1 },
      { id: 3, name: "Supps", type: "supps", order: 2 },
      { id: 4, name: "Water", type: "water", order: 3 },
      { id: 5, name: "REHIT Ride", type: "rehit", order: 4 },
      { id: 6, name: "Fitness Metrics", type: "fitnessMetrics", order: 5 },
      { id: 7, name: "Meditated", type: "meditated", order: 6 }
    ];
    let morningCheckedState = {};

    function getMorningKey() {
      const now = new Date();
      return 'morningState-' + now.toISOString().slice(0, 10);
    }

    function checkMorningRoutine(forceToday) {
      const section = document.getElementById('morningRoutine');
      if (!section) { console.log('morning: no section element'); return; }

      // Determine if viewing today
      let viewingToday;
      if (forceToday !== undefined) {
        // Called from initial load  always today on fresh page load
        viewingToday = forceToday;
      } else if (typeof isViewingToday === 'function') {
        try { viewingToday = isViewingToday(); } catch(e) { viewingToday = true; }
      } else {
        viewingToday = true;
      }
      console.log('morning: viewingToday=', viewingToday);

      if (!viewingToday) {
        section.classList.remove('show');
        return;
      }

      const state = localStorage.getItem(getMorningKey());

      if (state === 'dismissed') {
        section.classList.remove('show');
        return;
      }

      section.classList.add('show');
      const prompt = document.getElementById('morningPrompt');
      const stack = document.getElementById('morningStack');

      if (state === 'accepted') {
        prompt.style.display = 'none';
        stack.style.display = 'block';
        renderMorningItems();
      } else {
        prompt.style.display = 'block';
        stack.style.display = 'none';
      }
    }

    window.acceptMorningRoutine = function() {
      localStorage.setItem(getMorningKey(), 'accepted');
      const prompt = document.getElementById('morningPrompt');
      const stack = document.getElementById('morningStack');
      prompt.style.display = 'none';
      stack.style.display = 'block';
      renderMorningItems();
    };

    window.dismissMorningRoutine = function() {
      localStorage.setItem(getMorningKey(), 'dismissed');
      const section = document.getElementById('morningRoutine');
      if (section) section.classList.remove('show');
    };

    window.resetMorningRoutine = function() {
      localStorage.removeItem(getMorningKey());
      checkMorningRoutine(true);
      // Navigate back to main page so user can see it
      if (typeof showPage === 'function') showPage('today');
      else if (typeof showSettingsMain === 'function') showSettingsMain();
    };

    function isMorningItemDone(item) {
      switch (item.type) {
        case 'pulse':
          return !!document.getElementById('heartRate')?.value;
        case 'bloodPressure':
          return !!document.getElementById('systolic')?.value || !!document.getElementById('diastolic')?.value;
        case 'supps':
          return ['creatine', 'vitaminD', 'no2', 'psyllium', 'zinc', 'prebiotic'].every(id => document.getElementById(id)?.checked);
        case 'water':
          return !!morningCheckedState[item.id];
        case 'rehit':
          return document.getElementById('rehit2')?.checked || document.getElementById('rehit3')?.checked;
        case 'fitnessMetrics':
          return !!document.getElementById('fitnessScore')?.value;
        case 'meditated':
          return document.getElementById('meditation')?.checked;
        case 'custom':
          return !!morningCheckedState[item.id];
        default:
          return false;
      }
    }

    function renderMorningItemContent(item) {
      switch (item.type) {
        case 'pulse': {
          const val = document.getElementById('heartRate')?.value || '';
          return `<span class="morning-item-label">Pulse</span>
            <div class="morning-item-controls">
              <input type="number" class="morning-inline-input" data-sync="heartRate" value="${val}" inputmode="numeric" placeholder="--">
            </div>`;
        }
        case 'bloodPressure': {
          if (typeof currentDate !== 'undefined' && currentDate.getDay() !== 1) return null;
          const sys = document.getElementById('systolic')?.value || '';
          const dia = document.getElementById('diastolic')?.value || '';
          return `<span class="morning-item-label">Blood Pressure</span>
            <div class="morning-item-controls">
              <div class="morning-bp-inputs">
                <input type="number" class="morning-inline-input" data-sync="systolic" value="${sys}" inputmode="numeric" placeholder="Sys">
                <input type="number" class="morning-inline-input" data-sync="diastolic" value="${dia}" inputmode="numeric" placeholder="Dia">
              </div>
            </div>`;
        }
        case 'supps': {
          const chips = [
            { id: 'creatine', label: 'Creat' },
            { id: 'vitaminD', label: 'Vit D' },
            { id: 'no2', label: 'NO2' },
            { id: 'psyllium', label: 'Psyllium' },
            { id: 'zinc', label: 'Zinc' },
            { id: 'prebiotic', label: 'Prebio' }
          ];
          const chipsHtml = chips.map(c => {
            const checked = document.getElementById(c.id)?.checked;
            return `<button type="button" class="morning-chip ${checked ? 'active' : ''}" data-toggle-checkbox="${c.id}">${c.label}</button>`;
          }).join('');
          return `<span class="morning-item-label">Supps</span>
            <div class="morning-item-controls">
              <div class="morning-chips">${chipsHtml}</div>
            </div>`;
        }
        case 'water': {
          const done = morningCheckedState[item.id];
          return `<span class="morning-item-label">Water</span>
            <div class="morning-item-controls">
              <button type="button" class="morning-chip ${done ? 'active' : ''}" data-water-btn="${item.id}">16oz</button>
            </div>`;
        }
        case 'rehit': {
          const r2 = document.getElementById('rehit2')?.checked;
          const r3 = document.getElementById('rehit3')?.checked;
          return `<span class="morning-item-label">REHIT Ride</span>
            <div class="morning-item-controls">
              <div class="morning-chips">
                <button type="button" class="morning-chip ${r2 ? 'active' : ''}" data-toggle-checkbox="rehit2">2x10</button>
                <button type="button" class="morning-chip ${r3 ? 'active' : ''}" data-toggle-checkbox="rehit3">3x10</button>
              </div>
            </div>`;
        }
        case 'fitnessMetrics': {
          const fs = document.getElementById('fitnessScore')?.value || '';
          const ws = document.getElementById('wattSeconds')?.value || '';
          const pw = document.getElementById('peakWatts')?.value || '';
          const cal = document.getElementById('calories')?.value || '';
          return `<span class="morning-item-label">Fitness</span>
            <div class="morning-item-controls">
              <div class="morning-metrics-grid">
                <div class="morning-metric"><span class="morning-metric-label">Score</span><input type="number" class="morning-inline-input" data-sync="fitnessScore" value="${fs}" inputmode="decimal" step="0.1" placeholder="--"></div>
                <div class="morning-metric"><span class="morning-metric-label">W-Sec</span><input type="number" class="morning-inline-input" data-sync="wattSeconds" value="${ws}" inputmode="numeric" placeholder="--"></div>
                <div class="morning-metric"><span class="morning-metric-label">Watts</span><input type="number" class="morning-inline-input" data-sync="peakWatts" value="${pw}" inputmode="numeric" placeholder="--"></div>
                <div class="morning-metric"><span class="morning-metric-label">Cals</span><input type="number" class="morning-inline-input" data-sync="calories" value="${cal}" inputmode="numeric" placeholder="--"></div>
              </div>
            </div>`;
        }
        case 'meditated': {
          const checked = document.getElementById('meditation')?.checked;
          return `<span class="morning-item-label">Meditated</span>
            <div class="morning-item-controls">
              <button type="button" class="morning-chip ${checked ? 'active' : ''}" data-toggle-checkbox="meditation"></button>
            </div>`;
        }
        case 'custom': {
          const checked = morningCheckedState[item.id];
          return `<span class="morning-item-label">${item.name}</span>
            <div class="morning-item-controls">
              <button type="button" class="morning-chip ${checked ? 'active' : ''}" data-custom-toggle="${item.id}"></button>
            </div>`;
        }
        default:
          return `<span class="morning-item-label">${item.name}</span>`;
      }
    }

    function renderMorningItems() {
      const container = document.getElementById('morningItems');
      if (!container) return;

      container.innerHTML = morningItems.map(item => {
        const content = renderMorningItemContent(item);
        if (content === null) return '';
        const done = isMorningItemDone(item);
        return `<div class="morning-item ${done ? 'checked' : ''}" data-morning-id="${item.id}">
          <div class="morning-checkbox">${done ? '' : ''}</div>
          ${content}
        </div>`;
      }).join('');

      setupMorningItemListeners();
      checkMorningAllDone();
    }

    function setupMorningItemListeners() {
      const container = document.getElementById('morningItems');
      if (!container) return;

      // Input sync: morning input  real form field
      container.querySelectorAll('[data-sync]').forEach(input => {
        input.addEventListener('input', (e) => {
          const targetId = e.target.dataset.sync;
          const targetEl = document.getElementById(targetId);
          if (targetEl) {
            targetEl.value = e.target.value;
            targetEl.dispatchEvent(new Event('input', { bubbles: true }));
            targetEl.dispatchEvent(new Event('change', { bubbles: true }));
          }
          if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
          updateMorningItemStates();
        });
      });

      // Chip toggles: toggle real checkbox
      container.querySelectorAll('[data-toggle-checkbox]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const cbId = e.currentTarget.dataset.toggleCheckbox;
          const cb = document.getElementById(cbId);
          if (cb) {
            cb.checked = !cb.checked;
            cb.dispatchEvent(new Event('change', { bubbles: true }));
            if (typeof syncCheckboxVisual === 'function') syncCheckboxVisual(cb);
          }
          if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
          updateMorningItemStates();
        });
      });

      // Water button: add 2 to water count
      container.querySelectorAll('[data-water-btn]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const itemId = parseInt(e.currentTarget.dataset.waterBtn);
          if (!morningCheckedState[itemId]) {
            morningCheckedState[itemId] = true;
            if (typeof window.handleAguaPlus === 'function') {
              window.handleAguaPlus();
              window.handleAguaPlus();
            }
          }
          updateMorningItemStates();
        });
      });

      // Custom toggle
      container.querySelectorAll('[data-custom-toggle]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const itemId = parseInt(e.currentTarget.dataset.customToggle);
          morningCheckedState[itemId] = !morningCheckedState[itemId];
          updateMorningItemStates();
        });
      });
    }

    function updateMorningItemStates() {
      const container = document.getElementById('morningItems');
      if (!container) return;

      container.querySelectorAll('.morning-item').forEach(el => {
        const itemId = parseInt(el.dataset.morningId);
        const item = morningItems.find(i => i.id === itemId);
        if (!item) return;

        const done = isMorningItemDone(item);
        el.classList.toggle('checked', done);
        const cb = el.querySelector('.morning-checkbox');
        if (cb) cb.textContent = done ? '' : '';

        // Update chip active states
        el.querySelectorAll('[data-toggle-checkbox]').forEach(chip => {
          const cbEl = document.getElementById(chip.dataset.toggleCheckbox);
          chip.classList.toggle('active', cbEl?.checked || false);
        });

        el.querySelectorAll('[data-water-btn]').forEach(chip => {
          const wId = parseInt(chip.dataset.waterBtn);
          chip.classList.toggle('active', !!morningCheckedState[wId]);
        });

        el.querySelectorAll('[data-custom-toggle]').forEach(chip => {
          const cId = parseInt(chip.dataset.customToggle);
          chip.classList.toggle('active', !!morningCheckedState[cId]);
        });
      });

      checkMorningAllDone();
    }

    let morningCelebrationShown = false;

    function checkMorningAllDone() {
      if (morningCelebrationShown) return;
      const visibleItems = morningItems.filter(item => {
        if (item.type === 'bloodPressure' && typeof currentDate !== 'undefined' && currentDate.getDay() !== 1) return false;
        return true;
      });

      const allDone = visibleItems.length > 0 && visibleItems.every(item => isMorningItemDone(item));
      if (allDone) {
        morningCelebrationShown = true;
        showMorningCelebration();
      }
    }

    function showMorningCelebration() {
      const celebration = document.getElementById('morningCelebration');
      if (!celebration) return;

      const starsContainer = celebration.querySelector('.celebration-stars');
      if (starsContainer) {
        starsContainer.innerHTML = '';
        const emojis = ['', '', '', '', '', '', ''];
        for (let i = 0; i < 30; i++) {
          const star = document.createElement('div');
          star.className = 'celebration-star';
          star.textContent = emojis[Math.floor(Math.random() * emojis.length)];
          star.style.left = Math.random() * 100 + '%';
          star.style.animationDelay = Math.random() * 2 + 's';
          star.style.animationDuration = (1.5 + Math.random()) + 's';
          starsContainer.appendChild(star);
        }
      }
      celebration.classList.add('show');
    }

    window.dismissMorningCelebration = function() {
      const celebration = document.getElementById('morningCelebration');
      if (celebration) celebration.classList.remove('show');
    };

    // Expose on window so app.js can always call it
    window.checkMorningRoutine = checkMorningRoutine;

    // Show morning routine immediately during parse (element exists above this script)
    // This ensures visibility even if DOMContentLoaded or API calls are delayed
    checkMorningRoutine(true);

    // Load morning items from KV
    async function loadMorningItems() {
      try {
        const result = await apiGet('morning_items_load');
        if (result.items && result.items.length > 0) {
          morningItems = result.items;
          morningItems.sort((a, b) => (a.order || 0) - (b.order || 0));
        } else {
          morningItems = getDefaultMorningItems();
        }
      } catch (err) {
        console.error('Failed to load morning items:', err);
        morningItems = getDefaultMorningItems();
      }
      try { renderMorningSettings(); } catch(e) { console.error('renderMorningSettings error:', e); }
      checkMorningRoutine(true); // forceToday=true on initial load
    }

    function getDefaultMorningItems() {
      return [
        { id: 1, name: "Pulse", type: "pulse", order: 0 },
        { id: 2, name: "Blood Pressure", type: "bloodPressure", order: 1 },
        { id: 3, name: "Supps", type: "supps", order: 2 },
        { id: 4, name: "Water", type: "water", order: 3 },
        { id: 5, name: "REHIT Ride", type: "rehit", order: 4 },
        { id: 6, name: "Fitness Metrics", type: "fitnessMetrics", order: 5 },
        { id: 7, name: "Meditated", type: "meditated", order: 6 }
      ];
    }

    // Save morning items to KV
    async function saveMorningItems() {
      try {
        await apiPost('morning_items_save', { items: morningItems });
      } catch (err) {
        console.error('Failed to save morning items:', err);
      }
    }

    // ===== Morning Settings Management =====
    function renderMorningSettings() {
      const list = document.getElementById('morningItemsList');
      if (!list) return;

      list.innerHTML = morningItems.map((item, idx) => `
        <div class="section-item" draggable="true" data-idx="${idx}" data-id="${item.id}">
          <span class="section-item-drag"></span>
          <input type="text" class="input morning-edit-input" value="${item.name}" data-id="${item.id}" ${item.type && item.type !== 'custom' ? 'readonly' : ''} style="flex:1;padding:6px 10px;font-size:13px;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:6px;color:var(--text)${item.type && item.type !== 'custom' ? ';opacity:0.7' : ''}">
          <button class="section-item-delete" data-id="${item.id}"></button>
        </div>
      `).join('');

      // Change handlers for custom items only
      list.querySelectorAll('.morning-edit-input:not([readonly])').forEach(input => {
        input.addEventListener('change', (e) => {
          const id = parseInt(e.target.dataset.id);
          const item = morningItems.find(i => i.id === id);
          if (item) {
            item.name = e.target.value.trim() || item.name;
            saveMorningItems();
          }
        });
      });

      // Delete handlers
      list.querySelectorAll('.section-item-delete').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = parseInt(btn.dataset.id);
          deleteMorningItem(id);
        });
      });

      setupMorningDragDrop();
    }

    function setupMorningDragDrop() {
      const list = document.getElementById('morningItemsList');
      if (!list) return;

      let draggedItem = null;
      let touchCurrentItem = null;

      list.querySelectorAll('.section-item').forEach(item => {
        item.addEventListener('dragstart', (e) => {
          draggedItem = item;
          item.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
        });

        item.addEventListener('dragend', () => {
          item.classList.remove('dragging');
          list.querySelectorAll('.section-item').forEach(i => i.classList.remove('drag-over'));
          draggedItem = null;
        });

        item.addEventListener('dragover', (e) => {
          e.preventDefault();
          if (draggedItem && draggedItem !== item) item.classList.add('drag-over');
        });

        item.addEventListener('dragleave', () => {
          item.classList.remove('drag-over');
        });

        item.addEventListener('drop', (e) => {
          e.preventDefault();
          item.classList.remove('drag-over');
          if (!draggedItem || draggedItem === item) return;

          const fromIdx = parseInt(draggedItem.dataset.idx);
          const toIdx = parseInt(item.dataset.idx);
          const [moved] = morningItems.splice(fromIdx, 1);
          morningItems.splice(toIdx, 0, moved);
          morningItems.forEach((it, i) => it.order = i);
          saveMorningItems();
          renderMorningSettings();
          renderMorningItems();
        });

        // Mobile touch events
        const dragHandle = item.querySelector('.section-item-drag');
        if (dragHandle) {
          dragHandle.addEventListener('touchstart', (e) => {
            e.preventDefault();
            touchCurrentItem = item;
            item.classList.add('dragging');
            if (navigator.vibrate) navigator.vibrate(30);
          }, { passive: false });

          dragHandle.addEventListener('touchmove', (e) => {
            if (!touchCurrentItem) return;
            e.preventDefault();
            const touchY = e.touches[0].clientY;
            Array.from(list.querySelectorAll('.section-item')).forEach(otherItem => {
              if (otherItem === touchCurrentItem) return;
              const rect = otherItem.getBoundingClientRect();
              otherItem.classList.toggle('drag-over', touchY > rect.top && touchY < rect.bottom);
            });
          }, { passive: false });

          dragHandle.addEventListener('touchend', (e) => {
            if (!touchCurrentItem) return;
            const touchY = e.changedTouches[0].clientY;
            const items = Array.from(list.querySelectorAll('.section-item'));
            let targetItem = null;
            items.forEach(otherItem => {
              if (otherItem === touchCurrentItem) return;
              const rect = otherItem.getBoundingClientRect();
              if (touchY > rect.top && touchY < rect.bottom) targetItem = otherItem;
            });
            if (targetItem) {
              const fromIdx = parseInt(touchCurrentItem.dataset.idx);
              const toIdx = parseInt(targetItem.dataset.idx);
              const [moved] = morningItems.splice(fromIdx, 1);
              morningItems.splice(toIdx, 0, moved);
              morningItems.forEach((it, i) => it.order = i);
              saveMorningItems();
              renderMorningSettings();
              renderMorningItems();
              if (navigator.vibrate) navigator.vibrate(50);
            }
            touchCurrentItem.classList.remove('dragging');
            items.forEach(i => i.classList.remove('drag-over'));
            touchCurrentItem = null;
          });
        }
      });
    }

    window.addMorningItem = function() {
      const input = document.getElementById('newMorningItem');
      const name = input.value.trim();
      if (!name) return;

      const maxId = morningItems.reduce((max, i) => Math.max(max, i.id), 0);
      morningItems.push({
        id: maxId + 1,
        name: name,
        type: 'custom',
        order: morningItems.length
      });

      saveMorningItems();
      renderMorningSettings();
      renderMorningItems();
      input.value = '';
    };

    window.deleteMorningItem = function(id) {
      morningItems = morningItems.filter(i => i.id !== id);
      morningItems.forEach((item, i) => item.order = i);
      saveMorningItems();
      renderMorningSettings();
      renderMorningItems();
    };

    // Initialize morning routine on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadMorningItems();

      // Safety nets at 1s and 5s in case the API call or initial check failed
      [1000, 5000].forEach(delay => {
        setTimeout(() => {
          const section = document.getElementById('morningRoutine');
          if (section && !section.classList.contains('show')) {
            const state = localStorage.getItem(getMorningKey());
            if (state !== 'dismissed') {
              console.log('morning: safety net triggered at ' + delay + 'ms');
              section.classList.add('show');
              const prompt = document.getElementById('morningPrompt');
              const stack = document.getElementById('morningStack');
              if (state === 'accepted') {
                if (prompt) prompt.style.display = 'none';
                if (stack) stack.style.display = 'block';
                renderMorningItems();
              } else {
                if (prompt) prompt.style.display = 'block';
                if (stack) stack.style.display = 'none';
              }
            }
          }
        }, delay);
      });

      document.getElementById('addMorningItemBtn')?.addEventListener('click', addMorningItem);
      document.getElementById('newMorningItem')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          addMorningItem();
        }
      });
    });

    // ===== Trash Reminder =====
    function getTuesdayKey() {
      const now = new Date();
      // Find the Tuesday of the current week (or most recent Tuesday if today is Mon)
      const day = now.getDay();
      const diff = day >= 2 ? day - 2 : day + 5; // days since last Tuesday
      const tue = new Date(now);
      tue.setDate(now.getDate() - diff);
      return 'trashReminder-' + tue.toISOString().slice(0, 10);
    }

    function checkTrashReminder() {
      const now = new Date();
      // Only show on Tuesday (day 2) after 6 PM (18:00)
      if (now.getDay() !== 2) return;
      if (now.getHours() < 18) return;

      const key = getTuesdayKey();
      if (localStorage.getItem(key)) return; // Already dismissed this week

      document.getElementById('trashReminderModal').classList.add('show');
    }

    window.dismissTrashReminder = function() {
      document.getElementById('trashReminderModal').classList.remove('show');
      localStorage.setItem(getTuesdayKey(), 'true');
    };

    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(checkTrashReminder, 2000);
      document.getElementById('trashReminderModal').addEventListener('click', (e) => {
        if (e.target.id === 'trashReminderModal') dismissTrashReminder();
      });
    });

    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then((registration) => {
            console.log('SW registered:', registration.scope);
            // Force the browser to check for a new service worker immediately
            registration.update();
          })
          .catch((error) => {
            console.log('SW registration failed:', error);
          });
      });
    }

  </script>
</body>
</html>
