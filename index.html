<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Habits - Daily Rituals</title>
  <meta name="theme-color" content="#1a1a2e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="icon" type="image/png" href="apple-touch-icon.png">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="manifest" href="manifest.json">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* === NIGHT MODE (Default - Aurora/Twilight) === */
      --bg-deep: #1a1a2e;
      --bg-mid: #16213e;
      --bg-card: rgba(255,255,255,0.08);
      --bg-card-hover: rgba(255,255,255,0.12);
      
      --text: #ffffff;
      --text-dim: rgba(255,255,255,0.85);
      --text-muted: rgba(255,255,255,0.6);
      
      --accent-pink: #ff6b9d;
      --accent-orange: #ffa552;
      --accent-yellow: #ffd93d;
      --accent-teal: #6dd5ed;
      --accent-purple: #c471ed;
      
      --glow-pink: rgba(255,107,157,0.4);
      --glow-orange: rgba(255,165,82,0.4);
      --glow-teal: rgba(109,213,237,0.4);
      --glow-purple: rgba(196,113,237,0.4);
      
      --success: #6dd5ed;
      --success-soft: rgba(109,213,237,0.2);
      
      --sleep: #c471ed;
      --water: #6dd5ed;
      --movement: #ff6b9d;
      --nutrition: #6dd5ed;
      
      --border: rgba(255,255,255,0.2);
      --radius: 20px;
      --radius-sm: 12px;
      --radius-pill: 100px;
      
      /* Gradient backgrounds */
      --bg-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 25%, #1a1a2e 50%, #2d1b4e 75%, #1a1a2e 100%);
      --bg-aurora: 
        radial-gradient(ellipse at 20% 20%, rgba(196,113,237,0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(255,107,157,0.1) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, rgba(109,213,237,0.08) 0%, transparent 60%);
    }
    
    /* === DAY MODE - Soft Cantaloupe === */
    body.day-mode {
      --bg-deep: #ffeaa7;
      --bg-mid: #fdcb6e;
      --bg-card: rgba(255,255,255,0.6);
      --bg-card-hover: rgba(255,255,255,0.8);
      
      /* Dark text for contrast on light background */
      --text: #1a1a2e;
      --text-dim: rgba(26,26,46,0.8);
      --text-muted: rgba(26,26,46,0.6);
      
      /* Vibrant accents to pop against yellow-orange background */
      --accent-pink: #e11d48;
      --accent-orange: #ea580c;
      --accent-yellow: #ca8a04;
      --accent-teal: #0d9488;
      --accent-purple: #6366f1;
      
      --glow-pink: rgba(225,29,72,0.3);
      --glow-orange: rgba(234,88,12,0.3);
      --glow-teal: rgba(13,148,136,0.3);
      --glow-purple: rgba(99,102,241,0.4);
      
      --success: #059669;
      --success-soft: rgba(5,150,105,0.15);
      
      --sleep: #6366f1;
      --water: #0d9488;
      --movement: #e11d48;
      --nutrition: #059669;
      
      --border: rgba(0,0,0,0.1);
      
      /* Soft Cantaloupe gradient */
      background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 30%, #f9a825 70%, #fdcb6e 100%) !important;
    }
    
    body.day-mode::before {
      background: radial-gradient(ellipse at 30% 20%, rgba(255,234,167,0.5) 0%, transparent 50%) !important;
    }
    
    /* Day mode specific overrides - indigo/purple buttons on cantaloupe background */
    body.day-mode .logo {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      box-shadow: 0 0 20px var(--glow-purple);
    }
    body.day-mode .date-btn {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      box-shadow: 0 4px 15px var(--glow-purple);
      color: white;
    }
    body.day-mode .phase-fill {
      background: linear-gradient(90deg, #6366f1, #8b5cf6, #a855f7);
    }
    body.day-mode .fab {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      box-shadow: 0 8px 25px var(--glow-purple);
      color: white;
    }
    body.day-mode .btn-primary {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
    }
    body.day-mode .ring-progress {
      stroke: #6366f1;
    }
    body.day-mode .ring-text {
      color: #6366f1;
    }
    body.day-mode .chip.on {
      background: rgba(251, 146, 60, 0.25);
      border-color: #f97316;
      box-shadow: 0 0 10px rgba(249, 115, 22, 0.3);
    }
    body.day-mode .chip.on .chip-dot {
      background: #f97316;
      border-color: #f97316;
      color: white;
      box-shadow: 0 0 8px rgba(249, 115, 22, 0.4);
    }
    body.day-mode .water-btn {
      border-color: var(--accent-teal);
      color: var(--accent-teal);
    }
    body.day-mode .water-btn:hover {
      background: var(--accent-teal);
      color: white;
    }
    body.day-mode .water-num {
      color: var(--text);
    }
    body.day-mode .milestone-title {
      background: linear-gradient(90deg, var(--accent-orange), var(--accent-pink), var(--accent-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    body.day-mode .card {
      background: rgba(255,255,255,0.6);
      border-color: rgba(0,0,0,0.08);
    }
    body.day-mode .card-title {
      color: var(--text-muted);
    }
    body.day-mode .card-avg {
      color: var(--text-muted);
    }
    body.day-mode .section {
      background: rgba(255,255,255,0.6);
      border-color: rgba(0,0,0,0.08);
    }
    body.day-mode .sec-name {
      color: var(--text);
    }
    body.day-mode .nav-link {
      background: rgba(255,255,255,0.6);
      border-color: rgba(0,0,0,0.1);
      color: var(--text-dim);
    }
    body.day-mode .nav-link:hover {
      background: rgba(255,255,255,0.8);
      color: var(--accent-orange);
      border-color: var(--accent-orange);
    }
    body.day-mode .date-nav {
      background: rgba(255,255,255,0.6);
      border-color: rgba(0,0,0,0.08);
    }
    body.day-mode .date-main,
    body.day-mode .date-sub {
      color: var(--text);
    }
    body.day-mode .steps-bar-fill {
      background: linear-gradient(to top, #6366f1, #8b5cf6, #a855f7);
    }
    body.day-mode .water-bar-fill {
      background: linear-gradient(to top, var(--accent-teal), #14b8a6, #5eead4);
    }
    body.day-mode .big-input {
      color: var(--text);
    }
    body.day-mode .big-input::placeholder {
      color: var(--text-muted);
    }
    body.day-mode .chip-text {
      color: var(--text-dim);
    }
    body.day-mode .chip.on .chip-text {
      color: #1f2937;
    }
    body.day-mode .chip-dot {
      border-color: var(--text-muted);
    }
    /* Dark empty progress bars in day mode */
    body.day-mode .steps-bar-track,
    body.day-mode .water-bar-track {
      background: rgba(0,0,0,0.15);
    }
    body.day-mode .ring-bg {
      stroke: rgba(0,0,0,0.15);
    }
    body.day-mode .phase-track {
      background: rgba(0,0,0,0.12);
    }
    /* Darker collapse arrows */
    body.day-mode .sec-toggle {
      color: var(--text-dim);
    }
    
    /* === SUNSET TRANSITION MODE === */
    body.sunset-mode {
      --bg-deep: #2d1b4e;
      --bg-mid: #1a1a2e;
      --bg-card: rgba(255,255,255,0.06);
      --bg-card-hover: rgba(255,255,255,0.1);
      
      --text: #f0f0f0;
      --text-dim: rgba(255,255,255,0.7);
      --text-muted: rgba(255,255,255,0.5);
      
      --bg-gradient: linear-gradient(135deg, #2d1b4e 0%, #4a1942 30%, #1a1a2e 70%, #16213e 100%);
      --bg-aurora: 
        radial-gradient(ellipse at 50% 0%, rgba(255,107,157,0.2) 0%, transparent 50%),
        radial-gradient(ellipse at 30% 50%, rgba(255,165,82,0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 70% 80%, rgba(196,113,237,0.15) 0%, transparent 50%);
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      min-height: 100vh;
      color: var(--text);
      padding: 16px;
      padding-bottom: 120px;
      font-size: 16px;
      line-height: 1.5;
      background: var(--bg-gradient);
      background-attachment: fixed;
      position: relative;
      transition: background 1s ease, color 0.5s ease;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--bg-aurora);
      pointer-events: none;
      z-index: 0;
      transition: background 1s ease;
    }
    
    body > * { position: relative; z-index: 1; }
    
    /* Theme indicator */
    .theme-indicator {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      color: var(--text-muted);
      background: var(--bg-card);
      padding: 4px 12px;
      border-radius: var(--radius-pill);
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 1001;
      backdrop-filter: blur(10px);
    }
    .theme-indicator.show {
      opacity: 1;
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--bg-deep);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .loading-overlay.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }
    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: var(--accent-pink);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .loading-text {
      margin-top: 16px;
      font-size: 14px;
      color: var(--text-muted);
    }
    body.day-mode .loading-overlay {
      background: linear-gradient(135deg, #fef3e2 0%, #fce7c8 50%, #fff9f0 100%);
    }
    body.day-mode .loading-spinner {
      border-color: rgba(0,0,0,0.1);
      border-top-color: var(--accent-orange);
    }
    body.day-mode .loading-text {
      color: #6b7280;
    }
    
    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 12px 24px;
      border-radius: var(--radius-pill);
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      backdrop-filter: blur(20px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 10000;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .toast.show {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }
    .toast.success {
      border-color: var(--success);
      box-shadow: 0 0 20px var(--glow-teal);
    }
    .toast.error {
      border-color: #ef4444;
      box-shadow: 0 0 20px rgba(239,68,68,0.4);
    }
    body.day-mode .toast {
      background: rgba(255,255,255,0.95);
      color: #1f2937;
    }
    
    /* Pull to Refresh */
    .pull-indicator {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%) translateY(-100%);
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 8px 16px;
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
      font-size: 12px;
      color: var(--text-muted);
      backdrop-filter: blur(10px);
      transition: transform 0.2s;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .pull-indicator.visible {
      transform: translateX(-50%) translateY(0);
    }
    .pull-indicator .pull-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.2);
      border-top-color: var(--accent-teal);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    body.day-mode .pull-indicator {
      background: rgba(255,255,255,0.9);
      color: #6b7280;
    }
    body.day-mode .pull-indicator .pull-spinner {
      border-color: rgba(0,0,0,0.1);
      border-top-color: var(--accent-orange);
    }
      --radius-pill: 100px;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      min-height: 100vh;
      color: var(--text);
      padding: 16px;
      padding-top: max(66px, calc(12px + env(safe-area-inset-top, 54px)));
      padding-bottom: calc(120px + env(safe-area-inset-bottom, 0px));
      padding-left: calc(16px + env(safe-area-inset-left, 0px));
      padding-right: calc(16px + env(safe-area-inset-right, 0px));
      font-size: 16px;
      line-height: 1.5;
      
      /* Aurora gradient background */
      background: linear-gradient(135deg, 
        #1a1a2e 0%, 
        #16213e 25%, 
        #1a1a2e 50%,
        #2d1b4e 75%,
        #1a1a2e 100%
      );
      background-attachment: fixed;
      position: relative;
    }
    
    /* Animated aurora glow overlay */
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: 
        radial-gradient(ellipse at 20% 20%, rgba(196,113,237,0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(255,107,157,0.1) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, rgba(109,213,237,0.08) 0%, transparent 60%);
      pointer-events: none;
      z-index: 0;
    }
    
    body > * { position: relative; z-index: 1; }
    
    /* Header */
    .header { 
      padding: 20px; 
      margin-bottom: 20px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: var(--radius);
      backdrop-filter: blur(20px);
    }
    body.day-mode .header {
      background: rgba(255,255,255,0.6);
      border-color: rgba(0,0,0,0.08);
    }
    .header-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; }
    .brand { display: flex; align-items: center; gap: 12px; }
    .logo {
      width: 48px; height: 48px; border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-pink), var(--accent-purple));
      display: flex; align-items: center; justify-content: center; font-size: 22px;
      box-shadow: 0 0 30px var(--glow-pink), 0 0 60px var(--glow-purple);
      animation: pulse-glow 3s ease-in-out infinite;
    }
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px var(--glow-pink), 0 0 40px var(--glow-purple); }
      50% { box-shadow: 0 0 30px var(--glow-pink), 0 0 60px var(--glow-purple); }
    }
    .brand h1 { font-family: 'Space Grotesk', sans-serif; font-size: 32px; font-weight: 700; letter-spacing: -0.02em; color: white; margin: 0; }
    .brand h1 .version { font-size: 12px; font-weight: 500; color: var(--text-muted); vertical-align: super; margin-left: 4px; }
    body.day-mode .brand h1 { color: #1f2937; }
    .brand .tagline { font-size: 16px; font-weight: 600; color: var(--accent-pink); margin-top: 2px; }
    .phase-day { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    .nav-links { display: flex; gap: 8px; }
    .nav-link {
      width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border);
      background: var(--bg-card); color: var(--text-dim); font-size: 15px; cursor: pointer;
      display: flex; align-items: center; justify-content: center; text-decoration: none;
      transition: all 0.3s; backdrop-filter: blur(10px);
    }
    .nav-link:hover { 
      background: var(--bg-card-hover); 
      color: var(--accent-teal); 
      border-color: var(--accent-teal);
      box-shadow: 0 0 20px var(--glow-teal);
    }
    
    /* Date Nav - Glassmorphism */
    .date-nav {
      display: grid; 
      grid-template-columns: auto 1fr auto auto;
      align-items: center; 
      gap: 12px; 
      padding: 16px;
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius); backdrop-filter: blur(20px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    .date-nav .phase {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }
    .date-btn {
      width: 44px; height: 44px; border-radius: 50%; border: none;
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));
      color: white; font-size: 18px; font-weight: 600;
      cursor: pointer; transition: all 0.3s;
      box-shadow: 0 4px 15px var(--glow-purple);
    }
    .date-btn:hover { transform: scale(1.1); box-shadow: 0 6px 25px var(--glow-pink); }
    .date-btn:active { transform: scale(0.95); }
    .date-center { flex: 1; text-align: center; }
    .date-main { font-family: 'Space Grotesk', sans-serif; font-size: 18px; font-weight: 600; color: white; }
    .date-sub { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

    /* Day Lock - prevents accidental edits on past days */
    .day-locked #healthForm input:not([type="hidden"]),
    .day-locked #healthForm textarea,
    .day-locked #healthForm select,
    .day-locked #healthForm button:not(.unlock-day-btn):not(.start-walk-btn),
    .day-locked .mini-supp,
    .day-locked .checkbox-field,
    .day-locked .chip,
    .day-locked .water-btn,
    .day-locked .section-item-drag {
      pointer-events: none;
      opacity: 0.6;
    }
    .day-locked .sec-head { pointer-events: auto; opacity: 1; }
    .unlock-banner {
      display: none;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 10px 16px;
      background: linear-gradient(135deg, rgba(255,159,28,0.15), rgba(230,57,70,0.15));
      border: 1px solid rgba(255,159,28,0.3);
      border-radius: var(--radius);
      margin-bottom: 12px;
      font-size: 13px;
      color: var(--text-muted);
    }
    .day-locked .unlock-banner { display: flex; }
    .unlock-day-btn {
      padding: 6px 14px;
      font-size: 12px;
      font-weight: 600;
      background: linear-gradient(135deg, var(--accent-orange), var(--accent-pink));
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
    }
    .unlock-day-btn:hover { transform: scale(1.05); box-shadow: 0 4px 15px var(--glow-orange); }
    
    /* Progress Ring - Glowing */
    .ring-wrap { position: relative; width: 72px; height: 72px; }
    .ring { transform: rotate(-90deg); }
    .ring-bg { fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 5; }
    .ring-progress { 
      fill: none; 
      stroke: url(#auroraGrad); 
      stroke-width: 5; 
      stroke-linecap: round; 
      transition: stroke-dashoffset 0.6s;
      filter: drop-shadow(0 0 6px var(--glow-teal));
    }
    .ring-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-family: 'Space Grotesk', sans-serif; font-size: 18px; font-weight: 700; color: var(--accent-teal); }
    .ring-text.celebrating { animation: ringTextPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
    @keyframes ringTextPop {
      0% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.5); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }

    /* Ring Completion Celebration */
    .ring-celebration {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9999;
      overflow: hidden;
    }
    .ring-celebration .particle {
      position: absolute;
      border-radius: 50%;
      pointer-events: none;
    }
    .ring-celebration .confetti {
      width: 10px;
      height: 10px;
      animation: confettiFall 3s ease-out forwards;
    }
    @keyframes confettiFall {
      0% { transform: translateY(0) rotate(0deg) scale(1); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg) scale(0); opacity: 0; }
    }
    .ring-celebration .firework {
      width: 6px;
      height: 6px;
      animation: fireworkBurst 1s ease-out forwards;
    }
    @keyframes fireworkBurst {
      0% { transform: translate(0, 0) scale(1); opacity: 1; }
      100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
    }
    .ring-celebration .sparkle {
      width: 4px;
      height: 4px;
      background: gold;
      box-shadow: 0 0 6px gold, 0 0 12px orange;
      animation: sparkleFloat 2s ease-out forwards;
    }
    @keyframes sparkleFloat {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      50% { opacity: 1; }
      100% { transform: translateY(100vh) scale(0.5); opacity: 0; }
    }
    .ring-celebration .star {
      font-size: 24px;
      animation: starBurst 1.5s ease-out forwards;
    }
    @keyframes starBurst {
      0% { transform: translate(0, 0) scale(0) rotate(0deg); opacity: 1; }
      50% { transform: translate(var(--tx), var(--ty)) scale(1.2) rotate(180deg); opacity: 1; }
      100% { transform: translate(calc(var(--tx) * 1.5), calc(var(--ty) * 1.5)) scale(0) rotate(360deg); opacity: 0; }
    }
    .ring-celebration .ring-pulse {
      position: absolute;
      border-radius: 50%;
      border: 3px solid;
      animation: ringPulse 1s ease-out forwards;
    }
    @keyframes ringPulse {
      0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(4); opacity: 0; }
    }
    .ring-celebration .emoji-burst {
      font-size: 32px;
      animation: emojiBurst 2s ease-out forwards;
    }
    @keyframes emojiBurst {
      0% { transform: translate(0, 0) scale(0); opacity: 1; }
      20% { transform: translate(0, 0) scale(1.3); opacity: 1; }
      100% { transform: translate(var(--tx), var(--ty)) scale(0.5); opacity: 0; }
    }
    .ring-glow-burst {
      animation: glowBurst 0.8s ease-out;
    }
    @keyframes glowBurst {
      0% { filter: drop-shadow(0 0 6px var(--glow-teal)); }
      50% { filter: drop-shadow(0 0 30px var(--glow-teal)) drop-shadow(0 0 60px var(--glow-pink)); }
      100% { filter: drop-shadow(0 0 6px var(--glow-teal)); }
    }

    /* Cue Detected Button */
    .cue-detected-btn {
      width: 100%;
      padding: 16px 20px;
      margin-bottom: 16px;
      background: linear-gradient(135deg, rgba(196,113,237,0.2), rgba(109,213,237,0.15));
      border: 2px dashed rgba(196,113,237,0.5);
      border-radius: var(--radius);
      color: var(--text);
      font-family: 'Space Grotesk', sans-serif;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .cue-detected-btn:hover {
      background: linear-gradient(135deg, rgba(196,113,237,0.3), rgba(109,213,237,0.25));
      border-color: var(--accent-purple);
      box-shadow: 0 0 20px var(--glow-purple);
      transform: scale(1.02);
    }
    .cue-detected-btn:active {
      transform: scale(0.98);
    }
    .cue-detected-btn .cue-icon {
      font-size: 24px;
    }

    /* Cue Modal */
    .cue-modal {
      position: fixed;
      inset: 0;
      background: rgba(26,26,46,0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2500;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      backdrop-filter: blur(15px);
      padding: 20px;
    }
    .cue-modal.show {
      opacity: 1;
      pointer-events: auto;
    }
    .cue-modal-content {
      background: var(--bg-mid);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      width: 100%;
      max-width: 400px;
      padding: 24px;
      animation: pop 0.3s cubic-bezier(0.34,1.56,0.64,1);
    }
    .cue-modal-header {
      text-align: center;
      margin-bottom: 20px;
    }
    .cue-modal-header .cue-emoji {
      font-size: 48px;
      margin-bottom: 10px;
    }
    .cue-modal-header h3 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 20px;
      font-weight: 700;
      margin: 0;
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-teal));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .cue-modal-header p {
      color: var(--text-muted);
      font-size: 13px;
      margin: 8px 0 0 0;
    }
    .cue-timestamp {
      text-align: center;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 16px;
      padding: 8px;
      background: rgba(255,255,255,0.05);
      border-radius: var(--radius-sm);
    }
    .cue-note-input {
      width: 100%;
      padding: 14px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 15px;
      resize: none;
      min-height: 100px;
      margin-bottom: 16px;
    }
    .cue-note-input:focus {
      outline: none;
      border-color: var(--accent-purple);
      box-shadow: 0 0 10px var(--glow-purple);
    }
    .cue-note-input::placeholder {
      color: var(--text-muted);
    }
    .cue-modal-buttons {
      display: flex;
      gap: 12px;
    }
    .cue-modal-buttons button {
      flex: 1;
      padding: 12px;
      border-radius: var(--radius);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .cue-cancel-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid var(--border);
      color: var(--text-muted);
    }
    .cue-cancel-btn:hover {
      background: rgba(255,255,255,0.15);
      color: var(--text);
    }
    .cue-save-btn {
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-teal));
      border: none;
      color: white;
    }
    .cue-save-btn:hover {
      box-shadow: 0 0 20px var(--glow-purple);
      transform: scale(1.02);
    }

    /* Full Screen Cue Celebration */
    .cue-celebration {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, rgba(26,26,46,0.98), rgba(50,30,80,0.98));
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s;
      backdrop-filter: blur(20px);
      overflow: hidden;
    }
    .cue-celebration.show {
      opacity: 1;
      pointer-events: auto;
    }
    .cue-celebration-content {
      text-align: center;
      z-index: 1;
      padding: 40px;
    }
    .cue-celebration-emoji {
      font-size: 80px;
      animation: celebrationBounce 0.6s cubic-bezier(0.34,1.56,0.64,1);
    }
    @keyframes celebrationBounce {
      0% { transform: scale(0) rotate(-20deg); }
      60% { transform: scale(1.2) rotate(10deg); }
      100% { transform: scale(1) rotate(0deg); }
    }
    .cue-celebration-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 28px;
      font-weight: 700;
      margin: 20px 0 10px;
      background: linear-gradient(135deg, #ffd93d, #ff6b9d, #c471ed, #6dd5ed);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: titleSlide 0.5s ease-out 0.2s both;
    }
    @keyframes titleSlide {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .cue-celebration-subtitle {
      font-size: 16px;
      color: var(--text-muted);
      max-width: 300px;
      margin: 0 auto;
      animation: titleSlide 0.5s ease-out 0.4s both;
      line-height: 1.5;
    }
    .cue-celebration-dismiss {
      margin-top: 30px;
      padding: 14px 40px;
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));
      border: none;
      border-radius: var(--radius-pill);
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      animation: titleSlide 0.5s ease-out 0.6s both;
      transition: all 0.2s;
    }
    .cue-celebration-dismiss:hover {
      transform: scale(1.05);
      box-shadow: 0 0 30px var(--glow-pink);
    }
    .cue-celebration-particles {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    /* Phase Bar */
    .phase { margin-top: 0; }
    .phase-label { display: flex; justify-content: space-between; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 8px; }
    .phase-track { height: 6px; background: rgba(255,255,255,0.1); border-radius: var(--radius-pill); overflow: hidden; }
    .phase-fill { 
      height: 100%; 
      background: linear-gradient(90deg, var(--accent-purple), var(--accent-pink), var(--accent-orange)); 
      border-radius: var(--radius-pill); 
      box-shadow: 0 0 20px var(--glow-pink);
      transition: width 0.6s;
    }
    
    /* Cards - Glowing borders on hover */
    .quick-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
    
    /* REHIT full-width card */
    .rehit-full {
      margin-bottom: 16px;
      min-height: auto;
    }
    .rehit-dots-row {
      display: flex;
      gap: 8px;
      margin: 10px 0 14px 0;
    }
    .rehit-dots-row .rehit-dot {
      flex: 1;
      height: 8px;
      border-radius: 4px;
      background: rgba(255,255,255,0.15);
      transition: all 0.3s;
    }
    .rehit-dots-row .rehit-dot.on {
      background: linear-gradient(90deg, var(--accent-pink), var(--accent-orange));
      box-shadow: 0 0 10px var(--glow-pink);
    }
    .rehit-layout {
      display: flex;
      gap: 20px;
      align-items: flex-end;
    }
    .rehit-left {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .rehit-chips {
      flex-direction: column;
      gap: 8px;
    }
    .rehit-chip {
      padding: 10px 16px;
    }
    .rehit-chip .chip-dot {
      width: 22px;
      height: 22px;
      font-size: 12px;
    }
    .rehit-chip .chip-text {
      font-size: 15px;
      font-weight: 600;
    }
    .rehit-week-count {
      margin-top: auto;
      padding-top: 0;
    }
    .rehit-right {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding-left: 20px;
      border-left: 1px solid var(--border);
    }
    .rehit-stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px 24px;
    }
    .rehit-stat {
      text-align: center;
    }
    .rehit-stat-label {
      display: block;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: var(--text-muted);
      margin-bottom: 2px;
    }
    .rehit-stat-value {
      display: block;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 20px;
      font-weight: 700;
    }
    .rehit-stat-input {
      display: block;
      width: 100%;
      background: transparent;
      border: none;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 20px;
      font-weight: 700;
      text-align: center;
      outline: none;
    }
    .rehit-stat-input::placeholder { color: var(--text-muted); opacity: 0.5; }
    .rehit-stat-input:focus { background: rgba(255,255,255,0.05); border-radius: 4px; }
    .rehit-edit-btn {
      display: none; /* Hidden - no longer used */
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-pill);
      background: rgba(255,255,255,0.06);
      color: var(--text-dim);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .rehit-edit-btn .chip-dot {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 2px solid var(--accent-pink);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: var(--accent-pink);
      transition: all 0.3s;
    }
    .rehit-edit-btn:hover {
      background: rgba(236, 72, 153, 0.1);
      border-color: var(--accent-pink);
    }
    .rehit-edit-btn:hover .chip-dot {
      background: var(--accent-pink);
      color: white;
      box-shadow: 0 0 10px var(--glow-pink);
    }
    body.day-mode .rehit-edit-btn {
      background: rgba(0,0,0,0.05);
    }
    
    .card {
      background: rgba(255,255,255,0.06); 
      border: 1px solid rgba(255,255,255,0.15); 
      border-radius: var(--radius);
      padding: 18px; 
      position: relative; 
      overflow: hidden; 
      backdrop-filter: blur(20px);
      transition: all 0.3s;
      display: flex;
      flex-direction: column;
      min-height: 140px;
    }
    .card::before { 
      content: ''; 
      position: absolute; 
      top: 0; left: 0; right: 0; 
      height: 3px; 
      background: linear-gradient(90deg, var(--accent-start, var(--accent-purple)), var(--accent-end, var(--accent-pink))); 
      opacity: 0.8; 
    }
    .card:hover { 
      border-color: rgba(255,255,255,0.25);
      box-shadow: 0 0 30px var(--card-glow, var(--glow-purple));
      transform: translateY(-2px);
    }
    .card.sleep { --accent-start: var(--accent-purple); --accent-end: var(--accent-pink); --card-glow: var(--glow-purple); }
    .card.water { --accent-start: var(--accent-teal); --accent-end: var(--accent-purple); --card-glow: var(--glow-teal); }
    .card.movement { --accent-start: var(--accent-pink); --accent-end: var(--accent-orange); --card-glow: var(--glow-pink); }
    
    .card-head { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
    .card-icon { 
      width: 32px; height: 32px; border-radius: 50%; 
      display: flex; align-items: center; justify-content: center; font-size: 15px; 
      background: linear-gradient(135deg, var(--accent-start, var(--accent-purple)), var(--accent-end, var(--accent-pink)));
      box-shadow: 0 0 15px var(--card-glow, var(--glow-purple));
    }
    .card-title { font-size: 12px; font-weight: 600; color: rgba(255,255,255,0.8); text-transform: uppercase; letter-spacing: 0.05em; }
    .card-value { font-family: 'Space Grotesk', sans-serif; font-size: 32px; font-weight: 700; line-height: 1; color: #ffffff; }
    .card-unit { font-size: 13px; color: var(--text); margin-left: 4px; }
    .input-row { display: flex; align-items: baseline; }
    .card-avg { font-size: 11px; color: rgba(255,255,255,0.5); margin-top: auto; padding-top: 8px; }
    
    /* REHIT Dots */
    .rehit-dots { display: flex; gap: 6px; margin-left: auto; }
    .rehit-dot { 
      width: 10px; height: 10px; 
      border-radius: 50%; 
      background: rgba(255,255,255,0.2); 
      transition: all 0.3s;
    }
    .rehit-dot.on { 
      background: var(--accent-teal); 
      box-shadow: 0 0 8px var(--glow-teal);
    }
    body.day-mode .rehit-dot {
      background: rgba(0,0,0,0.15);
    }
    body.day-mode .rehit-dot.on {
      background: var(--success);
      box-shadow: 0 0 8px rgba(5,150,105,0.4);
    }
    body.day-mode .rehit-dots-row .rehit-dot {
      background: rgba(0,0,0,0.1);
    }
    body.day-mode .rehit-dots-row .rehit-dot.on {
      background: linear-gradient(90deg, var(--accent-pink), var(--accent-orange));
      box-shadow: 0 0 8px rgba(236, 72, 153, 0.4);
    }
    
    /* Counter dots (for weekly goals) */
    .counter-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      transition: all 0.3s;
    }
    .counter-dot.on {
      background: var(--accent-teal);
      box-shadow: 0 0 8px var(--glow-teal);
    }
    body.day-mode .counter-dot {
      background: rgba(0,0,0,0.15);
    }
    body.day-mode .counter-dot.on {
      background: var(--success);
      box-shadow: 0 0 8px rgba(5,150,105,0.4);
    }
    
    /* Rating stars */
    .rating-stars {
      display: flex;
      gap: 8px;
      font-size: 28px;
    }
    .star {
      cursor: pointer;
      color: rgba(255,255,255,0.3);
      transition: all 0.2s;
    }
    .star:hover, .star.filled {
      color: var(--accent-orange);
      text-shadow: 0 0 10px var(--glow-orange);
    }
    body.day-mode .star {
      color: rgba(0,0,0,0.2);
    }
    body.day-mode .star:hover, body.day-mode .star.filled {
      color: var(--accent-orange);
    }
    
    /* Custom log modal */
    #customLogModal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    #customLogModal.show {
      display: flex;
    }
    #customLogModal .modal-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
    }
    #customLogModal .modal-content {
      position: relative;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }
    #customLogModal .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    #customLogModal .modal-header h3 {
      margin: 0;
      font-size: 18px;
    }
    body.day-mode #customLogModal .modal-content {
      background: rgba(255,255,255,0.95);
    }

    /* Phase System Styles */
    .phase-transition-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 16px;
      z-index: 1000;
      display: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .phase-banner-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 600px;
      margin: 0 auto;
    }
    .phase-banner-content span {
      font-weight: 500;
    }
    .phase-banner-content button {
      background: white;
      color: #667eea;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      cursor: pointer;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(4px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1001;
    }
    .phase-modal {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      max-height: 85vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }
    .modal-header h2 {
      margin: 0;
      font-size: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }
    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }
    .modal-footer {
      display: flex;
      gap: 12px;
      padding: 16px 20px;
      border-top: 1px solid var(--border);
    }
    .modal-footer button {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      border: none;
    }
    .btn-secondary {
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border) !important;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .phase-modal-info {
      margin-bottom: 20px;
    }
    .phase-modal-info p {
      margin: 0 0 8px;
      color: var(--text-muted);
    }
    .phase-dates {
      font-weight: 500;
      color: var(--text) !important;
    }

    .phase-goals-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .phase-goal-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
    }
    .phase-goal-info {
      flex: 1;
    }
    .phase-goal-name {
      display: block;
      font-weight: 500;
      margin-bottom: 4px;
    }
    .phase-goal-current {
      font-size: 12px;
      color: var(--text-muted);
    }
    .phase-goal-input {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .phase-goal-input input[type="number"] {
      width: 70px;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text);
      text-align: center;
      font-size: 16px;
    }
    .phase-goal-input input[type="checkbox"] {
      width: 24px;
      height: 24px;
    }
    .phase-goal-unit {
      font-size: 12px;
      color: var(--text-muted);
    }

    .suggestion-good { color: #4CAF50; font-size: 11px; display: block; margin-top: 4px; }
    .suggestion-ok { color: #FF9800; font-size: 11px; display: block; margin-top: 4px; }
    .suggestion-work { color: #f44336; font-size: 11px; display: block; margin-top: 4px; }

    /* Phase performance review */
    .phase-performance-review {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .phase-stat-row {
      display: flex;
      align-items: flex-start;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }
    .phase-stat-row:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }
    .phase-stat-row:first-of-type {
      padding-top: 0;
    }
    .phase-stat-label {
      width: 100px;
      font-weight: 500;
      color: var(--text);
      font-size: 13px;
      flex-shrink: 0;
    }
    .phase-stat-details {
      flex: 1;
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.5;
    }
    .stat-highlight {
      color: var(--text);
      font-weight: 600;
    }
    .stat-pct {
      color: var(--accent-teal);
      font-weight: 500;
    }
    .stat-avg {
      color: var(--text-muted);
      font-size: 12px;
    }

    /* Phase selector */
    .summary-controls {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      flex-wrap: wrap;
      align-items: center;
    }
    .phase-selector {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--card);
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
    }

    /* Phase Comparison */
    .comparison-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .comparison-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-muted);
      cursor: pointer;
    }
    .comparison-selectors {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
    }
    .comparison-vs {
      color: var(--text-muted);
      font-weight: 500;
    }
    .comparison-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .comparison-row {
      display: grid;
      grid-template-columns: 1fr 80px 80px 60px;
      gap: 8px;
      align-items: center;
      padding: 10px 12px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
    }
    .comparison-row.header {
      background: transparent;
      border: none;
      font-weight: 600;
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
    }
    .comparison-goal-name {
      font-weight: 500;
    }
    .comparison-goal-target {
      font-size: 12px;
      color: var(--text-muted);
    }
    .comparison-value {
      text-align: center;
      font-weight: 600;
    }
    .comparison-change {
      text-align: center;
      font-size: 13px;
      font-weight: 600;
    }
    .comparison-change.positive { color: #4CAF50; }
    .comparison-change.negative { color: #f44336; }
    .comparison-change.neutral { color: var(--text-muted); }

    /* Phase Goals Section */
    .phase-goals-content {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 12px;
    }
    .phase-goal-card {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
    }
    .phase-goal-card .goal-icon {
      font-size: 18px;
    }
    .phase-goal-card .goal-details {
      flex: 1;
    }
    .phase-goal-card .goal-name {
      font-size: 12px;
      color: var(--text-muted);
    }
    .phase-goal-card .goal-target {
      font-weight: 600;
      font-size: 15px;
    }
    #phaseGoalsSection .sec-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Mini Supplements (in own card) */
    .mini-supps-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 8px;
    }
    .mini-supp {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px 6px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: rgba(255,255,255,0.05);
      cursor: pointer;
      transition: all 0.2s;
    }
    .mini-supp input {
      display: none;
    }
    .mini-supp span {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
    }
    .mini-supp:has(input:checked) {
      background: var(--success-soft);
      border-color: var(--success);
      box-shadow: 0 0 10px var(--glow-teal);
    }
    .mini-supp:has(input:checked) span {
      color: white;
    }
    body.day-mode .mini-supp {
      background: rgba(0,0,0,0.05);
    }
    body.day-mode .mini-supp:has(input:checked) {
      background: rgba(251, 146, 60, 0.25);
      border-color: #f97316;
      box-shadow: 0 0 8px rgba(249, 115, 22, 0.3);
    }
    body.day-mode .mini-supp:has(input:checked) span {
      color: #1f2937;
    }
    .card.supplements {
      --accent-start: var(--accent-teal);
      --accent-end: var(--accent-purple);
      --card-glow: var(--glow-teal);
    }
    .mini-supps-grid.three-col {
      grid-template-columns: 1fr 1fr 1fr;
    }
    
    /* Horizontal Progress Bars (same style as phase bar) */
    .progress-bar-h {
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: var(--radius-pill);
      overflow: hidden;
      margin-top: 10px;
    }
    .progress-bar-h-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-purple), var(--accent-pink), var(--accent-orange));
      border-radius: var(--radius-pill);
      box-shadow: 0 0 10px var(--glow-pink);
      transition: width 0.5s ease;
      width: 0%;
    }
    body.day-mode .progress-bar-h {
      background: rgba(0,0,0,0.1);
    }
    
    /* Movement Modal */
    .movement-types {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }
    .movement-type-btn {
      padding: 20px 10px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg-card);
      color: var(--text);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .movement-type-btn .type-icon {
      font-size: 28px;
    }
    .movement-type-btn.selected {
      border-color: var(--accent-teal);
      background: rgba(45, 212, 191, 0.15);
      box-shadow: 0 0 20px var(--glow-teal);
    }
    .duration-section {
      margin-bottom: 0;
    }
    .duration-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 12px;
    }
    .duration-presets {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .duration-preset {
      flex: 1;
      min-width: 50px;
      padding: 12px 8px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg-card);
      color: var(--text);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    .duration-preset.selected {
      border-color: var(--accent-pink);
      background: rgba(236, 72, 153, 0.15);
      box-shadow: 0 0 15px var(--glow-pink);
    }
    .duration-custom-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 12px;
    }
    .duration-custom-row input {
      width: 80px;
      padding: 10px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg-card);
      color: var(--text);
      font-size: 18px;
      font-weight: 600;
      text-align: center;
    }
    .duration-custom-row input:focus {
      outline: none;
      border-color: var(--accent-pink);
    }
    .duration-custom-row span {
      color: var(--text-muted);
      font-size: 14px;
    }
    #movementModal .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    body.day-mode .movement-type-btn,
    body.day-mode .duration-preset,
    body.day-mode .duration-custom-row input {
      background: rgba(255,255,255,0.5);
    }

    /* Reading Modal */
    .reading-field {
      margin-bottom: 20px;
    }
    .reading-field:last-child {
      margin-bottom: 0;
    }
    .reading-label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 10px;
    }
    .reading-input {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg-card);
      color: var(--text);
      font-size: 15px;
      font-family: 'Inter', -apple-system, sans-serif;
    }
    .reading-input:focus {
      outline: none;
      border-color: var(--accent-purple);
      box-shadow: 0 0 15px var(--glow-purple);
    }
    .reading-input::placeholder {
      color: var(--text-muted);
    }
    #readingModal .duration-preset.selected {
      border-color: var(--accent-purple);
      background: rgba(196, 113, 237, 0.15);
      box-shadow: 0 0 15px var(--glow-purple);
    }
    #readingModal .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    body.day-mode .reading-input {
      background: rgba(255,255,255,0.5);
    }

    .big-input { width: auto; flex: 1; min-width: 0; background: transparent; border: none; font-family: 'Space Grotesk', sans-serif; font-size: 32px; font-weight: 700; color: white; outline: none; transition: color 0.3s; }
    .big-input::placeholder { color: var(--text-muted); }
    .big-input:focus { color: var(--accent-teal); }
    
    /* Water */
    .water-row { display: flex; align-items: center; gap: 12px; justify-content: center; }
    .water-btn { 
      width: 44px; height: 44px; border-radius: 50%; 
      border: 2px solid var(--accent-teal); background: transparent; 
      color: var(--accent-teal); font-size: 18px; cursor: pointer; transition: all 0.3s; 
    }
    .water-btn:hover { 
      background: var(--accent-teal); 
      color: var(--bg-deep); 
      box-shadow: 0 0 20px var(--glow-teal);
    }
    .water-btn:active { transform: scale(0.9); }
    .water-num { font-family: 'Space Grotesk', sans-serif; font-size: 32px; font-weight: 700; min-width: 44px; text-align: center; color: white; }
    
    /* Sections */
    .section { 
      background: rgba(255,255,255,0.06); 
      border: 1px solid rgba(255,255,255,0.15); 
      border-radius: var(--radius); 
      padding: 18px; 
      margin-bottom: 12px; 
      backdrop-filter: blur(20px); 
      transition: all 0.3s;
    }
    .section:hover { border-color: rgba(255,255,255,0.2); }

    .reminder-card {
      background: rgba(249, 115, 22, 0.35);
      border: 1px solid rgba(249, 115, 22, 0.55);
      border-radius: var(--radius);
      padding: 18px;
      margin-bottom: 12px;
      text-align: center;
      backdrop-filter: blur(20px);
    }
    .reminder-card .reminder-icon { font-size: 28px; margin-bottom: 6px; }
    .reminder-card .reminder-title { font-size: 15px; font-weight: 600; color: var(--text); }
    .reminder-card .reminder-sub { font-size: 12px; color: var(--text-dim); margin-top: 4px; }
    .reminder-card .reminder-close { position: absolute; top: 8px; right: 12px; background: none; border: none; color: var(--text-dim); font-size: 16px; cursor: pointer; }
    .reminder-card { position: relative; }
    body.day-mode .reminder-card {
      background: rgba(99, 102, 241, 0.32);
      border-color: rgba(99, 102, 241, 0.55);
    }
    /* Biomarkers Page */
    .bio-category { margin-bottom: 14px; }
    .bio-cat-header { display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius) var(--radius) 0 0; cursor: pointer; }
    .bio-cat-header .bio-cat-icon { font-size: 16px; }
    .bio-cat-header .bio-cat-name { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-dim); flex: 1; }
    .bio-cat-header .bio-cat-toggle { font-size: 10px; color: var(--text-muted); transition: transform 0.3s; }
    .bio-cat-header.collapsed .bio-cat-toggle { transform: rotate(-90deg); }
    .bio-cat-body { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-top: none; border-radius: 0 0 var(--radius) var(--radius); overflow: hidden; }
    .bio-cat-body.collapsed { display: none; }

    .bio-card { padding: 14px; border-bottom: 1px solid rgba(255,255,255,0.06); }
    .bio-card:last-child { border-bottom: none; }
    .bio-card-top { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
    .bio-name { font-size: 14px; font-weight: 600; color: var(--accent-teal); flex: 1; cursor: pointer; }
    .bio-name:active { opacity: 0.7; }
    .bio-history-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.06); font-size: 13px; }
    .bio-history-row:last-child { border-bottom: none; }
    .bio-history-date { color: var(--text-muted); }
    .bio-history-val { font-weight: 600; }
    .bio-history-val.in-range { color: #52b788; }
    .bio-history-val.out-range { color: #d4a017; }
    body.day-mode .bio-history-row { border-bottom-color: rgba(0,0,0,0.06); }
    body.day-mode .bio-name { color: #6366f1; }
    .bio-info-btn { width: 22px; height: 22px; border-radius: 50%; border: 1px solid var(--text-muted); background: none; color: var(--text-muted); font-size: 11px; font-style: italic; font-family: Georgia, serif; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .bio-info-btn:hover, .bio-info-btn.active { border-color: var(--accent-teal); color: var(--accent-teal); }
    .bio-range-text { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; }
    .bio-desc { font-size: 11px; color: var(--text-muted); line-height: 1.4; margin-bottom: 10px; }
    .bio-no-data-badge { font-size: 10px; padding: 2px 6px; background: rgba(212,160,23,0.2); color: #d4a017; border-radius: 4px; font-weight: 500; }
    .bio-card.no-data { opacity: 0.6; }

    .bio-bar-wrap { position: relative; height: 14px; border-radius: 7px; overflow: visible; margin: 0 8px 4px; display: flex; }
    .bio-bar-low { background: #d4a017; border-radius: 7px 0 0 7px; height: 100%; }
    .bio-bar-normal { background: #52b788; height: 100%; }
    .bio-bar-high { background: #d4a017; border-radius: 0 7px 7px 0; height: 100%; flex: 1; }
    .bio-bar-labels { display: flex; justify-content: space-between; padding: 0 8px; margin-bottom: 8px; }
    .bio-bar-label { font-size: 10px; color: var(--text-muted); }

    .bio-bubble-wrap { position: absolute; top: -28px; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; pointer-events: none; }
    .bio-bubble { padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: 700; color: #fff; white-space: nowrap; }
    .bio-bubble-arrow { width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 5px solid; }
    .bio-bubble.in-range { background: #52b788; }
    .bio-bubble.in-range + .bio-bubble-arrow { border-top-color: #52b788; }
    .bio-bubble.out-range { background: #d4a017; }
    .bio-bubble.out-range + .bio-bubble-arrow { border-top-color: #d4a017; }
    .bio-bubble.no-result { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-muted); }
    .bio-bubble.no-result + .bio-bubble-arrow { border-top-color: var(--border); }

    .bio-input-row { display: flex; align-items: center; gap: 8px; margin-top: 6px; }
    .bio-input-label { font-size: 11px; color: var(--text-muted); }
    .bio-input { width: 80px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 6px 8px; color: var(--text); font-size: 13px; font-family: 'Space Grotesk', sans-serif; text-align: center; outline: none; flex-shrink: 0; }
    .bio-input:focus { border-color: var(--accent-teal); }

    body.day-mode .bio-cat-header { background: rgba(0,0,0,0.03); border-color: rgba(0,0,0,0.08); }
    body.day-mode .bio-cat-body { background: rgba(255,255,255,0.6); border-color: rgba(0,0,0,0.08); }
    body.day-mode .bio-card { border-bottom-color: rgba(0,0,0,0.06); }
    body.day-mode .bio-input { background: rgba(255,255,255,0.8); color: #1f2937; }

    .sec-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; cursor: pointer; }
    .sec-title { display: flex; align-items: center; gap: 10px; }
    .sec-icon { 
      width: 28px; height: 28px; border-radius: 50%; 
      display: flex; align-items: center; justify-content: center; font-size: 13px; 
      background: linear-gradient(135deg, var(--icon-start, var(--accent-purple)), var(--icon-end, var(--accent-pink)));
      box-shadow: 0 0 12px var(--icon-glow, var(--glow-purple));
    }
    .sec-name { font-size: 14px; font-weight: 600; color: #ffffff; }
    .streak-badge {
      font-size: 11px;
      font-weight: 500;
      color: #ffa552;
      margin-left: 8px;
      animation: streak-glow 2s ease-in-out infinite;
    }
    @keyframes streak-glow {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .sec-toggle { color: rgba(255,255,255,0.5); font-size: 11px; transition: transform 0.3s; }
    .sec-head.collapsed .sec-toggle { transform: rotate(-90deg); }
    .sec-content { transition: max-height 0.3s, opacity 0.3s; overflow: hidden; }
    .sec-content.collapsed { max-height: 0; opacity: 0; }
    
    /* Chips - Glowing when active */
    .chips { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip {
      display: flex; align-items: center; gap: 6px; padding: 8px 14px;
      background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: var(--radius-pill);
      cursor: pointer; transition: all 0.3s; user-select: none;
    }
    .chip:hover { background: rgba(255,255,255,0.1); }
    .chip:active { transform: scale(0.97); }
    .chip.on { 
      background: var(--success-soft); 
      border-color: var(--success); 
      box-shadow: 0 0 15px var(--glow-teal);
    }
    .chip-dot { 
      width: 18px; height: 18px; border-radius: 50%; 
      border: 2px solid var(--text-muted); 
      display: flex; align-items: center; justify-content: center; 
      font-size: 10px; transition: all 0.3s; 
    }
    .chip.on .chip-dot { 
      background: var(--success); 
      border-color: var(--success); 
      color: white; 
      box-shadow: 0 0 10px var(--glow-teal);
    }
    .chip-text { font-size: 13px; font-weight: 500; color: var(--text-dim); transition: color 0.3s; }
    .chip.on .chip-text { color: var(--text); }
    .chip input { display: none; }
    
    /* Inputs */
    .field { margin-bottom: 14px; }
    .field-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 6px; display: block; }
    .input { 
      width: 100%; padding: 14px; 
      background: rgba(255,255,255,0.05); 
      border: 1px solid var(--border); 
      border-radius: var(--radius-sm); 
      color: var(--text); font-size: 15px; outline: none; transition: all 0.3s; 
    }
    .input:focus { 
      border-color: var(--accent-teal); 
      box-shadow: 0 0 20px var(--glow-teal);
    }
    .input::placeholder { color: var(--text-muted); }
    textarea.input { min-height: 90px; resize: vertical; font-family: inherit; line-height: 1.5; }
    
    /* Buttons */
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 16px; border-radius: var(--radius-sm); font-size: 13px; font-weight: 600; cursor: pointer; border: none; transition: all 0.3s; }
    .btn-secondary { background: rgba(255,255,255,0.08); color: var(--text-dim); border: 1px solid var(--border); }
    .btn-secondary:hover { background: rgba(255,255,255,0.12); color: var(--text); }
    .btn-secondary.active { background: var(--accent-teal); color: #fff; border-color: var(--accent-teal); box-shadow: 0 0 10px var(--glow-teal); }
    body.day-mode .btn-secondary.active { background: #6366f1; color: #fff; border-color: #6366f1; box-shadow: 0 0 10px var(--glow-purple); }
    .btn-primary { 
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink)); 
      color: white; padding: 14px 24px; 
      box-shadow: 0 4px 20px var(--glow-purple);
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 30px var(--glow-pink); }
    
    /* Items */
    .items { margin-bottom: 12px; }
    .item { 
      display: flex; align-items: center; justify-content: space-between; 
      padding: 12px 14px; 
      background: var(--success-soft); 
      border: 1px solid var(--success); 
      border-radius: var(--radius-sm); 
      margin-bottom: 6px;
      box-shadow: 0 0 10px var(--glow-teal);
    }
    .item-text { font-size: 13px; color: var(--text); }
    .item-time { font-size: 11px; color: var(--text-muted); margin-left: 4px; }
    .item-del { background: none; border: none; color: var(--text-muted); font-size: 16px; cursor: pointer; }
    .item-del:hover { color: var(--accent-pink); }
    body.day-mode .item {
      background: rgba(5, 150, 105, 0.15);
      border-color: var(--success);
      box-shadow: 0 0 8px rgba(5, 150, 105, 0.3);
    }
    
    /* REHIT Calendar */
    .rehit-calendar {
      user-select: none;
    }
    .rehit-cal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    .rehit-cal-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
    }
    .rehit-cal-nav {
      display: flex;
      gap: 8px;
    }
    .rehit-cal-nav button {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-muted);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .rehit-cal-nav button:hover {
      border-color: var(--accent-pink);
      color: var(--accent-pink);
    }
    .rehit-cal-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 8px;
    }
    .rehit-cal-weekday {
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      padding: 4px;
    }
    .rehit-cal-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    .rehit-cal-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-muted);
      border-radius: 50%;
      transition: all 0.2s;
    }
    .rehit-cal-day.other-month {
      color: var(--text-muted);
      opacity: 0.3;
    }
    .rehit-cal-day.today {
      background: var(--accent-orange);
      color: white;
      font-weight: 700;
    }
    .rehit-cal-day.has-rehit {
      border: 2px solid var(--accent-pink);
      color: var(--text);
    }
    .rehit-cal-day.has-rehit.rehit-2x10 {
      border-color: var(--accent-teal);
      box-shadow: 0 0 8px var(--glow-teal);
    }
    .rehit-cal-day.has-rehit.rehit-3x10 {
      border-color: var(--accent-pink);
      background: rgba(255, 107, 157, 0.2);
      box-shadow: 0 0 8px var(--glow-pink);
    }
    .rehit-cal-legend {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      justify-content: center;
    }
    .rehit-cal-legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }
    .rehit-cal-legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid;
    }
    .rehit-cal-legend-dot.dot-2x10 {
      border-color: var(--accent-teal);
    }
    .rehit-cal-legend-dot.dot-3x10 {
      border-color: var(--accent-pink);
      background: rgba(255, 107, 157, 0.2);
    }
    body.day-mode .rehit-cal-day {
      color: #6b7280;
    }
    body.day-mode .rehit-cal-day.has-rehit {
      color: #1f2937;
    }
    body.day-mode .rehit-cal-day.today {
      color: white;
    }
    
    /* Summary Page Styles */
    .summary-overview {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .summary-stat {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 16px;
      text-align: center;
    }
    .summary-stat.full-width {
      grid-column: 1 / -1;
    }
    .summary-stat-value {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 32px;
      font-weight: 700;
      background: linear-gradient(90deg, var(--accent-teal), var(--accent-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .summary-stat-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    .summary-stat-sub {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }
    .goal-stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .goal-stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px;
    }
    .goal-stat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .goal-stat-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }
    .goal-stat-pct {
      font-size: 12px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 10px;
    }
    .goal-stat-pct.good {
      background: rgba(109, 213, 237, 0.2);
      color: var(--accent-teal);
    }
    .goal-stat-pct.ok {
      background: rgba(255, 165, 82, 0.2);
      color: var(--accent-orange);
    }
    .goal-stat-pct.needs-work {
      background: rgba(255, 107, 157, 0.2);
      color: var(--accent-pink);
    }
    .goal-stat-bar {
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      overflow: hidden;
    }
    .goal-stat-bar-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.3s;
    }
    .goal-stat-detail {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
    }
    .goal-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      margin: 4px;
    }
    .goal-badge-icon {
      font-size: 18px;
    }
    .goal-badge-text {
      font-size: 13px;
      color: var(--text);
    }
    .goal-badge-pct {
      font-size: 12px;
      font-weight: 600;
      color: var(--accent-teal);
    }
    body.day-mode .summary-stat {
      background: rgba(255,255,255,0.8);
    }
    body.day-mode .goal-stat-card {
      background: rgba(255,255,255,0.8);
    }
    body.day-mode .goal-stat-bar {
      background: rgba(0,0,0,0.1);
    }
    body.day-mode .goal-badge {
      background: rgba(255,255,255,0.8);
    }
    
    /* Body Grid */
    .body-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .body-cell { background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px; }
    .body-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 4px; }
    .body-input { width: 100%; background: transparent; border: none; font-family: 'Space Grotesk', sans-serif; font-size: 18px; font-weight: 600; color: var(--text); outline: none; transition: color 0.3s; }
    .body-input:focus { color: var(--accent-teal); }
    .body-pct { font-family: 'Space Grotesk', sans-serif; font-size: 18px; font-weight: 600; color: var(--accent-teal); }

    /* Movement Rows */
    .movement-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      margin-bottom: 10px;
    }
    .movement-row-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      min-width: 80px;
    }
    .movement-row select {
      flex: 1;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 8px 12px;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 14px;
      color: var(--text);
      outline: none;
      cursor: pointer;
    }
    .movement-row select:focus { border-color: var(--accent-pink); }
    .movement-row input[type="number"] {
      width: 60px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 8px 12px;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 14px;
      color: var(--text);
      text-align: center;
      outline: none;
    }
    .movement-row input[type="number"]:focus { border-color: var(--accent-pink); }
    .movement-row .min-label { font-size: 12px; color: var(--text-muted); }
    body.day-mode .movement-row { background: rgba(0,0,0,0.03); }
    body.day-mode .movement-row select,
    body.day-mode .movement-row input[type="number"] { background: white; }

    /* FAB - Glowing */
    .fab { 
      position: fixed; bottom: 24px; right: 24px; 
      width: 60px; height: 60px; border-radius: 50%; 
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink)); 
      border: none; color: white; font-size: 24px; cursor: pointer; 
      box-shadow: 0 8px 30px var(--glow-purple);
      z-index: 100; transition: all 0.3s; 
      animation: fab-pulse 2s ease-in-out infinite;
    }
    @keyframes fab-pulse {
      0%, 100% { box-shadow: 0 8px 30px var(--glow-purple); }
      50% { box-shadow: 0 8px 40px var(--glow-pink), 0 0 60px var(--glow-purple); }
    }
    .fab:hover { transform: scale(1.1); }
    .fab:active { transform: scale(0.95); }
    .fab.open { transform: rotate(45deg); background: var(--bg-card); animation: none; }
    
    .fab-menu { position: fixed; bottom: 100px; right: 24px; display: flex; flex-direction: column; gap: 10px; opacity: 0; transform: translateY(20px); pointer-events: none; transition: all 0.3s; z-index: 99; }
    .fab-menu.open { opacity: 1; transform: translateY(0); pointer-events: auto; }
    .fab-item { 
      display: flex; align-items: center; gap: 10px; padding: 10px 16px; 
      background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-pill); 
      backdrop-filter: blur(20px); cursor: pointer; transition: all 0.3s; white-space: nowrap; 
    }
    .fab-item:hover { background: var(--bg-card-hover); transform: translateX(-8px); box-shadow: 0 0 20px var(--glow-purple); }
    .fab-icon { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .fab-label { font-size: 14px; font-weight: 600; color: var(--text); }
    
    /* Sticky */
    .sticky { position: fixed; top: 0; left: 0; right: 0; background: rgba(26,26,46,0.95); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); padding: 10px 16px; padding-top: max(60px, calc(14px + env(safe-area-inset-top, 44px))); display: flex; justify-content: space-between; align-items: center; z-index: 1000; transform: translateY(-100%); transition: transform 0.3s; }
    body.day-mode .sticky { background: rgba(255,255,255,0.92); border-bottom-color: #e5e7eb; }
    body.day-mode .sticky-date { color: #6b7280; }
    .sticky.visible { transform: translateY(0); }
    .sticky-date { font-size: 14px; font-weight: 600; }
    .sticky-btns { display: flex; gap: 8px; }
    .sticky-btns button { width: 32px; height: 32px; border-radius: 50%; border: none; background: var(--bg-card); color: var(--text-dim); font-size: 13px; cursor: pointer; }
    
    /* Milestone - Aurora themed */
    .milestone { position: fixed; inset: 0; background: rgba(26,26,46,0.95); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(10px); }
    .milestone.show { opacity: 1; pointer-events: auto; }
    .milestone-box { text-align: center; animation: pop 0.5s cubic-bezier(0.34,1.56,0.64,1); }
    @keyframes pop { 0%{transform:scale(0.5);opacity:0} 100%{transform:scale(1);opacity:1} }
    .milestone-emoji { font-size: 72px; animation: float 2s ease-in-out infinite; }
    @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-15px)} }
    .milestone-title { font-family: 'Space Grotesk', sans-serif; font-size: 26px; font-weight: 700; margin-top: 16px; background: linear-gradient(90deg, var(--accent-teal), var(--accent-purple), var(--accent-pink)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .milestone-sub { font-size: 15px; color: var(--text-dim); margin-top: 8px; }
    .milestone-btn { margin-top: 28px; padding: 14px 32px; background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink)); border: none; border-radius: var(--radius-pill); font-size: 16px; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 8px 30px var(--glow-purple); }
    
    /* Modal */
    .modal { position: fixed; inset: 0; background: rgba(26,26,46,0.9); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(10px); padding: 16px; }
    .modal.show { opacity: 1; pointer-events: auto; }
    .modal-content { background: var(--bg-mid); border: 1px solid var(--border); border-radius: var(--radius); width: 100%; max-width: 360px; animation: pop 0.3s cubic-bezier(0.34,1.56,0.64,1); overflow: hidden; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 18px; border-bottom: 1px solid var(--border); }
    .modal-close { width: 34px; height: 34px; border-radius: 50%; border: none; background: rgba(255,255,255,0.1); color: var(--text-muted); font-size: 16px; cursor: pointer; transition: all 0.3s; }
    .modal-close:hover { background: rgba(255,255,255,0.15); color: var(--text); }
    .modal-body { padding: 18px; }
    .modal-footer { padding: 18px; border-top: 1px solid var(--border); }

    .weekly-review-intro { font-size: 16px; font-weight: 600; color: var(--accent-teal); text-align: center; margin-bottom: 16px; }
    .weekly-review-section { margin-bottom: 14px; }
    .weekly-review-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 8px; }
    .weekly-review-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.06); font-size: 14px; font-weight: 500; }
    .weekly-review-row:last-child { border-bottom: none; }
    .weekly-review-input-wrap { display: flex; align-items: center; gap: 6px; }
    .weekly-review-unit { font-size: 11px; color: var(--text-muted); min-width: 65px; }
    .weekly-review-input-wrap .goal-input { width: 70px; }
    body.day-mode .weekly-review-row { border-bottom-color: rgba(0,0,0,0.06); }

    /* Bedtime Routine Section */
    .bedtime-routine {
      background: linear-gradient(135deg, rgba(196,113,237,0.15), rgba(109,213,237,0.1));
      border: 1px solid rgba(196,113,237,0.3);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 16px;
      display: none;
    }
    .bedtime-routine.show { display: block; }
    .bedtime-routine.done-state {
      background: linear-gradient(135deg, rgba(109,213,237,0.1), rgba(196,113,237,0.05));
      padding: 12px 16px;
    }
    .bedtime-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .bedtime-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .bedtime-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-teal));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      box-shadow: 0 0 15px var(--glow-purple);
    }
    .bedtime-label {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 16px;
      font-weight: 700;
    }
    .bedtime-sublabel {
      font-size: 11px;
      color: var(--text-muted);
    }
    .bedtime-done-btn {
      padding: 6px 14px;
      background: rgba(255,255,255,0.1);
      border: 1px solid var(--border);
      border-radius: var(--radius-pill);
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .bedtime-done-btn:hover {
      background: rgba(255,255,255,0.15);
      color: var(--text);
    }
    .bedtime-items {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .bedtime-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s;
    }
    .bedtime-item:hover {
      background: rgba(255,255,255,0.08);
    }
    .bedtime-item.checked {
      background: rgba(109,213,237,0.1);
      border-color: var(--accent-teal);
    }
    .bedtime-item.checked .bedtime-item-text {
      text-decoration: line-through;
      color: var(--text-muted);
    }
    .bedtime-checkbox {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .bedtime-item.checked .bedtime-checkbox {
      background: linear-gradient(135deg, var(--accent-teal), var(--accent-purple));
      border-color: var(--accent-teal);
      color: white;
      font-size: 12px;
    }
    .bedtime-item-text {
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }
    .bedtime-done-message {
      text-align: center;
      font-size: 14px;
      color: var(--accent-teal);
      font-weight: 600;
    }
    body.day-mode .bedtime-routine {
      background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(13,148,136,0.08));
      border-color: rgba(99,102,241,0.2);
    }
    body.day-mode .bedtime-item {
      background: rgba(255,255,255,0.5);
    }
    body.day-mode .bedtime-item.checked {
      background: rgba(13,148,136,0.15);
      border-color: var(--accent-teal);
    }

    /* Bedtime Celebration Animation */
    .bedtime-celebration {
      position: fixed;
      inset: 0;
      background: rgba(26,26,46,0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s;
      backdrop-filter: blur(15px);
    }
    .bedtime-celebration.show {
      opacity: 1;
      pointer-events: auto;
    }
    .celebration-content {
      text-align: center;
      animation: celebrationPop 0.6s cubic-bezier(0.34,1.56,0.64,1);
    }
    @keyframes celebrationPop {
      0% { transform: scale(0.3) rotate(-10deg); opacity: 0; }
      50% { transform: scale(1.1) rotate(3deg); }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    .celebration-emoji {
      font-size: 80px;
      animation: celebrationBounce 0.8s ease-in-out infinite;
    }
    @keyframes celebrationBounce {
      0%, 100% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-20px) scale(1.1); }
    }
    .celebration-stars {
      position: absolute;
      inset: 0;
      overflow: hidden;
      pointer-events: none;
    }
    .celebration-star {
      position: absolute;
      font-size: 24px;
      animation: starFloat 2s ease-out forwards;
    }
    @keyframes starFloat {
      0% { transform: translateY(100vh) scale(0); opacity: 1; }
      100% { transform: translateY(-100px) scale(1); opacity: 0; }
    }
    .celebration-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 28px;
      font-weight: 700;
      margin-top: 20px;
      background: linear-gradient(90deg, var(--accent-purple), var(--accent-teal), var(--accent-pink));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmer 2s ease-in-out infinite;
    }
    @keyframes shimmer {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.3); }
    }
    .celebration-subtitle {
      font-size: 16px;
      color: var(--text-dim);
      margin-top: 10px;
      opacity: 0;
      animation: fadeInUp 0.5s ease-out 0.3s forwards;
    }
    @keyframes fadeInUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .celebration-dismiss {
      margin-top: 30px;
      padding: 14px 36px;
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-teal));
      border: none;
      border-radius: var(--radius-pill);
      font-size: 16px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      box-shadow: 0 8px 30px var(--glow-purple);
      opacity: 0;
      animation: fadeInUp 0.5s ease-out 0.5s forwards;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .celebration-dismiss:hover {
      transform: scale(1.05);
      box-shadow: 0 12px 40px var(--glow-purple);
    }

    /* Responsive */
    @media (max-width: 430px) {
      body { padding: 12px; padding-top: max(66px, calc(12px + env(safe-area-inset-top, 54px))); padding-bottom: calc(120px + env(safe-area-inset-bottom, 0px)); }
      .quick-grid { gap: 10px; }
      .card { padding: 14px; }
      .card-value { font-size: 28px; }
      .big-input { font-size: 28px; }
    }

    /* Tablet */
    @media (min-width: 768px) {
      body { max-width: 720px; margin: 0 auto; }
      .quick-grid { grid-template-columns: repeat(2, 1fr); }
    }

    /* Desktop */
    @media (min-width: 1024px) {
      body { max-width: 960px; margin: 0 auto; padding: 24px; padding-top: 80px; }

      /* Two-column layout for sections */
      #healthForm {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        align-items: start;
      }

      /* Quick grid spans full width */
      .quick-grid {
        grid-column: 1 / -1;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
      }

      /* REHIT card spans full width */
      .rehit-full {
        grid-column: 1 / -1;
      }

      /* Header spans full width */
      .header {
        grid-column: 1 / -1;
      }

      /* Larger cards */
      .card { padding: 20px; }
      .section { padding: 20px; }

      /* Better text sizes */
      .card-title { font-size: 16px; }
      .sec-name { font-size: 16px; }

      /* Expand all sections on desktop */
      .sec-content.collapsed {
        max-height: none !important;
        opacity: 1 !important;
        overflow: visible !important;
      }
      .sec-head.collapsed .sec-toggle {
        transform: rotate(0deg);
      }
    }

    /* Large Desktop */
    @media (min-width: 1400px) {
      body { max-width: 1200px; }

      .quick-grid {
        grid-template-columns: repeat(4, 1fr);
      }

      #healthForm {
        grid-template-columns: 1fr 1fr 1fr;
      }
    }
    
    /* Settings Page Styles */
    .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }
    .setting-row:last-child { border-bottom: none; }
    .setting-label { flex: 1; }
    .setting-title { display: block; font-size: 14px; font-weight: 600; color: var(--text); }
    .setting-desc { display: block; font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    
    .time-input {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 8px 12px;
      color: var(--text);
      font-size: 14px;
      font-family: 'Space Grotesk', sans-serif;
      outline: none;
    }
    .time-input:focus { border-color: var(--accent-teal); }
    
    .goal-input {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 8px 12px;
      color: var(--text);
      font-size: 14px;
      font-family: 'Space Grotesk', sans-serif;
      outline: none;
      width: 80px;
      text-align: center;
    }
    .goal-input:focus { border-color: var(--accent-teal); }
    body.day-mode .goal-input {
      background: rgba(255,255,255,0.8);
      color: #1f2937;
    }

    /* Goal Settings Rows */
    .goal-setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }
    .goal-setting-row:last-child { border-bottom: none; }
    .goal-setting-info {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
    }
    .goal-setting-icon {
      font-size: 18px;
      width: 28px;
      text-align: center;
    }
    .goal-setting-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
    }
    .goal-setting-controls {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .goal-setting-controls .goal-input {
      width: 65px;
    }
    .goal-unit {
      font-size: 11px;
      color: var(--text-muted);
      min-width: 50px;
    }
    .goal-freq {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: 12px;
      padding: 6px 8px;
      min-width: 70px;
    }
    .goal-freq:focus { border-color: var(--accent-teal); }
    body.day-mode .goal-freq {
      background: rgba(255,255,255,0.8);
      color: #1f2937;
    }

    /* Habit Notes */
    .habit-notes-input-row {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 16px;
    }
    .habit-note-input {
      width: 100%;
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 14px;
      resize: none;
      min-height: 70px;
      font-family: inherit;
    }
    .habit-note-input:focus {
      outline: none;
      border-color: var(--accent-orange);
      box-shadow: 0 0 10px var(--glow-orange);
    }
    .habit-note-input::placeholder {
      color: var(--text-muted);
    }
    .habit-note-add-btn {
      align-self: flex-end;
      padding: 10px 20px;
    }
    .habit-notes-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .habit-note-item {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      position: relative;
    }
    .habit-note-item:hover {
      border-color: rgba(255,255,255,0.2);
    }
    .habit-note-text {
      font-size: 14px;
      line-height: 1.5;
      color: var(--text);
      margin-bottom: 8px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .habit-note-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .habit-note-time {
      font-size: 11px;
      color: var(--text-muted);
    }
    .habit-note-delete {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px 8px;
      font-size: 12px;
      border-radius: var(--radius-sm);
      transition: all 0.2s;
    }
    .habit-note-delete:hover {
      background: rgba(255,107,157,0.2);
      color: #ff6b9d;
    }
    .habit-notes-empty {
      text-align: center;
      color: var(--text-muted);
      font-size: 13px;
      padding: 20px;
      font-style: italic;
    }
    body.day-mode .habit-note-input {
      background: rgba(255,255,255,0.8);
      color: #1f2937;
    }
    body.day-mode .habit-note-item {
      background: rgba(255,255,255,0.6);
    }

    .theme-preview { display: flex; gap: 8px; }
    .theme-btn {
      width: 40px; height: 40px;
      border-radius: 50%;
      border: 2px solid var(--border);
      background: var(--bg-card);
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .theme-btn:hover { border-color: var(--accent-teal); transform: scale(1.1); }
    .theme-btn.active { border-color: var(--accent-teal); box-shadow: 0 0 15px var(--glow-teal); }
    
    /* Section List for Drag & Drop */
    .section-list { }
    .section-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
      cursor: grab;
      transition: all 0.2s;
    }
    .section-item:active { cursor: grabbing; }
    .section-item.dragging {
      opacity: 0.5;
      transform: scale(1.02);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    .section-item.drag-over {
      border-color: var(--accent-teal);
      background: var(--success-soft);
    }
    .section-item-drag {
      color: var(--text-muted);
      font-size: 16px;
      cursor: grab;
    }
    .section-item-icon { font-size: 18px; }
    .section-item-name { flex: 1; font-size: 14px; font-weight: 500; }
    .section-item-toggle {
      position: relative;
      width: 44px;
      height: 24px;
      background: var(--bg-deep);
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .section-item-toggle.on { background: var(--success); }
    .section-item-toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
    }
    .section-item-toggle.on::after { transform: translateX(20px); }
    .section-item-delete {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 16px;
      cursor: pointer;
      padding: 4px;
      opacity: 0.5;
      transition: all 0.2s;
    }
    .section-item-delete:hover { color: var(--accent-pink); opacity: 1; }
  </style>
</head>
<body>
  <!-- Loading Overlay - starts hidden, shown by JS when loading -->
  <div class="loading-overlay hidden" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">Loading...</div>
  </div>
  
  <!-- Debug Error Display -->
  <div id="debugError" style="display:none; position:fixed; bottom:120px; left:16px; right:16px; background:rgba(255,0,0,0.9); color:white; padding:12px; border-radius:8px; font-size:12px; z-index:9999; max-height:200px; overflow:auto;"></div>
  
  <script>
    window.onerror = function(msg, url, line, col, error) {
      const el = document.getElementById('debugError');
      if (el) {
        el.style.display = 'block';
        el.innerHTML += '<b>Error:</b> ' + msg + '<br><small>at line ' + line + '</small><br>';
      }
      return false;
    };
    window.addEventListener('unhandledrejection', function(e) {
      const el = document.getElementById('debugError');
      if (el) {
        el.style.display = 'block';
        el.innerHTML += '<b>Promise Error:</b> ' + (e.reason?.message || e.reason) + '<br>';
      }
    });
  </script>
  
  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <span class="toast-icon"></span>
    <span class="toast-text">Saved</span>
  </div>
  
  <!-- Pull to Refresh Indicator -->
  <div class="pull-indicator" id="pullIndicator">
    <div class="pull-spinner"></div>
    <span>Refreshing...</span>
  </div>

  <div class="theme-indicator" id="themeIndicator"> Day Mode</div>
  
  <svg width="0" height="0" style="position:absolute">
    <defs>
      <linearGradient id="auroraGrad" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" style="stop-color:#c471ed"/>
        <stop offset="50%" style="stop-color:#ff6b9d"/>
        <stop offset="100%" style="stop-color:#6dd5ed"/>
      </linearGradient>
    </defs>
  </svg>

  <div id="stickyDateBar" class="sticky">
    <div class="sticky-date" id="stickyDateDisplay">Today</div>
    <div class="sticky-btns"><button id="stickyPrevBtn"></button><button id="stickyNextBtn"></button></div>
  </div>

  <div id="milestoneOverlay" class="milestone">
    <div class="milestone-box">
      <div class="milestone-emoji" id="milestoneEmoji"></div>
      <div class="milestone-title" id="milestoneTitle">Amazing!</div>
      <div class="milestone-sub" id="milestoneSubtitle">You did something great!</div>
      <button class="milestone-btn" onclick="closeMilestone()">Continue</button>
    </div>
  </div>

  <!-- Weekly Goals Review Modal (Sunday) -->
  <div id="weeklyReviewModal" class="modal">
    <div class="modal-content" style="max-width:380px">
      <div class="modal-header">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent-teal),var(--accent-purple));display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 0 15px var(--glow-teal)"></div>
          <div>
            <div style="font-family:'Space Grotesk', sans-serif;font-size:18px;font-weight:700">Weekly Goals</div>
            <div style="font-size:12px;color:var(--text-muted)">Set your intentions for the week</div>
          </div>
        </div>
        <button class="modal-close" onclick="closeWeeklyReview()"></button>
      </div>
      <div class="modal-body">
        <div class="weekly-review-intro">This week I will...</div>
        <div class="weekly-review-section">
          <div class="weekly-review-label">Daily Goals</div>
          <div class="weekly-review-row"><span> Sleep</span><div class="weekly-review-input-wrap"><input type="number" class="goal-input" id="wr-sleep" value="7" min="4" max="12" step="0.5"><span class="weekly-review-unit">hrs/night</span></div></div>
          <div class="weekly-review-row"><span> Water</span><div class="weekly-review-input-wrap"><input type="number" class="goal-input" id="wr-agua" value="6" min="1" max="20"><span class="weekly-review-unit">glasses/day</span></div></div>
          <div class="weekly-review-row"><span> Steps</span><div class="weekly-review-input-wrap"><input type="number" class="goal-input" id="wr-steps" value="7500" min="1000" max="50000" step="500"><span class="weekly-review-unit">steps/day</span></div></div>
          <div class="weekly-review-row"><span> Movement</span><div class="weekly-review-input-wrap"><input type="number" class="goal-input" id="wr-movement" value="2" min="1" max="10"><span class="weekly-review-unit">breaks/day</span></div></div>
        </div>
        <div class="weekly-review-section">
          <div class="weekly-review-label">Weekly Goals</div>
          <div class="weekly-review-row"><span> REHIT</span><div class="weekly-review-input-wrap"><input type="number" class="goal-input" id="wr-rehit" value="4" min="1" max="7"><span class="weekly-review-unit">sessions</span></div></div>
          <div class="weekly-review-row"><span> Reading</span><div class="weekly-review-input-wrap"><input type="number" class="goal-input" id="wr-reading" value="60" min="5" max="500" step="5"><span class="weekly-review-unit">min</span></div></div>
          <div class="weekly-review-row"><span> Meditation</span><div class="weekly-review-input-wrap"><input type="number" class="goal-input" id="wr-meditation" value="60" min="5" max="500" step="5"><span class="weekly-review-unit">min</span></div></div>
        </div>
      </div>
      <div class="modal-footer" style="display:flex;gap:10px">
        <button class="btn btn-secondary" onclick="closeWeeklyReview()" style="flex:1">Keep Current</button>
        <button class="btn btn-primary" onclick="saveWeeklyReview()" style="flex:2">Lock In My Goals</button>
      </div>
    </div>
  </div>

  <header class="header">
    <div class="header-top">
      <div class="brand">
        <div>
<h1>Habits <span class="version">v7.9</span></h1>
          <div class="tagline">Phase 1</div>
          <div class="phase-day" id="phaseDayCount">Day -- of 21</div>
        </div>
      </div>
      <div class="nav-links">
        <a href="#" id="homeBtn" class="nav-link" title="Home"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M3 12L12 4L21 12" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 10V19C5 19.5523 5.44772 20 6 20H9V15C9 14.4477 9.44772 14 10 14H14C14.5523 14 15 14.4477 15 15V20H18C18.5523 20 19 19.5523 19 19V10" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg></a>
        <a href="#" id="weeklySummaryLink" class="nav-link" title="Summary"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"><circle cx="8" cy="9" r="1" fill="currentColor"/><path d="M10.5 9H17.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><circle cx="8" cy="12" r="1" fill="currentColor"/><path d="M10.5 12H16" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><circle cx="8" cy="15" r="1" fill="currentColor"/><path d="M10.5 15H17.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg></a>
        <a href="#" id="chartsBtn" class="nav-link" title="Charts"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M6.5 17.5V7.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M6.5 17.5H17.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M8.5 14.5L11.2 11.8L13.6 13.4L17.3 9.7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/><circle cx="8.5" cy="14.5" r="0.9" fill="currentColor"/><circle cx="11.2" cy="11.8" r="0.9" fill="currentColor"/><circle cx="13.6" cy="13.4" r="0.9" fill="currentColor"/><circle cx="17.3" cy="9.7" r="0.9" fill="currentColor"/></svg></a>
        <a href="#" id="biomarkersBtn" class="nav-link" title="Biomarkers"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M9 7H17" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M10 7V15.2C10 16.9 11.3 18.2 13 18.2C14.7 18.2 16 16.9 16 15.2V7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/><path d="M10.8 13.2H15.2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg></a>
        <a href="#" id="settingsBtn" class="nav-link" title="Settings"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="2.4" stroke="currentColor" stroke-width="1.8"/><path d="M12 6.8V8.6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M12 15.4V17.2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M6.8 12H8.6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M15.4 12H17.2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M8.4 8.4L9.7 9.7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M14.3 14.3L15.6 15.6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M15.6 8.4L14.3 9.7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M9.7 14.3L8.4 15.6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg></a>
      </div>
    </div>
    <div class="date-nav">
      <button class="date-btn" id="prevBtn"></button>
      <div class="date-center">
        <div class="date-main" id="dateDisplay"></div>
      </div>
      <button class="date-btn" id="nextBtn"></button>
      <div class="ring-wrap">
        <svg class="ring" width="72" height="72" viewBox="0 0 72 72">
          <circle class="ring-bg" cx="36" cy="36" r="32"/>
          <circle class="ring-progress" id="completionProgress" cx="36" cy="36" r="32" stroke-dasharray="201" stroke-dashoffset="201"/>
        </svg>
        <div class="ring-text" id="completionNumber">0</div>
      </div>
      <div class="phase" style="grid-column: 1 / -1;">
        <div class="phase-track"><div class="phase-fill" id="phaseProgressBar" style="width:0%"></div></div>
      </div>
    </div>
  </header>

  <!-- Ring Completion Celebration Container -->
  <div id="ringCelebration" class="ring-celebration"></div>

  <!-- Bedtime Routine Section -->
  <div id="bedtimeRoutine" class="bedtime-routine">
    <div class="bedtime-header">
      <div class="bedtime-title">
        <div class="bedtime-icon"></div>
        <div>
          <div class="bedtime-label">Bedtime Routine</div>
          <div class="bedtime-sublabel">Wind down for a great tomorrow</div>
        </div>
      </div>
      <button type="button" class="bedtime-done-btn" onclick="dismissBedtimeRoutine()">Done</button>
    </div>
    <div class="bedtime-items" id="bedtimeItems">
      <!-- Items populated by JS -->
    </div>
  </div>

  <!-- Bedtime Celebration Overlay -->
  <div id="bedtimeCelebration" class="bedtime-celebration">
    <div class="celebration-stars" id="celebrationStars"></div>
    <div class="celebration-content">
      <div class="celebration-emoji"></div>
      <div class="celebration-title">Goodnight!</div>
      <div class="celebration-subtitle">Have a great workout in the morning!</div>
      <button type="button" class="celebration-dismiss" onclick="dismissCelebration()">Sweet Dreams</button>
    </div>
  </div>

  <!-- Cue Detection Modal -->
  <div id="cueModal" class="cue-modal">
    <div class="cue-modal-content">
      <div class="cue-modal-header">
        <div class="cue-emoji"></div>
        <h3>Cue Detected!</h3>
        <p>What triggered this awareness?</p>
      </div>
      <div class="cue-timestamp" id="cueTimestamp"></div>
      <textarea class="cue-note-input" id="cueNoteInput" placeholder="What cue did you notice? (e.g., feeling stressed, saw a snack, phone notification...)"></textarea>
      <div class="cue-modal-buttons">
        <button type="button" class="cue-cancel-btn" onclick="closeCueModal()">Cancel</button>
        <button type="button" class="cue-save-btn" onclick="saveCueAndCelebrate()">Log It! </button>
      </div>
    </div>
  </div>

  <!-- Cue Celebration Full Screen -->
  <div id="cueCelebration" class="cue-celebration">
    <div class="cue-celebration-particles" id="cueCelebrationParticles"></div>
    <div class="cue-celebration-content">
      <div class="cue-celebration-emoji" id="cueCelebrationEmoji"></div>
      <div class="cue-celebration-title" id="cueCelebrationTitle">Amazing Awareness!</div>
      <div class="cue-celebration-subtitle" id="cueCelebrationSubtitle">You just took the first step to building a better habit.</div>
      <button type="button" class="cue-celebration-dismiss" onclick="dismissCueCelebration()">Keep Going! </button>
    </div>
  </div>

  <form id="healthForm">
    <div class="unlock-banner" id="unlockBanner">
      <span> This day is locked to prevent accidental edits</span>
      <button type="button" class="unlock-day-btn" onclick="unlockDay()">Unlock</button>
    </div>

    <!-- Cue Detected Button -->
    <button type="button" class="cue-detected-btn" onclick="openCueModal()">
      <span class="cue-icon"></span>
      <span>Cue Detected</span>
    </button>
    <div class="quick-grid">
      <div class="card sleep" id="sleepSection">
        <div class="card-head"><div class="card-icon"></div><div class="card-title">Sleep</div></div>
        <div class="input-row"><input type="number" inputmode="decimal" class="big-input" id="sleepHours" step="0.1" placeholder="0"><span class="card-unit">hrs</span></div>
        <div class="card-avg">7-day avg: <span id="avgSleep">--</span></div>
      </div>
      <script>
        window.handleAguaPlus = function() {
          var el = document.getElementById('aguaCount');
          if (!el) return;
          var n = (parseInt(el.textContent) || 0) + 1;
          el.textContent = n;
          if (typeof aguaCount !== 'undefined') aguaCount = n;
          if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
          if (typeof checkWaterGoal === 'function') checkWaterGoal();
        };
        window.handleAguaMinus = function() {
          var el = document.getElementById('aguaCount');
          if (!el) return;
          var n = Math.max(0, (parseInt(el.textContent) || 0) - 1);
          el.textContent = n;
          if (typeof aguaCount !== 'undefined') aguaCount = n;
          if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
        };
      </script>
      <div class="card water" id="waterSection">
        <div class="card-head"><div class="card-icon"></div><div class="card-title">Water</div></div>
        <div class="water-row">
          <button type="button" class="water-btn" onclick="window.handleAguaMinus()"></button>
          <div class="water-num" id="aguaCount">0</div>
          <button type="button" class="water-btn" onclick="window.handleAguaPlus()">+</button>
        </div>
        <div class="progress-bar-h">
          <div class="progress-bar-h-fill" id="aguaBarFill"></div>
        </div>
      </div>
      <div class="card supplements">
        <div class="card-head"><div class="card-icon"></div><div class="card-title">Supps</div></div>
        <div class="mini-supps-grid">
          <div class="mini-supp" title="Creatine"><input type="checkbox" id="creatine"><span>Creatine</span></div>
          <div class="mini-supp" title="Vitamin D"><input type="checkbox" id="vitaminD"><span>Vit D</span></div>
          <div class="mini-supp" title="NO2"><input type="checkbox" id="no2"><span>NO2</span></div>
          <div class="mini-supp" title="Psyllium"><input type="checkbox" id="psyllium"><span>Psyllium</span></div>
        </div>
      </div>
      <div class="card movement">
        <div class="card-head"><div class="card-icon"></div><div class="card-title">Steps</div></div>
        <div class="input-row"><input type="number" inputmode="numeric" class="big-input" id="steps" placeholder="0"><span class="card-unit">steps</span></div>
        <div class="progress-bar-h">
          <div class="progress-bar-h-fill" id="stepsBarFill"></div>
        </div>
        <div class="card-avg">7-day avg: <span id="avgSteps">--</span></div>
      </div>
    </div>
    
    <div class="card movement rehit-full" id="rehitCard">
      <div class="card-head" style="margin-bottom:0">
        <div class="card-icon"></div>
        <div class="card-title">REHIT</div>
      </div>
      <div class="rehit-dots-row" id="rehitDots">
        <div class="rehit-dot"></div>
        <div class="rehit-dot"></div>
        <div class="rehit-dot"></div>
        <div class="rehit-dot"></div>
      </div>
      <div class="rehit-layout">
        <div class="rehit-left">
          <div class="chips rehit-chips">
            <div class="chip rehit-chip" id="rehit2Chip"><input type="checkbox" id="rehit2"><div class="chip-dot"></div><span class="chip-text">210</span></div>
            <div class="chip rehit-chip" id="rehit3Chip"><input type="checkbox" id="rehit3"><div class="chip-dot"></div><span class="chip-text">310</span></div>
          </div>
          <div class="card-avg rehit-week-count" style="display:none">This week: <span id="rehitWeek">--</span></div>
        </div>
        <div class="rehit-right">
          <div class="rehit-stats-grid">
            <div class="rehit-stat">
              <span class="rehit-stat-label">Score</span>
              <input type="number" id="fitnessScore" class="rehit-stat-input" inputmode="decimal" step="0.1" placeholder="--" style="color:var(--accent-teal)">
            </div>
            <div class="rehit-stat">
              <span class="rehit-stat-label">Cals</span>
              <input type="number" id="calories" class="rehit-stat-input" inputmode="numeric" placeholder="--" style="color:var(--accent-orange)">
            </div>
            <div class="rehit-stat">
              <span class="rehit-stat-label">Watts</span>
              <input type="number" id="peakWatts" class="rehit-stat-input" inputmode="numeric" placeholder="--" style="color:var(--accent-pink)">
            </div>
            <div class="rehit-stat">
              <span class="rehit-stat-label">W-Sec</span>
              <input type="number" id="wattSeconds" class="rehit-stat-input" inputmode="numeric" placeholder="--" style="color:var(--accent-purple)">
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="section" id="greysHabitsSection">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:#ffa552;--icon-end:#ffd93d;--icon-glow:var(--glow-orange)"></div><span class="sec-name">Grey's Habits</span></div><span class="sec-toggle"></span></div>
      <div class="sec-content">
        <div class="mini-supps-grid three-col">
          <div class="mini-supp" title="Inhaler Morning"><input type="checkbox" id="inhalerMorning"><span>Inhaler AM</span></div>
          <div class="mini-supp" title="Inhaler Evening"><input type="checkbox" id="inhalerEvening"><span>Inhaler PM</span></div>
          <div class="mini-supp" title="Math"><input type="checkbox" id="multiplication"><span>Math</span></div>
        </div>
      </div>
    </div>

    <div class="section" id="mealsSection">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:#ffa552;--icon-end:#ff6b9d;--icon-glow:var(--glow-orange)"></div><span class="sec-name">Meals</span></div><span class="sec-toggle"></span></div>
      <div class="sec-content">
        <div class="mini-supps-grid three-col" style="margin-bottom:10px">
          <div class="mini-supp"><input type="checkbox" id="breakfast"><span>Breakfast</span></div>
          <div class="mini-supp"><input type="checkbox" id="lunch"><span>Lunch</span></div>
          <div class="mini-supp"><input type="checkbox" id="dinner"><span>Dinner</span></div>
        </div>
        <div class="mini-supps-grid three-col">
          <div class="mini-supp"><input type="checkbox" id="daySnacks"><span>Day Snacks</span></div>
          <div class="mini-supp"><input type="checkbox" id="nightSnacks"><span>Night Snacks</span></div>
          <div class="mini-supp"><input type="checkbox" id="noAlcohol"><span>No Alcohol</span></div>
        </div>
      </div>
    </div>

    <div class="section" id="movementSection">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:#ff6b9d;--icon-end:#c471ed;--icon-glow:var(--glow-pink)"></div><span class="sec-name">Movement Breaks</span></div><span class="sec-toggle"></span></div>
      <div class="sec-content">
        <div class="movement-row">
          <span class="movement-row-label">Morning</span>
          <select id="morningMovementType">
            <option value="">--</option>
            <option value="Walk"> Walk</option>
            <option value="Carol Bike"> Carol Bike</option>
            <option value="Other"> Other</option>
          </select>
          <input type="number" id="morningMovementDuration" placeholder="--" min="1" max="120" inputmode="numeric">
          <span class="min-label">min</span>
        </div>
        <div class="movement-row">
          <span class="movement-row-label">Afternoon</span>
          <select id="afternoonMovementType">
            <option value="">--</option>
            <option value="Walk"> Walk</option>
            <option value="Carol Bike"> Carol Bike</option>
            <option value="Other"> Other</option>
          </select>
          <input type="number" id="afternoonMovementDuration" placeholder="--" min="1" max="120" inputmode="numeric">
          <span class="min-label">min</span>
        </div>
        <div class="card-avg" style="margin-top:10px">Daily avg: <span id="avgMovements">--</span></div>
      </div>
    </div>

    <div class="section" id="mentalHabitsSection">
      <div class="sec-head collapsed"><div class="sec-title"><div class="sec-icon" style="--icon-start:#c471ed;--icon-end:#6dd5ed;--icon-glow:var(--glow-purple)"></div><span class="sec-name">Reading</span></div><span class="sec-toggle"></span></div>
      <div class="sec-content collapsed">
        <div id="readingList" class="items"></div>
        <button type="button" class="btn btn-secondary" id="addReadingBtn">+ Add Reading</button>
      </div>
    </div>

    <div class="section" id="meditationSection">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:#ffd93d;--icon-end:#ffa552;--icon-glow:var(--glow-orange)"></div><span class="sec-name">Mindfulness</span></div><span class="sec-toggle"></span></div>
      <div class="sec-content">
        <div class="mini-supps-grid" style="grid-template-columns: 1fr;">
          <div class="mini-supp"><input type="checkbox" id="meditation"><span>Meditated</span></div>
        </div>
      </div>
    </div>

    <div class="section" id="reflectionsSection">
      <div class="sec-head collapsed"><div class="sec-title"><div class="sec-icon" style="--icon-start:#c471ed;--icon-end:#ff6b9d;--icon-glow:var(--glow-purple)"></div><span class="sec-name">Reflections</span></div><span class="sec-toggle"></span></div>
      <div class="sec-content collapsed"><textarea class="input" id="reflections" placeholder="What's on your mind?"></textarea></div>
    </div>

    <div class="section" id="storiesSection">
      <div class="sec-head collapsed"><div class="sec-title"><div class="sec-icon" style="--icon-start:#ff6b9d;--icon-end:#ffa552;--icon-glow:var(--glow-pink)"></div><span class="sec-name">Grey & Sloane</span></div><span class="sec-toggle"></span></div>
      <div class="sec-content collapsed"><textarea class="input" id="stories" placeholder="Capture their moments..."></textarea></div>
    </div>

    <div class="section" id="carlySection">
      <div class="sec-head collapsed"><div class="sec-title"><div class="sec-icon" style="--icon-start:#ffd93d;--icon-end:#ff6b9d;--icon-glow:var(--glow-orange)"></div><span class="sec-name">Carly</span></div><span class="sec-toggle"></span></div>
      <div class="sec-content collapsed"><textarea class="input" id="carly" placeholder="Notes..."></textarea></div>
    </div>

    <div class="section" id="bodyDataSection">
      <div class="sec-head collapsed"><div class="sec-title"><div class="sec-icon" style="--icon-start:#6dd5ed;--icon-end:#c471ed;--icon-glow:var(--glow-teal)"></div><span class="sec-name">Body</span></div><span class="sec-toggle"></span></div>
      <div class="sec-content collapsed">
        <div class="body-grid">
          <div class="body-cell"><div class="body-label">Weight</div><input type="number" inputmode="decimal" class="body-input" id="weight" step="0.1"></div>
          <div class="body-cell"><div class="body-label">Waist</div><input type="number" inputmode="decimal" class="body-input" id="waist" step="0.1"></div>
          <div class="body-cell"><div class="body-label">Lean Mass</div><input type="number" inputmode="decimal" class="body-input" id="leanMass" step="0.1"></div>
          <div class="body-cell"><div class="body-label">Lean %</div><div class="body-pct" id="leanMassPercent">--</div></div>
          <div class="body-cell"><div class="body-label">Body Fat</div><input type="number" inputmode="decimal" class="body-input" id="bodyFat" step="0.1"></div>
          <div class="body-cell"><div class="body-label">Fat %</div><div class="body-pct" id="bodyFatPercent">--</div></div>
          <div class="body-cell"><div class="body-label">Bone Mass</div><input type="number" inputmode="decimal" class="body-input" id="boneMass" step="0.1"></div>
          <div class="body-cell"><div class="body-label">Bone %</div><div class="body-pct" id="boneMassPercent">--</div></div>
          <div class="body-cell"><div class="body-label">Water (lbs)</div><input type="number" inputmode="decimal" class="body-input" id="bodywater" step="0.1"></div>
          <div class="body-cell"><div class="body-label">Water %</div><div class="body-pct" id="bodywaterPercent">--</div></div>
        </div>
      </div>
    </div>

    <div class="section" id="bloodPressureSection">
      <div class="sec-head collapsed"><div class="sec-title"><div class="sec-icon" style="--icon-start:#ff6b9d;--icon-end:#c471ed;--icon-glow:var(--glow-pink)"></div><span class="sec-name">Blood Pressure</span></div><span class="sec-toggle"></span></div>
      <div class="sec-content collapsed">
        <div class="body-grid">
          <div class="body-cell"><div class="body-label">Systolic</div><input type="number" inputmode="numeric" class="body-input" id="systolic"></div>
          <div class="body-cell"><div class="body-label">Diastolic</div><input type="number" inputmode="numeric" class="body-input" id="diastolic"></div>
          <div class="body-cell"><div class="body-label">Heart Rate</div><input type="number" inputmode="numeric" class="body-input" id="heartRate"></div>
          <div class="body-cell"><div class="body-label">Status</div><div class="body-pct" id="bpStatus">--</div></div>
        </div>
      </div>
    </div>
  </form>

  <div id="chartsPage" style="display:none">
    <header class="header">
      <div class="header-top">
        <div class="brand"><div class="logo"></div><div><h1>Charts</h1></div></div>
        <button type="button" id="chartsCloseBtn" class="nav-link"></button>
      </div>
      <div style="display:flex;gap:8px;margin-top:16px">
        <button type="button" class="range-btn btn btn-secondary active" data-range="7">7 Days</button>
        <button type="button" class="range-btn btn btn-secondary" data-range="30">30 Days</button>
        <button type="button" class="range-btn btn btn-secondary" data-range="all">All</button>
      </div>
    </header>
    <div class="section"><div class="sec-name">Weight and Waist</div><canvas id="weightChart" style="max-height:220px"></canvas></div>
    <div class="section"><div class="sec-name">Sleep</div><canvas id="sleepChart" style="max-height:220px"></canvas></div>
    <div class="section"><div class="sec-name">Steps</div><canvas id="stepsChart" style="max-height:220px"></canvas></div>
    <div class="section"><div class="sec-name">REHIT Calendar</div><div id="rehitCalendar" class="rehit-calendar"></div></div>
    <div class="section"><div class="sec-name">Peak Watts</div><canvas id="peakWattsChart" style="max-height:220px"></canvas></div>
    <div class="section"><div class="sec-name">Lean Mass %</div><canvas id="bodyCompChart" style="max-height:220px"></canvas></div>
    <div class="section"><div class="sec-name">Blood Pressure and Pulse</div><canvas id="bpChart" style="max-height:220px"></canvas></div>
  </div>

  <div id="biomarkersPage" style="display:none">
    <header class="header">
      <div class="header-top">
        <div class="brand"><div class="logo"></div><div><h1>Biomarkers</h1><div class="tagline" id="biomarkersSubtitle">Most recent: --</div></div></div>
        <button type="button" id="biomarkersCloseBtn" class="nav-link"></button>
      </div>
    </header>
    <div class="section">
      <div class="field"><label class="field-label">Lab Date</label><input type="text" class="input" id="biomarkersDate" placeholder="M/D/YY"></div>
    </div>
    <div id="biomarkersTable"></div>
    <div class="section" style="margin-top:4px">
      <button type="button" class="btn btn-primary" id="biomarkersSubmitBtn" style="width:100%">Submit</button>
      <button type="button" class="btn" id="biomarkersExportBtn" style="width:100%;margin-top:8px;background:var(--bg-card);border:1px solid var(--border-color)">Export Latest Results (CSV)</button>
      <div id="biomarkersSaveStatus" style="text-align:center;margin-top:8px;color:var(--accent-teal)"></div>
    </div>
  </div>

  <!-- Biomarker History Chart Modal -->
  <div id="bioHistoryModal" class="modal">
    <div class="modal-content" style="max-width:400px">
      <div class="modal-header">
        <div>
          <div id="bioHistoryTitle" style="font-family:'Space Grotesk', sans-serif;font-size:16px;font-weight:700">Biomarker</div>
          <div id="bioHistoryRange" style="font-size:12px;color:var(--text-muted)">Normal: --</div>
        </div>
        <button class="modal-close" onclick="closeBioHistory()"></button>
      </div>
      <div class="modal-body" style="padding:14px">
        <canvas id="bioHistoryChart" style="max-height:200px"></canvas>
        <div id="bioHistoryTable" style="margin-top:12px"></div>
      </div>
    </div>
  </div>

  <div id="weeklySummaryPage" style="display:none">
    <header class="header">
      <div class="header-top">
        <div class="brand"><div class="logo"></div><div><h1>Phase Summary</h1></div></div>
        <button type="button" id="summaryCloseBtn" class="nav-link"></button>
      </div>
      <div class="summary-controls">
        <select id="phaseSelector" class="phase-selector">
          <!-- Populated by JS -->
        </select>
        <button type="button" class="summary-range-btn btn btn-secondary active" data-range="phase">Current Phase</button>
        <button type="button" class="summary-range-btn btn btn-secondary" data-range="all">All Time</button>
        <button type="button" id="comparePhaseBtn" class="btn btn-secondary" style="margin-left:auto"> Compare</button>
      </div>
    </header>

    <!-- Phase Comparison Section (hidden by default) -->
    <div id="phaseComparisonSection" class="section" style="display:none">
      <div class="comparison-header">
        <div class="sec-name">Phase Comparison</div>
        <button type="button" id="closeComparisonBtn" class="comparison-close">&times;</button>
      </div>
      <div class="comparison-selectors">
        <select id="comparePhase1" class="phase-selector"></select>
        <span class="comparison-vs">vs</span>
        <select id="comparePhase2" class="phase-selector"></select>
      </div>
      <div id="phaseComparisonContent"></div>
    </div>

    <!-- Overview Stats -->
    <div class="section">
      <div class="summary-overview" id="summaryOverview">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Phase Goals (shows targets for selected phase) -->
    <div id="phaseGoalsSection" class="section">
      <div class="sec-head" style="cursor:pointer" onclick="togglePhaseGoals()">
        <div class="sec-name"> Phase Goals</div>
        <span class="sec-toggle" id="phaseGoalsToggle"></span>
      </div>
      <div id="phaseGoalsContent" class="phase-goals-content">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- REHIT Calendar -->
    <div class="section">
      <div class="sec-name" style="margin-bottom:12px">REHIT Sessions</div>
      <div id="summaryRehitCalendar" class="rehit-calendar"></div>
    </div>
    
    <!-- Goal Performance -->
    <div class="section">
      <div class="sec-name" style="margin-bottom:12px"> Doing Great</div>
      <div id="goalsDoingWell"></div>
    </div>
    
    <div class="section">
      <div class="sec-name" style="margin-bottom:12px"> Needs Work</div>
      <div id="goalsNeedWork"></div>
    </div>
    
    <!-- Goal Categories -->
    <div class="section">
      <div class="sec-name" style="margin-bottom:12px">Health Goals</div>
      <div id="healthGoalsStats" class="goal-stats-grid"></div>
    </div>
    
    <div class="section">
      <div class="sec-name" style="margin-bottom:12px">Nutrition</div>
      <div id="nutritionStats" class="goal-stats-grid"></div>
    </div>
    
    <div class="section">
      <div class="sec-name" style="margin-bottom:12px">Mindfulness</div>
      <div id="mindfulnessStats" class="goal-stats-grid"></div>
    </div>
    
    <div class="section">
      <div class="sec-name" style="margin-bottom:12px">Kid's Habits</div>
      <div id="kidsHabitsStats" class="goal-stats-grid"></div>
    </div>
    
    <div class="section">
      <div class="sec-name" style="margin-bottom:12px">Writing</div>
      <div id="writingStats" class="goal-stats-grid"></div>
    </div>
  </div>

  <!-- Settings Page -->
  <div id="settingsPage" style="display:none">
    <header class="header">
      <div class="header-top">
        <div class="brand"><div class="logo"></div><div><h1>Settings</h1><div class="tagline">Customize your experience</div></div></div>
        <button type="button" id="settingsCloseBtn" class="nav-link"></button>
      </div>
    </header>

    <!-- Phase Management -->
    <div class="section">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:var(--accent-purple);--icon-end:var(--accent-pink);--icon-glow:var(--glow-purple)"></div><span class="sec-name">Phase Management</span></div></div>
      <div class="sec-content">
        <div id="phaseManagementInfo" style="margin-bottom:12px">
          <!-- Populated by JS -->
        </div>
        <button type="button" class="btn btn-primary" id="planNextPhaseBtn" style="width:100%">Plan Next Phase</button>
      </div>
    </div>

    <!-- Goals Settings -->
    <div class="section">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:var(--accent-teal);--icon-end:var(--accent-pink);--icon-glow:var(--glow-teal)"></div><span class="sec-name">Goal Settings</span></div></div>
      <div class="sec-content">
        <p style="color:var(--text-muted);font-size:12px;margin:0 0 16px 0">Set your target for each goal and choose daily or weekly frequency.</p>

        <div class="goal-setting-row">
          <div class="goal-setting-info">
            <span class="goal-setting-icon"></span>
            <span class="goal-setting-name">Sleep</span>
          </div>
          <div class="goal-setting-controls">
            <input type="number" class="goal-input" id="sleepGoal" value="7" min="4" max="12">
            <span class="goal-unit">hrs</span>
            <select class="goal-freq" id="sleepFreq">
              <option value="daily" selected>Daily</option>
              <option value="weekly">Weekly</option>
            </select>
          </div>
        </div>

        <div class="goal-setting-row">
          <div class="goal-setting-info">
            <span class="goal-setting-icon"></span>
            <span class="goal-setting-name">Water</span>
          </div>
          <div class="goal-setting-controls">
            <input type="number" class="goal-input" id="aguaGoal" value="6" min="1" max="20">
            <span class="goal-unit">glasses</span>
            <select class="goal-freq" id="aguaFreq">
              <option value="daily" selected>Daily</option>
              <option value="weekly">Weekly</option>
            </select>
          </div>
        </div>

        <div class="goal-setting-row">
          <div class="goal-setting-info">
            <span class="goal-setting-icon"></span>
            <span class="goal-setting-name">Steps</span>
          </div>
          <div class="goal-setting-controls">
            <input type="number" class="goal-input" id="stepsGoal" value="5000" min="1000" max="50000" step="500">
            <span class="goal-unit">steps</span>
            <select class="goal-freq" id="stepsFreq">
              <option value="daily" selected>Daily</option>
              <option value="weekly">Weekly</option>
            </select>
          </div>
        </div>

        <div class="goal-setting-row">
          <div class="goal-setting-info">
            <span class="goal-setting-icon"></span>
            <span class="goal-setting-name">Movement</span>
          </div>
          <div class="goal-setting-controls">
            <input type="number" class="goal-input" id="movementGoal" value="2" min="1" max="10">
            <span class="goal-unit">sessions</span>
            <select class="goal-freq" id="movementFreq">
              <option value="daily" selected>Daily</option>
              <option value="weekly">Weekly</option>
            </select>
          </div>
        </div>

        <div class="goal-setting-row">
          <div class="goal-setting-info">
            <span class="goal-setting-icon"></span>
            <span class="goal-setting-name">Meals</span>
          </div>
          <div class="goal-setting-controls">
            <input type="number" class="goal-input" id="mealsGoal" value="2" min="1" max="3">
            <span class="goal-unit">meals</span>
            <select class="goal-freq" id="mealsFreq">
              <option value="daily" selected>Daily</option>
              <option value="weekly">Weekly</option>
            </select>
          </div>
        </div>

        <div class="goal-setting-row">
          <div class="goal-setting-info">
            <span class="goal-setting-icon"></span>
            <span class="goal-setting-name">Healthy Snacks</span>
          </div>
          <div class="goal-setting-controls">
            <input type="number" class="goal-input" id="snacksGoal" value="2" min="1" max="2">
            <span class="goal-unit">checks</span>
            <select class="goal-freq" id="snacksFreq">
              <option value="daily" selected>Daily</option>
              <option value="weekly">Weekly</option>
            </select>
          </div>
        </div>

        <div class="goal-setting-row">
          <div class="goal-setting-info">
            <span class="goal-setting-icon"></span>
            <span class="goal-setting-name">No Alcohol</span>
          </div>
          <div class="goal-setting-controls">
            <input type="number" class="goal-input" id="noAlcoholGoal" value="1" min="1" max="1" disabled style="opacity:0.5">
            <span class="goal-unit">check</span>
            <select class="goal-freq" id="noAlcoholFreq">
              <option value="daily" selected>Daily</option>
              <option value="weekly">Weekly</option>
            </select>
          </div>
        </div>

        <div class="goal-setting-row">
          <div class="goal-setting-info">
            <span class="goal-setting-icon"></span>
            <span class="goal-setting-name">REHIT 2x10</span>
          </div>
          <div class="goal-setting-controls">
            <input type="number" class="goal-input" id="rehit2x10Goal" value="2" min="0" max="7">
            <span class="goal-unit">sessions</span>
            <select class="goal-freq" id="rehit2x10Freq">
              <option value="daily">Daily</option>
              <option value="weekly" selected>Weekly</option>
            </select>
          </div>
        </div>

        <div class="goal-setting-row">
          <div class="goal-setting-info">
            <span class="goal-setting-icon"></span>
            <span class="goal-setting-name">REHIT 3x10</span>
          </div>
          <div class="goal-setting-controls">
            <input type="number" class="goal-input" id="rehit3x10Goal" value="3" min="0" max="7">
            <span class="goal-unit">sessions</span>
            <select class="goal-freq" id="rehit3x10Freq">
              <option value="daily">Daily</option>
              <option value="weekly" selected>Weekly</option>
            </select>
          </div>
        </div>

        <div class="goal-setting-row">
          <div class="goal-setting-info">
            <span class="goal-setting-icon"></span>
            <span class="goal-setting-name">Reading</span>
          </div>
          <div class="goal-setting-controls">
            <input type="number" class="goal-input" id="readingGoal" value="60" min="5" max="500" step="5">
            <span class="goal-unit">min</span>
            <select class="goal-freq" id="readingFreq">
              <option value="daily">Daily</option>
              <option value="weekly" selected>Weekly</option>
            </select>
          </div>
        </div>

        <div class="goal-setting-row">
          <div class="goal-setting-info">
            <span class="goal-setting-icon"></span>
            <span class="goal-setting-name">Meditation</span>
          </div>
          <div class="goal-setting-controls">
            <input type="number" class="goal-input" id="meditationGoal" value="3" min="1" max="7">
            <span class="goal-unit">sessions</span>
            <select class="goal-freq" id="meditationFreq">
              <option value="daily">Daily</option>
              <option value="weekly" selected>Weekly</option>
            </select>
          </div>
        </div>

      </div>
    </div>

    <div class="section">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:var(--accent-teal);--icon-end:var(--accent-purple);--icon-glow:var(--glow-teal)"></div><span class="sec-name">About Goals</span></div></div>
      <div class="sec-content">
        <p style="color:var(--text-muted);font-size:13px;margin:0;line-height:1.5">
          These are your default goals. When you create a new Phase, these values are used as starting points.
          Each Phase can have its own targets that you set during the Phase planning process.
          <br><br>
          <strong>Supplements</strong> (all 4 daily) is tracked separately as a fixed goal.
        </p>
      </div>
    </div>

    <!-- Habit Notes -->
    <div class="section">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:var(--accent-yellow);--icon-end:var(--accent-orange);--icon-glow:var(--glow-orange)"></div><span class="sec-name">Habit Notes</span></div></div>
      <div class="sec-content">
        <p style="color:var(--text-muted);font-size:12px;margin:0 0 12px 0">Quick notes about your habits, triggers, or insights.</p>
        <div class="habit-notes-input-row">
          <textarea class="habit-note-input" id="newHabitNote" placeholder="Write a note about your habits..."></textarea>
          <button type="button" class="btn btn-primary habit-note-add-btn" id="addHabitNoteBtn">Add Note</button>
        </div>
        <div id="habitNotesList" class="habit-notes-list">
          <!-- Notes populated by JS -->
        </div>
      </div>
    </div>

    <!-- Theme Settings -->
    <div class="section">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:var(--accent-orange);--icon-end:var(--accent-yellow);--icon-glow:var(--glow-orange)"></div><span class="sec-name">Theme Schedule</span></div></div>
      <div class="sec-content">
        <div class="setting-row">
          <div class="setting-label">
            <span class="setting-title"> Day Mode Starts</span>
            <span class="setting-desc">When to switch to bright theme</span>
          </div>
          <input type="time" class="time-input" id="dayStartTime" value="06:00">
        </div>
        <div class="setting-row">
          <div class="setting-label">
            <span class="setting-title"> Night Mode Starts</span>
            <span class="setting-desc">When to switch to dark theme</span>
          </div>
          <input type="time" class="time-input" id="nightStartTime" value="18:00">
        </div>
        <div class="setting-row">
          <div class="setting-label">
            <span class="setting-title">Current Theme</span>
            <span class="setting-desc" id="currentThemeDisplay">Auto</span>
          </div>
          <div class="theme-preview">
            <button type="button" class="theme-btn" data-theme="day" title="Day"></button>
            <button type="button" class="theme-btn" data-theme="night" title="Night"></button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bedtime Routine Settings -->
    <div class="section">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:var(--accent-purple);--icon-end:var(--accent-teal);--icon-glow:var(--glow-purple)"></div><span class="sec-name">Bedtime Habit Stack</span></div></div>
      <div class="sec-content">
        <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px">Shows weekdays 9:45pm-midnight. Drag to reorder.</p>
        <div id="bedtimeItemsList" class="section-list">
          <!-- Populated by JS -->
        </div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <input type="text" class="input" id="newBedtimeItem" placeholder="New item name..." style="flex:1">
          <button type="button" class="btn btn-primary" id="addBedtimeItemBtn" style="padding:8px 16px">Add</button>
        </div>
      </div>
    </div>

    <!-- Section Management -->
    <div class="section">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:var(--accent-purple);--icon-end:var(--accent-pink);--icon-glow:var(--glow-purple)"></div><span class="sec-name">Manage Sections</span></div></div>
      <div class="sec-content">
        <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px">Drag to reorder  Toggle to show/hide</p>
        <div id="sectionList" class="section-list">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>
    
    <!-- Add Custom Section -->
    <div class="section">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:var(--accent-teal);--icon-end:var(--accent-purple);--icon-glow:var(--glow-teal)"></div><span class="sec-name">Add Custom Section</span></div></div>
      <div class="sec-content">
        <div class="field">
          <label class="field-label">Section Name</label>
          <input type="text" class="input" id="newSectionName" placeholder="e.g., Gratitude, Goals, etc.">
        </div>
        <div class="field">
          <label class="field-label">Section Type</label>
          <select class="input" id="newSectionType">
            <option value="text">Text/Notes</option>
            <option value="checkbox">Checkboxes (multiple)</option>
            <option value="number">Number Input</option>
            <option value="counter">Counter (+/- with goal)</option>
            <option value="log">Log (list of entries)</option>
            <option value="time">Time Input</option>
            <option value="rating">Rating (1-5 stars)</option>
            <option value="toggle">Yes/No Toggle</option>
          </select>
        </div>
        <div class="field">
          <label class="field-label">Icon (emoji)</label>
          <input type="text" class="input" id="newSectionIcon" placeholder="" maxlength="2" style="width:80px">
        </div>
        
        <!-- Dynamic options based on type -->
        <div id="checkboxOptions" class="type-options" style="display:none">
          <div class="field">
            <label class="field-label">Checkbox Names (comma-separated)</label>
            <input type="text" class="input" id="checkboxNames" placeholder="Morning, Afternoon, Evening">
          </div>
        </div>
        
        <div id="counterOptions" class="type-options" style="display:none">
          <div class="field">
            <label class="field-label">Goal Type</label>
            <select class="input" id="counterGoalType">
              <option value="daily">Daily (progress bar)</option>
              <option value="weekly">Weekly (dots)</option>
            </select>
          </div>
          <div class="field">
            <label class="field-label">Goal Number</label>
            <input type="number" class="input" id="counterGoalNumber" placeholder="6" min="1" max="20">
          </div>
          <div class="field">
            <label class="field-label">Unit Label</label>
            <input type="text" class="input" id="counterUnitLabel" placeholder="glasses, sessions, times">
          </div>
        </div>
        
        <div id="logOptions" class="type-options" style="display:none">
          <div class="field">
            <label class="field-label">Fields per Entry</label>
            <div id="logFieldsList">
              <div class="log-field-row" style="display:flex;gap:8px;margin-bottom:8px">
                <input type="text" class="input" placeholder="Field name" style="flex:2">
                <select class="input" style="flex:1">
                  <option value="text">Text</option>
                  <option value="number">Number</option>
                  <option value="select">Dropdown</option>
                </select>
                <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()" style="padding:8px"></button>
              </div>
            </div>
            <button type="button" class="btn btn-secondary" id="addLogFieldBtn" style="width:100%;margin-top:4px">+ Add Field</button>
          </div>
        </div>
        
        <div id="numberOptions" class="type-options" style="display:none">
          <div class="field">
            <label class="field-label">Unit (optional)</label>
            <input type="text" class="input" id="numberUnit" placeholder="lbs, mins, etc.">
          </div>
          <div class="field">
            <label class="field-label">Placeholder</label>
            <input type="text" class="input" id="numberPlaceholder" placeholder="0">
          </div>
        </div>
        
        <div id="ratingOptions" class="type-options" style="display:none">
          <div class="field">
            <label class="field-label">Rating Label</label>
            <input type="text" class="input" id="ratingLabel" placeholder="How was your day?">
          </div>
        </div>
        
        <button type="button" class="btn btn-primary" id="addSectionBtn" style="width:100%;margin-top:12px">Add Section</button>
      </div>
    </div>
    
    <!-- Data Management -->
    <div class="section">
      <div class="sec-head"><div class="sec-title"><div class="sec-icon" style="--icon-start:var(--accent-pink);--icon-end:var(--accent-orange);--icon-glow:var(--glow-pink)"></div><span class="sec-name">Data</span></div></div>
      <div class="sec-content">
        <button type="button" class="btn btn-secondary" id="exportSettingsBtn" style="width:100%;margin-bottom:8px">Export Settings</button>
        <button type="button" class="btn btn-secondary" id="importSettingsBtn" style="width:100%">Import Settings</button>
        <input type="file" id="importSettingsFile" accept=".json" style="display:none">
      </div>
    </div>
  </div>

  <!-- Reading Modal -->
  <div id="readingModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent-purple),var(--accent-teal));display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 0 15px var(--glow-purple)"></div>
          <div>
            <div style="font-family:'Space Grotesk', sans-serif;font-size:18px;font-weight:700">Add Reading</div>
            <div style="font-size:12px;color:var(--text-muted)">Book title and duration</div>
          </div>
        </div>
        <button class="modal-close" onclick="closeReadingModal()"></button>
      </div>
      <div class="modal-body">
        <div class="reading-field">
          <label class="reading-label" for="readingBookInput">Book Title</label>
          <input type="text" id="readingBookInput" class="reading-input" placeholder="Enter book title...">
        </div>
        <div class="reading-field">
          <label class="reading-label">Duration</label>
          <div class="duration-presets reading-duration-presets">
            <button type="button" class="duration-preset reading-duration-preset" data-mins="10">10</button>
            <button type="button" class="duration-preset reading-duration-preset" data-mins="15">15</button>
            <button type="button" class="duration-preset reading-duration-preset" data-mins="20">20</button>
            <button type="button" class="duration-preset reading-duration-preset" data-mins="30">30</button>
            <button type="button" class="duration-preset reading-duration-preset" data-mins="45">45</button>
          </div>
          <div class="duration-custom-row">
            <input type="number" id="readingCustomMins" placeholder="--" min="1" max="300" inputmode="numeric">
            <span>minutes</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="readingSaveBtn" disabled style="width:100%">Add Reading</button>
      </div>
    </div>
  </div>

  <!-- Trash Reminder Modal -->
  <div id="trashReminderModal" class="modal">
    <div class="modal-content" style="max-width:340px">
      <div class="modal-header">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent-orange),var(--accent-pink));display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 0 15px var(--glow-orange)"></div>
          <div>
            <div style="font-family:'Space Grotesk', sans-serif;font-size:18px;font-weight:700">Trash Night!</div>
            <div style="font-size:12px;color:var(--text-muted)">Tuesday reminder</div>
          </div>
        </div>
        <button class="modal-close" onclick="dismissTrashReminder()"></button>
      </div>
      <div class="modal-body" style="text-align:center;padding:24px">
        <div style="font-size:48px;margin-bottom:12px"></div>
        <div style="font-size:16px;font-weight:600;color:var(--text)">Take out the trash!</div>
        <div style="font-size:13px;color:var(--text-muted);margin-top:6px">Don't forget to put the bins out tonight</div>
      </div>
      <div class="modal-footer" style="padding:14px 18px">
        <button type="button" class="btn btn-primary" onclick="dismissTrashReminder()" style="width:100%;background:linear-gradient(135deg,var(--accent-orange),var(--accent-pink))">Got it!</button>
      </div>
    </div>
  </div>

  <button id="quickLogFab" class="fab">+</button>
  <div id="quickLogMenu" class="fab-menu">
    <button class="fab-item quick-log-item" data-action="movement"><div class="fab-icon" style="background:linear-gradient(135deg,var(--accent-pink),var(--accent-purple))"></div><span class="fab-label">Movement</span></button>
    <button class="fab-item quick-log-item" data-action="agua"><div class="fab-icon" style="background:linear-gradient(135deg,var(--accent-teal),var(--accent-purple))"></div><span class="fab-label">Water</span></button>
    <button class="fab-item quick-log-item" data-action="reading"><div class="fab-icon" style="background:linear-gradient(135deg,var(--accent-purple),var(--accent-pink))"></div><span class="fab-label">Reading</span></button>
    <button class="fab-item quick-log-item" data-action="rehit"><div class="fab-icon" style="background:linear-gradient(135deg,var(--accent-orange),var(--accent-pink))"></div><span class="fab-label">REHIT</span></button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
  <script src="app.js?v=6.19" defer></script>
  <script>
    // =============================================
    // TOAST NOTIFICATIONS
    // =============================================
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      if (!toast) return;
      
      const icon = toast.querySelector('.toast-icon');
      const text = toast.querySelector('.toast-text');
      
      text.textContent = message;
      icon.textContent = type === 'success' ? '' : type === 'error' ? '' : '';
      
      toast.className = 'toast ' + type;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 2000);
    }
    
    // Make it globally available
    window.showToast = showToast;
    
    // =============================================
    // LOADING OVERLAY
    // =============================================
    function showLoading() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) overlay.classList.remove('hidden');
    }
    
    function hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) overlay.classList.add('hidden');
    }
    
    window.showLoading = showLoading;
    window.hideLoading = hideLoading;
    
    // =============================================
    // PULL TO REFRESH
    // =============================================
    let pullStartY = 0;
    let isPulling = false;
    
    function setupPullToRefresh() {
      const indicator = document.getElementById('pullIndicator');
      if (!indicator) return;
      
      document.addEventListener('touchstart', (e) => {
        if (window.scrollY === 0) {
          pullStartY = e.touches[0].clientY;
          isPulling = true;
        }
      }, { passive: true });
      
      document.addEventListener('touchmove', (e) => {
        if (!isPulling) return;
        const pullDistance = e.touches[0].clientY - pullStartY;
        
        if (pullDistance > 60 && window.scrollY === 0) {
          indicator.classList.add('visible');
        }
      }, { passive: true });
      
      document.addEventListener('touchend', () => {
        if (!isPulling) return;
        isPulling = false;
        
        const indicator = document.getElementById('pullIndicator');
        if (indicator && indicator.classList.contains('visible')) {
          // Trigger refresh
          if (typeof loadDay === 'function') {
            loadDay(window.currentDate || new Date().toISOString().split('T')[0]);
          }
          
          setTimeout(() => {
            indicator.classList.remove('visible');
            showToast('Refreshed', 'success');
          }, 500);
        }
      });
    }
    
    // =============================================
    // SYNC FUNCTIONS
    // =============================================
    // Sync all chip visuals
    function syncAllChips() {
      document.querySelectorAll('.chip').forEach(c => {
        const cb = c.querySelector('input[type="checkbox"]');
        if (cb) c.classList.toggle('on', cb.checked);
      });
    }
    
    // Our own completion ring update (since app.js looks for .checkbox-field)
    function updateCompletionRingAurora() {
      // 9 daily goals: sleep, agua, steps, movement, meals, no alcohol,
      // day snacks, night snacks, supplements
      const total = 9;
      let checked = 0;

      // 1. Sleep  goal
      const sleepVal = parseFloat(document.getElementById('sleepHours')?.value) || 0;
      const sleepGoal = (typeof appSettings !== 'undefined' && appSettings.sleepGoal) ? appSettings.sleepGoal : 7;
      if (sleepVal >= sleepGoal) checked++;

      // 2. Agua  goal
      const aguaGoal = (typeof appSettings !== 'undefined' && appSettings.aguaGoal) ? appSettings.aguaGoal : 6;
      const aguaEl = document.getElementById('aguaCount');
      if ((aguaEl ? parseInt(aguaEl.textContent) || 0 : 0) >= aguaGoal) checked++;

      // 3. Steps  goal
      const stepsVal = parseInt(document.getElementById('steps')?.value) || 0;
      const stepsGoal = (typeof appSettings !== 'undefined' && appSettings.stepsGoal) ? appSettings.stepsGoal : 7500;
      if (stepsVal >= stepsGoal) checked++;

      // 4. Movement breaks  goal
      const movementGoal = (typeof appSettings !== 'undefined' && appSettings.movementGoal) ? appSettings.movementGoal : 2;
      // Count movements: morning and afternoon each count if type selected or duration entered
      let movementCount = 0;
      const morningType = document.getElementById('morningMovementType')?.value;
      const morningDuration = document.getElementById('morningMovementDuration')?.value;
      if (morningType || morningDuration) movementCount++;
      const afternoonType = document.getElementById('afternoonMovementType')?.value;
      const afternoonDuration = document.getElementById('afternoonMovementDuration')?.value;
      if (afternoonType || afternoonDuration) movementCount++;
      if (movementCount >= movementGoal) checked++;

      // 5. Meals: breakfast, lunch, dinner checked >= goal
      const mealsGoal = (typeof appSettings !== 'undefined' && appSettings.mealsGoal) ? appSettings.mealsGoal : 2;
      const mealsChecked = ['breakfast', 'lunch', 'dinner']
        .filter(id => document.getElementById(id)?.checked).length;
      if (mealsChecked >= mealsGoal) checked++;

      // 6. No alcohol
      if (document.getElementById('noAlcohol')?.checked) checked++;

      // 7. Healthy day snacks
      if (document.getElementById('daySnacks')?.checked) checked++;

      // 8. Healthy night snacks
      if (document.getElementById('nightSnacks')?.checked) checked++;

      // 9. Supplements: all 4 (creatine, vitD, NO2, psyllium)
      const suppsChecked = ['creatine', 'vitaminD', 'no2', 'psyllium']
        .filter(id => document.getElementById(id)?.checked).length;
      if (suppsChecked === 4) checked++;
      
      // Debug removed
      
      const progress = document.getElementById('completionProgress');
      const number = document.getElementById('completionNumber');
      
      if (progress && number) {
        const circumference = 2 * Math.PI * 32; // r=32 = ~201
        let offset;
        if (total === 0) {
          offset = circumference; // Empty ring
        } else {
          offset = circumference - (checked / total) * circumference;
        }
        progress.style.strokeDashoffset = offset;
        number.textContent = checked;

        // Trigger celebration when ring is complete!
        if (checked === total && total > 0 && !window._ringCelebratedToday) {
          window._ringCelebratedToday = true;
          triggerRingCelebration();
        }
      }
    }

    // Track if we've celebrated today (resets on date change)
    window._ringCelebratedToday = false;

    // Ring completion celebration with random animations
    function triggerRingCelebration() {
      const container = document.getElementById('ringCelebration');
      if (!container) return;

      // Haptic feedback
      if (navigator.vibrate) {
        navigator.vibrate([50, 30, 100, 30, 150]); // Celebratory pattern
      }

      // Glow burst on the ring
      const ringProgress = document.getElementById('completionProgress');
      const ringText = document.getElementById('completionNumber');
      if (ringProgress) {
        ringProgress.classList.add('ring-glow-burst');
        setTimeout(() => ringProgress.classList.remove('ring-glow-burst'), 800);
      }
      if (ringText) {
        ringText.classList.add('celebrating');
        setTimeout(() => ringText.classList.remove('celebrating'), 600);
      }

      // Pick random celebration type
      const celebrations = [
        createConfettiExplosion,
        createFireworks,
        createGoldenShower,
        createEmojiParty,
        createPulseWave
      ];
      const celebrate = celebrations[Math.floor(Math.random() * celebrations.length)];
      celebrate(container);

      // Clean up after animation
      setTimeout(() => {
        container.innerHTML = '';
      }, 3500);
    }

    function createConfettiExplosion(container) {
      const colors = ['#ff6b9d', '#c471ed', '#6dd5ed', '#ffd93d', '#6bcf63', '#ff9f43', '#ee5a5a'];
      const ringRect = document.querySelector('.ring-wrap')?.getBoundingClientRect();
      const centerX = ringRect ? ringRect.left + ringRect.width / 2 : window.innerWidth / 2;
      const centerY = ringRect ? ringRect.top + ringRect.height / 2 : 100;

      for (let i = 0; i < 60; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'particle confetti';
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.left = centerX + (Math.random() - 0.5) * 100 + 'px';
        confetti.style.top = centerY + 'px';
        confetti.style.animationDelay = Math.random() * 0.3 + 's';
        confetti.style.animationDuration = (2 + Math.random() * 1.5) + 's';
        if (Math.random() > 0.5) {
          confetti.style.borderRadius = '2px';
          confetti.style.width = '8px';
          confetti.style.height = '14px';
        }
        container.appendChild(confetti);
      }
    }

    function createFireworks(container) {
      const colors = ['#ff6b9d', '#c471ed', '#6dd5ed', '#ffd93d', '#fff'];
      const positions = [
        { x: window.innerWidth * 0.3, y: 120 },
        { x: window.innerWidth * 0.5, y: 80 },
        { x: window.innerWidth * 0.7, y: 140 }
      ];

      positions.forEach((pos, idx) => {
        setTimeout(() => {
          for (let i = 0; i < 30; i++) {
            const spark = document.createElement('div');
            spark.className = 'particle firework';
            spark.style.background = colors[Math.floor(Math.random() * colors.length)];
            spark.style.boxShadow = `0 0 6px ${spark.style.background}`;
            spark.style.left = pos.x + 'px';
            spark.style.top = pos.y + 'px';
            const angle = (i / 30) * Math.PI * 2;
            const distance = 80 + Math.random() * 60;
            spark.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
            spark.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
            container.appendChild(spark);
          }
          // Extra haptic for each burst
          if (navigator.vibrate) navigator.vibrate(30);
        }, idx * 200);
      });
    }

    function createGoldenShower(container) {
      for (let i = 0; i < 50; i++) {
        const sparkle = document.createElement('div');
        sparkle.className = 'particle sparkle';
        sparkle.style.left = Math.random() * window.innerWidth + 'px';
        sparkle.style.top = -10 + 'px';
        sparkle.style.animationDelay = Math.random() * 1 + 's';
        sparkle.style.animationDuration = (1.5 + Math.random() * 1) + 's';
        container.appendChild(sparkle);
      }
    }

    function createEmojiParty(container) {
      const emojis = ['', '', '', '', '', '', '', '', '', ''];
      const ringRect = document.querySelector('.ring-wrap')?.getBoundingClientRect();
      const centerX = ringRect ? ringRect.left + ringRect.width / 2 : window.innerWidth / 2;
      const centerY = ringRect ? ringRect.top + ringRect.height / 2 : 100;

      for (let i = 0; i < 15; i++) {
        const emoji = document.createElement('div');
        emoji.className = 'emoji-burst';
        emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
        emoji.style.position = 'absolute';
        emoji.style.left = centerX + 'px';
        emoji.style.top = centerY + 'px';
        const angle = (i / 15) * Math.PI * 2;
        const distance = 100 + Math.random() * 80;
        emoji.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
        emoji.style.setProperty('--ty', Math.sin(angle) * distance - 50 + 'px');
        emoji.style.animationDelay = Math.random() * 0.2 + 's';
        container.appendChild(emoji);
      }
    }

    function createPulseWave(container) {
      const colors = ['#6dd5ed', '#c471ed', '#ff6b9d', '#ffd93d'];
      const ringRect = document.querySelector('.ring-wrap')?.getBoundingClientRect();
      const centerX = ringRect ? ringRect.left + ringRect.width / 2 : window.innerWidth / 2;
      const centerY = ringRect ? ringRect.top + ringRect.height / 2 : 100;

      for (let i = 0; i < 4; i++) {
        setTimeout(() => {
          const pulse = document.createElement('div');
          pulse.className = 'ring-pulse';
          pulse.style.left = centerX + 'px';
          pulse.style.top = centerY + 'px';
          pulse.style.width = '60px';
          pulse.style.height = '60px';
          pulse.style.borderColor = colors[i];
          pulse.style.boxShadow = `0 0 20px ${colors[i]}`;
          container.appendChild(pulse);
          if (navigator.vibrate) navigator.vibrate(20);
        }, i * 150);
      }
    }

    // Reset celebration flag on date change
    window.addEventListener('dateChanged', () => {
      window._ringCelebratedToday = false;
    });

    // ===== CUE DETECTION SYSTEM =====
    let cueTimestamp = null;

    // Haptic feedback helper (works on Android, not iOS Safari)
    function triggerHaptic(pattern) {
      if ('vibrate' in navigator) {
        try {
          navigator.vibrate(pattern);
        } catch (e) {
          console.log('Haptic not supported');
        }
      }
    }

    window.openCueModal = function() {
      const modal = document.getElementById('cueModal');
      const timestampEl = document.getElementById('cueTimestamp');
      const noteInput = document.getElementById('cueNoteInput');

      cueTimestamp = new Date();
      const timeStr = cueTimestamp.toLocaleTimeString('en-US', {
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      });
      const dateStr = cueTimestamp.toLocaleDateString('en-US', {
        weekday: 'short',
        month: 'short',
        day: 'numeric'
      });

      timestampEl.textContent = ` ${dateStr} at ${timeStr}`;
      noteInput.value = '';
      modal.classList.add('show');

      // Focus the input after animation
      setTimeout(() => noteInput.focus(), 300);

      triggerHaptic(50);
    };

    window.closeCueModal = function() {
      document.getElementById('cueModal').classList.remove('show');
      cueTimestamp = null;
    };

    window.saveCueAndCelebrate = function() {
      const noteInput = document.getElementById('cueNoteInput');
      const note = noteInput.value.trim();

      if (!note) {
        noteInput.style.borderColor = '#ff6b9d';
        noteInput.placeholder = 'Please describe the cue you noticed...';
        triggerHaptic([50, 50, 50]);
        setTimeout(() => {
          noteInput.style.borderColor = '';
          noteInput.placeholder = 'What cue did you notice? (e.g., feeling stressed, saw a snack, phone notification...)';
        }, 2000);
        return;
      }

      // Save the cue log
      saveCueLog({
        timestamp: cueTimestamp.toISOString(),
        note: note,
        date: cueTimestamp.toLocaleDateString()
      });

      // Close modal
      closeCueModal();

      // Show celebration
      showCueCelebration();
    };

    async function saveCueLog(cueData) {
      // Get existing cue logs from localStorage
      let cueLogs = [];
      try {
        const stored = localStorage.getItem('cueLogs');
        if (stored) cueLogs = JSON.parse(stored);
      } catch (e) {}

      cueLogs.push(cueData);
      localStorage.setItem('cueLogs', JSON.stringify(cueLogs));

      // Save to KV storage
      try {
        await apiPost('cue_log_save', { cueData: cueData });
      } catch (e) {
        console.log('Cue log saved locally only');
      }
    }

    async function loadCueLogs() {
      try {
        const result = await apiGet('cue_logs_load');
        if (result && result.logs) {
          // Merge with local storage (KV is source of truth)
          localStorage.setItem('cueLogs', JSON.stringify(result.logs));
          return result.logs;
        }
      } catch (e) {
        console.log('Loading cue logs from localStorage');
      }
      // Fallback to localStorage
      try {
        const stored = localStorage.getItem('cueLogs');
        if (stored) return JSON.parse(stored);
      } catch (e) {}
      return [];
    }

    const cueCelebrations = [
      {
        emoji: '',
        title: 'Amazing Awareness!',
        subtitle: 'You just took the first step to building a better habit.'
      },
      {
        emoji: '',
        title: 'Great Job Detecting That Cue!',
        subtitle: 'Awareness is the foundation of all change.'
      },
      {
        emoji: '',
        title: 'Cue Spotted!',
        subtitle: 'Now you can choose how to respond. That\'s real power!'
      },
      {
        emoji: '',
        title: 'Brilliant Catch!',
        subtitle: 'Every cue you notice is a chance to create a new habit.'
      },
      {
        emoji: '',
        title: 'You\'re On Fire!',
        subtitle: 'Self-awareness is a superpower. Keep using it!'
      },
      {
        emoji: '',
        title: 'Lightning Reflexes!',
        subtitle: 'You caught that cue before it controlled you.'
      },
      {
        emoji: '',
        title: 'Champion Mindset!',
        subtitle: 'The best habit builders notice their triggers. You\'re one of them!'
      },
      {
        emoji: '',
        title: 'Star Performer!',
        subtitle: 'That awareness just rewired a tiny part of your brain. For real!'
      },
      {
        emoji: '',
        title: 'Mental Muscle Flexed!',
        subtitle: 'Each time you notice a cue, your self-control grows stronger.'
      },
      {
        emoji: '',
        title: 'Launching New Habits!',
        subtitle: 'You\'ve identified a trigger. Now you can build something amazing.'
      },
      {
        emoji: '',
        title: 'Mindfulness Master!',
        subtitle: 'Being present in the moment is a gift. You just gave it to yourself.'
      },
      {
        emoji: '',
        title: 'Celebration Time!',
        subtitle: 'You\'re breaking the autopilot cycle. That deserves applause!'
      }
    ];

    function showCueCelebration() {
      const celebration = document.getElementById('cueCelebration');
      const particles = document.getElementById('cueCelebrationParticles');
      const emojiEl = document.getElementById('cueCelebrationEmoji');
      const titleEl = document.getElementById('cueCelebrationTitle');
      const subtitleEl = document.getElementById('cueCelebrationSubtitle');

      // Pick random celebration
      const cel = cueCelebrations[Math.floor(Math.random() * cueCelebrations.length)];
      emojiEl.textContent = cel.emoji;
      titleEl.textContent = cel.title;
      subtitleEl.textContent = cel.subtitle;

      // Clear and create particles
      particles.innerHTML = '';
      createCueParticles(particles);

      // Show celebration
      celebration.classList.add('show');

      // Haptic celebration pattern
      triggerHaptic([100, 50, 100, 50, 200]);
    }

    function createCueParticles(container) {
      const colors = ['#ffd93d', '#ff6b9d', '#c471ed', '#6dd5ed', '#6bcf63'];
      const emojis = ['', '', '', '', '', '', '', ''];

      // Create sparkles
      for (let i = 0; i < 30; i++) {
        const sparkle = document.createElement('div');
        sparkle.className = 'particle sparkle';
        sparkle.style.left = Math.random() * 100 + '%';
        sparkle.style.top = Math.random() * 100 + '%';
        sparkle.style.background = colors[Math.floor(Math.random() * colors.length)];
        sparkle.style.animationDelay = Math.random() * 2 + 's';
        sparkle.style.animationDuration = (1.5 + Math.random() * 2) + 's';
        container.appendChild(sparkle);
      }

      // Create floating emojis
      for (let i = 0; i < 12; i++) {
        const emoji = document.createElement('div');
        emoji.className = 'emoji-burst';
        emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
        emoji.style.position = 'absolute';
        emoji.style.left = Math.random() * 100 + '%';
        emoji.style.top = Math.random() * 100 + '%';
        emoji.style.fontSize = (20 + Math.random() * 20) + 'px';
        emoji.style.setProperty('--tx', (Math.random() - 0.5) * 200 + 'px');
        emoji.style.setProperty('--ty', (Math.random() - 0.5) * 200 + 'px');
        emoji.style.animationDelay = Math.random() * 0.5 + 's';
        container.appendChild(emoji);
      }
    }

    window.dismissCueCelebration = function() {
      const celebration = document.getElementById('cueCelebration');
      celebration.classList.remove('show');
      document.getElementById('cueCelebrationParticles').innerHTML = '';
      triggerHaptic(30);
    };

    // Agua progress bar
    function updateAguaBar(){
      const aguaCount = document.getElementById('aguaCount');
      const fill = document.getElementById('aguaBarFill');
      if(!aguaCount || !fill) return;
      const count = parseInt(aguaCount.textContent) || 0;
      const goal = (typeof appSettings !== 'undefined' && appSettings.aguaGoal) ? appSettings.aguaGoal : 6;
      const pct = Math.min(100, (count / goal) * 100);
      fill.style.width = pct + '%';
    }
    
    // Steps progress bar
    function updateStepsBar(){
      const stepsInput = document.getElementById('steps');
      const fill = document.getElementById('stepsBarFill');
      if(!stepsInput || !fill) return;
      const steps = parseInt(stepsInput.value) || 0;
      const goal = (typeof appSettings !== 'undefined' && appSettings.stepsGoal) ? appSettings.stepsGoal : 7500;
      const pct = Math.min(100, (steps / goal) * 100);
      fill.style.width = pct + '%';
    }
    
    // REHIT dots - count sessions this week (goal: 4 sessions per week)
    const REHIT_API = "https://habit-proxy.joeywigs.workers.dev/";
    window._rehitServerCount = 0;  // Count from server
    window._rehitTodaySaved = false; // Whether today's REHIT was saved on server

    // Fetch REHIT count from dedicated endpoint
    async function fetchRehitWeekCount() {
      try {
        // Format date as M/D/YY for the API
        const d = window.currentDate || new Date();
        const date = `${d.getMonth() + 1}/${d.getDate()}/${String(d.getFullYear()).slice(-2)}`;
        const resp = await fetch(`${REHIT_API}?action=rehit_week&date=${encodeURIComponent(date)}`);
        const data = await resp.json();

        if (data.ok) {
          window._rehitServerCount = data.count;

          // Check if today's REHIT is already in the server count
          const todayStr = date;
          const todayDetail = data.details?.find(d => d.date === todayStr);
          window._rehitTodaySaved = todayDetail?.hasRehit || false;

          // Update display
          updateRehitDotsFromState();
        }
      } catch (err) {
        console.error('Failed to fetch REHIT week count:', err);
      }
    }

    // Calculate display count based on server + current checkbox state
    function updateRehitDotsFromState() {
      const dotsContainer = document.getElementById('rehitDots');
      if (!dotsContainer) return;
      const dots = dotsContainer.querySelectorAll('.rehit-dot');

      // Current checkbox state
      const todayChecked = document.getElementById('rehit2')?.checked || document.getElementById('rehit3')?.checked;

      // Start with server count
      let count = window._rehitServerCount || 0;

      // Adjust for unsaved changes:
      // If today is checked but wasn't saved, add 1
      // If today was saved but now unchecked, subtract 1
      if (todayChecked && !window._rehitTodaySaved) {
        count++;
      } else if (!todayChecked && window._rehitTodaySaved) {
        count--;
      }

      // Update dots (max 4)
      dots.forEach((dot, i) => {
        dot.classList.toggle('on', i < Math.min(count, 4));
      });
    }

    // Called when checkbox changes - update display immediately (optimistic)
    function updateRehitDots() {
      updateRehitDotsFromState();
    }

    // Expose globally
    window.updateRehitDots = updateRehitDots;
    window.fetchRehitWeekCount = fetchRehitWeekCount;
    
    // Hook populateForm - wait for app.js to define it first
    function setupPopulateFormHook() {
      if (typeof window.populateForm === 'function' && !window._populateFormHooked) {
        const originalPopulateForm = window.populateForm;
        window.populateForm = async function(data) {
          // Await the original so loadDataForCurrentDate properly waits
          await originalPopulateForm.call(this, data);

          // Sync our UI after the form is fully populated
          syncAllChips();
          updateAguaBar();
          updateRehitDisplay();
          updateStepsBar();
          updateCompletionRingAurora();
          updateRehitDots();
        };
        window._populateFormHooked = true;
      } else if (!window._populateFormHooked) {
        // Try again in 100ms if app.js hasn't loaded yet
        setTimeout(setupPopulateFormHook, 100);
      }
    }
    
    // =============================================
    // MAIN DOM READY SETUP
    // =============================================
    document.addEventListener('DOMContentLoaded', () => {
      // Setup populateForm hook (must happen before app.js calls loadDataForCurrentDate)
      setupPopulateFormHook();
      
      // Wire up chip toggles
      document.querySelectorAll('.chip').forEach(c => {
        c.addEventListener('click', e => {
          if(e.target.type === 'checkbox') return;
          const cb = c.querySelector('input[type="checkbox"]');
          if(cb) {
            cb.checked = !cb.checked;
            cb.dispatchEvent(new Event('change', {bubbles: true}));
          }
        });
        const cb = c.querySelector('input[type="checkbox"]');
        if(cb) {
          cb.addEventListener('change', () => {
            c.classList.toggle('on', cb.checked);
            updateCompletionRingAurora();
            if(typeof triggerSaveSoon === 'function') triggerSaveSoon();
          });
        }
      });
      
      // Wire up mini supplements
      document.querySelectorAll('.mini-supp').forEach(supp => {
        supp.addEventListener('click', () => {
          const cb = supp.querySelector('input[type="checkbox"]');
          if (cb) {
            cb.checked = !cb.checked;
            cb.dispatchEvent(new Event('change', { bubbles: true }));
            updateCompletionRingAurora();
            if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
          }
        });
      });
      
      // Section collapse toggles
      document.querySelectorAll('.sec-head').forEach(h => {
        h.addEventListener('click', () => {
          h.classList.toggle('collapsed');
          const c = h.nextElementSibling;
          if(c && c.classList.contains('sec-content')) c.classList.toggle('collapsed');
        });
      });
      
      // Agua count observer
      const aguaCount = document.getElementById('aguaCount');
      if (aguaCount) {
        const observer = new MutationObserver(() => { updateAguaBar(); updateCompletionRingAurora(); });
        observer.observe(aguaCount, { childList: true, characterData: true, subtree: true });
      }
      
      // Steps input listener
      const stepsInput = document.getElementById('steps');
      if (stepsInput) {
        stepsInput.addEventListener('input', () => { updateStepsBar(); updateCompletionRingAurora(); });
        stepsInput.addEventListener('change', () => { updateStepsBar(); updateCompletionRingAurora(); });
      }

      // Sleep input listener (for completion ring)
      const sleepInput = document.getElementById('sleepHours');
      if (sleepInput) {
        sleepInput.addEventListener('input', updateCompletionRingAurora);
        sleepInput.addEventListener('change', updateCompletionRingAurora);
      }

      // Movement inputs listener (for completion ring)
      ['morningMovementType', 'morningMovementDuration', 'afternoonMovementType', 'afternoonMovementDuration'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('change', updateCompletionRingAurora);
          el.addEventListener('input', updateCompletionRingAurora);
        }
      });
      
      // REHIT week observer
      const rehitWeek = document.getElementById('rehitWeek');
      if (rehitWeek) {
        const rehitObserver = new MutationObserver(updateRehitDots);
        rehitObserver.observe(rehitWeek, { childList: true, characterData: true, subtree: true });
      }
      
      // REHIT checkbox change listeners (chip clicktoggle is handled by generic chip handler at line 2752)
      const rehit2 = document.getElementById('rehit2');
      const rehit3 = document.getElementById('rehit3');
      if (rehit2) rehit2.addEventListener('change', () => { syncAllChips(); updateRehitDots(); updateRehitDisplay(); });
      if (rehit3) rehit3.addEventListener('change', () => { syncAllChips(); updateRehitDots(); updateRehitDisplay(); });
      
      // Initial update after app.js loads data
      setTimeout(() => {
        syncAllChips();
        updateAguaBar();
        updateStepsBar();
        fetchRehitWeekCount(); // Fetch from new endpoint
        updateRehitDisplay();
        updateCompletionRingAurora();
        updatePhaseInfoFixed();
      }, 1500);
      
      // Debug removed
    });
    
    // =============================================
    // MOVEMENT INLINE INPUTS
    // =============================================
    // Wire up morning/afternoon movement inputs to trigger save
    ['morningMovementType', 'morningMovementDuration', 'afternoonMovementType', 'afternoonMovementDuration'].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('change', () => {
          if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
        });
      }
    });


    // =============================================
    // READING MODAL
    // =============================================
    let selectedReadingDuration = null;

    window.openReadingModal = function() {
      selectedReadingDuration = null;

      // Autopopulate book title from last entry
      const bookInput = document.getElementById('readingBookInput');
      if (typeof lastBookTitle !== 'undefined' && lastBookTitle) {
        bookInput.value = lastBookTitle;
      } else {
        bookInput.value = '';
      }

      // Reset duration UI
      document.querySelectorAll('.reading-duration-preset').forEach(b => b.classList.remove('selected'));
      document.getElementById('readingCustomMins').value = '';
      document.getElementById('readingSaveBtn').disabled = true;
      updateReadingSaveBtn();

      document.getElementById('readingModal').classList.add('show');
    };

    window.closeReadingModal = function() {
      document.getElementById('readingModal').classList.remove('show');
    };

    function updateReadingSaveBtn() {
      const btn = document.getElementById('readingSaveBtn');
      const bookInput = document.getElementById('readingBookInput');
      btn.disabled = !selectedReadingDuration || !bookInput.value.trim();
    }

    // Wire up reading duration presets
    document.querySelectorAll('.reading-duration-preset').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.reading-duration-preset').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedReadingDuration = parseInt(btn.dataset.mins, 10);
        document.getElementById('readingCustomMins').value = '';
        updateReadingSaveBtn();
      });
    });

    // Wire up custom reading duration input
    document.getElementById('readingCustomMins')?.addEventListener('input', (e) => {
      const val = parseInt(e.target.value, 10);
      if (val > 0) {
        document.querySelectorAll('.reading-duration-preset').forEach(b => b.classList.remove('selected'));
        selectedReadingDuration = val;
      } else {
        selectedReadingDuration = null;
      }
      updateReadingSaveBtn();
    });

    // Wire up book title input
    document.getElementById('readingBookInput')?.addEventListener('input', updateReadingSaveBtn);

    // Wire up save button
    document.getElementById('readingSaveBtn')?.addEventListener('click', () => {
      const bookInput = document.getElementById('readingBookInput');
      const bookTitle = bookInput.value.trim();
      if (!selectedReadingDuration || !bookTitle) return;

      if (typeof readings !== 'undefined') {
        readings.push({ duration: selectedReadingDuration, book: bookTitle, time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true, timeZone: 'America/Chicago' }) });
        lastBookTitle = bookTitle;
        localStorage.setItem('lastBookTitle', bookTitle);
        if (typeof renderReadings === 'function') renderReadings();
        if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
      }

      closeReadingModal();
    });

    // Close reading modal when clicking backdrop
    document.getElementById('readingModal')?.addEventListener('click',(e)=>{if(e.target.id==='readingModal')closeReadingModal()});

    // Override promptAddReading to use our modal
    window.promptAddReading = openReadingModal;

    // Also override quickLogReading for the FAB
    window.quickLogReading = async function() {
      openReadingModal();
    };

    // Also try immediately in case app.js loaded first
    setupPopulateFormHook();
    
    // Hook agua display updates
    function setupAguaHook() {
      if (typeof window.updateAguaDisplay === 'function' && !window._aguaHooked) {
        const origAgua = window.updateAguaDisplay;
        window.updateAguaDisplay = function() {
          origAgua.call(this);
          updateAguaBar();
          updateCompletionRingAurora();
        };
        window._aguaHooked = true;
      } else if (!window._aguaHooked) {
        setTimeout(setupAguaHook, 100);
      }
    }
    setupAguaHook();
    
    // Fixed phase info that always uses today's date
    function updatePhaseInfoFixed() {
      const PHASE_START = new Date("2026-01-19T00:00:00");
      const PHASE_LENGTH = 21;
      const today = new Date();
      today.setHours(0,0,0,0);
      
      const diffTime = today - PHASE_START;
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays < 0) {
        // Before phase start
        const phaseDayEl = document.getElementById("phaseDayCount");
        if (phaseDayEl) phaseDayEl.textContent = "Starting soon";
        return;
      }
      
      const phase = Math.floor(diffDays / PHASE_LENGTH) + 1;
      const dayInPhase = (diffDays % PHASE_LENGTH) + 1;
      const daysRemaining = PHASE_LENGTH - dayInPhase + 1;
      
      // Update the day counter under Phase title
      const phaseDayEl = document.getElementById("phaseDayCount");
      if (phaseDayEl) phaseDayEl.textContent = `Day ${dayInPhase} of ${PHASE_LENGTH}`;
      
      // Update tagline to show current phase number
      const subtitleEl = document.querySelector(".tagline");
      if (subtitleEl) subtitleEl.textContent = `Phase ${phase}`;
      
      // Update progress bar
      const progressBar = document.getElementById("phaseProgressBar");
      if (progressBar) {
        const progress = ((dayInPhase - 1) / PHASE_LENGTH) * 100;
        progressBar.style.width = `${progress}%`;
      }
    }
    
    // Override app.js phase functions to use our fixed version
    // Run immediately and also on window load
    window.updatePhaseInfo = updatePhaseInfoFixed;
    window.loadPhaseProgress = updatePhaseInfoFixed;
    
    window.addEventListener('load', () => {
      // Ensure overrides are in place
      window.updatePhaseInfo = updatePhaseInfoFixed;
      window.loadPhaseProgress = updatePhaseInfoFixed;
      // Run it once
      updatePhaseInfoFixed();
    });
    
    // Also run phase update periodically to override any app.js changes
    setInterval(updatePhaseInfoFixed, 3000);
    
    // Periodically sync chips and update completion ring
    setInterval(() => {
      syncAllChips();
      updateCompletionRingAurora();
    }, 2000);
    
    // REHIT inline inputs - wire up autosave
    function updateRehitDisplay() {
      // No longer needed - inputs show their own values
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Wire up REHIT stat inputs to trigger save
      ['fitnessScore','calories','peakWatts','wattSeconds'].forEach(id=>{
        const el=document.getElementById(id);
        if(el) el.addEventListener('change', () => {
          if(typeof triggerSaveSoon==='function') triggerSaveSoon();
        });
      });
    });
    
    // =============================================
    // SETTINGS & THEME SYSTEM
    // =============================================
    
    // Default settings
    const defaultSettings = {
      dayStartTime: '05:00',
      nightStartTime: '17:00',
      // Goal values
      sleepGoal: 7,
      aguaGoal: 6,
      stepsGoal: 5000,
      movementGoal: 2,
      mealsGoal: 2,
      snacksGoal: 2,
      noAlcoholGoal: 1,
      rehit2x10Goal: 2,
      rehit3x10Goal: 3,
      rehitGoal: 4, // legacy - combined total
      readingGoal: 60,
      meditationGoal: 3,
      // Goal frequencies
      sleepFreq: 'daily',
      aguaFreq: 'daily',
      stepsFreq: 'daily',
      movementFreq: 'daily',
      mealsFreq: 'daily',
      snacksFreq: 'daily',
      noAlcoholFreq: 'daily',
      rehit2x10Freq: 'weekly',
      rehit3x10Freq: 'weekly',
      readingFreq: 'weekly',
      meditationFreq: 'weekly',
      sections: [
        { id: 'greysHabitsSection', name: "Grey's Habits", icon: '', visible: true, custom: false },
        { id: 'nutritionSection', name: 'Supplements', icon: '', visible: true, custom: false },
        { id: 'mealsSection', name: 'Meals', icon: '', visible: true, custom: false },
        { id: 'movementSection', name: 'Movement Breaks', icon: '', visible: true, custom: false },
        { id: 'mentalHabitsSection', name: 'Reading', icon: '', visible: true, custom: false },
        { id: 'meditationSection', name: 'Mindfulness', icon: '', visible: true, custom: false },
        { id: 'reflectionsSection', name: 'Reflections', icon: '', visible: true, custom: false },
        { id: 'storiesSection', name: 'Grey & Sloane', icon: '', visible: true, custom: false },
        { id: 'carlySection', name: 'Carly', icon: '', visible: true, custom: false },
        { id: 'bodyDataSection', name: 'Body', icon: '', visible: true, custom: false },
        { id: 'bloodPressureSection', name: 'Blood Pressure', icon: '', visible: true, custom: false },
      ]
    };
    
    // Load settings from localStorage
    function loadSettings() {
      try {
        const saved = localStorage.getItem('elevateSettings');
        if (saved) {
          return { ...defaultSettings, ...JSON.parse(saved) };
        }
      } catch (e) {
        console.error('Error loading settings:', e);
      }
      return { ...defaultSettings };
    }
    
    // Save settings to localStorage
    function saveSettings(settings) {
      try {
        localStorage.setItem('elevateSettings', JSON.stringify(settings));
      } catch (e) {
        console.error('Error saving settings:', e);
      }
    }
    
    let appSettings = loadSettings();

    // Migrate old waterGoal  aguaGoal
    if (appSettings.waterGoal && !appSettings.aguaGoal) {
      appSettings.aguaGoal = appSettings.waterGoal;
      delete appSettings.waterGoal;
      saveSettings(appSettings);
    }

    // Theme functions
    function getCurrentTheme() {
      const now = new Date();
      const currentTime = now.getHours() * 60 + now.getMinutes();
      
      const [dayH, dayM] = appSettings.dayStartTime.split(':').map(Number);
      const [nightH, nightM] = appSettings.nightStartTime.split(':').map(Number);
      
      const dayStart = dayH * 60 + dayM;
      const nightStart = nightH * 60 + nightM;
      
      if (currentTime >= dayStart && currentTime < nightStart) {
        return 'day';
      } else {
        return 'night';
      }
    }
    
    function applyTheme(theme, showIndicator = false) {
      const body = document.body;
      const indicator = document.getElementById('themeIndicator');
      
      body.classList.remove('day-mode', 'sunset-mode');
      
      if (theme === 'day') {
        body.classList.add('day-mode');
        if (indicator) indicator.innerHTML = ' Day Mode';
      } else {
        if (indicator) indicator.innerHTML = ' Night Mode';
      }
      
      // Update theme buttons
      document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.theme === theme);
      });
      
      // Update display
      const display = document.getElementById('currentThemeDisplay');
      if (display) display.textContent = theme === 'day' ? 'Day Mode' : 'Night Mode';
      
      if (showIndicator && indicator) {
        indicator.classList.add('show');
        setTimeout(() => indicator.classList.remove('show'), 2000);
      }
    }
    
    // Initialize theme
    let currentTheme = getCurrentTheme();
    applyTheme(currentTheme, false);
    
    // Check for theme changes every minute
    setInterval(() => {
      const newTheme = getCurrentTheme();
      if (newTheme !== currentTheme) {
        currentTheme = newTheme;
        applyTheme(newTheme, true);
      }
    }, 60000);
    
    // =============================================
    // SETTINGS PAGE
    // =============================================
    
    function openSettingsPage() {
      // Hide all other pages
      const mainPage = document.getElementById('healthForm');
      const chartsPage = document.getElementById('chartsPage');
      const bioPage = document.getElementById('biomarkersPage');
      const summaryPage = document.getElementById('weeklySummaryPage');
      const settingsPage = document.getElementById('settingsPage');
      const fab = document.getElementById('quickLogFab');
      
      if (mainPage) mainPage.style.display = 'none';
      if (chartsPage) chartsPage.style.display = 'none';
      if (bioPage) bioPage.style.display = 'none';
      if (summaryPage) summaryPage.style.display = 'none';
      if (settingsPage) settingsPage.style.display = 'block';
      if (fab) fab.style.display = 'none';
      
      // Populate settings
      document.getElementById('dayStartTime').value = appSettings.dayStartTime;
      document.getElementById('nightStartTime').value = appSettings.nightStartTime;

      // Goal values
      document.getElementById('sleepGoal').value = appSettings.sleepGoal || 7;
      document.getElementById('aguaGoal').value = appSettings.aguaGoal || 6;
      document.getElementById('stepsGoal').value = appSettings.stepsGoal || 5000;
      document.getElementById('movementGoal').value = appSettings.movementGoal || 2;
      document.getElementById('mealsGoal').value = appSettings.mealsGoal || 2;
      document.getElementById('snacksGoal').value = appSettings.snacksGoal || 2;
      document.getElementById('rehit2x10Goal').value = appSettings.rehit2x10Goal || 2;
      document.getElementById('rehit3x10Goal').value = appSettings.rehit3x10Goal || 3;
      document.getElementById('readingGoal').value = appSettings.readingGoal || 60;
      document.getElementById('meditationGoal').value = appSettings.meditationGoal || 3;

      // Goal frequencies
      document.getElementById('sleepFreq').value = appSettings.sleepFreq || 'daily';
      document.getElementById('aguaFreq').value = appSettings.aguaFreq || 'daily';
      document.getElementById('stepsFreq').value = appSettings.stepsFreq || 'daily';
      document.getElementById('movementFreq').value = appSettings.movementFreq || 'daily';
      document.getElementById('mealsFreq').value = appSettings.mealsFreq || 'daily';
      document.getElementById('snacksFreq').value = appSettings.snacksFreq || 'daily';
      document.getElementById('noAlcoholFreq').value = appSettings.noAlcoholFreq || 'daily';
      document.getElementById('rehit2x10Freq').value = appSettings.rehit2x10Freq || 'weekly';
      document.getElementById('rehit3x10Freq').value = appSettings.rehit3x10Freq || 'weekly';
      document.getElementById('readingFreq').value = appSettings.readingFreq || 'weekly';
      document.getElementById('meditationFreq').value = appSettings.meditationFreq || 'weekly';

      window.scrollTo(0, 0);
      renderSectionList();
      updatePhaseManagementInfo();
    }

    function updatePhaseManagementInfo() {
      const infoEl = document.getElementById('phaseManagementInfo');
      const btn = document.getElementById('planNextPhaseBtn');
      if (!infoEl || !btn) return;

      // Get current phase info from app.js
      const currentPhase = typeof getCurrentPhase === 'function' ? getCurrentPhase() : null;
      const phases = typeof phasesData !== 'undefined' ? phasesData : [];

      if (!currentPhase) {
        infoEl.innerHTML = '<p style="color:var(--text-muted);font-size:13px;margin:0">No phase data available.</p>';
        btn.textContent = 'Create Phase 1';
        btn.onclick = () => {
          if (typeof openNewPhaseModal === 'function') openNewPhaseModal();
        };
        return;
      }

      // Calculate days remaining in current phase
      const phaseStart = typeof parseDataDate === 'function' ? parseDataDate(currentPhase.start) : new Date(currentPhase.start);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const dayInPhase = Math.floor((today - phaseStart) / (1000 * 60 * 60 * 24)) + 1;
      const daysRemaining = currentPhase.length - dayInPhase;

      const nextPhaseId = currentPhase.id + 1;
      const nextPhaseExists = phases.some(p => p.id === nextPhaseId);

      let statusHtml = `
        <p style="color:var(--text);font-size:14px;margin:0 0 8px 0"><strong>${currentPhase.name}</strong></p>
        <p style="color:var(--text-muted);font-size:13px;margin:0">Day ${dayInPhase} of ${currentPhase.length} (${daysRemaining > 0 ? daysRemaining + ' days remaining' : 'Phase complete!'})</p>
      `;

      if (nextPhaseExists) {
        const nextPhase = phases.find(p => p.id === nextPhaseId);
        statusHtml += `<p style="color:var(--accent-teal);font-size:13px;margin:8px 0 0 0"> ${nextPhase.name} is planned</p>`;
        btn.textContent = `Plan Phase ${nextPhaseId + 1}`;
        btn.onclick = () => {
          if (typeof openNewPhaseModal === 'function') openNewPhaseModal(nextPhaseId);
        };
      } else {
        statusHtml += `<p style="color:var(--accent-orange);font-size:13px;margin:8px 0 0 0"> Phase ${nextPhaseId} not yet planned</p>`;
        btn.textContent = `Plan Phase ${nextPhaseId}`;
        btn.onclick = () => {
          if (typeof openNewPhaseModal === 'function') openNewPhaseModal();
        };
      }

      infoEl.innerHTML = statusHtml;
    }
    
    function closeSettingsPage() {
      document.getElementById('settingsPage').style.display = 'none';
      document.getElementById('healthForm').style.display = 'block';
      document.getElementById('quickLogFab').style.display = 'block';
      
      // Apply section visibility
      applySectionSettings();
      window.scrollTo(0, 0);
    }
    
    function renderSectionList() {
      const list = document.getElementById('sectionList');
      if (!list) return;
      
      list.innerHTML = appSettings.sections.map((sec, idx) => `
        <div class="section-item" draggable="true" data-idx="${idx}" data-id="${sec.id}">
          <span class="section-item-drag"></span>
          <span class="section-item-icon">${sec.icon}</span>
          <span class="section-item-name">${sec.name}</span>
          <div class="section-item-toggle ${sec.visible ? 'on' : ''}" data-idx="${idx}"></div>
          ${sec.custom ? `<button class="section-item-delete" data-idx="${idx}"></button>` : ''}
        </div>
      `).join('');
      
      // Add event listeners
      list.querySelectorAll('.section-item-toggle').forEach(toggle => {
        toggle.addEventListener('click', () => {
          const idx = parseInt(toggle.dataset.idx);
          appSettings.sections[idx].visible = !appSettings.sections[idx].visible;
          toggle.classList.toggle('on');
          saveSettings(appSettings);
        });
      });
      
      list.querySelectorAll('.section-item-delete').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.idx);
          if (confirm('Delete this section?')) {
            appSettings.sections.splice(idx, 1);
            saveSettings(appSettings);
            renderSectionList();
          }
        });
      });
      
      // Drag and drop
      setupDragAndDrop();
    }
    
    function setupDragAndDrop() {
      const list = document.getElementById('sectionList');
      const items = list.querySelectorAll('.section-item');
      let draggedItem = null;
      let touchCurrentItem = null;

      items.forEach(item => {
        // Desktop drag events
        item.addEventListener('dragstart', (e) => {
          draggedItem = item;
          item.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
        });

        item.addEventListener('dragend', () => {
          item.classList.remove('dragging');
          document.querySelectorAll('.section-item').forEach(i => i.classList.remove('drag-over'));
          draggedItem = null;
        });

        item.addEventListener('dragover', (e) => {
          e.preventDefault();
          if (item !== draggedItem) {
            item.classList.add('drag-over');
          }
        });

        item.addEventListener('dragleave', () => {
          item.classList.remove('drag-over');
        });

        item.addEventListener('drop', (e) => {
          e.preventDefault();
          if (item !== draggedItem && draggedItem) {
            const fromIdx = parseInt(draggedItem.dataset.idx);
            const toIdx = parseInt(item.dataset.idx);

            const [moved] = appSettings.sections.splice(fromIdx, 1);
            appSettings.sections.splice(toIdx, 0, moved);

            saveSettings(appSettings);
            renderSectionList();
            applySectionSettings();
          }
        });

        // Mobile touch events - only on the drag handle
        const dragHandle = item.querySelector('.section-item-drag');
        if (dragHandle) {
          dragHandle.addEventListener('touchstart', (e) => {
            e.preventDefault();
            touchCurrentItem = item;
            item.classList.add('dragging');
            if (navigator.vibrate) navigator.vibrate(30);
          }, { passive: false });

          dragHandle.addEventListener('touchmove', (e) => {
            if (!touchCurrentItem) return;
            e.preventDefault();

            const touchY = e.touches[0].clientY;
            const allItems = Array.from(list.querySelectorAll('.section-item'));

            allItems.forEach(otherItem => {
              if (otherItem === touchCurrentItem) return;
              const rect = otherItem.getBoundingClientRect();
              if (touchY > rect.top && touchY < rect.bottom) {
                otherItem.classList.add('drag-over');
              } else {
                otherItem.classList.remove('drag-over');
              }
            });
          }, { passive: false });

          dragHandle.addEventListener('touchend', (e) => {
            if (!touchCurrentItem) return;

            const touchY = e.changedTouches[0].clientY;
            const allItems = Array.from(list.querySelectorAll('.section-item'));

            let targetItem = null;
            allItems.forEach(otherItem => {
              if (otherItem === touchCurrentItem) return;
              const rect = otherItem.getBoundingClientRect();
              if (touchY > rect.top && touchY < rect.bottom) {
                targetItem = otherItem;
              }
            });

            if (targetItem) {
              const fromIdx = parseInt(touchCurrentItem.dataset.idx);
              const toIdx = parseInt(targetItem.dataset.idx);

              const [moved] = appSettings.sections.splice(fromIdx, 1);
              appSettings.sections.splice(toIdx, 0, moved);

              saveSettings(appSettings);
              renderSectionList();
              applySectionSettings();

              if (navigator.vibrate) navigator.vibrate(50);
            }

            touchCurrentItem.classList.remove('dragging');
            allItems.forEach(i => i.classList.remove('drag-over'));
            touchCurrentItem = null;
          });
        }
      });
    }
    
    function applySectionSettings() {
      const form = document.getElementById('healthForm');
      if (!form) return;
      
      // Apply visibility and order
      appSettings.sections.forEach((sec, idx) => {
        const el = document.getElementById(sec.id);
        if (el) {
          el.style.display = sec.visible ? '' : 'none';
          el.style.order = idx;
        }
      });
    }
    
    // Wire up home button
    document.getElementById('homeBtn')?.addEventListener('click', (e) => {
      e.preventDefault();
      // Hide all pages, show main form
      document.getElementById('settingsPage').style.display = 'none';
      document.getElementById('chartsPage').style.display = 'none';
      document.getElementById('biomarkersPage').style.display = 'none';
      document.getElementById('weeklySummaryPage').style.display = 'none';
      document.getElementById('healthForm').style.display = 'block';
      document.getElementById('quickLogFab').style.display = 'block';
      window.scrollTo(0, 0);
    });
    
    // Wire up settings page
    document.getElementById('settingsBtn')?.addEventListener('click', (e) => {
      e.preventDefault();
      openSettingsPage();
    });
    
    document.getElementById('settingsCloseBtn')?.addEventListener('click', closeSettingsPage);
    
    // Time inputs
    document.getElementById('dayStartTime')?.addEventListener('change', (e) => {
      appSettings.dayStartTime = e.target.value;
      saveSettings(appSettings);
      currentTheme = getCurrentTheme();
      applyTheme(currentTheme, true);
    });
    
    document.getElementById('nightStartTime')?.addEventListener('change', (e) => {
      appSettings.nightStartTime = e.target.value;
      saveSettings(appSettings);
      currentTheme = getCurrentTheme();
      applyTheme(currentTheme, true);
    });
    
    // Goal inputs - unified handler
    const goalInputConfigs = [
      { id: 'sleepGoal', key: 'sleepGoal', default: 7, name: 'Sleep', updateRing: true },
      { id: 'aguaGoal', key: 'aguaGoal', default: 6, name: 'Water', updateRing: true, updateAguaBar: true },
      { id: 'stepsGoal', key: 'stepsGoal', default: 5000, name: 'Steps', updateRing: true, updateStepsBar: true },
      { id: 'movementGoal', key: 'movementGoal', default: 2, name: 'Movement', updateRing: true },
      { id: 'mealsGoal', key: 'mealsGoal', default: 2, name: 'Meals', updateRing: true },
      { id: 'snacksGoal', key: 'snacksGoal', default: 2, name: 'Snacks', updateRing: true },
      { id: 'rehit2x10Goal', key: 'rehit2x10Goal', default: 2, name: 'REHIT 2x10' },
      { id: 'rehit3x10Goal', key: 'rehit3x10Goal', default: 3, name: 'REHIT 3x10' },
      { id: 'readingGoal', key: 'readingGoal', default: 60, name: 'Reading' },
      { id: 'meditationGoal', key: 'meditationGoal', default: 3, name: 'Meditation' }
    ];

    goalInputConfigs.forEach(config => {
      document.getElementById(config.id)?.addEventListener('change', (e) => {
        appSettings[config.key] = parseInt(e.target.value) || config.default;
        saveSettings(appSettings);
        if (config.updateRing && typeof updateCompletionRingAurora === 'function') updateCompletionRingAurora();
        if (config.updateAguaBar && typeof updateAguaBar === 'function') updateAguaBar();
        if (config.updateStepsBar && typeof updateStepsBar === 'function') updateStepsBar();
        showToast(`${config.name} goal updated`, 'success');
      });
    });

    // Goal frequency selectors
    const freqConfigs = [
      'sleepFreq', 'aguaFreq', 'stepsFreq', 'movementFreq', 'mealsFreq',
      'snacksFreq', 'noAlcoholFreq', 'rehit2x10Freq', 'rehit3x10Freq', 'readingFreq', 'meditationFreq'
    ];

    freqConfigs.forEach(freqId => {
      document.getElementById(freqId)?.addEventListener('change', (e) => {
        appSettings[freqId] = e.target.value;
        saveSettings(appSettings);
        showToast('Frequency updated', 'success');
      });
    });

    // ===== HABIT NOTES =====
    let habitNotes = [];

    async function loadHabitNotes() {
      try {
        const result = await apiGet('habit_notes_load');
        habitNotes = result.notes || [];
      } catch (e) {
        console.error('Failed to load habit notes:', e);
        // Fall back to localStorage
        try {
          const stored = localStorage.getItem('habitNotes');
          if (stored) habitNotes = JSON.parse(stored);
        } catch (e2) {
          habitNotes = [];
        }
      }
      renderHabitNotes();
    }

    async function saveHabitNotes() {
      // Save to localStorage as backup
      localStorage.setItem('habitNotes', JSON.stringify(habitNotes));
      // Save to KV
      try {
        await apiPost('habit_notes_save', { notes: habitNotes });
      } catch (e) {
        console.error('Failed to save habit notes to KV:', e);
      }
    }

    function renderHabitNotes() {
      const list = document.getElementById('habitNotesList');
      if (!list) return;

      if (habitNotes.length === 0) {
        list.innerHTML = '<div class="habit-notes-empty">No notes yet. Add your first habit note above!</div>';
        return;
      }

      // Show newest first
      const sortedNotes = [...habitNotes].reverse();
      list.innerHTML = sortedNotes.map((note, idx) => {
        const realIdx = habitNotes.length - 1 - idx; // Get actual index
        const date = new Date(note.timestamp);
        const timeStr = date.toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric'
        }) + ' at ' + date.toLocaleTimeString('en-US', {
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        });
        return `
          <div class="habit-note-item" data-idx="${realIdx}">
            <div class="habit-note-text">${escapeHtml(note.text)}</div>
            <div class="habit-note-meta">
              <span class="habit-note-time"> ${timeStr}</span>
              <button type="button" class="habit-note-delete" onclick="deleteHabitNote(${realIdx})"> Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    window.addHabitNote = function() {
      const input = document.getElementById('newHabitNote');
      const text = input.value.trim();

      if (!text) {
        input.style.borderColor = '#ff6b9d';
        setTimeout(() => input.style.borderColor = '', 1500);
        return;
      }

      habitNotes.push({
        text: text,
        timestamp: new Date().toISOString()
      });

      saveHabitNotes();
      renderHabitNotes();
      input.value = '';
      showToast('Note added!', 'success');
    };

    window.deleteHabitNote = function(idx) {
      if (idx >= 0 && idx < habitNotes.length) {
        habitNotes.splice(idx, 1);
        saveHabitNotes();
        renderHabitNotes();
        showToast('Note deleted', 'success');
      }
    };

    // Initialize habit notes
    document.getElementById('addHabitNoteBtn')?.addEventListener('click', addHabitNote);
    document.getElementById('newHabitNote')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        addHabitNote();
      }
    });
    loadHabitNotes();

    // Theme preview buttons
    document.querySelectorAll('.theme-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        currentTheme = btn.dataset.theme;
        applyTheme(currentTheme, true);
      });
    });
    
    // Show/hide type-specific options
    document.getElementById('newSectionType')?.addEventListener('change', (e) => {
      // Hide all options first
      document.querySelectorAll('.type-options').forEach(opt => opt.style.display = 'none');
      
      // Show relevant options
      const type = e.target.value;
      if (type === 'checkbox') {
        document.getElementById('checkboxOptions').style.display = 'block';
      } else if (type === 'counter') {
        document.getElementById('counterOptions').style.display = 'block';
      } else if (type === 'log') {
        document.getElementById('logOptions').style.display = 'block';
      } else if (type === 'number') {
        document.getElementById('numberOptions').style.display = 'block';
      } else if (type === 'rating') {
        document.getElementById('ratingOptions').style.display = 'block';
      }
    });
    
    // Add log field button
    document.getElementById('addLogFieldBtn')?.addEventListener('click', () => {
      const list = document.getElementById('logFieldsList');
      const row = document.createElement('div');
      row.className = 'log-field-row';
      row.style.cssText = 'display:flex;gap:8px;margin-bottom:8px';
      row.innerHTML = `
        <input type="text" class="input" placeholder="Field name" style="flex:2">
        <select class="input" style="flex:1">
          <option value="text">Text</option>
          <option value="number">Number</option>
          <option value="select">Dropdown</option>
        </select>
        <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()" style="padding:8px"></button>
      `;
      list.appendChild(row);
    });
    
    // Add custom section
    document.getElementById('addSectionBtn')?.addEventListener('click', () => {
      const name = document.getElementById('newSectionName').value.trim();
      const type = document.getElementById('newSectionType').value;
      const icon = document.getElementById('newSectionIcon').value || '';
      
      if (!name) {
        alert('Please enter a section name');
        return;
      }
      
      const id = 'custom_' + Date.now();
      
      // Gather type-specific config
      let config = {};
      
      if (type === 'checkbox') {
        const names = document.getElementById('checkboxNames').value;
        config.checkboxes = names.split(',').map(n => n.trim()).filter(n => n);
        if (config.checkboxes.length === 0) {
          alert('Please enter at least one checkbox name');
          return;
        }
      } else if (type === 'counter') {
        config.goalType = document.getElementById('counterGoalType').value;
        config.goalNumber = parseInt(document.getElementById('counterGoalNumber').value) || 6;
        config.unitLabel = document.getElementById('counterUnitLabel').value || 'times';
      } else if (type === 'log') {
        const rows = document.querySelectorAll('#logFieldsList .log-field-row');
        config.fields = [];
        rows.forEach(row => {
          const fname = row.querySelector('input').value.trim();
          const ftype = row.querySelector('select').value;
          if (fname) config.fields.push({ name: fname, type: ftype });
        });
        if (config.fields.length === 0) {
          alert('Please add at least one field for the log');
          return;
        }
      } else if (type === 'number') {
        config.unit = document.getElementById('numberUnit').value || '';
        config.placeholder = document.getElementById('numberPlaceholder').value || '0';
      } else if (type === 'rating') {
        config.label = document.getElementById('ratingLabel').value || 'Rate';
      }
      
      appSettings.sections.push({
        id,
        name,
        icon,
        visible: true,
        custom: true,
        type,
        config
      });
      
      saveSettings(appSettings);
      
      // Create the section element
      createCustomSection(id, name, icon, type, config);
      
      // Clear inputs
      document.getElementById('newSectionName').value = '';
      document.getElementById('newSectionIcon').value = '';
      document.getElementById('checkboxNames').value = '';
      document.getElementById('counterGoalNumber').value = '';
      document.getElementById('counterUnitLabel').value = '';
      document.getElementById('logFieldsList').innerHTML = `
        <div class="log-field-row" style="display:flex;gap:8px;margin-bottom:8px">
          <input type="text" class="input" placeholder="Field name" style="flex:2">
          <select class="input" style="flex:1">
            <option value="text">Text</option>
            <option value="number">Number</option>
            <option value="select">Dropdown</option>
          </select>
          <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()" style="padding:8px"></button>
        </div>
      `;
      document.querySelectorAll('.type-options').forEach(opt => opt.style.display = 'none');
      document.getElementById('newSectionType').value = 'text';
      
      renderSectionList();
    });
    
    // Store custom section data (for logs, counters, etc.)
    window.customSectionData = window.customSectionData || {};
    
    function createCustomSection(id, name, icon, type, config = {}) {
      const form = document.getElementById('healthForm');
      if (!form) return;
      
      // Initialize data storage for this section
      if (!window.customSectionData[id]) {
        window.customSectionData[id] = { value: type === 'counter' ? 0 : null, entries: [] };
      }
      
      const section = document.createElement('div');
      section.className = 'section';
      section.id = id;
      
      let content = '';
      
      if (type === 'text') {
        content = '<textarea class="input" id="' + id + '_input" placeholder="Enter notes..."></textarea>';
      
      } else if (type === 'checkbox') {
        const checkboxes = config.checkboxes || ['Done'];
        let cbHtml = '';
        checkboxes.forEach((cb, i) => {
          cbHtml += '<div class="chip"><input type="checkbox" id="' + id + '_check_' + i + '"><div class="chip-dot"></div><span class="chip-text">' + cb + '</span></div>';
        });
        content = '<div class="chips">' + cbHtml + '</div>';
      
      } else if (type === 'number') {
        const unit = config.unit ? '<span class="card-unit">' + config.unit + '</span>' : '';
        content = '<div style="display:flex;align-items:center;gap:8px"><input type="number" class="big-input" id="' + id + '_input" placeholder="' + (config.placeholder || '0') + '" style="max-width:120px">' + unit + '</div>';
      
      } else if (type === 'counter') {
        const goalNum = config.goalNumber || 6;
        const unit = config.unitLabel || 'times';
        const isWeekly = config.goalType === 'weekly';
        
        if (isWeekly) {
          // Weekly goal with dots
          let dots = '';
          for (let i = 0; i < goalNum; i++) {
            dots += `<div class="counter-dot" data-idx="${i}"></div>`;
          }
          content = `
            <div style="display:flex;align-items:center;gap:12px">
              <button type="button" class="water-btn counter-minus" data-id="${id}"></button>
              <div class="water-num counter-value" id="${id}_value">0</div>
              <button type="button" class="water-btn counter-plus" data-id="${id}">+</button>
              <div class="counter-dots" id="${id}_dots" style="display:flex;gap:6px;margin-left:auto">
                ${dots}
              </div>
            </div>
            <div class="card-avg" style="margin-top:8px">Goal: ${goalNum} ${unit}/week</div>
          `;
        } else {
          // Daily goal with progress bar
          content = `
            <div style="display:flex;align-items:center;gap:12px">
              <button type="button" class="water-btn counter-minus" data-id="${id}"></button>
              <div class="water-num counter-value" id="${id}_value">0</div>
              <button type="button" class="water-btn counter-plus" data-id="${id}">+</button>
              <div class="water-bar-wrap">
                <div class="water-bar-track">
                  <div class="water-bar-fill counter-fill" id="${id}_fill" style="height:0%"></div>
                </div>
                <div class="water-bar-goal">${goalNum}</div>
              </div>
            </div>
            <div class="card-avg" style="margin-top:8px">Goal: ${goalNum} ${unit}/day</div>
          `;
        }
      
      } else if (type === 'log') {
        content = `
          <div class="items" id="${id}_list"></div>
          <button type="button" class="btn btn-secondary" id="${id}_addBtn">+ Add Entry</button>
        `;
      
      } else if (type === 'time') {
        content = `<input type="time" class="input" id="${id}_input">`;
      
      } else if (type === 'rating') {
        const label = config.label || 'Rate';
        content = `
          <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px">${label}</div>
          <div class="rating-stars" id="${id}_stars">
            <span class="star" data-val="1"></span>
            <span class="star" data-val="2"></span>
            <span class="star" data-val="3"></span>
            <span class="star" data-val="4"></span>
            <span class="star" data-val="5"></span>
          </div>
          <input type="hidden" id="${id}_input" value="">
        `;
      
      } else if (type === 'toggle') {
        content = `
          <div class="chips">
            <div class="chip toggle-chip" id="${id}_toggle">
              <input type="checkbox" id="${id}_input">
              <div class="chip-dot"></div>
              <span class="chip-text">Yes</span>
            </div>
          </div>
        `;
      }
      
      section.innerHTML = `
        <div class="sec-head collapsed">
          <div class="sec-title">
            <div class="sec-icon" style="--icon-start:var(--accent-purple);--icon-end:var(--accent-pink)">${icon}</div>
            <span class="sec-name">${name}</span>
          </div>
          <span class="sec-toggle"></span>
        </div>
        <div class="sec-content collapsed">${content}</div>
      `;
      
      form.appendChild(section);
      
      // Wire up collapse
      const head = section.querySelector('.sec-head');
      head.addEventListener('click', () => {
        head.classList.toggle('collapsed');
        section.querySelector('.sec-content').classList.toggle('collapsed');
      });
      
      // Wire up type-specific interactions
      wireUpCustomSection(section, id, type, config);
    }
    
    function wireUpCustomSection(section, id, type, config) {
      if (type === 'checkbox') {
        section.querySelectorAll('.chip').forEach(chip => {
          const cb = chip.querySelector('input');
          chip.addEventListener('click', (e) => {
            if (e.target.type !== 'checkbox') {
              cb.checked = !cb.checked;
              chip.classList.toggle('on', cb.checked);
              updateCompletionRingAurora();
              if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
            }
          });
          cb.addEventListener('change', () => {
            chip.classList.toggle('on', cb.checked);
            updateCompletionRingAurora();
            if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
          });
        });
      
      } else if (type === 'counter') {
        const goalNum = config.goalNumber || 6;
        const isWeekly = config.goalType === 'weekly';
        
        section.querySelector('.counter-plus')?.addEventListener('click', () => {
          const valEl = document.getElementById(`${id}_value`);
          let val = parseInt(valEl.textContent) || 0;
          val++;
          valEl.textContent = val;
          window.customSectionData[id].value = val;
          
          if (isWeekly) {
            // Update dots
            const dots = section.querySelectorAll('.counter-dot');
            dots.forEach((dot, i) => dot.classList.toggle('on', i < val));
          } else {
            // Update progress bar
            const fill = document.getElementById(`${id}_fill`);
            if (fill) fill.style.height = Math.min(100, (val / goalNum) * 100) + '%';
          }
          if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
        });
        
        section.querySelector('.counter-minus')?.addEventListener('click', () => {
          const valEl = document.getElementById(`${id}_value`);
          let val = parseInt(valEl.textContent) || 0;
          if (val > 0) val--;
          valEl.textContent = val;
          window.customSectionData[id].value = val;
          
          if (isWeekly) {
            const dots = section.querySelectorAll('.counter-dot');
            dots.forEach((dot, i) => dot.classList.toggle('on', i < val));
          } else {
            const fill = document.getElementById(`${id}_fill`);
            if (fill) fill.style.height = Math.min(100, (val / goalNum) * 100) + '%';
          }
          if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
        });
      
      } else if (type === 'log') {
        const addBtn = document.getElementById(`${id}_addBtn`);
        addBtn?.addEventListener('click', () => openLogModal(id, config.fields || []));
      
      } else if (type === 'rating') {
        const stars = section.querySelectorAll('.star');
        const input = document.getElementById(`${id}_input`);
        stars.forEach(star => {
          star.addEventListener('click', () => {
            const val = parseInt(star.dataset.val);
            input.value = val;
            window.customSectionData[id].value = val;
            stars.forEach((s, i) => {
              s.textContent = i < val ? '' : '';
              s.classList.toggle('filled', i < val);
            });
            if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
          });
        });
      
      } else if (type === 'toggle') {
        const chip = section.querySelector('.toggle-chip');
        const cb = chip.querySelector('input');
        chip.addEventListener('click', (e) => {
          if (e.target.type !== 'checkbox') {
            cb.checked = !cb.checked;
            chip.classList.toggle('on', cb.checked);
            chip.querySelector('.chip-text').textContent = cb.checked ? 'Yes' : 'No';
            updateCompletionRingAurora();
            if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
          }
        });
        cb.addEventListener('change', () => {
          chip.classList.toggle('on', cb.checked);
          chip.querySelector('.chip-text').textContent = cb.checked ? 'Yes' : 'No';
          updateCompletionRingAurora();
          if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
        });
      
      } else if (type === 'text') {
        const input = document.getElementById(`${id}_input`);
        if (input) {
          // Save on blur (when user clicks away) to avoid interrupting typing
          input.addEventListener('blur', () => {
            window.customSectionData[id] = window.customSectionData[id] || {};
            window.customSectionData[id].value = input.value;
            if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
          });
        }
      
      } else if (type === 'number') {
        const input = document.getElementById(`${id}_input`);
        if (input) {
          input.addEventListener('change', () => {
            window.customSectionData[id] = window.customSectionData[id] || {};
            window.customSectionData[id].value = input.value;
            if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
          });
        }
      
      } else if (type === 'time') {
        const input = document.getElementById(`${id}_input`);
        if (input) {
          input.addEventListener('change', () => {
            window.customSectionData[id] = window.customSectionData[id] || {};
            window.customSectionData[id].value = input.value;
            if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
          });
        }
      }
    }
    
    // Log modal for custom log sections
    function openLogModal(sectionId, fields) {
      // Create modal if doesn't exist
      let modal = document.getElementById('customLogModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'customLogModal';
        modal.className = 'modal';
        modal.innerHTML = `
          <div class="modal-overlay" onclick="closeLogModal()"></div>
          <div class="modal-content">
            <div class="modal-header">
              <h3 id="logModalTitle">Add Entry</h3>
              <button onclick="closeLogModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text)"></button>
            </div>
            <div id="logModalFields"></div>
            <button class="btn btn-primary" id="logModalSaveBtn" style="width:100%;margin-top:12px">Save</button>
          </div>
        `;
        document.body.appendChild(modal);
      }
      
      // Populate fields
      const fieldsContainer = document.getElementById('logModalFields');
      fieldsContainer.innerHTML = fields.map(f => `
        <div class="field">
          <label class="field-label">${f.name}</label>
          ${f.type === 'number' 
            ? `<input type="number" class="input" id="logField_${f.name.replace(/\s/g, '_')}" placeholder="0">`
            : `<input type="text" class="input" id="logField_${f.name.replace(/\s/g, '_')}" placeholder="">`
          }
        </div>
      `).join('');
      
      // Wire up save
      document.getElementById('logModalSaveBtn').onclick = () => {
        const entry = {};
        fields.forEach(f => {
          const input = document.getElementById(`logField_${f.name.replace(/\s/g, '_')}`);
          entry[f.name] = f.type === 'number' ? (parseFloat(input.value) || 0) : input.value;
        });
        
        if (!window.customSectionData[sectionId]) {
          window.customSectionData[sectionId] = { entries: [] };
        }
        window.customSectionData[sectionId].entries.push(entry);
        
        renderLogEntries(sectionId, fields);
        closeLogModal();
        if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
      };
      
      modal.classList.add('show');
    }
    
    function closeLogModal() {
      document.getElementById('customLogModal')?.classList.remove('show');
    }
    
    function renderLogEntries(sectionId, fields) {
      const list = document.getElementById(`${sectionId}_list`);
      if (!list) return;
      
      const entries = window.customSectionData[sectionId]?.entries || [];
      list.innerHTML = entries.map((entry, idx) => {
        const summary = fields.map(f => entry[f.name]).filter(v => v).join('  ');
        return `
          <div class="item">
            <span class="item-text">${summary || 'Entry ' + (idx + 1)}</span>
            <button type="button" class="btn btn-danger" onclick="removeLogEntry('${sectionId}', ${idx})"></button>
          </div>
        `;
      }).join('');
    }
    
    window.removeLogEntry = function(sectionId, idx) {
      if (window.customSectionData[sectionId]?.entries) {
        window.customSectionData[sectionId].entries.splice(idx, 1);
        // Re-render - need to get fields from config
        const sec = appSettings.sections.find(s => s.id === sectionId);
        if (sec?.config?.fields) {
          renderLogEntries(sectionId, sec.config.fields);
        }
        if (typeof triggerSaveSoon === 'function') triggerSaveSoon();
      }
    };
    
    // Load custom sections data from server and update UI
    window.loadCustomSectionsData = function(data) {
      // Reset all custom section data first
      window.customSectionData = {};
      
      // Then load new data if provided
      if (data && typeof data === 'object') {
        window.customSectionData = data;
      }
      
      // Update UI for each custom section
      appSettings.sections.filter(s => s.custom).forEach(sec => {
        const sectionData = window.customSectionData[sec.id] || {};
        
        // Ensure data structure exists
        if (!window.customSectionData[sec.id]) {
          window.customSectionData[sec.id] = { value: null, entries: [] };
        }
        
        const type = sec.type;
        const config = sec.config || {};
        
        if (type === 'counter') {
          const val = sectionData.value || 0;
          const valEl = document.getElementById(`${sec.id}_value`);
          if (valEl) valEl.textContent = val;
          
          if (config.goalType === 'weekly') {
            // Update dots
            const dots = document.querySelectorAll(`#${sec.id} .counter-dot`);
            dots.forEach((dot, i) => dot.classList.toggle('on', i < val));
          } else {
            // Update progress bar
            const fill = document.getElementById(`${sec.id}_fill`);
            const goalNum = config.goalNumber || 6;
            if (fill) fill.style.height = Math.min(100, (val / goalNum) * 100) + '%';
          }
        
        } else if (type === 'checkbox') {
          const checkboxes = config.checkboxes || ['Done'];
          checkboxes.forEach((cb, i) => {
            const input = document.getElementById(`${sec.id}_check_${i}`);
            const chip = input?.closest('.chip');
            const isChecked = sectionData.checkboxes?.[i] || false;
            if (input) {
              input.checked = isChecked;
              chip?.classList.toggle('on', isChecked);
            }
          });
        
        } else if (type === 'text') {
          const input = document.getElementById(`${sec.id}_input`);
          if (input) {
            input.value = sectionData.value || '';
          }
        
        } else if (type === 'number') {
          const input = document.getElementById(`${sec.id}_input`);
          if (input) input.value = sectionData.value || '';
        
        } else if (type === 'time') {
          const input = document.getElementById(`${sec.id}_input`);
          if (input) input.value = sectionData.value || '';
        
        } else if (type === 'rating') {
          const val = sectionData.value || 0;
          const input = document.getElementById(`${sec.id}_input`);
          if (input) input.value = val;
          const stars = document.querySelectorAll(`#${sec.id}_stars .star`);
          stars.forEach((s, i) => {
            s.textContent = i < val ? '' : '';
            s.classList.toggle('filled', i < val);
          });
        
        } else if (type === 'toggle') {
          const input = document.getElementById(`${sec.id}_input`);
          const chip = document.getElementById(`${sec.id}_toggle`);
          const isChecked = sectionData.value || false;
          if (input) {
            input.checked = isChecked;
            chip?.classList.toggle('on', isChecked);
            const textEl = chip?.querySelector('.chip-text');
            if (textEl) textEl.textContent = isChecked ? 'Yes' : 'No';
          }
        
        } else if (type === 'log') {
          if (config.fields) {
            renderLogEntries(sec.id, config.fields);
          }
        }
      });
      
      // Update completion ring
      if (typeof updateCompletionRingAurora === 'function') {
        updateCompletionRingAurora();
      }
      
    };
    
    // Collect custom sections data from UI for saving
    window.collectCustomSectionsData = function() {
      appSettings.sections.filter(s => s.custom).forEach(sec => {
        if (!window.customSectionData[sec.id]) {
          window.customSectionData[sec.id] = { value: null, entries: [] };
        }
        
        const type = sec.type;
        const config = sec.config || {};
        
        if (type === 'checkbox') {
          const checkboxes = config.checkboxes || ['Done'];
          window.customSectionData[sec.id].checkboxes = checkboxes.map((cb, i) => {
            const input = document.getElementById(`${sec.id}_check_${i}`);
            return input?.checked || false;
          });
        
        } else if (type === 'text' || type === 'number' || type === 'time') {
          const input = document.getElementById(`${sec.id}_input`);
          window.customSectionData[sec.id].value = input?.value || '';
        
        } else if (type === 'toggle') {
          const input = document.getElementById(`${sec.id}_input`);
          window.customSectionData[sec.id].value = input?.checked || false;
        }
        // counter, rating, and log already update customSectionData directly
      });
      
      return window.customSectionData;
    };
    
    // Export/Import settings
    document.getElementById('exportSettingsBtn')?.addEventListener('click', () => {
      const data = JSON.stringify(appSettings, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'elevate-settings.json';
      a.click();
      URL.revokeObjectURL(url);
    });
    
    document.getElementById('importSettingsBtn')?.addEventListener('click', () => {
      document.getElementById('importSettingsFile').click();
    });
    
    document.getElementById('importSettingsFile')?.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (evt) => {
        try {
          const imported = JSON.parse(evt.target.result);
          appSettings = { ...defaultSettings, ...imported };
          saveSettings(appSettings);
          renderSectionList();
          applySectionSettings();
          currentTheme = getCurrentTheme();
          applyTheme(currentTheme, true);
          alert('Settings imported successfully!');
        } catch (err) {
          alert('Error importing settings: ' + err.message);
        }
      };
      reader.readAsText(file);
    });
    
    // Initialize section settings on load
    document.addEventListener('DOMContentLoaded', () => {
      applySectionSettings();
      
      // Recreate any custom sections
      appSettings.sections.filter(s => s.custom).forEach(sec => {
        if (!document.getElementById(sec.id)) {
          createCustomSection(sec.id, sec.name, sec.icon, sec.type, sec.config || {});
        }
      });
    });
    
    // Weekly Goals Review (Sunday)
    function getWeekKey() {
      const now = new Date();
      const sun = new Date(now);
      sun.setDate(now.getDate() - now.getDay());
      return 'weeklyReview-' + sun.toISOString().slice(0, 10);
    }

    function checkWeeklyReview() {
      const today = new Date();
      if (today.getDay() !== 0) return; // Only Sundays
      const key = getWeekKey();
      if (localStorage.getItem(key)) return; // Already shown this week
      populateWeeklyReview();
      document.getElementById('weeklyReviewModal').classList.add('show');
    }

    function populateWeeklyReview() {
      document.getElementById('wr-sleep').value = 7;
      document.getElementById('wr-agua').value = appSettings.aguaGoal || 6;
      document.getElementById('wr-steps').value = appSettings.stepsGoal || 7500;
      document.getElementById('wr-movement').value = appSettings.movementGoal || 2;
      document.getElementById('wr-rehit').value = appSettings.rehitGoal || 4;
      document.getElementById('wr-reading').value = appSettings.readingGoal || 60;
      document.getElementById('wr-meditation').value = appSettings.meditationGoal || 60;
    }

    window.closeWeeklyReview = function() {
      document.getElementById('weeklyReviewModal').classList.remove('show');
      localStorage.setItem(getWeekKey(), 'true');
    };

    window.saveWeeklyReview = function() {
      appSettings.aguaGoal = parseInt(document.getElementById('wr-agua').value) || 6;
      appSettings.stepsGoal = parseInt(document.getElementById('wr-steps').value) || 7500;
      appSettings.movementGoal = parseInt(document.getElementById('wr-movement').value) || 2;
      appSettings.rehitGoal = parseInt(document.getElementById('wr-rehit').value) || 4;
      appSettings.readingGoal = parseInt(document.getElementById('wr-reading').value) || 60;
      appSettings.meditationGoal = parseInt(document.getElementById('wr-meditation').value) || 60;
      saveSettings(appSettings);

      // Sync Settings page inputs if they exist
      const wg = document.getElementById('aguaGoal');
      const sg = document.getElementById('stepsGoal');
      const mg = document.getElementById('movementGoal');
      const rg = document.getElementById('rehitGoal');
      const rdg = document.getElementById('readingGoal');
      const mdg = document.getElementById('meditationGoal');
      if (wg) wg.value = appSettings.aguaGoal;
      if (sg) sg.value = appSettings.stepsGoal;
      if (mg) mg.value = appSettings.movementGoal;
      if (rg) rg.value = appSettings.rehitGoal;
      if (rdg) rdg.value = appSettings.readingGoal;
      if (mdg) mdg.value = appSettings.meditationGoal;

      document.getElementById('weeklyReviewModal').classList.remove('show');
      localStorage.setItem(getWeekKey(), 'true');
      if (typeof showToast === 'function') showToast('Goals locked in! Let\'s go.', 'success');
    };

    // Check after a short delay so the page finishes loading
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(checkWeeklyReview, 1500);
      document.getElementById('weeklyReviewModal').addEventListener('click', (e) => {
        if (e.target.id === 'weeklyReviewModal') closeWeeklyReview();
      });
    });

    // Trash Reminder (Tuesday after 6 PM)
    // ===== Bedtime Routine =====
    let bedtimeItems = [];
    let bedtimeCheckedState = {};

    // Get tonight's key for localStorage dismissal
    function getBedtimeKey() {
      const now = new Date();
      return 'bedtimeDismissed-' + now.toISOString().slice(0, 10);
    }

    // Check if bedtime routine should show (weekdays 9:45pm-midnight)
    function shouldShowBedtimeRoutine() {
      const now = new Date();
      const day = now.getDay(); // 0=Sun, 1-5=weekdays, 6=Sat
      const hour = now.getHours();
      const minute = now.getMinutes();

      // Only weekdays (Mon-Fri = 1-5)
      if (day === 0 || day === 6) return false;

      // Only 9:45pm (21:45) to midnight
      if (hour < 21) return false;
      if (hour === 21 && minute < 45) return false;

      // Already dismissed tonight?
      if (localStorage.getItem(getBedtimeKey())) return false;

      return true;
    }

    // Load bedtime items from KV
    async function loadBedtimeItems() {
      try {
        const result = await apiGet('bedtime_items_load');
        bedtimeItems = result.items || [];
        bedtimeItems.sort((a, b) => (a.order || 0) - (b.order || 0));
        renderBedtimeItems();
        renderBedtimeSettings();
        checkBedtimeRoutine();
      } catch (err) {
        console.error('Failed to load bedtime items:', err);
        // Use defaults
        bedtimeItems = [
          { id: 1, name: "Brush Teeth", order: 0 },
          { id: 2, name: "Pick Clothes", order: 1 },
          { id: 3, name: "Computer", order: 2 },
          { id: 4, name: "Supplements", order: 3 },
          { id: 5, name: "Water", order: 4 }
        ];
        renderBedtimeItems();
        renderBedtimeSettings();
        checkBedtimeRoutine();
      }
    }

    // Save bedtime items to KV
    async function saveBedtimeItems() {
      try {
        await apiPost('bedtime_items_save', { items: bedtimeItems });
      } catch (err) {
        console.error('Failed to save bedtime items:', err);
      }
    }

    // Render bedtime items in the routine section
    function renderBedtimeItems() {
      const container = document.getElementById('bedtimeItems');
      if (!container) return;

      container.innerHTML = bedtimeItems.map(item => `
        <div class="bedtime-item ${bedtimeCheckedState[item.id] ? 'checked' : ''}" data-id="${item.id}" onclick="toggleBedtimeItem(${item.id})">
          <div class="bedtime-checkbox">${bedtimeCheckedState[item.id] ? '' : ''}</div>
          <span class="bedtime-item-text">${item.name}</span>
        </div>
      `).join('');
    }

    // Toggle a bedtime item
    window.toggleBedtimeItem = function(id) {
      bedtimeCheckedState[id] = !bedtimeCheckedState[id];
      renderBedtimeItems();

      // Check if all items are checked
      const allChecked = bedtimeItems.every(item => bedtimeCheckedState[item.id]);
      if (allChecked && bedtimeItems.length > 0) {
        showBedtimeCelebration();
      }
    };

    // Check and show bedtime routine if conditions are met
    function checkBedtimeRoutine() {
      const section = document.getElementById('bedtimeRoutine');
      if (!section) return;

      if (shouldShowBedtimeRoutine()) {
        section.classList.add('show');
        section.classList.remove('done-state');
      } else {
        section.classList.remove('show');
      }
    }

    // Dismiss bedtime routine (Done button)
    window.dismissBedtimeRoutine = function() {
      localStorage.setItem(getBedtimeKey(), 'true');
      const section = document.getElementById('bedtimeRoutine');
      if (section) {
        section.classList.remove('show');
      }
    };

    // Show celebration animation
    function showBedtimeCelebration() {
      const celebration = document.getElementById('bedtimeCelebration');
      const starsContainer = document.getElementById('celebrationStars');

      // Generate random stars
      starsContainer.innerHTML = '';
      const starEmojis = ['', '', '', '', '', '', ''];
      for (let i = 0; i < 30; i++) {
        const star = document.createElement('div');
        star.className = 'celebration-star';
        star.textContent = starEmojis[Math.floor(Math.random() * starEmojis.length)];
        star.style.left = Math.random() * 100 + '%';
        star.style.animationDelay = Math.random() * 2 + 's';
        star.style.animationDuration = (1.5 + Math.random()) + 's';
        starsContainer.appendChild(star);
      }

      celebration.classList.add('show');
    }

    // Dismiss celebration
    window.dismissCelebration = function() {
      const celebration = document.getElementById('bedtimeCelebration');
      celebration.classList.remove('show');
      dismissBedtimeRoutine();
    };

    // ===== Bedtime Settings Management =====
    function renderBedtimeSettings() {
      const list = document.getElementById('bedtimeItemsList');
      if (!list) return;

      list.innerHTML = bedtimeItems.map((item, idx) => `
        <div class="section-item" draggable="true" data-idx="${idx}" data-id="${item.id}">
          <span class="section-item-drag"></span>
          <input type="text" class="input bedtime-edit-input" value="${item.name}" data-id="${item.id}" style="flex:1;padding:6px 10px;font-size:13px;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:6px;color:var(--text)">
          <button class="section-item-delete" data-id="${item.id}"></button>
        </div>
      `).join('');

      // Add change handlers for editing names
      list.querySelectorAll('.bedtime-edit-input').forEach(input => {
        input.addEventListener('change', (e) => {
          const id = parseInt(e.target.dataset.id);
          const item = bedtimeItems.find(i => i.id === id);
          if (item) {
            item.name = e.target.value.trim() || item.name;
            saveBedtimeItems();
            renderBedtimeItems();
          }
        });
      });

      // Add delete handlers
      list.querySelectorAll('.section-item-delete').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = parseInt(btn.dataset.id);
          deleteBedtimeItem(id);
        });
      });

      // Setup drag and drop
      setupBedtimeDragDrop();
    }

    // Setup drag and drop for bedtime settings (desktop + mobile touch)
    function setupBedtimeDragDrop() {
      const list = document.getElementById('bedtimeItemsList');
      if (!list) return;

      let draggedItem = null;
      let touchStartY = 0;
      let touchCurrentItem = null;
      let placeholder = null;

      list.querySelectorAll('.section-item').forEach(item => {
        // Desktop drag events
        item.addEventListener('dragstart', (e) => {
          draggedItem = item;
          item.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
        });

        item.addEventListener('dragend', () => {
          item.classList.remove('dragging');
          list.querySelectorAll('.section-item').forEach(i => i.classList.remove('drag-over'));
          draggedItem = null;
        });

        item.addEventListener('dragover', (e) => {
          e.preventDefault();
          if (draggedItem && draggedItem !== item) {
            item.classList.add('drag-over');
          }
        });

        item.addEventListener('dragleave', () => {
          item.classList.remove('drag-over');
        });

        item.addEventListener('drop', (e) => {
          e.preventDefault();
          item.classList.remove('drag-over');
          if (!draggedItem || draggedItem === item) return;

          const fromIdx = parseInt(draggedItem.dataset.idx);
          const toIdx = parseInt(item.dataset.idx);

          const [moved] = bedtimeItems.splice(fromIdx, 1);
          bedtimeItems.splice(toIdx, 0, moved);
          bedtimeItems.forEach((item, i) => item.order = i);
          saveBedtimeItems();
          renderBedtimeSettings();
          renderBedtimeItems();
        });

        // Mobile touch events - only on the drag handle
        const dragHandle = item.querySelector('.section-item-drag');
        if (dragHandle) {
          dragHandle.addEventListener('touchstart', (e) => {
            e.preventDefault();
            touchCurrentItem = item;
            touchStartY = e.touches[0].clientY;
            item.classList.add('dragging');

            // Haptic feedback
            if (navigator.vibrate) navigator.vibrate(30);
          }, { passive: false });

          dragHandle.addEventListener('touchmove', (e) => {
            if (!touchCurrentItem) return;
            e.preventDefault();

            const touchY = e.touches[0].clientY;
            const items = Array.from(list.querySelectorAll('.section-item'));

            // Find which item we're over
            items.forEach(otherItem => {
              if (otherItem === touchCurrentItem) return;
              const rect = otherItem.getBoundingClientRect();
              const midY = rect.top + rect.height / 2;

              if (touchY > rect.top && touchY < rect.bottom) {
                otherItem.classList.add('drag-over');
              } else {
                otherItem.classList.remove('drag-over');
              }
            });
          }, { passive: false });

          dragHandle.addEventListener('touchend', (e) => {
            if (!touchCurrentItem) return;

            const touchY = e.changedTouches[0].clientY;
            const items = Array.from(list.querySelectorAll('.section-item'));

            // Find target item
            let targetItem = null;
            items.forEach(otherItem => {
              if (otherItem === touchCurrentItem) return;
              const rect = otherItem.getBoundingClientRect();
              if (touchY > rect.top && touchY < rect.bottom) {
                targetItem = otherItem;
              }
            });

            // Perform the swap
            if (targetItem) {
              const fromIdx = parseInt(touchCurrentItem.dataset.idx);
              const toIdx = parseInt(targetItem.dataset.idx);

              const [moved] = bedtimeItems.splice(fromIdx, 1);
              bedtimeItems.splice(toIdx, 0, moved);
              bedtimeItems.forEach((item, i) => item.order = i);
              saveBedtimeItems();
              renderBedtimeSettings();
              renderBedtimeItems();

              // Haptic feedback on successful drop
              if (navigator.vibrate) navigator.vibrate(50);
            }

            // Cleanup
            touchCurrentItem.classList.remove('dragging');
            items.forEach(i => i.classList.remove('drag-over'));
            touchCurrentItem = null;
          });
        }
      });
    }

    // Add new bedtime item
    window.addBedtimeItem = function() {
      const input = document.getElementById('newBedtimeItem');
      const name = input.value.trim();
      if (!name) return;

      const maxId = bedtimeItems.reduce((max, i) => Math.max(max, i.id), 0);
      bedtimeItems.push({
        id: maxId + 1,
        name: name,
        order: bedtimeItems.length
      });

      saveBedtimeItems();
      renderBedtimeSettings();
      renderBedtimeItems();
      input.value = '';
    };

    // Delete bedtime item
    window.deleteBedtimeItem = function(id) {
      bedtimeItems = bedtimeItems.filter(i => i.id !== id);
      bedtimeItems.forEach((item, i) => item.order = i);
      saveBedtimeItems();
      renderBedtimeSettings();
      renderBedtimeItems();
    };

    // Initialize bedtime routine on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadBedtimeItems();

      // Add button click handler
      document.getElementById('addBedtimeItemBtn')?.addEventListener('click', addBedtimeItem);

      // Allow Enter key to add item
      document.getElementById('newBedtimeItem')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          addBedtimeItem();
        }
      });

      // Check every minute if bedtime routine should show
      setInterval(checkBedtimeRoutine, 60000);
    });

    // ===== Trash Reminder =====
    function getTuesdayKey() {
      const now = new Date();
      // Find the Tuesday of the current week (or most recent Tuesday if today is Mon)
      const day = now.getDay();
      const diff = day >= 2 ? day - 2 : day + 5; // days since last Tuesday
      const tue = new Date(now);
      tue.setDate(now.getDate() - diff);
      return 'trashReminder-' + tue.toISOString().slice(0, 10);
    }

    function checkTrashReminder() {
      const now = new Date();
      // Only show on Tuesday (day 2) after 6 PM (18:00)
      if (now.getDay() !== 2) return;
      if (now.getHours() < 18) return;

      const key = getTuesdayKey();
      if (localStorage.getItem(key)) return; // Already dismissed this week

      document.getElementById('trashReminderModal').classList.add('show');
    }

    window.dismissTrashReminder = function() {
      document.getElementById('trashReminderModal').classList.remove('show');
      localStorage.setItem(getTuesdayKey(), 'true');
    };

    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(checkTrashReminder, 2000);
      document.getElementById('trashReminderModal').addEventListener('click', (e) => {
        if (e.target.id === 'trashReminderModal') dismissTrashReminder();
      });
    });

    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then((registration) => {
            console.log('SW registered:', registration.scope);
            // Force the browser to check for a new service worker immediately
            registration.update();
          })
          .catch((error) => {
            console.log('SW registration failed:', error);
          });
      });
    }

  </script>
</body>
</html>
